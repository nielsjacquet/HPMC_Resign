window._hpmcBridge = window._hpmcBridge || new function HpmcBridge() {

    this.ScreenRatioType = {
        X: "appToScreenRatioX",
        Y: "appToScreenRatioY"
    };

    var stateCallbacks = [];
    var communication = new NativeCommunication();
    var screenRatios = {};

    /**
    * bellow method should be override by the js client in order to register for rnr events.
    */

    /**
     * onStartRecord() called to indicate that record is starting.
     * @param {Function} eventcallback – a callback which should be called to indicate success or failure
     * @returns {undefined}
     */
    this.onStartRecord = null;

    /**
     * onStopRecord() called to indicate that record is ending.
     * @param {Function} eventcallback – a callback which should be called to indicate success or failure
     * @returns {undefined}
     */
    this.onStopRecord = null;

    /**
     * onStartReplay() called to indicate that replay is starting.
     * @param {Function} eventcallback – a callback which should be called to indicate success or failure
     * @returns {undefined}
     */
    this.onStartReplay = null;

    /**
     * onStopReplay() called to indicate that record is ending.
     * @param {Function} eventcallback – a callback which should be called to indicate success or failure
     * @returns {undefined}
     */
    this.onStopReplay = null;

    /**
     * onRequest() called when a new request is received. A request is a message that requires a response.
     * @param {Object} message – the request message sent by the testing tool.
     * @param {Function} responseCallback – callback function to be used to send the response for this specific request.
     * @returns {undefined}
     */
    this.onRequest = null;

    /**
     * onWaitForWebObject() called on native-to-web 'waitFor' action.
     * @param {Object} message – the request message sent by the testing tool ("webData").
     * @param {Integer} timeout – the remaining time to wait for the web element to be found (milliseconds).
     * @param {Function} responseCallback – callback function to be used to send the response.
     * @returns {undefined}
     */
    this.onWaitForWebObject = null;
    /**
     * onFindElement() called to when a findElement command is executed on the bridge.
     * param {JsonObject} query by which to locate the elements.
     * @param {Function} queryCallback – a callback which is called with the find results payload or error if occurred.
     * @returns {undefined}
     */
    this.onFindElement = null;

    /**
     * onWebViewVisible(isVisible) called when the webView change visibility.
     * @param {Boolean} isVisible - true - visible, false - invisible
     * @returns {JsonObject} - json object to pass to Tool's main.
     */
    this.onWebViewVisible = null;

    /**
     * setState(state) set or override runtime state of the Webview.
     * @param {JsonObject} state.
     * @param {Function} external JS callback.
     * @returns {undefined}
     */
    this.setState = function(state, callback){
        var stateStr = JSON.stringify(state);
        this.setStateResponse.callbackQueue.push(callback);
        communication.setState(stateStr);
    };

    /**
     * getState(state) get runtime state of the Webview.
     * @param {Function} external JS callback.
     * @returns {undefined}
     */
    this.getState = function(callback){
        this.getStateResponse.callbackQueue.push(callback);
        communication.getState();
    };

    /**
     * responseCallback() called to send a response for the appropriate request
     * @param {*} error – falsy if the sendMessage succeeded. truthy otherwise
     * @param {Object} responseMsg – the response message that should be forwarded to the testing tool which sent the request message which included this callback function
     * @returns {undefined}
     */
    function responseCallback(error, responseMsg) {
        console.log(this.context);
        if(error) {
            console.log("request failed");
        }
        var msgToSend = responseMsg;
        try {
            if(typeof responseMsg != "string") {
                msgToSend = JSON.stringify(responseMsg);
            }
            communication.sendMessage('JsResponse', msgToSend, this.context);
        } catch(e) {
            console.error("failed sending message " + msgToSend + " - exception: " + e);
        }
    }

    /**
     * waitForWebObjectCallback() called to send a response for the appropriate request
     * @param {Boolean} error – false if everything is fine
     * @param {Object} responseMsg – always returns JSON for webData (even on success)
     * @returns {undefined}
     */
    function waitForWebObjectCallback(error, responseMsg) {
        console.log(this.context);
        var response = {error: error, message: responseMsg};

        try {
            communication.sendMessage('JsResponse', JSON.stringify(response), this.context);
        } catch(e) {
            console.error("failed sending message " + response + " - exception: " + e);
        }
    }

    /**
     * responseCallback() called to send a findElement results
     * @param {*} error – falsy if the sendMessage succeeded. truthy otherwise
     * @param {Object} results – results returned that return to the native
     * @returns {undefined}
     */
    function queryCallback(error, results) {
        console.log(this.context);
        if(error) {
            console.log("request failed");
        }
        communication.sendQueryResultFromHpmcBridge(results, this.context);
    }

    // we save last state - in case we call to change state (e.g startRecord/startReplay) before tool connected.
    // then we'll call the state callback in connect()
    var _currentState = null;
    /**
     * connect() called to the indicate the js client finished registering to all the relevant events and ready to receive events.
     */
    this.connect = function(onConnect) {
        stateCallbacks['startRecord'] = this.onStartRecord;
        stateCallbacks['stopRecord'] = this.onStopRecord;
        stateCallbacks['startReplay'] = this.onStartReplay;
        stateCallbacks['stopReplay'] = this.onStopReplay;
        stateCallbacks['request'] = this.onRequest;
        stateCallbacks['webViewVisible'] = this.onWebViewVisible;
        console.log('set callback');

        // This didn't tested for Android - so for now it's only for iOS
        if (window.hpmcAgent == "ios" && _currentState) {
          setTimeout(function (){ doStateMsg(_currentState)}, 0);
        }
    };

    /**
     * sendEvent() called to notify the testing tool of an event
     * @param {Object} eventMsg – the event message sent by the testing tool
     * @param {Function} eventcallback – a callback which should be called by the mobile framework to indicate success or failure in delivering the event. eventCallback was defined previously under the record/replay section.
     * @returns {undefined}
     */
    this.sendEvent = function(eventMsg, eventCallback) {
        try {
            var eventToSend = stringify(eventMsg);

            communication.sendMessage('JsEvent', eventToSend, null);
        } catch(e) {
            console.error("failed sending message " + eventToSend + " - exception: " + e);
            eventCallback(e);
            return;
        }

        eventCallback();
    };

    function stringify (eventMsg) {

        if(typeof eventMsg != "string") {
            eventMsg = JSON.stringify(eventMsg);
        }

        return eventMsg;
    };

    /**
     * sendWebRequest() is called to send web request to the testing tool.
     * @param isSync
     * @param eventMsg
     * @param eventCallback
     * @param timeout
    */
    this.sendWebRequest = function(isSync, eventMsg, eventCallback, timeout) {
        try {
            // MC currently only supports sync web request without callback
            // The sync web response result will be stored in the localStorage "hpmc_js_sync_response"
            isSync = true;
            eventCallback = null;
            var eventToSend = stringify(eventMsg);
            communication.sendWebRequest(isSync, eventToSend, eventCallback, timeout);
        } catch(e) {
            console.error("failed to send sync web request " + eventToSend + " - exception: " + e);
            if (eventCallback) {
                eventCallback(e);
            }
            return;
        }
    };

    this.onMessage = function(command, message, nativeContext) {
        if(command != undefined) {
            switch(command) {
                case "startRecord":
                case "startReplay":
                case "stopRecord" :
                case "stopReplay" :
                    doStateMsg(command);
                    break;
                case "request" :
                    setTimeout(doRequestMessage.bind(this, message, nativeContext), 0);
                    break;
                case "webViewVisible":
                    if (stateCallbacks[command]) {
                        // in visibility api - 'message' will be boolean, not string: true/false, indicates webView visible/invisible
                        return JSON.stringify(stateCallbacks[command](message));
                    } else {
                        return "";
                    }
                    break;
            }
        }
    };

    this.version = "3.20.00" + "-" + "109";

    /**
     * getWebViewBounds() get the bounds of the webview.
     * @param {Function} external JS callback.
     * @returns {undefined}
     */
    this.getWebViewBounds = function(callback) {
        this.getWebViewBoundsResponse.callbackQueue.push(callback);
        communication.getWebViewBounds();
    };

    this.setStateResponse = function (error){
        var callback = this.setStateResponse.callbackQueue.shift();
        if (callback) {
          callback(error);
        }
    };
    this.setStateResponse.callbackQueue = [];

    this.getStateResponse = function (state, error){
        var callback = this.getStateResponse.callbackQueue.shift();
        if (callback) {
          callback(error, state);
        }
    };
    this.getStateResponse.callbackQueue = [];

    this.getWebViewBoundsResponse = function (bounds, error) {
        var callback = this.getWebViewBoundsResponse.callbackQueue.shift();
        if (callback){
          callback(error, bounds);
        }
    };
    this.getWebViewBoundsResponse.callbackQueue = [];

    this.findElement = function(query, nativeContext) {
        var callBack = queryCallback.bind({ context: nativeContext });
        this.onFindElement(query, callBack);
    };

    this.waitForWebObject = function(message, timeout, nativeContext) {
        var callBack = waitForWebObjectCallback.bind({ context: nativeContext });
        if (this.onWaitForWebObject) {
          console.log("sending message to 'onWaitForWebObject' callback");
          this.onWaitForWebObject(message, timeout, callBack);
        } else {
          console.error("No callback for 'onWaitForWebObject' !");
        }
    };

    this.notifyInjected = function () {
        if (!this.isRefreshing) {
            communication.notifyInjected(location.href);
        } else {
            communication.notifyInjected("");
        }
    };

    /**
     * Converts given logical point value to the device measurement value
     * @param logicalVal logical point value
     * @param screenRatioType screen ratio to use in the conversion, use _hpmcBridge.ScreenRatioType values
     * @returns {number} device measurement value
     */
    this.convertLogicalToDeviceValue = function(logicalVal, screenRatioType) {
        var zoomFactor = communication.getZoomFactor(false),
            screenRatio = screenRatios[screenRatioType] || 1;

        console.log("convertLogicalToDeviceValue - zoomFactor: " + zoomFactor + ", screenRatio: " + screenRatio);

        return Math.round(communication.convertLogicalToDeviceValue(logicalVal) * zoomFactor * screenRatio);
    };

    /**
     * Converts given device measurement value to logical point value
     * @param deviceVal device measurement value
     * @returns {number} logical point value
     */
    this.convertDeviceToLogicalValue = function(deviceVal) {
        var zoomFactor = communication.getZoomFactor(true);

        console.log("convertDeviceToLogicalValue - zoomFactor: " + zoomFactor);

        return Math.round(communication.convertDeviceToLogicalValue(deviceVal) * zoomFactor);
    };

    this.getZoomFactor = function(toDomValues) {
        return communication.getZoomFactor(toDomValues);
    };

    this.setWebViewBounds = function(bounds) {
        communication.setOuterWidth(bounds);
    };

    this.appSpaceToScreenSpaceRatio = function(appToScreenRatioX, appToScreenRatioY) {
        console.log("appSpaceToScreenSpaceRatio set - " + this.ScreenRatioType.X + ": " + appToScreenRatioX +
            ", " + this.ScreenRatioType.Y + ": " + appToScreenRatioY);

        screenRatios[this.ScreenRatioType.X] = appToScreenRatioX;
        screenRatios[this.ScreenRatioType.Y] = appToScreenRatioY;

        return true;
    };

    function doStateMsg(command) {
        if(stateCallbacks.hasOwnProperty(command)) {
            console.log("executing command " + command + " " + stateCallbacks[command]);
            stateCallbacks[command](onEventCallBack);
        }
        // save command - in case connect() hadn't been called yet
        _currentState = command;
    }

    function doRequestMessage(message, nativeContext) {
        if(stateCallbacks["request"]) {
            var callBack = responseCallback.bind({ context: nativeContext });
            stateCallbacks["request"](message, callBack);
        } else {
            console.log("js client did not register for request message");
        }
    }

    function onEventCallBack(error) {
        if(error) {
            console.log("onEventCallBack error");
        } else {
            console.log("onEventCallBack success");
        }
    }

    function onComplete(error) {
        if(error) {
            console.log("on Complete error");
        } else {
            console.log("on complete success");
        }
    }

}();
function NativeCommunication() {

    var webViewWidth,
        getLogger = function () {
            return window._aamWebViewBridge || console;
        };

    this.setOuterWidth = function(bounds) {
        webViewWidth = bounds.right - bounds.left;
    };

    this.getZoomFactor = function (toDomValues) {
        // either the real webViewWidth if available or the factor will return 1 (no zoom)
        var winAvailWidth = webViewWidth || window.innerWidth;

        return toDomValues ? window.innerWidth / winAvailWidth : winAvailWidth / window.innerWidth;
    };

    this.shouldPerformFullClick = function () {
        return true;
    };

    this.convertLogicalToDeviceValue = function(logicalVal) {
        // in iOS device works in logical pixel like the webview, so no conversion is needed
        return logicalVal;
    };

    this.convertDeviceToLogicalValue = function(deviceVal) {
        // in iOS device works in logical pixel like the webview, so no conversion is needed
        return deviceVal;
    };

    this.sendMsg = function (eventRecord) {
        getLogger().log("about to send recorded step: " + JSON.stringify(eventRecord));
        var url = "hpwebviewevent://?hpevent="+encodeURI(JSON.stringify(eventRecord));

        if (window.webkit == undefined){  // UIWebView
            var iframe = document.createElement("iframe");
            iframe.setAttribute("src", url);
            document.documentElement.appendChild(iframe);
            iframe.parentNode.removeChild(iframe);
            iframe = null;
        } else {// for WKWebView
                window.webkit.messageHandlers.hpmc.postMessage(url);
        }
    };

    this.sendQueryResult = function(queryResult) {
        getLogger().log("about to send query result: " + JSON.stringify(queryResult));
        return JSON.stringify(queryResult);
    };

    this.sendQueryResultFromHpmcBridge = function(queryResult, nativeContext) {
        getLogger().log("about to send query result: " + JSON.stringify(queryResult));
        sendMessageToNativeUsingIFrame('findElementResponse', {message: JSON.stringify(queryResult), context: nativeContext});
    };

    this.stepDone = function(result) {
        getLogger().log("about to send step done: " + JSON.stringify(result));
        return result;
    };

    this.getElementStatus = function (response) {
        getLogger().log("about to send element status: " + JSON.stringify(response));
        return response;
    };

    this.notifyInjected = function (urlToReport) {
        getLogger().log("notifyInjected: started");
        getLogger().log("notifyInjected: calling notifyInjected: " + urlToReport);
        sendMessageToNativeUsingIFrame("notifyLoad", {url: urlToReport});
        getLogger().log("notifyInjected: finished");
    };

    var urlFormat = "hpmcwebviewevent://?action=";
    function sendMessageToNativeUsingIFrame(action, params) {

        var url = urlFormat + action;
        if (params) {
            for(var paramName in params) {
                if (params.hasOwnProperty(paramName)) {
                    var paramVal = params[paramName];
                    url += "&" + paramName + "=" + paramVal;
                }
            }
        }
        console.log("url is: " + url);

        if (window.webkit == undefined){  // UIWebView
            var iframe = document.createElement("iframe");
            iframe.setAttribute("src", encodeURI("hpwebviewevent?" + url));
            document.documentElement.appendChild(iframe);
            iframe.parentNode.removeChild(iframe);
            iframe = null;
        } else {  // for WKWebView
            window.webkit.messageHandlers.hpmc.postMessage(url);
        }
    }

    this.sendMessage = function(type, message, nativeContext, sync, timeout) {
        getLogger().log("pass to bridge type " + type + " message " + message + " context " + nativeContext + " with timeout " + timeout);
        sendMessageToNativeUsingIFrame("sendMessage", {type: type, message: message, context: nativeContext, sync: sync, timeout:timeout});

    };

    this.sendWebRequest = function(isSync, eventMsg, eventCallback, timeout) {
        this.sendMessage('JsEvent', eventMsg, null, isSync, timeout);
      	if (eventCallback) {
      	     eventCallback();
      	}
    };

    this.getState = function(){
        sendMessageToNativeUsingIFrame("getState");
    };

    this.setState = function(state){
        sendMessageToNativeUsingIFrame("setState", {state: state});
    };

    this.getWebViewBounds = function () {
        sendMessageToNativeUsingIFrame("getWebViewBounds");
    };
}

window.hpmcAgent = "ios";
!function(){function X2JS(config){"use strict";function initConfigDefaults(){void 0===config.escapeMode&&(config.escapeMode=!0),config.attributePrefix=config.attributePrefix||"_",config.arrayAccessForm=config.arrayAccessForm||"none",config.emptyNodeForm=config.emptyNodeForm||"text",void 0===config.enableToStringFunc&&(config.enableToStringFunc=!0),config.arrayAccessFormPaths=config.arrayAccessFormPaths||[],void 0===config.skipEmptyTextNodesForObj&&(config.skipEmptyTextNodesForObj=!0),void 0===config.stripWhitespaces&&(config.stripWhitespaces=!0),config.datetimeAccessFormPaths=config.datetimeAccessFormPaths||[]}function initRequiredPolyfills(){function pad(number){var r=String(number);return 1===r.length&&(r="0"+r),r}"function"!=typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|^\n+|(\s|\n)+$/g,"")}),"function"!=typeof Date.prototype.toISOString&&(Date.prototype.toISOString=function(){return this.getUTCFullYear()+"-"+pad(this.getUTCMonth()+1)+"-"+pad(this.getUTCDate())+"T"+pad(this.getUTCHours())+":"+pad(this.getUTCMinutes())+":"+pad(this.getUTCSeconds())+"."+String((this.getUTCMilliseconds()/1e3).toFixed(3)).slice(2,5)+"Z"})}function getNodeLocalName(node){var nodeLocalName=node.localName;return null==nodeLocalName&&(nodeLocalName=node.baseName),null!=nodeLocalName&&""!=nodeLocalName||(nodeLocalName=node.nodeName),nodeLocalName}function getNodePrefix(node){return node.prefix}function escapeXmlChars(str){return"string"==typeof str?str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\//g,"&#x2F;"):str}function unescapeXmlChars(str){return str.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#x27;/g,"'").replace(/&#x2F;/g,"/")}function toArrayAccessForm(obj,childName,path){switch(config.arrayAccessForm){case"property":obj[childName]instanceof Array?obj[childName+"_asArray"]=obj[childName]:obj[childName+"_asArray"]=[obj[childName]]}if(!(obj[childName]instanceof Array)&&config.arrayAccessFormPaths.length>0){for(var idx=0;idx<config.arrayAccessFormPaths.length;idx++){var arrayPath=config.arrayAccessFormPaths[idx];if("string"==typeof arrayPath){if(arrayPath==path)break}else if(arrayPath instanceof RegExp){if(arrayPath.test(path))break}else if("function"==typeof arrayPath&&arrayPath(obj,childName,path))break}idx!=config.arrayAccessFormPaths.length&&(obj[childName]=[obj[childName]])}}function fromXmlDateTime(prop){var bits=prop.split(/[-T:+Z]/g),d=new Date(bits[0],bits[1]-1,bits[2]),secondBits=bits[5].split(".");if(d.setHours(bits[3],bits[4],secondBits[0]),secondBits.length>1&&d.setMilliseconds(secondBits[1]),bits[6]&&bits[7]){var offsetMinutes=60*bits[6]+Number(bits[7]);offsetMinutes=0+("-"==(/\d\d-\d\d:\d\d$/.test(prop)?"-":"+")?-1*offsetMinutes:offsetMinutes),d.setMinutes(d.getMinutes()-offsetMinutes-d.getTimezoneOffset())}else-1!==prop.indexOf("Z",prop.length-1)&&(d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes(),d.getSeconds(),d.getMilliseconds())));return d}function checkFromXmlDateTimePaths(value,childName,fullPath){if(config.datetimeAccessFormPaths.length>0){for(var path=fullPath.split(".#")[0],idx=0;idx<config.datetimeAccessFormPaths.length;idx++){var dtPath=config.datetimeAccessFormPaths[idx];if("string"==typeof dtPath){if(dtPath==path)break}else if(dtPath instanceof RegExp){if(dtPath.test(path))break}else if("function"==typeof dtPath&&dtPath(obj,childName,path))break}return idx!=config.datetimeAccessFormPaths.length?fromXmlDateTime(value):value}return value}function parseDOMChildren(node,path){if(node.nodeType==DOMNodeTypes.DOCUMENT_NODE){for(var result=new Object,nodeChildren=node.childNodes,cidx=0;cidx<nodeChildren.length;cidx++){var child=nodeChildren.item(cidx);if(child.nodeType==DOMNodeTypes.ELEMENT_NODE){var childName=getNodeLocalName(child);result[childName]=parseDOMChildren(child,childName)}}return result}if(node.nodeType==DOMNodeTypes.ELEMENT_NODE){var result=new Object;result.__cnt=0;for(var nodeChildren=node.childNodes,cidx=0;cidx<nodeChildren.length;cidx++){var child=nodeChildren.item(cidx),childName=getNodeLocalName(child);child.nodeType!=DOMNodeTypes.COMMENT_NODE&&(result.__cnt++,null==result[childName]?(result[childName]=parseDOMChildren(child,path+"."+childName),toArrayAccessForm(result,childName,path+"."+childName)):(null!=result[childName]&&(result[childName]instanceof Array||(result[childName]=[result[childName]],toArrayAccessForm(result,childName,path+"."+childName))),result[childName][result[childName].length]=parseDOMChildren(child,path+"."+childName)))}for(var aidx=0;aidx<node.attributes.length;aidx++){var attr=node.attributes.item(aidx);result.__cnt++,result[config.attributePrefix+attr.name]=attr.value}var nodePrefix=getNodePrefix(node);return null!=nodePrefix&&""!=nodePrefix&&(result.__cnt++,result.__prefix=nodePrefix),null!=result["#text"]&&(result.__text=result["#text"],result.__text instanceof Array&&(result.__text=result.__text.join("\n")),config.escapeMode&&(result.__text=unescapeXmlChars(result.__text)),config.stripWhitespaces&&(result.__text=result.__text.trim()),delete result["#text"],"property"==config.arrayAccessForm&&delete result["#text_asArray"],result.__text=checkFromXmlDateTimePaths(result.__text,childName,path+"."+childName)),null!=result["#cdata-section"]&&(result.__cdata=result["#cdata-section"],delete result["#cdata-section"],"property"==config.arrayAccessForm&&delete result["#cdata-section_asArray"]),1==result.__cnt&&null!=result.__text?result=result.__text:0==result.__cnt&&"text"==config.emptyNodeForm?result="":result.__cnt>1&&null!=result.__text&&config.skipEmptyTextNodesForObj&&(config.stripWhitespaces&&""==result.__text||""==result.__text.trim())&&delete result.__text,delete result.__cnt,!config.enableToStringFunc||null==result.__text&&null==result.__cdata||(result.toString=function(){return(null!=this.__text?this.__text:"")+(null!=this.__cdata?this.__cdata:"")}),result}if(node.nodeType==DOMNodeTypes.TEXT_NODE||node.nodeType==DOMNodeTypes.CDATA_SECTION_NODE)return node.nodeValue}function startTag(jsonObj,element,attrList,closed){var resultStr="<"+(null!=jsonObj&&null!=jsonObj.__prefix?jsonObj.__prefix+":":"")+element;if(null!=attrList)for(var aidx=0;aidx<attrList.length;aidx++){var attrName=attrList[aidx],attrVal=jsonObj[attrName];config.escapeMode&&(attrVal=escapeXmlChars(attrVal)),resultStr+=" "+attrName.substr(config.attributePrefix.length)+"='"+attrVal+"'"}return resultStr+=closed?"/>":">"}function endTag(jsonObj,elementName){return"</"+(null!=jsonObj.__prefix?jsonObj.__prefix+":":"")+elementName+">"}function endsWith(str,suffix){return-1!==str.indexOf(suffix,str.length-suffix.length)}function jsonXmlSpecialElem(jsonObj,jsonObjField){return!!("property"==config.arrayAccessForm&&endsWith(jsonObjField.toString(),"_asArray")||0==jsonObjField.toString().indexOf(config.attributePrefix)||0==jsonObjField.toString().indexOf("__")||jsonObj[jsonObjField]instanceof Function)}function jsonXmlElemCount(jsonObj){var elementsCnt=0;if(jsonObj instanceof Object)for(var it in jsonObj)jsonXmlSpecialElem(jsonObj,it)||elementsCnt++;return elementsCnt}function parseJSONAttributes(jsonObj){var attrList=[];if(jsonObj instanceof Object)for(var ait in jsonObj)-1==ait.toString().indexOf("__")&&0==ait.toString().indexOf(config.attributePrefix)&&attrList.push(ait);return attrList}function parseJSONTextAttrs(jsonTxtObj){var result="";return null!=jsonTxtObj.__cdata&&(result+="<![CDATA["+jsonTxtObj.__cdata+"]]>"),null!=jsonTxtObj.__text&&(config.escapeMode?result+=escapeXmlChars(jsonTxtObj.__text):result+=jsonTxtObj.__text),result}function parseJSONTextObject(jsonTxtObj){var result="";return jsonTxtObj instanceof Object?result+=parseJSONTextAttrs(jsonTxtObj):null!=jsonTxtObj&&(config.escapeMode?result+=escapeXmlChars(jsonTxtObj):result+=jsonTxtObj),result}function parseJSONArray(jsonArrRoot,jsonArrObj,attrList){var result="";if(0==jsonArrRoot.length)result+=startTag(jsonArrRoot,jsonArrObj,attrList,!0);else for(var arIdx=0;arIdx<jsonArrRoot.length;arIdx++)result+=startTag(jsonArrRoot[arIdx],jsonArrObj,parseJSONAttributes(jsonArrRoot[arIdx]),!1),result+=parseJSONObject(jsonArrRoot[arIdx]),result+=endTag(jsonArrRoot[arIdx],jsonArrObj);return result}function parseJSONObject(jsonObj){var result="";if(jsonXmlElemCount(jsonObj)>0)for(var it in jsonObj)if(!jsonXmlSpecialElem(jsonObj,it)){var subObj=jsonObj[it],attrList=parseJSONAttributes(subObj);if(null==subObj||void 0==subObj)result+=startTag(subObj,it,attrList,!0);else if(subObj instanceof Object)if(subObj instanceof Array)result+=parseJSONArray(subObj,it,attrList);else if(subObj instanceof Date)result+=startTag(subObj,it,attrList,!1),result+=subObj.toISOString(),result+=endTag(subObj,it);else{var subObjElementsCnt=jsonXmlElemCount(subObj);subObjElementsCnt>0||null!=subObj.__text||null!=subObj.__cdata?(result+=startTag(subObj,it,attrList,!1),result+=parseJSONObject(subObj),result+=endTag(subObj,it)):result+=startTag(subObj,it,attrList,!0)}else result+=startTag(subObj,it,attrList,!1),result+=parseJSONTextObject(subObj),result+=endTag(subObj,it)}return result+=parseJSONTextObject(jsonObj)}var VERSION="1.1.5";config=config||{},initConfigDefaults(),initRequiredPolyfills();var DOMNodeTypes={ELEMENT_NODE:1,TEXT_NODE:3,CDATA_SECTION_NODE:4,COMMENT_NODE:8,DOCUMENT_NODE:9};this.parseXmlString=function(xmlDocStr){var isIEParser=window.ActiveXObject||"ActiveXObject"in window;if(void 0===xmlDocStr)return null;var xmlDoc;if(window.DOMParser){var parser=new window.DOMParser,parsererrorNS=null;if(!isIEParser)try{parsererrorNS=parser.parseFromString("INVALID","text/xml").childNodes[0].namespaceURI}catch(err){parsererrorNS=null}try{xmlDoc=parser.parseFromString(xmlDocStr,"text/xml"),null!=parsererrorNS&&xmlDoc.getElementsByTagNameNS(parsererrorNS,"parsererror").length>0&&(xmlDoc=null)}catch(err){xmlDoc=null}}else 0==xmlDocStr.indexOf("<?")&&(xmlDocStr=xmlDocStr.substr(xmlDocStr.indexOf("?>")+2)),xmlDoc=new ActiveXObject("Microsoft.XMLDOM"),xmlDoc.async="false",xmlDoc.loadXML(xmlDocStr);return xmlDoc},this.asArray=function(prop){return prop instanceof Array?prop:[prop]},this.toXmlDateTime=function(dt){return dt instanceof Date?dt.toISOString():"number"==typeof dt?new Date(dt).toISOString():null},this.asDateTime=function(prop){return"string"==typeof prop?fromXmlDateTime(prop):prop},this.xml2json=function(xmlDoc){return parseDOMChildren(xmlDoc)},this.xml_str2json=function(xmlDocStr){var xmlDoc=this.parseXmlString(xmlDocStr);return null!=xmlDoc?this.xml2json(xmlDoc):null},this.json2xml_str=function(jsonObj){return parseJSONObject(jsonObj)},this.json2xml=function(jsonObj){var xmlDocStr=this.json2xml_str(jsonObj);return this.parseXmlString(xmlDocStr)},this.getVersion=function(){return VERSION}}function LocalStroageAppender(){}function WebSocketAppender(){this._buffer=[],this.enabled=!0,this.logWebSocket=null}function LazyFormatLayout(){this.JSONspaces=0}function LoggerUtil(catName){var log;try{log=log4javascript.getLogger(catName);var catLogLevel=LoggerUtilSettings.getCategoryLogLevel(catName);catLogLevel&&log.setLevel(log4javascript.Level[catLogLevel]),log.prettyTrace=function(){lazyFormatLayout.JSONspaces=2,log.log(log4javascript.Level.TRACE,arguments),lazyFormatLayout.JSONspaces=0},log.prettyDebug=function(){lazyFormatLayout.JSONspaces=2,log.log(log4javascript.Level.DEBUG,arguments),lazyFormatLayout.JSONspaces=0},log.addAppender(BrowserAppender),WebSocketAppenderInstance.enabled&&log.addAppender(WebSocketAppenderInstance)}catch(e){Util.safeConsoleError("QTP Agent: Got Exception "+e+"\nStack:"+e.stack)}return log}function Msg(type,to,data,tab){this._msgType=type,this._to=to||{},this._tab=tab,this._data=data}function mergeMessages(tgtMsg,srcMsg,valNameMapping,logger){function mergeStatus(tgtMsg,srcMsg,logger){if(srcMsg.status)return tgtMsg.status&&"OK"!==tgtMsg.status?void(logger&&"OK"!==srcMsg.status&&logger.warn("mergeMessages: Trying to merge copy two error statuses: "+srcMsg.status+" into "+tgtMsg.status)):void(tgtMsg.status=srcMsg.status)}valNameMapping=valNameMapping||{},tgtMsg._data=tgtMsg._data||{};for(var key in srcMsg._data)tgtMsg._data[valNameMapping[key]||key]=srcMsg._data[key];for(var p in valNameMapping)p!==valNameMapping[p]&&(tgtMsg._data[p]=tgtMsg._data[valNameMapping[p]]);return mergeStatus(tgtMsg,srcMsg,logger),tgtMsg}function MultipleResponses(responsesToWaitFor){if(this._logger=new LoggerUtil("Common.MultipleResponses"),this._logger.info("Common.MultipleResponses"),responsesToWaitFor<1)return void this._logger.debug("MultipleResponses: received invalid numOfResponses="+responsesToWaitFor);this._numOfResponses=responsesToWaitFor}function WebIdContainer(){this._logger=new LoggerUtil("Common.WebIdContainer"),this._logger.info("WebIdContainer was created"),this._container=[]}function AsyncCommunicationHelper(options){this._logger=new LoggerUtil("Common.AsyncCommunicationHelper"),this._initializeOptions(options),this._logger.info("c'tor: Created with the following options:",this._options),this._listeners={},this._pendingAckForAsynMsgs=[],this._timerID=-1}function EventDispatcher(logger){this._logger=logger||new LoggerUtil("Common.EventDispatcher"),this._listeners={}}function MessageChannelComChannel(context,disableAsyncHelper){if("undefined"==typeof MessageChannel)return new PostMessageComChannel(context);switch(context){case"extension":this._logger=new LoggerUtil("ComChannels.MessageChannelComChannel.Extension"),this._mode="extension",this.id=-1,MessageChannelComChannel.prototype._ext=this;break;case"content":this._logger=new LoggerUtil("ComChannels.MessageChannelComChannel.Content"),this._mode="content",this.id=Math.random(),MessageChannelComChannel.prototype._content=this;break;default:throw new Error("MessageChannelComChannel initialized with an Unknown Context")}this._logger.info("Ctor: Created id:"+this.id),this._listeners={},disableAsyncHelper||(this._asyncHelper=new AsyncCommunicationHelper,this._asyncHelper.addListener("MessageTimedOut",this))}function PostMessageComChannel(context){switch(context){case"extension":this._logger=new LoggerUtil("ComChannels.PostMessageComChannel.Extension"),this._mode="extension",this.id=-1,PostMessageComChannel.prototype._ext=this;break;case"content":this._logger=new LoggerUtil("ComChannels.PostMessageComChannel.Content"),this._mode="content",this.id=Math.random(),PostMessageComChannel.prototype._content=this;break;default:throw new Error("PostMessageComChannel initialized with an Unknown Context")}this._logger.info("Ctor: Created id:"+this.id),this._listeners={},this._asyncHelper=new AsyncCommunicationHelper,this._asyncHelper.addListener("MessageTimedOut",this)}function RemoteComChannelStrategy(){}function MobileCenterComChannelStrategy(){}function WebSocketComChannel(){this._logger=new LoggerUtil("ComChannels.WebSocketComChannel"),this._connection=null,this._listeners=[],this._waitingMessages=[],this._timerId=-1,this._serverUrl=null,Util.isNullOrUndefined(WebSocketComChannel.prototype.WEBSOCKET_OBJECT_NAME)&&(this._logger.error("WebSocketComChannel: browser does not support WebSocket"),ErrorReporter.ThrowGeneralError()),this._logger.trace("WebSocketComChannel: ctor completed")}function ExternalComChannel(strategy){this._logger=new LoggerUtil("ComChannels.ExternalComChannel"),this._listeners=[],this._applyStrategy(strategy),this._innerChannel=this._createInnerChannel()}function MobileCenterComChannel(){EventDispatcher.call(this,new LoggerUtil("ComChannels.MobileCenterComChannel")),this._mobileCenter=window._hpmcBridge,this._responseCallbacks={},this._mobileBrowserId=1e3,this.init(),Util.assert(null!=this._mobileCenter,"C'tor: MobileCenterComChannel is undefined",this._logger),Object.defineProperty(this,"id",{value:"MobileCenterComChannel",writable:!1}),this._logger.trace("MobileCenterComChannel: ctor completed")}function EmbeddedBrowserAPI(){this._logger=new LoggerUtil("EmbeddedBrowserAPI"),this._logger.trace("EmbeddedBrowserAPI started."),this._clientTabId=webViewId}function EmbeddedBrowserTab(tab){this._logger=new LoggerUtil("EmbeddedBrowserTab"),this._logger.trace("EmbeddedBrowserTab created."),this.id=tab.id,this.windowId=tab.windowId}function MobileCenterBrowserAPI(){this._logger=new LoggerUtil("MobileCenterAPI"),this._logger.trace("MobileCenterAPI started."),this._clientTabId=webViewId}function MobileCenterBrowserTab(tab){this._logger=new LoggerUtil("MobileCenterBrowserTab"),this._logger.trace("MobileCenterBrowserTab created."),this.id=tab.id,this.windowId=tab.windowId}function Browser(tab){this._logger=new LoggerUtil("Ext.Browser"),this._logger.info("Browser was created for tab "+tab.id),this._associatedTab=tab,this._creationTime=new Date,this._recordTransactionQueue=[],Object.defineProperty(this,"id",{value:this.getID(),writable:!1}),ext.dispatcher.addListener("Message",this),ext.dispatcher.addListener("clientRegistered",this)}function FrameTree(page){this._logger=new LoggerUtil("Ext.FrameTree"),this.page=page}function Page(associatedTab,browserRtId){this._logger=new LoggerUtil("Ext.Page"),this._logger.info("Page created"),this._tab=associatedTab,this._frames=new FrameTree(this),this._browserId=browserRtId,this._extToolkits=[],this._frameCreationCount=ext.app.initialFrameCounter||-1,Object.defineProperty(this,"id",{value:this.getID(),writable:!1}),ext.dispatcher.addListener("Message",this),ext.dispatcher.addListener("clientRegistered",this),ext.dispatcher.addListener("clientUnRegistered",this)}function BrowserRecorder(knownTabs){this._logger=new LoggerUtil("Ext.BrowserRecorder"),this._logger.info("BrowserRecorder was initiated"),this._knownTabs=knownTabs,this._tabsReplacedMap={},this._eventData={},this._destroyedTabs=[],this._lastRemoveInfo=null}function Agent(){this._logger=new LoggerUtil("Ext.Agent"),this._logger.info("Agent was initiated"),this._inspectionMode=null,ext.dispatcher.addListener("clientRegistered",this),this._registerAppEvent("onTabCreated",this._onTabCreated.bind(this)),this._registerAppEvent("onTabClosed",this._onTabClosed.bind(this)),this._registerAppEvent("onAddressBarNavigation",this._onAddressBarNavigation.bind(this)),this._registerAppEvent("onTabReplaced",this._onTabReplaced.bind(this)),this._registerAppEvent("onUserOpenedNewTab",this._onUserOpenedNewTab.bind(this)),this._registerAppEvent("onReload",this._onReload.bind(this)),this._registerAppEvent("onBack",this._onBack.bind(this)),this._registerAppEvent("onForward",this._onForward.bind(this)),this._registerAppEvent("onUserClosedTab",this._onUserClosedTab.bind(this)),this._registerAppEvent("onSpySuspended",this._onSpySuspended.bind(this)),this._registerAppEvent("onSpyResumed",this._onSpyResumed.bind(this)),Util.assert(typeof ext.app.onSpySuspended==typeof ext.app.onSpyResumed,"Both onSpySuspend && onSpyResumed should exist or not exist. But never a case where only one of them exists.",this._logger)}function ExtDispatcher(){this._logger=new LoggerUtil("Ext.Dispatcher"),this._logger.info("ExtDispatcher was created"),this.isConnectPerformed=!1,this._listeners={},this._responseCallbacks={},this._setExternalComChannel(),this._inboundChromeCOM=ext.app.createComChannel(),this._inboundChromeCOM.init(),this._inboundChromeCOM.addListener("event",this.onEvent.bind(this)),this._inboundChromeCOM.addListener("message",this.onAsyncMessage.bind(this)),this._inboundChromeCOM.addListener("response",this.onResponseMessage.bind(this)),this._inboundChromeCOM.addListener("clientConnected",this.onClientConnect.bind(this)),this._inboundChromeCOM.addListener("clientDisconnected",this.onClientDisconnect.bind(this)),this._inboundChromeCOM.addListener("MessageTimedOut",this.onRequestTimedout.bind(this))}function GestureDetector(){this._logger=new LoggerUtil("Content.GestureDetector"),this._detectors=[this.SwipePanDetector,this.TapDetector,this.PinchDetector].map(function(detector){return new detector(this)},this);var handler=this._addEvent.bind(this);["touchstart","touchmove","touchend","touchcancel"].forEach(function(name){window.addEventListener(name,handler,!0)},this),document.addEventListener("touchstart",Util.identity,!0),this._listeners=[],this._logger.trace("GestureDetector created")}function SimulateGesture(){this._logger=new LoggerUtil("Content.SimulateGesture"),this._touches=[]}function Recorder(frame){function AddEventListners(){this.recordingEvents.forEach(function(e){window.addEventListener(e,handler,!0)}),this.recordingEventsOnDocument=["mouseenter"],this.recordingEventsOnDocument.forEach(function(e){document.addEventListener(e,handler,!0)}),["beforeunload","hashchange"].forEach(function(eventName){window.addEventListener(eventName,this.sendBrowserRecordInfo.bind(this))},this)}this._logger=new LoggerUtil("Content.Recorder"),this._logger.info("Recorder was created"),this.frame=frame,(new GestureDetector).addListener(this._recordGesture.bind(this)),this.recordingEvents=["click","input","change","focus","blur","keydown","keyup","submit","mouseup","mouseover","mouseout","dragstart","drop","dragend","contextmenu","play","pause","mousedown","dblclick","keypress","textInput","select","reset"];var handler=this._handlerFunc.bind(this);this.frame.isPage?AddEventListners.apply(this):window.setTimeout(AddEventListners.bind(this))}function FrameCommunicationChannel(){this._logger=new LoggerUtil("ComChannel.FrameCommunicationChannel"),this._logger.info(" created"),this._listeners={}}function ContentDispatcher(){this._logger=new LoggerUtil("Content.Dispatcher"),this._logger.info("ctor: created with registration data"),this._listeners={},this._responseCallbacks={},this._chromeChannel=BrowserServices.createComChannel(this._logger),this._chromeChannel.addListener("event",this.onEvent.bind(this)),this._chromeChannel.addListener("message",this.onMessage.bind(this)),this._chromeChannel.addListener("MessageTimedOut",this.onMessageTimedOut.bind(this)),this._chromeChannel.addListener("response",this.onResponseMessage.bind(this)),this._chromeChannel.addListener("connected",this.onComChannelConnected.bind(this)),this._chromeChannel.addListener("connectError",this.onComChannelConnectionFailed.bind(this)),this._frameComChannel=new FrameCommunicationChannel,this._frameComChannel.addListener("event",this.onEvent.bind(this)),this._frameComChannel.addListener("message",this.onMessage.bind(this)),this._frameComChannel.addListener("response",this.onResponseMessage.bind(this)),this._frameComChannel.addListener("connected",this.onFrameCOMChannelConnected.bind(this))}function DotObjJSProxy(obj,parentId){this._logger=new LoggerUtil("Content.DotObjJSProxy"),this._obj=obj,this._id=Util.shallowObjectClone(parentId),this._id.object=content.rtidManager.GetIDForElement(this),window.addEventListener("_DOT_OBJ_RESULT",this.ResultMsgHandler.bind(this))}function DomRequestSubscriber(){this.handlers="",this._htmlLogger=HTMLLogger}function BrowserContentHelper(frameAo){this._logger=new LoggerUtil("Content.BrowserContentHelper"),this._frameAo=frameAo}function ElementInspector(frameId){this._init(frameId)}function Frame(){this._logger=new LoggerUtil("Content.Frame"),this._logger.info("Frame was created"),this._isPage=window===window.parent,this._recorder=new Recorder(this),window.addEventListener("message",this.responseFromHTMLHandler.bind(this),!1),window.addEventListener("_QTP_RUN_SCRIPT_RESULT",this._runOnDocResult.bind(this)),window.addEventListener("DialogHandled",this._recordDialogHandled.bind(this),!1)}function KitsManager(){this._logger.trace("Created instance")}function ObjectRTIDManager(){this._logger=new LoggerUtil("Content.ObjectRTIDManager"),content.dispatcher.addListener("RegistrationResult",this)}function AO(element,parentID){this._elem=element,this._id=null,this._attrs={micclass:function(){return this._micclass}},this._methods={},this._behaviors=[],this._micclass=[],this._parentID=Util.shallowObjectClone(parentID),this._logger=WebKit._logger,this._logger.trace(function(){return"AO: new ao created for element "+element.tagName})}function WebExtKit(toolkits){this._logger=new LoggerUtil("Content.WebExtKit"),this._toolkitManager=new ToolkitManager,this._tagElements=[],this._skipTypes=[],this.loadToolkits(toolkits)}function ToolkitManager(){this._logger=new LoggerUtil("WebExt.ToolkitManager"),this._toolkits=[]}function Toolkit(kitInfo,index){this._logger=new LoggerUtil("WebExt.Toolkit"),this.toolkitindex=index,this.toolkitName=kitInfo.name.toUpperCase(),this.priority=kitInfo.description.Controls._priority||this.CONST_PRIORITY_ATTR_DEF_VALUE,this.scriptEnv=this._setScriptingEnviroment(),this.jsFunctionsManager=new JSFunctionsManager(kitInfo.jsFunctions,kitInfo.jsScripts),this._settings=[],Util.isNullOrUndefined(kitInfo.description.Controls.Settings)||(this._settings=this._settings.concat(kitInfo.description.Controls.Settings.Variable)),this._commonIdentificationInfo=kitInfo.description.Controls.CommonIdentification||null,this._commonIdentificationFunctionHandler=this.CONST_UNINITIALIZE,this._toolkitStatusNode=kitInfo.description.Controls.ToolkitStateQuery||null,this._toolkitStatusFunctionHandler=this.CONST_UNINITIALIZE,this._controlByMicClass=Object.create(null),this._controls=this._initControlList(kitInfo.description.Controls.Control),this._controlListByTags=null}function JSFunctionsManager(jsFunctionFileNames,jsFunctionsScripts){this._jsFunctionFileNames=jsFunctionFileNames,this._jsFunctionScripts=jsFunctionsScripts}function Control(controlInfo,index,toolkit){this._logger=new LoggerUtil("WebExt.Control"),this.controlIndex=index,this.controlType=controlInfo._TestObjectClass,this._toolkit=toolkit,this._controlInfo=controlInfo,this._identificationConditions=null,this._methodList=this._initMethodList(controlInfo),this._settings=[],Util.isNullOrUndefined(controlInfo.Settings)||Util.isNullOrUndefined(controlInfo.Settings.Variable)||(this._settings=this._settings.concat(controlInfo.Settings.Variable)),this._identificationHanlder=this.CONST_UNINITIALIZE,this._propertyHandler=this.CONST_UNINITIALIZE,this._innerElementHandler=this.CONST_UNINITIALIZE,this._listenToEventsHandler=this.CONST_UNINITIALIZE,this._learnFilterHandler=this.CONST_UNINITIALIZE,this._learnControl=this._getControlLearnType(),this._learnChildren=this._getChildrenLearnType()}function ConditionsExpress(conditionInfo){this._logger=new LoggerUtil("WebExt.Control.ConditionsExpress"),this._conditions=[],this._init(conditionInfo)}function Condition(conditionInfo){this._logger=new LoggerUtil("WebExt.Control.Conditions"),this._propName="",this._trimExpectedValue=!0,this._expectedValue="",this._isRegExp=!1,this._isNegative=!1,this._init(conditionInfo)}function WebExtAO(element,control,parentID){AO.call(this,element,parentID),this._logger=new LoggerUtil("WebExtAO"),this._control=control,this._innerAO=this._initInternalElement(element),this._baseAO=this._initBaseAO(element),this._excludeAttrs=[],this.mergeBehavior(WebExtAOBehavior),this._initMicClass(),this._sendingReport=!1,this._replayReport=null}function SectionHandlersFactory(){}function SectionHandlerBase(){this._sectionInfo=null,this._control=null,this._toolkit=null,this._valid=!1}function JScriptSectionHandler(){SectionHandlerBase.call(this),this._jsFileName="",this._function="",this._toolkitCommonFileName="",this._qtpCommonFileName="common.js",this._functionWrapperClassName="",this._functionWrapper=null}function FunctionWrapper(functionName,functionBody){this._functionName=functionName,this._functionBody=functionBody}function BoolSectionHandler(){SectionHandlerBase.call(this),this._value=!1}function QTPUtil(){}function ScriptWrapper(){this.key="#KEYPLACEHOLDER";var _elem=null,_QTPUtil=_uftext._QTPUtil;
//#USERSCRIPTSPLACEHOLDER
this._methods={},
//#METHODSPLACEHOLDER
(_elem||_QTPUtil)&&(this.dummy="dummy"),_uftext.PageAgent.registerScriptWrapper(this.key,this),this.invoke=function(elem,methodName,args,aoId){_elem=elem,this._elem=elem,this._aoId=aoId;var result,pageAgent=_uftext.PageAgent;pageAgent._activeScriptWrapper=this;var m=this._methods[methodName];try{if("function"!=typeof m)throw{message:methodName+" is not a function"};if(window[methodName]===m)throw{message:methodName+" is a window function"}}catch(e){return{status:pageAgent.INVOKE_STATUS_FAIL,data:{type:pageAgent.INVOKE_ERROR_METHOD_NOT_FOUND,error:e.message}}}if(null!==m&&void 0!==m)try{var ret=m.apply(null,args);result={status:pageAgent.INVOKE_STATUS_PASS,data:pageAgent.wrap(ret)}}catch(e){pageAgent._logger.error("error in executing code, e="+e),result={status:pageAgent.INVOKE_STATUS_FAIL,data:{type:pageAgent.INOVKE_ERROR_GENERAL,error:e.message}}}return result}}if(window._QTP||(window._QTP={}),!window._QTP.version){if(window._QTP.version="12.54.4806.5.r",console.log("<<<<<< UFT Mobile Agent Version "+window._QTP.version+" ("+(new Date).toLocaleString()+") >>>>>>"),"undefined"==typeof window&&"function"==typeof require&&"object"==typeof require("sdk/window/utils")){var WindowUtils=require("sdk/window/utils"),NSIDomWindow=WindowUtils.getMostRecentBrowserWindow(),xulWindow=WindowUtils.getXULWindow(NSIDomWindow);window=WindowUtils.getDOMWindow(xulWindow)}!window||null!==window.console&&void 0!==window.console||"undefined"==typeof console||(window.console=console),Array.prototype.push||(Array.prototype.push=function(){for(var i=0,len=arguments.length;i<len;i++)this[this.length]=arguments[i];return this.length}),Array.prototype.shift||(Array.prototype.shift=function(){if(this.length>0){for(var firstItem=this[0],i=0,len=this.length-1;i<len;i++)this[i]=this[i+1];return this.length=this.length-1,firstItem}}),Array.prototype.splice||(Array.prototype.splice=function(startIndex,deleteCount){var itemsAfterDeleted=this.slice(startIndex+deleteCount),itemsDeleted=this.slice(startIndex,startIndex+deleteCount);this.length=startIndex;for(var argumentsArray=[],i=0,len=arguments.length;i<len;i++)argumentsArray[i]=arguments[i];var itemsToAppend=argumentsArray.length>2?itemsAfterDeleted=argumentsArray.slice(2).concat(itemsAfterDeleted):itemsAfterDeleted;for(i=0,len=itemsToAppend.length;i<len;i++)this.push(itemsToAppend[i]);return itemsDeleted});var log4javascript;if(function(){function isUndefined(obj){return void 0===obj}function EventSupport(){}function Log4JavaScript(){}function toStr(obj){return obj&&obj.toString?obj.toString():String(obj)}function getExceptionMessage(ex){return ex.message?ex.message:ex.description?ex.description:toStr(ex)}function getUrlFileName(url){var lastSlashIndex=Math.max(url.lastIndexOf("/"),url.lastIndexOf("\\"));return url.substr(lastSlashIndex+1)}function getExceptionStringRep(ex){if(ex){var exStr="Exception: "+getExceptionMessage(ex);try{ex.lineNumber&&(exStr+=" on line number "+ex.lineNumber),ex.fileName&&(exStr+=" in file "+getUrlFileName(ex.fileName))}catch(localEx){logLog.warn("Unable to obtain file and line information for error")}return showStackTraces&&ex.stack&&(exStr+=newLine+"Stack trace:"+newLine+ex.stack),exStr}return null}function bool(obj){return Boolean(obj)}function splitIntoLines(text){return text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n")}function urlEncode(str){return escape(str).replace(/\+/g,"%2B").replace(/"/g,"%22").replace(/'/g,"%27").replace(/\//g,"%2F").replace(/=/g,"%3D")}function array_remove(arr,val){for(var index=-1,i=0,len=arr.length;i<len;i++)if(arr[i]===val){index=i;break}return index>=0&&(arr.splice(index,1),!0)}function array_contains(arr,val){for(var i=0,len=arr.length;i<len;i++)if(arr[i]==val)return!0;return!1}function extractBooleanFromParam(param,defaultValue){return isUndefined(param)?defaultValue:bool(param)}function extractStringFromParam(param,defaultValue){return isUndefined(param)?defaultValue:String(param)}function extractIntFromParam(param,defaultValue){if(isUndefined(param))return defaultValue;try{var value=parseInt(param,10);return isNaN(value)?defaultValue:value}catch(ex){return logLog.warn("Invalid int param "+param,ex),defaultValue}}function extractFunctionFromParam(param,defaultValue){return"function"==typeof param?param:defaultValue}function isError(err){return err instanceof Error}function getListenersPropertyName(eventName){return"__log4javascript_listeners__"+eventName}function addEvent(node,eventName,listener,useCapture,win){if(win=win||window,node.addEventListener)node.addEventListener(eventName,listener,useCapture);else if(node.attachEvent)node.attachEvent("on"+eventName,listener);else{var propertyName=getListenersPropertyName(eventName);node[propertyName]||(node[propertyName]=[],node["on"+eventName]=function(evt){evt=getEvent(evt,win);for(var currentListener,listenersPropertyName=getListenersPropertyName(eventName),listeners=this[listenersPropertyName].concat([]);currentListener=listeners.shift();)currentListener.call(this,evt)}),node[propertyName].push(listener)}}function getEvent(evt,win){return win=win||window,evt||win.event}function handleError(message,exception){logLog.error(message,exception),log4javascript.dispatchEvent("error",{message:message,exception:exception})}function Timer(name,level){this.name=name,this.level=isUndefined(level)?Level.INFO:level,this.start=new Date}function Logger(name){this.name=name,this.parent=null,this.children=[];var appenders=[],loggerLevel=null,isRoot=this.name===rootLoggerName,isNull=this.name===nullLoggerName,appenderCache=null,appenderCacheInvalidated=!1;this.addChild=function(childLogger){this.children.push(childLogger),childLogger.parent=this,childLogger.invalidateAppenderCache()};var additive=!0;this.getAdditivity=function(){return additive},this.setAdditivity=function(additivity){var valueChanged=additive!=additivity;additive=additivity,valueChanged&&this.invalidateAppenderCache()},this.addAppender=function(appender){isNull?handleError("Logger.addAppender: you may not add an appender to the null logger"):appender instanceof log4javascript.Appender?array_contains(appenders,appender)||(appenders.push(appender),appender.setAddedToLogger(this),this.invalidateAppenderCache()):handleError("Logger.addAppender: appender supplied ('"+toStr(appender)+"') is not a subclass of Appender")},this.removeAppender=function(appender){array_remove(appenders,appender),appender.setRemovedFromLogger(this),this.invalidateAppenderCache()},this.removeAllAppenders=function(){var appenderCount=appenders.length;if(appenderCount>0){for(var i=0;i<appenderCount;i++)appenders[i].setRemovedFromLogger(this);appenders.length=0,this.invalidateAppenderCache()}},this.getEffectiveAppenders=function(){if(null===appenderCache||appenderCacheInvalidated){var parentEffectiveAppenders=isRoot||!this.getAdditivity()?[]:this.parent.getEffectiveAppenders();appenderCache=parentEffectiveAppenders.concat(appenders),appenderCacheInvalidated=!1}return appenderCache},this.invalidateAppenderCache=function(){appenderCacheInvalidated=!0;for(var i=0,len=this.children.length;i<len;i++)this.children[i].invalidateAppenderCache()},this.log=function(level,params){if(level.isGreaterOrEqual(this.getEffectiveLevel())){var exception,finalParamIndex=params.length-1,lastParam=params[params.length-1];params.length>1&&isError(lastParam)&&(exception=lastParam,finalParamIndex--);for(var messages=[],i=0;i<=finalParamIndex;i++)messages[i]=params[i];var loggingEvent=new LoggingEvent(this,new Date,level,messages,exception);this.callAppenders(loggingEvent)}},this.callAppenders=function(loggingEvent){for(var effectiveAppenders=this.getEffectiveAppenders(),i=0,len=effectiveAppenders.length;i<len;i++)effectiveAppenders[i].doAppend(loggingEvent)},this.setLevel=function(level){isRoot&&null===level?handleError("Logger.setLevel: you cannot set the level of the root logger to null"):level instanceof Level?loggerLevel=level:handleError("Logger.setLevel: level supplied to logger "+this.name+" is not an instance of log4javascript.Level")},this.getLevel=function(){return loggerLevel},this.getEffectiveLevel=function(){for(var logger=this;null!==logger;logger=logger.parent){var level=logger.getLevel();if(null!==level)return level}},this.group=function(name,initiallyExpanded){for(var effectiveAppenders=this.getEffectiveAppenders(),i=0,len=effectiveAppenders.length;i<len;i++)effectiveAppenders[i].group(name,initiallyExpanded)},this.groupEnd=function(name){for(var effectiveAppenders=this.getEffectiveAppenders(),i=0,len=effectiveAppenders.length;i<len;i++)effectiveAppenders[i].groupEnd()};var timers={};this.time=function(name,level){isUndefined(name)?handleError("Logger.time: a name for the timer must be supplied"):!level||level instanceof Level?timers[name]=new Timer(name,level):handleError("Logger.time: level supplied to timer "+name+" is not an instance of log4javascript.Level")},this.timeEnd=function(name){if(isUndefined(name))handleError("Logger.timeEnd: a name for the timer must be supplied");else if(timers[name]){var timer=timers[name],milliseconds=timer.getElapsedTime();this.log(timer.level,["Timer "+toStr(name)+" completed in "+milliseconds+"ms"]),delete timers[name]}else logLog.warn("Logger.timeEnd: no timer found with name "+name)},this.assert=function(expr){if(!expr){for(var args=[],i=1,len=arguments.length;i<len;i++)args.push(arguments[i]);args=args.length>0?args:["Assertion Failure"],args.push(newLine),args.push(expr),this.log(Level.ERROR,args)}},this.toString=function(){return"Logger["+this.name+"]"}}function SimpleLayout(){this.customFields=[]}function NullLayout(){this.customFields=[]}function XmlLayout(combineMessages){this.combineMessages=extractBooleanFromParam(combineMessages,!0),this.customFields=[]}function escapeNewLines(str){return str.replace(/\r\n|\r|\n/g,"\\r\\n")}function JsonLayout(readable,combineMessages){this.readable=extractBooleanFromParam(readable,!1),this.combineMessages=extractBooleanFromParam(combineMessages,!0),this.batchHeader=this.readable?"["+newLine:"[",this.batchFooter=this.readable?"]"+newLine:"]",this.batchSeparator=this.readable?","+newLine:",",this.setKeys(),this.colon=this.readable?": ":":",this.tab=this.readable?"\t":"",this.lineBreak=this.readable?newLine:"",this.customFields=[]}function HttpPostDataLayout(){this.setKeys(),this.customFields=[],this.returnsPostData=!0}function formatObjectExpansion(obj,depth,indentation){function doFormat(obj,depth,indentation){function formatString(text){for(var lines=splitIntoLines(text),j=1,jLen=lines.length;j<jLen;j++)lines[j]=indentation+lines[j];return lines.join(newLine)}var i,len,childDepth,childIndentation,childLines,expansion,childExpansion;if(indentation||(indentation=""),null===obj)return"null";if(void 0===obj)return"undefined";if("string"==typeof obj)return formatString(obj);if("object"==typeof obj&&array_contains(objectsExpanded,obj)){try{expansion=toStr(obj)}catch(ex){expansion="Error formatting property. Details: "+getExceptionStringRep(ex)}return expansion+" [already expanded]"}if(obj instanceof Array&&depth>0){for(objectsExpanded.push(obj),expansion="["+newLine,childDepth=depth-1,childIndentation=indentation+"  ",childLines=[],i=0,len=obj.length;i<len;i++)try{childExpansion=doFormat(obj[i],childDepth,childIndentation),childLines.push(childIndentation+childExpansion)}catch(ex){childLines.push(childIndentation+"Error formatting array member. Details: "+getExceptionStringRep(ex))}return expansion+=childLines.join(","+newLine)+newLine+indentation+"]"}if("object"==typeof obj&&depth>0){objectsExpanded.push(obj),expansion="{"+newLine,childDepth=depth-1,childIndentation=indentation+"  ",childLines=[];for(i in obj)try{childExpansion=doFormat(obj[i],childDepth,childIndentation),childLines.push(childIndentation+i+": "+childExpansion)}catch(ex){childLines.push(childIndentation+i+": Error formatting property. Details: "+getExceptionStringRep(ex))}return expansion+=childLines.join(","+newLine)+newLine+indentation+"}"}return formatString(toStr(obj))}var objectsExpanded=[];return doFormat(obj,depth,indentation)}function PatternLayout(pattern){this.pattern=pattern||PatternLayout.DEFAULT_CONVERSION_PATTERN,this.customFields=[]}function AlertAppender(){}function BrowserConsoleAppender(){}function getXmlHttp(errorHandler){var xmlHttp=null;if("object"==typeof XMLHttpRequest||"function"==typeof XMLHttpRequest)xmlHttp=new XMLHttpRequest;else try{xmlHttp=new ActiveXObject("Msxml2.XMLHTTP")}catch(e1){try{xmlHttp=new ActiveXObject("Microsoft.XMLHTTP")}catch(e2){errorHandler?errorHandler():handleError("getXmlHttp: unable to obtain XMLHttpRequest object")}}return xmlHttp}function isHttpRequestSuccessful(xmlHttp){return isUndefined(xmlHttp.status)||0===xmlHttp.status||xmlHttp.status>=200&&xmlHttp.status<300}function AjaxAppender(url){function checkCanConfigure(configOptionName){return!initialized||(handleError("AjaxAppender: configuration option '"+configOptionName+"' may not be set after the appender has been initialized"),!1)}function sendAll(){if(isSupported&&enabled){sending=!0;var currentRequestBatch;if(waitForResponse)queuedRequests.length>0?(currentRequestBatch=queuedRequests.shift(),sendRequest(preparePostData(currentRequestBatch),sendAll)):(sending=!1,timed&&scheduleSending());else{for(;currentRequestBatch=queuedRequests.shift();)sendRequest(preparePostData(currentRequestBatch));sending=!1,timed&&scheduleSending()}}}function sendAllRemaining(){if(isSupported&&enabled){for(var currentLoggingEvent,actualBatchSize=appender.getLayout().allowBatching()?batchSize:1,batchedLoggingEvents=[];currentLoggingEvent=queuedLoggingEvents.shift();)batchedLoggingEvents.push(currentLoggingEvent),queuedLoggingEvents.length>=actualBatchSize&&(queuedRequests.push(batchedLoggingEvents),batchedLoggingEvents=[]);batchedLoggingEvents.length>0&&queuedRequests.push(batchedLoggingEvents),waitForResponse=!1,timed=!1,sendAll()}}function preparePostData(batchedLoggingEvents){for(var currentLoggingEvent,formattedMessages=[],postData="";currentLoggingEvent=batchedLoggingEvents.shift();){var currentFormattedMessage=appender.getLayout().format(currentLoggingEvent);appender.getLayout().ignoresThrowable()&&(currentFormattedMessage+=loggingEvent.getThrowableStrRep()),formattedMessages.push(currentFormattedMessage)}return postData=1==batchedLoggingEvents.length?formattedMessages.join(""):appender.getLayout().batchHeader+formattedMessages.join(appender.getLayout().batchSeparator)+appender.getLayout().batchFooter,postData=appender.getLayout().returnsPostData?postData:urlEncode(postVarName)+"="+urlEncode(postData),postData.length>0&&(postData+="&"),postData+"layout="+urlEncode(appender.getLayout().toString())}function scheduleSending(){setTimeout(function(){sendAll()},timerInterval)}function xmlHttpErrorHandler(){var msg="AjaxAppender: could not create XMLHttpRequest object. AjaxAppender disabled";handleError(msg),isSupported=!1,failCallback&&failCallback(msg)}function sendRequest(postData,successCallback){try{var xmlHttp=getXmlHttp(xmlHttpErrorHandler);if(isSupported){xmlHttp.overrideMimeType&&xmlHttp.overrideMimeType(appender.getLayout().getContentType()),xmlHttp.onreadystatechange=function(){if(4==xmlHttp.readyState){if(isHttpRequestSuccessful(xmlHttp))requestSuccessCallback&&requestSuccessCallback(xmlHttp),successCallback&&successCallback(xmlHttp);else{var msg="AjaxAppender.append: XMLHttpRequest request to URL "+url+" returned status code "+xmlHttp.status;handleError(msg),failCallback&&failCallback(msg)}xmlHttp.onreadystatechange=emptyFunction,xmlHttp=null}},xmlHttp.open("POST",url,!0);try{xmlHttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded")}catch(headerEx){var msg="AjaxAppender.append: your browser's XMLHttpRequest implementation does not support setRequestHeader, therefore cannot post data. AjaxAppender disabled";return handleError(msg),isSupported=!1,void(failCallback&&failCallback(msg))}xmlHttp.send(postData)}}catch(ex){var errMsg="AjaxAppender.append: error sending log message to "+url;handleError(errMsg,ex),isSupported=!1,failCallback&&failCallback(errMsg+". Details: "+getExceptionStringRep(ex))}}function init(){initialized=!0,sendAllOnUnload&&addEvent(window,"unload",sendAllRemaining),timed&&scheduleSending()}var appender=this,isSupported=!0;url||(handleError("AjaxAppender: URL must be specified in constructor"),isSupported=!1);var timed=this.defaults.timed,waitForResponse=this.defaults.waitForResponse,batchSize=this.defaults.batchSize,timerInterval=this.defaults.timerInterval,requestSuccessCallback=this.defaults.requestSuccessCallback,failCallback=this.defaults.failCallback,postVarName=this.defaults.postVarName,sendAllOnUnload=this.defaults.sendAllOnUnload,sessionId=null,queuedLoggingEvents=[],queuedRequests=[],sending=!1,initialized=!1;this.getSessionId=function(){return sessionId},this.setSessionId=function(sessionIdParam){sessionId=extractStringFromParam(sessionIdParam,null),this.layout.setCustomField("sessionid",sessionId)},this.setLayout=function(layoutParam){checkCanConfigure("layout")&&(this.layout=layoutParam,null!==sessionId&&this.setSessionId(sessionId))},this.isTimed=function(){return timed},this.setTimed=function(timedParam){checkCanConfigure("timed")&&(timed=bool(timedParam))},this.getTimerInterval=function(){return timerInterval},this.setTimerInterval=function(timerIntervalParam){checkCanConfigure("timerInterval")&&(timerInterval=extractIntFromParam(timerIntervalParam,timerInterval))},this.isWaitForResponse=function(){return waitForResponse},this.setWaitForResponse=function(waitForResponseParam){checkCanConfigure("waitForResponse")&&(waitForResponse=bool(waitForResponseParam))},this.getBatchSize=function(){return batchSize},this.setBatchSize=function(batchSizeParam){checkCanConfigure("batchSize")&&(batchSize=extractIntFromParam(batchSizeParam,batchSize))},this.isSendAllOnUnload=function(){return sendAllOnUnload},this.setSendAllOnUnload=function(sendAllOnUnloadParam){checkCanConfigure("sendAllOnUnload")&&(sendAllOnUnload=extractIntFromParam(sendAllOnUnloadParam,sendAllOnUnload))},this.setRequestSuccessCallback=function(requestSuccessCallbackParam){requestSuccessCallback=extractFunctionFromParam(requestSuccessCallbackParam,requestSuccessCallback)},this.setFailCallback=function(failCallbackParam){failCallback=extractFunctionFromParam(failCallbackParam,failCallback)},this.getPostVarName=function(){return postVarName},this.setPostVarName=function(postVarNameParam){checkCanConfigure("postVarName")&&(postVarName=extractStringFromParam(postVarNameParam,postVarName))},this.sendAll=sendAll,this.append=function(loggingEvent){if(isSupported){initialized||init(),queuedLoggingEvents.push(loggingEvent);var actualBatchSize=this.getLayout().allowBatching()?batchSize:1;if(queuedLoggingEvents.length>=actualBatchSize){for(var currentLoggingEvent,batchedLoggingEvents=[];currentLoggingEvent=queuedLoggingEvents.shift();)batchedLoggingEvents.push(currentLoggingEvent);queuedRequests.push(batchedLoggingEvents),timed||(!waitForResponse||waitForResponse&&!sending)&&sendAll()}}}}function addWindowLoadListener(listener){window.addEventListener("load",listener,!0)}EventSupport.prototype={eventTypes:[],eventListeners:{},setEventTypes:function(eventTypesParam){if(eventTypesParam instanceof Array){this.eventTypes=eventTypesParam,this.eventListeners={};for(var i=0,len=this.eventTypes.length;i<len;i++)this.eventListeners[this.eventTypes[i]]=[]}else handleError("log4javascript.EventSupport ["+this+"]: setEventTypes: eventTypes parameter must be an Array")},addEventListener:function(eventType,listener){"function"==typeof listener?(array_contains(this.eventTypes,eventType)||handleError("log4javascript.EventSupport ["+this+"]: addEventListener: no event called '"+eventType+"'"),this.eventListeners[eventType].push(listener)):handleError("log4javascript.EventSupport ["+this+"]: addEventListener: listener must be a function")},removeEventListener:function(eventType,listener){"function"==typeof listener?(array_contains(this.eventTypes,eventType)||handleError("log4javascript.EventSupport ["+this+"]: removeEventListener: no event called '"+eventType+"'"),array_remove(this.eventListeners[eventType],listener)):handleError("log4javascript.EventSupport ["+this+"]: removeEventListener: listener must be a function")},dispatchEvent:function(eventType,eventArgs){if(array_contains(this.eventTypes,eventType))for(var listeners=this.eventListeners[eventType],i=0,len=listeners.length;i<len;i++)listeners[i](this,eventType,eventArgs);else handleError("log4javascript.EventSupport ["+this+"]: dispatchEvent: no event called '"+eventType+"'")}};var applicationStartDate=new Date,emptyFunction=(applicationStartDate.getTime(),Math.floor(1e8*Math.random()),function(){}),newLine="\r\n",pageLoaded=!1;Log4JavaScript.prototype=new EventSupport,log4javascript=new Log4JavaScript,log4javascript.version="1.4.1",log4javascript.edition="log4javascript";var logLog={quietMode:!1,debugMessages:[],setQuietMode:function(quietMode){this.quietMode=bool(quietMode)},numberOfErrors:0,alertAllErrors:!1,setAlertAllErrors:function(alertAllErrors){this.alertAllErrors=alertAllErrors},debug:function(message){this.debugMessages.push(message)},displayDebug:function(){alert(this.debugMessages.join(newLine))},warn:function(message,exception){},error:function(message,exception){if((1==++this.numberOfErrors||this.alertAllErrors)&&!this.quietMode){var alertMessage="log4javascript error: "+message;exception&&(alertMessage+=newLine+newLine+"Original error: "+getExceptionStringRep(exception)),alert(alertMessage)}}};log4javascript.logLog=logLog,log4javascript.setEventTypes(["load","error"]),log4javascript.handleError=handleError;var enabled=!("undefined"!=typeof log4javascript_disabled&&log4javascript_disabled);log4javascript.setEnabled=function(enable){enabled=bool(enable)},log4javascript.isEnabled=function(){return enabled};var useTimeStampsInMilliseconds=!0;log4javascript.setTimeStampsInMilliseconds=function(timeStampsInMilliseconds){useTimeStampsInMilliseconds=bool(timeStampsInMilliseconds)},log4javascript.isTimeStampsInMilliseconds=function(){return useTimeStampsInMilliseconds};var showStackTraces=!1;log4javascript.setShowStackTraces=function(show){showStackTraces=bool(show)};var Level=function(level,name){this.level=level,this.name=name};Level.prototype={toString:function(){return this.name},equals:function(level){return this.level==level.level},isGreaterOrEqual:function(level){return this.level>=level.level}},Level.ALL=new Level(Number.MIN_VALUE,"ALL"),Level.TRACE=new Level(1e4,"TRACE"),Level.DEBUG=new Level(2e4,"DEBUG"),Level.INFO=new Level(3e4,"INFO"),Level.WARN=new Level(4e4,"WARN"),Level.ERROR=new Level(5e4,"ERROR"),Level.FATAL=new Level(6e4,"FATAL"),Level.OFF=new Level(Number.MAX_VALUE,"OFF"),log4javascript.Level=Level,Timer.prototype.getElapsedTime=function(){return(new Date).getTime()-this.start.getTime()};var anonymousLoggerName="[anonymous]",defaultLoggerName="[default]",nullLoggerName="[null]",rootLoggerName="root";Logger.prototype={trace:function(){this.log(Level.TRACE,arguments)},debug:function(){this.log(Level.DEBUG,arguments)},info:function(){this.log(Level.INFO,arguments)},warn:function(){this.log(Level.WARN,arguments)},error:function(){this.log(Level.ERROR,arguments)},fatal:function(){this.log(Level.FATAL,arguments)},isEnabledFor:function(level){return level.isGreaterOrEqual(this.getEffectiveLevel())},isTraceEnabled:function(){return this.isEnabledFor(Level.TRACE)},isDebugEnabled:function(){return this.isEnabledFor(Level.DEBUG)},isInfoEnabled:function(){return this.isEnabledFor(Level.INFO)},isWarnEnabled:function(){return this.isEnabledFor(Level.WARN)},isErrorEnabled:function(){return this.isEnabledFor(Level.ERROR)},isFatalEnabled:function(){return this.isEnabledFor(Level.FATAL)}},Logger.prototype.trace.isEntryPoint=!0,Logger.prototype.debug.isEntryPoint=!0,Logger.prototype.info.isEntryPoint=!0,Logger.prototype.warn.isEntryPoint=!0,Logger.prototype.error.isEntryPoint=!0,Logger.prototype.fatal.isEntryPoint=!0;var loggers={},loggerNames=[],ROOT_LOGGER_DEFAULT_LEVEL=Level.DEBUG,rootLogger=new Logger(rootLoggerName);rootLogger.setLevel(ROOT_LOGGER_DEFAULT_LEVEL),log4javascript.getRootLogger=function(){return rootLogger},log4javascript.getLogger=function(loggerName){if("string"!=typeof loggerName&&(loggerName=anonymousLoggerName,logLog.warn("log4javascript.getLogger: non-string logger name "+toStr(loggerName)+" supplied, returning anonymous logger")),loggerName==rootLoggerName&&handleError("log4javascript.getLogger: root logger may not be obtained by name"),!loggers[loggerName]){var logger=new Logger(loggerName);loggers[loggerName]=logger,loggerNames.push(loggerName);var parentLogger,lastDotIndex=loggerName.lastIndexOf(".");if(lastDotIndex>-1){var parentLoggerName=loggerName.substring(0,lastDotIndex);parentLogger=log4javascript.getLogger(parentLoggerName)}else parentLogger=rootLogger;parentLogger.addChild(logger)}return loggers[loggerName]};var defaultLogger=null;log4javascript.getDefaultLogger=function(){if(!defaultLogger){defaultLogger=log4javascript.getLogger(defaultLoggerName);var a=new log4javascript.PopUpAppender;defaultLogger.addAppender(a)}return defaultLogger};var nullLogger=null;log4javascript.getNullLogger=function(){return nullLogger||(nullLogger=new Logger(nullLoggerName),nullLogger.setLevel(Level.OFF)),nullLogger},log4javascript.resetConfiguration=function(){rootLogger.setLevel(ROOT_LOGGER_DEFAULT_LEVEL),loggers={}};var LoggingEvent=function(logger,timeStamp,level,messages,exception){this.logger=logger,this.timeStamp=timeStamp,this.timeStampInMilliseconds=timeStamp.getTime(),this.timeStampInSeconds=Math.floor(this.timeStampInMilliseconds/1e3),this.milliseconds=this.timeStamp.getMilliseconds(),this.level=level,this.messages=messages,this.exception=exception};LoggingEvent.prototype={getThrowableStrRep:function(){return this.exception?getExceptionStringRep(this.exception):""},getCombinedMessages:function(){return 1==this.messages.length?this.messages[0]:this.messages.join(newLine)},toString:function(){return"LoggingEvent["+this.level+"]"}},log4javascript.LoggingEvent=LoggingEvent;var Layout=function(){};Layout.prototype={defaults:{loggerKey:"logger",timeStampKey:"timestamp",millisecondsKey:"milliseconds",levelKey:"level",messageKey:"message",exceptionKey:"exception",urlKey:"url"},loggerKey:"logger",timeStampKey:"timestamp",millisecondsKey:"milliseconds",levelKey:"level",messageKey:"message",exceptionKey:"exception",urlKey:"url",batchHeader:"",batchFooter:"",batchSeparator:"",returnsPostData:!1,overrideTimeStampsSetting:!1,useTimeStampsInMilliseconds:null,format:function(loggingEvent){handleError("Layout.format: layout supplied has no format() method")},ignoresThrowable:function(){handleError("Layout.ignoresThrowable: layout supplied has no ignoresThrowable() method")},getContentType:function(){return"text/plain"},allowBatching:function(){return!0},setTimeStampsInMilliseconds:function(timeStampsInMilliseconds){this.overrideTimeStampsSetting=!0,this.useTimeStampsInMilliseconds=bool(timeStampsInMilliseconds)},isTimeStampsInMilliseconds:function(){return this.overrideTimeStampsSetting?this.useTimeStampsInMilliseconds:useTimeStampsInMilliseconds},getTimeStampValue:function(loggingEvent){return this.isTimeStampsInMilliseconds()?loggingEvent.timeStampInMilliseconds:loggingEvent.timeStampInSeconds},getDataValues:function(loggingEvent,combineMessages){var dataValues=[[this.loggerKey,loggingEvent.logger.name],[this.timeStampKey,this.getTimeStampValue(loggingEvent)],[this.levelKey,loggingEvent.level.name],[this.urlKey,window.location.href],[this.messageKey,combineMessages?loggingEvent.getCombinedMessages():loggingEvent.messages]];if(this.isTimeStampsInMilliseconds()||dataValues.push([this.millisecondsKey,loggingEvent.milliseconds]),loggingEvent.exception&&dataValues.push([this.exceptionKey,getExceptionStringRep(loggingEvent.exception)]),this.hasCustomFields())for(var i=0,len=this.customFields.length;i<len;i++){var val=this.customFields[i].value;"function"==typeof val&&(val=val(this,loggingEvent)),dataValues.push([this.customFields[i].name,val])}return dataValues},setKeys:function(loggerKey,timeStampKey,levelKey,messageKey,exceptionKey,urlKey,millisecondsKey){this.loggerKey=extractStringFromParam(loggerKey,this.defaults.loggerKey),this.timeStampKey=extractStringFromParam(timeStampKey,this.defaults.timeStampKey),this.levelKey=extractStringFromParam(levelKey,this.defaults.levelKey),this.messageKey=extractStringFromParam(messageKey,this.defaults.messageKey),this.exceptionKey=extractStringFromParam(exceptionKey,this.defaults.exceptionKey),this.urlKey=extractStringFromParam(urlKey,this.defaults.urlKey),this.millisecondsKey=extractStringFromParam(millisecondsKey,this.defaults.millisecondsKey)},setCustomField:function(name,value){for(var fieldUpdated=!1,i=0,len=this.customFields.length;i<len;i++)this.customFields[i].name===name&&(this.customFields[i].value=value,fieldUpdated=!0);fieldUpdated||this.customFields.push({name:name,value:value})},hasCustomFields:function(){return this.customFields.length>0},toString:function(){handleError("Layout.toString: all layouts must override this method")}},log4javascript.Layout=Layout;var Appender=function(){};Appender.prototype=new EventSupport,Appender.prototype.layout=new PatternLayout,Appender.prototype.threshold=Level.ALL,Appender.prototype.loggers=[],Appender.prototype.doAppend=function(loggingEvent){enabled&&loggingEvent.level.level>=this.threshold.level&&this.append(loggingEvent)},Appender.prototype.append=function(loggingEvent){},Appender.prototype.setLayout=function(layout){layout instanceof Layout?this.layout=layout:handleError("Appender.setLayout: layout supplied to "+this.toString()+" is not a subclass of Layout")},Appender.prototype.getLayout=function(){return this.layout},Appender.prototype.setThreshold=function(threshold){threshold instanceof Level?this.threshold=threshold:handleError("Appender.setThreshold: threshold supplied to "+this.toString()+" is not a subclass of Level")},Appender.prototype.getThreshold=function(){return this.threshold},Appender.prototype.setAddedToLogger=function(logger){this.loggers.push(logger)},Appender.prototype.setRemovedFromLogger=function(logger){array_remove(this.loggers,logger)},Appender.prototype.group=emptyFunction,Appender.prototype.groupEnd=emptyFunction,Appender.prototype.toString=function(){handleError("Appender.toString: all appenders must override this method")},log4javascript.Appender=Appender,SimpleLayout.prototype=new Layout,SimpleLayout.prototype.format=function(loggingEvent){return loggingEvent.level.name+" - "+loggingEvent.getCombinedMessages()},SimpleLayout.prototype.ignoresThrowable=function(){return!0},SimpleLayout.prototype.toString=function(){return"SimpleLayout"},log4javascript.SimpleLayout=SimpleLayout,NullLayout.prototype=new Layout,NullLayout.prototype.format=function(loggingEvent){return loggingEvent.messages},NullLayout.prototype.ignoresThrowable=function(){return!0},NullLayout.prototype.toString=function(){return"NullLayout"},log4javascript.NullLayout=NullLayout,XmlLayout.prototype=new Layout,XmlLayout.prototype.isCombinedMessages=function(){return this.combineMessages},XmlLayout.prototype.getContentType=function(){return"text/xml"},XmlLayout.prototype.escapeCdata=function(str){return str.replace(/\]\]>/,"]]>]]&gt;<![CDATA[")},XmlLayout.prototype.format=function(loggingEvent){function formatMessage(message){return message="string"==typeof message?message:toStr(message),"<log4javascript:message><![CDATA["+layout.escapeCdata(message)+"]]></log4javascript:message>"}var i,len,layout=this,str='<log4javascript:event logger="'+loggingEvent.logger.name+'" timestamp="'+this.getTimeStampValue(loggingEvent)+'"';if(this.isTimeStampsInMilliseconds()||(str+=' milliseconds="'+loggingEvent.milliseconds+'"'),str+=' level="'+loggingEvent.level.name+'">'+newLine,this.combineMessages)str+=formatMessage(loggingEvent.getCombinedMessages());else{
for(str+="<log4javascript:messages>"+newLine,i=0,len=loggingEvent.messages.length;i<len;i++)str+=formatMessage(loggingEvent.messages[i])+newLine;str+="</log4javascript:messages>"+newLine}if(this.hasCustomFields())for(i=0,len=this.customFields.length;i<len;i++)str+='<log4javascript:customfield name="'+this.customFields[i].name+'"><![CDATA['+this.customFields[i].value.toString()+"]]></log4javascript:customfield>"+newLine;return loggingEvent.exception&&(str+="<log4javascript:exception><![CDATA["+getExceptionStringRep(loggingEvent.exception)+"]]></log4javascript:exception>"+newLine),str+="</log4javascript:event>"+newLine+newLine},XmlLayout.prototype.ignoresThrowable=function(){return!1},XmlLayout.prototype.toString=function(){return"XmlLayout"},log4javascript.XmlLayout=XmlLayout,JsonLayout.prototype=new Layout,JsonLayout.prototype.isReadable=function(){return this.readable},JsonLayout.prototype.isCombinedMessages=function(){return this.combineMessages},JsonLayout.prototype.format=function(loggingEvent){function formatValue(val,prefix,expand){var formattedValue,valType=typeof val;if(val instanceof Date)formattedValue=String(val.getTime());else if(expand&&val instanceof Array){for(formattedValue="["+layout.lineBreak,i=0,len=val.length;i<len;i++){var childPrefix=prefix+layout.tab;formattedValue+=childPrefix+formatValue(val[i],childPrefix,!1),i<val.length-1&&(formattedValue+=","),formattedValue+=layout.lineBreak}formattedValue+=prefix+"]"}else formattedValue="number"!==valType&&"boolean"!==valType?'"'+escapeNewLines(toStr(val).replace(/\"/g,'\\"'))+'"':val;return formattedValue}var i,layout=this,dataValues=this.getDataValues(loggingEvent,this.combineMessages),str="{"+this.lineBreak;for(i=0,len=dataValues.length;i<len;i++)str+=this.tab+'"'+dataValues[i][0]+'"'+this.colon+formatValue(dataValues[i][1],this.tab,!0),i<dataValues.length-1&&(str+=","),str+=this.lineBreak;return str+="}"+this.lineBreak},JsonLayout.prototype.ignoresThrowable=function(){return!1},JsonLayout.prototype.toString=function(){return"JsonLayout"},JsonLayout.prototype.getContentType=function(){return"application/json"},log4javascript.JsonLayout=JsonLayout,HttpPostDataLayout.prototype=new Layout,HttpPostDataLayout.prototype.allowBatching=function(){return!1},HttpPostDataLayout.prototype.format=function(loggingEvent){for(var dataValues=this.getDataValues(loggingEvent),queryBits=[],i=0,len=dataValues.length;i<len;i++){var val=dataValues[i][1]instanceof Date?String(dataValues[i][1].getTime()):dataValues[i][1];queryBits.push(urlEncode(dataValues[i][0])+"="+urlEncode(val))}return queryBits.join("&")},HttpPostDataLayout.prototype.ignoresThrowable=function(loggingEvent){return!1},HttpPostDataLayout.prototype.toString=function(){return"HttpPostDataLayout"},log4javascript.HttpPostDataLayout=HttpPostDataLayout;var SimpleDateFormat;!function(){var regex=/('[^']*')|(G+|y+|M+|w+|W+|D+|d+|F+|E+|a+|H+|k+|K+|h+|m+|s+|S+|Z+)|([a-zA-Z]+)|([^a-zA-Z']+)/,monthNames=["January","February","March","April","May","June","July","August","September","October","November","December"],dayNames=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],TEXT2=0,TEXT3=1,NUMBER=2,YEAR=3,MONTH=4,TIMEZONE=5,types={G:TEXT2,y:YEAR,M:MONTH,w:NUMBER,W:NUMBER,D:NUMBER,d:NUMBER,F:NUMBER,E:TEXT3,a:TEXT2,H:NUMBER,k:NUMBER,K:NUMBER,h:NUMBER,m:NUMBER,s:NUMBER,S:NUMBER,Z:TIMEZONE},ONE_DAY=864e5,ONE_WEEK=7*ONE_DAY,DEFAULT_MINIMAL_DAYS_IN_FIRST_WEEK=1,newDateAtMidnight=function(year,month,day){var d=new Date(year,month,day,0,0,0);return d.setMilliseconds(0),d};Date.prototype.getDifference=function(date){return this.getTime()-date.getTime()},Date.prototype.isBefore=function(d){return this.getTime()<d.getTime()},Date.prototype.getUTCTime=function(){return Date.UTC(this.getFullYear(),this.getMonth(),this.getDate(),this.getHours(),this.getMinutes(),this.getSeconds(),this.getMilliseconds())},Date.prototype.getTimeSince=function(d){return this.getUTCTime()-d.getUTCTime()},Date.prototype.getPreviousSunday=function(){var midday=new Date(this.getFullYear(),this.getMonth(),this.getDate(),12,0,0),previousSunday=new Date(midday.getTime()-this.getDay()*ONE_DAY);return newDateAtMidnight(previousSunday.getFullYear(),previousSunday.getMonth(),previousSunday.getDate())},Date.prototype.getWeekInYear=function(minimalDaysInFirstWeek){isUndefined(this.minimalDaysInFirstWeek)&&(minimalDaysInFirstWeek=DEFAULT_MINIMAL_DAYS_IN_FIRST_WEEK);var previousSunday=this.getPreviousSunday(),startOfYear=newDateAtMidnight(this.getFullYear(),0,1),numberOfSundays=previousSunday.isBefore(startOfYear)?0:1+Math.floor(previousSunday.getTimeSince(startOfYear)/ONE_WEEK),numberOfDaysInFirstWeek=7-startOfYear.getDay(),weekInYear=numberOfSundays;return numberOfDaysInFirstWeek<minimalDaysInFirstWeek&&weekInYear--,weekInYear},Date.prototype.getWeekInMonth=function(minimalDaysInFirstWeek){isUndefined(this.minimalDaysInFirstWeek)&&(minimalDaysInFirstWeek=DEFAULT_MINIMAL_DAYS_IN_FIRST_WEEK);var previousSunday=this.getPreviousSunday(),startOfMonth=newDateAtMidnight(this.getFullYear(),this.getMonth(),1),numberOfSundays=previousSunday.isBefore(startOfMonth)?0:1+Math.floor(previousSunday.getTimeSince(startOfMonth)/ONE_WEEK),numberOfDaysInFirstWeek=7-startOfMonth.getDay(),weekInMonth=numberOfSundays;return numberOfDaysInFirstWeek>=minimalDaysInFirstWeek&&weekInMonth++,weekInMonth},Date.prototype.getDayInYear=function(){var startOfYear=newDateAtMidnight(this.getFullYear(),0,1);return 1+Math.floor(this.getTimeSince(startOfYear)/ONE_DAY)},SimpleDateFormat=function(formatString){this.formatString=formatString},SimpleDateFormat.prototype.setMinimalDaysInFirstWeek=function(days){this.minimalDaysInFirstWeek=days},SimpleDateFormat.prototype.getMinimalDaysInFirstWeek=function(){return isUndefined(this.minimalDaysInFirstWeek)?DEFAULT_MINIMAL_DAYS_IN_FIRST_WEEK:this.minimalDaysInFirstWeek};var padWithZeroes=function(str,len){for(;str.length<len;)str="0"+str;return str},formatText=function(data,numberOfLetters,minLength){return numberOfLetters>=4?data:data.substr(0,Math.max(minLength,numberOfLetters))},formatNumber=function(data,numberOfLetters){return padWithZeroes(""+data,numberOfLetters)};SimpleDateFormat.prototype.format=function(date){for(var result,formattedString="",searchString=this.formatString;result=regex.exec(searchString);){var quotedString=result[1],patternLetters=result[2],otherLetters=result[3],otherCharacters=result[4];if(quotedString)formattedString+="''"==quotedString?"'":quotedString.substring(1,quotedString.length-1);else if(otherLetters);else if(otherCharacters)formattedString+=otherCharacters;else if(patternLetters){var patternLetter=patternLetters.charAt(0),numberOfLetters=patternLetters.length,rawData="";switch(patternLetter){case"G":rawData="AD";break;case"y":rawData=date.getFullYear();break;case"M":rawData=date.getMonth();break;case"w":rawData=date.getWeekInYear(this.getMinimalDaysInFirstWeek());break;case"W":rawData=date.getWeekInMonth(this.getMinimalDaysInFirstWeek());break;case"D":rawData=date.getDayInYear();break;case"d":rawData=date.getDate();break;case"F":rawData=1+Math.floor((date.getDate()-1)/7);break;case"E":rawData=dayNames[date.getDay()];break;case"a":rawData=date.getHours()>=12?"PM":"AM";break;case"H":rawData=date.getHours();break;case"k":rawData=date.getHours()||24;break;case"K":rawData=date.getHours()%12;break;case"h":rawData=date.getHours()%12||12;break;case"m":rawData=date.getMinutes();break;case"s":rawData=date.getSeconds();break;case"S":rawData=date.getMilliseconds();break;case"Z":rawData=date.getTimezoneOffset()}switch(types[patternLetter]){case TEXT2:formattedString+=formatText(rawData,numberOfLetters,2);break;case TEXT3:formattedString+=formatText(rawData,numberOfLetters,3);break;case NUMBER:formattedString+=formatNumber(rawData,numberOfLetters);break;case YEAR:if(numberOfLetters<=3){var dataString=""+rawData;formattedString+=dataString.substr(2,2)}else formattedString+=formatNumber(rawData,numberOfLetters);break;case MONTH:formattedString+=numberOfLetters>=3?formatText(monthNames[rawData],numberOfLetters,numberOfLetters):formatNumber(rawData+1,numberOfLetters);break;case TIMEZONE:var isPositive=rawData>0,prefix=isPositive?"-":"+",absData=Math.abs(rawData),hours=""+Math.floor(absData/60);hours=padWithZeroes(hours,2);var minutes=""+absData%60;minutes=padWithZeroes(minutes,2),formattedString+=prefix+hours+minutes}}searchString=searchString.substr(result.index+result[0].length)}return formattedString}}(),log4javascript.SimpleDateFormat=SimpleDateFormat,PatternLayout.TTCC_CONVERSION_PATTERN="%r %p %c - %m%n",PatternLayout.DEFAULT_CONVERSION_PATTERN="%m%n",PatternLayout.ISO8601_DATEFORMAT="yyyy-MM-dd HH:mm:ss,SSS",PatternLayout.DATETIME_DATEFORMAT="dd MMM yyyy HH:mm:ss,SSS",PatternLayout.ABSOLUTETIME_DATEFORMAT="HH:mm:ss,SSS",PatternLayout.prototype=new Layout,PatternLayout.prototype.format=function(loggingEvent){for(var result,regex=/%(-?[0-9]+)?(\.?[0-9]+)?([acdfmMnpr%])(\{([^\}]+)\})?|([^%]+)/,formattedString="",searchString=this.pattern;result=regex.exec(searchString);){var matchedString=result[0],padding=result[1],truncation=result[2],conversionCharacter=result[3],specifier=result[5],text=result[6];if(text)formattedString+=""+text;else{var replacement="";switch(conversionCharacter){case"a":case"m":var depth=0;specifier&&(depth=parseInt(specifier,10),isNaN(depth)&&(handleError("PatternLayout.format: invalid specifier '"+specifier+"' for conversion character '"+conversionCharacter+"' - should be a number"),depth=0));for(var messages="a"===conversionCharacter?loggingEvent.messages[0]:loggingEvent.messages,i=0,len=messages.length;i<len;i++)i>0&&" "!==replacement.charAt(replacement.length-1)&&(replacement+=" "),replacement+=0===depth?messages[i]:formatObjectExpansion(messages[i],depth);break;case"c":var loggerName=loggingEvent.logger.name;if(specifier){var precision=parseInt(specifier,10),loggerNameBits=loggingEvent.logger.name.split(".");replacement=precision>=loggerNameBits.length?loggerName:loggerNameBits.slice(loggerNameBits.length-precision).join(".")}else replacement=loggerName;break;case"d":var dateFormat=PatternLayout.ISO8601_DATEFORMAT;specifier&&(dateFormat=specifier,"ISO8601"==dateFormat?dateFormat=PatternLayout.ISO8601_DATEFORMAT:"ABSOLUTE"==dateFormat?dateFormat=PatternLayout.ABSOLUTETIME_DATEFORMAT:"DATE"==dateFormat&&(dateFormat=PatternLayout.DATETIME_DATEFORMAT)),replacement=new SimpleDateFormat(dateFormat).format(loggingEvent.timeStamp);break;case"f":if(this.hasCustomFields()){var fieldIndex=0;specifier&&(fieldIndex=parseInt(specifier,10),isNaN(fieldIndex)?handleError("PatternLayout.format: invalid specifier '"+specifier+"' for conversion character 'f' - should be a number"):0===fieldIndex?handleError("PatternLayout.format: invalid specifier '"+specifier+"' for conversion character 'f' - must be greater than zero"):fieldIndex>this.customFields.length?handleError("PatternLayout.format: invalid specifier '"+specifier+"' for conversion character 'f' - there aren't that many custom fields"):fieldIndex-=1),replacement=this.customFields[fieldIndex].value}break;case"n":replacement=newLine;break;case"p":replacement=loggingEvent.level.name;break;case"r":replacement=""+loggingEvent.timeStamp.getDifference(applicationStartDate);break;case"%":replacement="%";break;default:replacement=matchedString}var l;if(truncation){l=parseInt(truncation.substr(1),10);var strLen=replacement.length;l<strLen&&(replacement=replacement.substring(strLen-l,strLen))}if(padding)if("-"==padding.charAt(0))for(l=parseInt(padding.substr(1),10);replacement.length<l;)replacement+=" ";else for(l=parseInt(padding,10);replacement.length<l;)replacement=" "+replacement;formattedString+=replacement}searchString=searchString.substr(result.index+result[0].length)}return formattedString},PatternLayout.prototype.ignoresThrowable=function(){return!0},PatternLayout.prototype.toString=function(){return"PatternLayout"},log4javascript.PatternLayout=PatternLayout,AlertAppender.prototype=new Appender,AlertAppender.prototype.layout=new SimpleLayout,AlertAppender.prototype.append=function(loggingEvent){var formattedMessage=this.getLayout().format(loggingEvent);this.getLayout().ignoresThrowable()&&(formattedMessage+=loggingEvent.getThrowableStrRep()),alert(formattedMessage)},AlertAppender.prototype.toString=function(){return"AlertAppender"},log4javascript.AlertAppender=AlertAppender,BrowserConsoleAppender.prototype=new log4javascript.Appender,BrowserConsoleAppender.prototype.layout=new NullLayout,BrowserConsoleAppender.prototype.threshold=Level.DEBUG,BrowserConsoleAppender.prototype.append=function(loggingEvent){var appender=this,getFormattedMessage=function(){var layout=appender.getLayout(),formattedMessage=layout.format(loggingEvent);return layout.ignoresThrowable()&&loggingEvent.exception&&(formattedMessage+=loggingEvent.getThrowableStrRep()),formattedMessage};if("undefined"!=typeof opera&&opera.postError)opera.postError(getFormattedMessage());else if(window.console&&window.console.log){var formattedMesage=getFormattedMessage();window.console.debug&&Level.DEBUG.isGreaterOrEqual(loggingEvent.level)?window.console.debug(formattedMesage):window.console.info&&Level.INFO.equals(loggingEvent.level)?window.console.info(formattedMesage):window.console.warn&&Level.WARN.equals(loggingEvent.level)?window.console.warn(formattedMesage):window.console.error&&loggingEvent.level.isGreaterOrEqual(Level.ERROR)?window.console.error(formattedMesage):window.console.log(formattedMesage)}},BrowserConsoleAppender.prototype.group=function(name){window.console&&window.console.group&&window.console.group(name)},BrowserConsoleAppender.prototype.groupEnd=function(){window.console&&window.console.groupEnd&&window.console.groupEnd()},BrowserConsoleAppender.prototype.toString=function(){return"BrowserConsoleAppender"},log4javascript.BrowserConsoleAppender=BrowserConsoleAppender,AjaxAppender.prototype=new Appender,AjaxAppender.prototype.defaults={waitForResponse:!1,timed:!1,timerInterval:1e3,batchSize:1,sendAllOnUnload:!0,requestSuccessCallback:null,failCallback:null,postVarName:"data"},AjaxAppender.prototype.layout=new HttpPostDataLayout,AjaxAppender.prototype.toString=function(){return"AjaxAppender"},log4javascript.AjaxAppender=AjaxAppender,addWindowLoadListener(function(){pageLoaded=!0,log4javascript.dispatchEvent("load",{})}),window.log4javascript=log4javascript}(),"undefined"!=typeof exports&&(exports.log4javascript=log4javascript),void 0===log4javascript&&"function"==typeof require)var log4javascript=require("./ThirdParty/log4javascript_uncompressed.js").log4javascript;LocalStroageAppender.prototype=new log4javascript.Appender,LocalStroageAppender.prototype.layout=new log4javascript.NullLayout,LocalStroageAppender.prototype.threshold=log4javascript.Level.DEBUG,LocalStroageAppender.prototype.append=function(loggingEvent){var appender=this,getFormattedMessage=function(){var layout=appender.getLayout(),formattedMessage=layout.format(loggingEvent);return layout.ignoresThrowable()&&loggingEvent.exception&&(formattedMessage+=loggingEvent.getThrowableStrRep()),formattedMessage};window.localStorage.setItem((new Date).toTimeString(),getFormattedMessage())},LocalStroageAppender.prototype.toString=function(){return"LocalStroageAppender"},WebSocketAppender.prototype=new log4javascript.Appender,WebSocketAppender.prototype.layout=new log4javascript.NullLayout,WebSocketAppender.prototype.threshold=log4javascript.Level.DEBUG,WebSocketAppender.prototype.append=function(loggingEvent){if(this.enabled){var appender=this,getFormattedMessage=function(){var layout=appender.getLayout(),formattedMessage=layout.format(loggingEvent);return layout.ignoresThrowable()&&loggingEvent.exception&&(formattedMessage+=loggingEvent.getThrowableStrRep()),(new Date).getTime()+" # "+formattedMessage};if(!this.logWebSocket)return void this._buffer.push(getFormattedMessage());switch(this.logWebSocket.readyState){case this.logWebSocket.CONNECTING:this._buffer.push(getFormattedMessage());break;case this.logWebSocket.OPEN:this.logWebSocket.send(getFormattedMessage());break;case this.logWebSocket.CLOSING:case this.logWebSocket.CLOSED:this.shutDown()}}},WebSocketAppender.prototype.connect=function(port){this.logWebSocket=new WebSocket("ws://127.0.0.1:"+port),this.logWebSocket.onopen=this.onOpen.bind(this),this.logWebSocket.onclose=this.onClose.bind(this),this.logWebSocket.onerror=this.onError.bind(this)},WebSocketAppender.prototype.onOpen=function(){this.enabled=!0,this._buffer.forEach(function(logMsg){this.logWebSocket.send(logMsg)},this),delete this._buffer},WebSocketAppender.prototype.onClose=function(){this.shutDown()},WebSocketAppender.prototype.onError=function(){Util.safeConsoleError("WebSocketAppender.onError: There was an error in WebSocket Appender"),this.shutDown()},WebSocketAppender.prototype.shutDown=function(){this.logWebSocket&&this.logWebSocket.close(),delete this._buffer,this.enabled=!1},WebSocketAppender.prototype.toString=function(){return"WebSocketAppender"};var WebSocketAppenderInstance=new WebSocketAppender;WebSocketAppenderInstance.setThreshold(log4javascript.Level.ALL),WebSocketAppenderInstance.setLayout(new log4javascript.PatternLayout("%d{HH:mm:ss} %c [%-5p] - %m")),LazyFormatLayout.prototype=new log4javascript.Layout,LazyFormatLayout.prototype.format=function(loggingEvent){var time=loggingEvent.timeStamp.toTimeString().split(/\s/)[0],head=time+" "+loggingEvent.logger.name+" ["+loggingEvent.level.name+"] - ",body=loggingEvent.messages.map(function(arg){try{switch(typeof arg){case"function":return arg();case"object":return JSON.stringify(arg,null,this.JSONspaces)}}catch(e){return"<<error while logging: "+(e.message||e.description)+" at: "+e.stack+">>"}return arg},this).join(""),result=head+body;if(loggingEvent.exception){var ex=loggingEvent.exception;result+=" ==> Exception: "+(ex.message||ex.description)+"\n"+ex.stack}return result.length>16384&&Util.safeConsoleWarn("Logging long message which may not show up at: ",Error().stack),result},LazyFormatLayout.prototype.ignoresThrowable=function(){return!1},LazyFormatLayout.prototype.toString=function(){return"LazyFormatLayout"};var BrowserAppender=new log4javascript.BrowserConsoleAppender;BrowserAppender.setThreshold(log4javascript.Level.ALL);var lazyFormatLayout=new LazyFormatLayout;BrowserAppender.setLayout(lazyFormatLayout),LoggerUtilSettings={_settings:null,DEFAULT_LOG_LEVEL:"WARN",init:function(){LoggerUtilSettings._settings={},log4javascript.getRootLogger().setLevel(log4javascript.Level[LoggerUtilSettings.DEFAULT_LOG_LEVEL])},setSettings:function(newSettings){LoggerUtilSettings._settings=newSettings;var defaultLogLevel=LoggerUtilSettings._settings["log:defaultLevel"]||LoggerUtilSettings.DEFAULT_LOG_LEVEL;log4javascript.getRootLogger().setLevel(log4javascript.Level[defaultLogLevel]),Object.keys(newSettings).filter(function(k){return k.match(/^log:cat/)}).forEach(function(catSetting){var logLevel=newSettings[catSetting],tokens=catSetting.split(":"),catName=tokens.pop();log4javascript.getLogger(catName).setLevel(log4javascript.Level[logLevel])}),newSettings.remoteLogging&&newSettings.remoteLogging.enabled?WebSocketAppenderInstance.connect(newSettings.remoteLogging.port):WebSocketAppenderInstance.shutDown()},getCategoryLogLevel:function(catName){if(!LoggerUtilSettings._settings)return null;var catLogLevel=LoggerUtilSettings._settings["log:cat:"+catName];return catLogLevel||null},getLogSettings:function(){var logSettings={};return Object.keys(LoggerUtilSettings._settings).filter(function(k){return k.match(/^log:/)}).forEach(function(logSetting){logSettings[logSetting]=LoggerUtilSettings._settings[logSetting]}),logSettings.remoteLogging=LoggerUtilSettings._settings.remoteLogging,logSettings},getAvailableLevels:function(){return Object.keys(log4javascript.Level)},getEmptyLogger:function(){function nop(){}return{trace:nop,prettyTrace:nop,debug:nop,prettyDebug:nop,warn:nop,info:nop,error:nop}}},"undefined"!=typeof exports&&(exports.LoggerUtil=LoggerUtil,exports.LoggerUtilSettings=LoggerUtilSettings);var MSG_TYPES={REGISTER_FRAME:"REGISTER_FRAME",QUERY:"QUERY_ATTR",SRVC_SET_GLOBAL_VARIABLES:"SRVC_SET_GLOBAL_VARIABLES",SRVC_GET_ALL_BROWSERS:"SRVC_GET_ALL_BROWSERS",QUERY_DESC_TO_ID:"QUERY_DESC_TO_ID",SRVC_CALL_OBJ_EVENT:"SRVC_CALL_OBJ_EVENT",SRVC_INVOKE_METHOD:"SRVC_INVOKE_METHOD",SRVC_MAKE_OBJ_VISIBLE:"SRVC_MAKE_OBJ_VISIBLE",SRVC_GET_SCREEN_RECT:"SRVC_GET_SCREEN_RECT",SRVC_EDIT_SET:"SRVC_EDIT_SET",SRVC_GET_FORM:"SRVC_GET_FORM",RECORD:"RECORD",REQUEST_COMID:"REQUEST_COMID",RESPONSE_COMID:"RESPONSE_COMID",DISPATCH_TO_FRAME_ELEM:"DISPATCH_TO_FRAME_ELEM",MATCH_DESC_TO_ID:"MATCH_DESC_TO_ID",FRAME_FROM_POINT:"FRAME_FROM_POINT",QUERY_GET_TABLE_DATA:"QUERY_GET_TABLE_DATA",SRVC_LOAD_KIT:"SRVC_LOAD_KIT",WEBEXT_REPORT_LINE:"WEBEXT_REPORT_LINE",WEBEXT_RECORD_EVENT:"WEBEXT_RECORD_EVENT"};Msg.prototype={_msgType:null,_to:null,_tab:-1,_data:null,toString:function(){return"\nType:"+this._msgType+"\nTo:"+this._to+"\nTab:"+this._tab+"\nData:"+this._data},clone:function(){return new Msg(this._msgType,this._to,this._data,this._tab)},QTP_COM_ID:-1};var ErrorReporter={ThrowGeneralError:function(){throw this.CreateExceptionObjFromStatus("ERROR")},ThrowNotImplemented:function(method){var e=this.CreateExceptionObjFromStatus("NotImplemented");throw e.Details=method,e},ThrowObjectNotFound:function(){throw this.CreateExceptionObjFromStatus("ObjectNotFound")},ThrowObjectDisabled:function(){throw this.CreateExceptionObjFromStatus("ObjectDisabled")},ThrowItemNotFound:function(){throw this.CreateExceptionObjFromStatus("ItemNotFound")},ThrowItemNotUnique:function(){throw this.CreateExceptionObjFromStatus("ItemNotUnique")},ThrowInvalidArg:function(){throw this.CreateExceptionObjFromStatus("InvalidArgument")},ThrowOutOfRange:function(){throw this.CreateExceptionObjFromStatus("OutOfRange")},ThrowMethodNotFound:function(){throw this.CreateExceptionObjFromStatus("MethodNotFound")},CreateExceptionObjFromStatus:function(status){return new Error(status)}},Util={identity:function(x){return x},identityWithCallback:function(x){(0,arguments[arguments.length-1])(x)},isUndefined:function(x){return void 0===x},isNullOrUndefined:function(x){return Util.isUndefined(x)||null===x},isObject:function(val){return"object"==typeof val&&!Array.isArray(val)},isFunction:function(val){return"function"==typeof val},isLegacyObject:function(obj){return void 0===obj&&-1!==(""+obj).search("HTMLAllCollection")},parseJSON:function(str,logger){if("undefined"==typeof JSON||null==JSON.parse)return logger&&logger.error("JSON or JSON.parse is undefined"),null;if(!str)return logger&&logger.error("Tried to parse empty message"),null;logger&&logger.trace("Parsing string: \n",str);try{return JSON.parse(str)}catch(e){return logger&&logger.error("Failed to parse string with exception: "+e+"\nString was: "+str+"\nStack:"+e.stack),null}},capitalize:function(str){return str[0].toUpperCase()+str.slice(1)},alwaysFalse:function(){return!1},alwaysTrue:function(){return!0},makeArray:function(seq){if(Array.isArray(seq))return seq;for(var array=new Array(seq.length),i=0;i<seq.length;i++)array[i]=seq[i];return array},arrayFindIndex:function(arr,predicate,thisArg){thisArg=thisArg||this;var result=-1;return Util.makeArray(arr).some(function(element,index,array){return!!predicate.call(thisArg,element,index,array)&&(result=index,!0)}),result},arrayFind:function(arr,predicate,thisArg){var realArray=Util.makeArray(arr),index=Util.arrayFindIndex(realArray,predicate,thisArg);if(-1!==index)return arr[index]},arrayCompact:function(arr){return Array.isArray(arr)?arr.filter(Util.identity):null},arrayWrap:function(obj){return Array.isArray(obj)?obj:[obj]},stringNthPosition:function(str,substr,n){for(var pos=-1;n--;){var index=str.indexOf(substr,pos+1);if(-1===index)return-1;pos=index}return pos},stringCount:function(str,substr){if(!substr)return-1;var count=-1,index=-1;do{count++,index=str.indexOf(substr,index+1)}while(-1!==index);return count},stringTrimLeft:function(str){if("string"!=typeof str)throw Error("stringTrimLeft called with non-string");return"function"==typeof str.trimLeft?str.trimLeft(str):str.replace(/^\s+/,"")},shallowObjectClone:function(srcObj){var targetObj={};for(var key in srcObj)targetObj[key]=srcObj[key];return targetObj},deepObjectClone:function(srcObj){if(null==srcObj||"object"!=typeof srcObj)return srcObj;var targetObj;if(Array.isArray(srcObj)){targetObj=[];for(var index=0;index<srcObj.length;index++){var cloneValue=arguments.callee(srcObj[index]);targetObj[index]=cloneValue}return targetObj}switch(srcObj.constructor){case RegExp:targetObj=new RegExp(srcObj);break;case Date:targetObj=new Data(srcObj.getTime());break;default:targetObj={}}for(var key in srcObj)targetObj[key]=arguments.callee(srcObj[key]);return targetObj},isVisible:function(elemRect,containerRect){var intersection=Util.intersectRect(containerRect,elemRect);if(Util.isRectEmpty(intersection))return!1;var minimalIntersectionSize=Math.min(.9*Util.rectArea(elemRect),1e4);return Util.rectArea(intersection)>minimalIntersectionSize},rectArea:function(rect){return Util.isRect(rect)?(rect.right-rect.left)*(rect.bottom-rect.top):0},intersectRect:function(r1,r2){var intersectionRect={top:0,left:0,bottom:0,right:0};if(Util.isRectEmpty(r1)||Util.isRectEmpty(r2))return intersectionRect;var isIntersected=!1;return(r1.left<r2.right&&r1.left>=r2.left||r2.left<r1.right&&r2.left>=r1.left)&&(r1.top<r2.bottom&&r1.top>=r2.top||r2.top<r1.bottom&&r2.top>=r1.top)&&(isIntersected=!0),isIntersected?(intersectionRect.top=Math.max(r1.top,r2.top),intersectionRect.left=Math.max(r1.left,r2.left),intersectionRect.bottom=Math.min(r1.bottom,r2.bottom),intersectionRect.right=Math.min(r1.right,r2.right),intersectionRect):intersectionRect},getCenterPoint:function(rect){return{x:(rect.left+rect.right)/2,y:(rect.top+rect.bottom)/2}},isPoint:function(point){return!Util.isUndefined(point)&&!Util.isUndefined(point.x)&&!Util.isUndefined(point.y)},isRect:function(rectCandidate){return!(Util.isUndefined(rectCandidate)||Util.isUndefined(rectCandidate.top)||Util.isUndefined(rectCandidate.bottom)||Util.isUndefined(rectCandidate.left)||Util.isUndefined(rectCandidate.right))},isCircle:function(circleCandidate){return!Util.isUndefined(circleCandidate)&&!Util.isUndefined(circleCandidate.x)&&!Util.isUndefined(circleCandidate.y)&&!Util.isUndefined(circleCandidate.radius)&&circleCandidate.radius>=0},isEqualRects:function(rect1,rect2,threshold){threshold||(threshold=10);var isEdgeEqual=function(e1,e2){return Math.abs(e1-e2)<threshold};return!(!Util.isRect(rect1)||!Util.isRect(rect2))&&(isEdgeEqual(rect1.top,rect2.top)&&isEdgeEqual(rect1.bottom,rect2.bottom)&&isEdgeEqual(rect1.left,rect2.left)&&isEdgeEqual(rect1.right,rect2.right))},isRectEmpty:function(rect){return!Util.isRect(rect)||(rect.right<=rect.left||rect.bottom<=rect.top)},isPointInRect:function(point,rect,logger){return logger=logger||LoggerUtilSettings.getEmptyLogger(),Util.isPoint(point)?Util.isRect(rect)?point.x>=rect.left&&point.x<=rect.right&&point.y>=rect.top&&point.y<=rect.bottom:(logger.error("isPointInRect: received invalid rect: ",rect),!1):(logger.error("isPointInRect: received invalid point: ",point),!1)},isPointInCircle:function(point,circle,logger){if(logger=logger||LoggerUtilSettings.getEmptyLogger(),!Util.isPoint(point))return logger.error("isPointInCircle: received invalid point: ",point),!1;if(!Util.isCircle(circle))return logger.error("isPointInCircle: received invalid circle: ",circle),!1;var dx=circle.x-point.x,dy=circle.y-point.y;return dx*dx+dy*dy<=circle.radius*circle.radius},isPointInPoly:function(point,coords,logger){if(logger=logger||LoggerUtilSettings.getEmptyLogger(),Util.isNullOrUndefined(coords)||!Array.isArray(coords))return logger.error("isPointInPoly: received invalid coords: ",coords),!1;var intersects=0,wherex=point.x,wherey=point.y,totalv=coords.length/2,totalc=2*totalv,xval=coords[totalc-2],yval=coords[totalc-1],end=totalc,pointer=1;for(yval>=wherey!=coords[pointer]>=wherey&&(xval>=wherex==coords[0]>=wherex?intersects+=xval>=wherex?1:0:intersects+=xval-(yval-wherey)*(coords[0]-xval)/(coords[pointer]-yval)>=wherex?1:0);pointer<end;)if(yval=coords[pointer],pointer+=2,yval>=wherey){for(;pointer<end&&coords[pointer]>=wherey;)pointer+=2;if(pointer>=end)break;coords[pointer-3]>=wherex==coords[pointer-1]>=wherex?intersects+=coords[pointer-3]>=wherex?1:0:intersects+=coords[pointer-3]-(coords[pointer-2]-wherey)*(coords[pointer-1]-coords[pointer-3])/(coords[pointer]-coords[pointer-2])>=wherex?1:0}else{for(;pointer<end&&coords[pointer]<wherey;)pointer+=2;if(pointer>=end)break;coords[pointer-3]>=wherex==coords[pointer-1]>=wherex?intersects+=coords[pointer-3]>=wherex?1:0:intersects+=coords[pointer-3]-(coords[pointer-2]-wherey)*(coords[pointer-1]-coords[pointer-3])/(coords[pointer]-coords[pointer-2])>=wherex?1:0}return 0!=(1&intersects)},getAgentNPObj:function(){return window.document.getElementById("__QTP__OBJ__")},assert:function(cond,msg,logger){cond||logger&&logger.error("ASSERT: "+msg)},generateQTPPropertyName:function(){return"__QTP__"+(new Date).getTime()},padLeft:function(n,ndigits){for(var num=""+n,zeros=ndigits-num.length;zeros>0;)num="0"+num,--zeros;return num},getTextNodesValue:function(node){if("SCRIPT"===node.tagName)return[];if(3===node.nodeType)return[node.nodeValue];var res=[];return Util.makeArray(node.childNodes).forEach(function(element){res=res.concat(Util.getTextNodesValue(element))}),res},cleanSpecialChars:function(strToClean){if("string"!=typeof strToClean)return strToClean;var cleanAttrVal=strToClean.replace(/\n|\r/gm,"");return cleanAttrVal=cleanAttrVal.replace(/\t/g," ")},cleanMultipleSpaces:function(strToClean){return"string"!=typeof strToClean?strToClean:strToClean.replace(/ +/g," ")},browserApplicationVersion:function(logger){if("undefined"==typeof navigator&&"function"==typeof require){var system=require("sdk/system");if(system){return system.vendor+" "+system.name+" "+system.version}}var browserVersion=Util._parseUserAgent(navigator.userAgent,logger);if(browserVersion)return browserVersion;var browserVersion=Util._guessBrowserFromVendorAndPlatform(navigator.vendor,navigator.platform,logger);return browserVersion||(logger&&logger.error("browserApplicationVersion: unable to detect browser"),"UnknownBrowser 0")},_parseUserAgent:function(userAgent,logger){var browserName,regex;if(-1!==userAgent.indexOf("OPR"))browserName="Opera",regex=/OPR\S+/;else if(-1!==userAgent.indexOf("Edge"))regex=/Edge\S+/,browserName="Edge";else if(-1!==userAgent.indexOf("PhantomJS"))regex=/PhantomJS\S+/,browserName="PhantomJS";else if(-1!==userAgent.indexOf("Chrome"))regex=/Chrome\S+/,browserName="Chrome";else if(-1!==userAgent.indexOf("Firefox"))regex=/Firefox\S+/,browserName="Mozilla Firefox";else if(-1!==userAgent.indexOf("Safari")&&-1!==userAgent.indexOf("Version"))regex=/Version\S+/,browserName="Safari";else if(-1!==userAgent.indexOf("JavaFX"))regex=/JavaFX\S+/,browserName="JavaFX";else{if(-1===userAgent.indexOf("iPhone")&&-1===userAgent.indexOf("iPad")&&-1===userAgent.indexOf("iPod"))return window._QTP.WebDriverInfo&&"chromeremotedebug"===window._QTP.WebDriverInfo.WebDriverType.toLowerCase()?"Chrome 0":(logger&&logger.warn("_parseUserAgent: unknown user agent: "+userAgent),null);regex=/\b(?:iPhone|iPad|iPod)\b.*?OS [\d_]+/,browserName="Safari"}var sVersion=regex.exec(userAgent);if(!sVersion)return logger&&logger.warn("_parseUserAgent: unable to parse user agent: "+userAgent),null;var sVersion=sVersion[0];sVersion=sVersion.replace("/"," "),sVersion=sVersion.replace(/_/g,"."),sVersion=sVersion.slice(sVersion.lastIndexOf(" ")+1);var version=sVersion.split(".");return browserName+" "+version[0]+"."+version[1]},_guessBrowserFromVendorAndPlatform:function(vendor,platform,logger){return null==vendor||null==platform?(logger&&logger.error("_guessBrowserFromVendorAndPlatform: missing vendor or platform values. vendor: "+vendor+" platform: "+platform),
null):vendor.match(/apple/i)&&platform.match(/(?:ipad|ipod|iphone)/i)?"Safari 0":(logger&&logger.warn("_guessBrowserFromVendorAndPlatform: unable to detect browser. vendor: "+vendor+" platform: "+platform),null)},jsonStringify:function(jsonObj,logger){return"undefined"==typeof JSON?(logger&&logger.error("jsonStringify: JSON is undefined"),null):null==JSON.stringify?(logger&&logger.error("jsonStringify: JSON.stringify is undefined"),null):JSON.stringify(jsonObj)},cleanTextProperty:function(text){return"string"!=typeof text?text:(text=Util.stringTrimLeft(text),text=text.replace(/\t/g," "),text=text.replace(/\r\n|\r|\n/g," "),text=text.replace(/ +/g," "),text=text.replace(/\xA0/g," "))},extend:function(obj,properties){return properties&&Object.keys(properties).forEach(function(key){obj[key]=properties[key]}),obj},calculateTabRect:function(pageDimensions,logger){function isEdgeMaximized(){return window.outerWidth-window.screen.availWidth==16&&window.outerHeight-window.screen.availHeight==16}logger&&logger.trace("calculateTabRect: pageDimensions: ",pageDimensions);var deltaWidth=pageDimensions.outerWidth>pageDimensions.innerWidth?pageDimensions.outerWidth-pageDimensions.innerWidth:0,deltaHeight=pageDimensions.outerHeight>pageDimensions.innerHeight?pageDimensions.outerHeight-pageDimensions.innerHeight:0,borderPixels=deltaWidth/2,rect={},window_rect=pageDimensions.window_rect;return rect.top=window_rect.top+deltaHeight-borderPixels,-1!=navigator.userAgent.indexOf("Edge")&&isEdgeMaximized()&&(rect.top-=(window.outerHeight-window.screen.availHeight)/2),rect.bottom=window_rect.top+pageDimensions.outerHeight,rect.left=window_rect.left+borderPixels,rect.right=window_rect.left+pageDimensions.outerWidth-borderPixels,rect},calculateTabRectByScreenAttribs:function(pageDimensions,logger){logger&&logger.trace("calculateTabRectByScreenAttribs: pageDimensions: ",pageDimensions);var screen_height=screen.height,screen_availheight=screen.availHeight,screen_availwidth=(screen.width,screen.availWidth),borderPixels=(screen_availwidth-pageDimensions.innerWidth)/2,signal_bar=screen_height-screen_availheight,address_bar=(screen_availheight-pageDimensions.innerHeight)/2,rect={},window_rect=pageDimensions.window_rect;return rect.top=window_rect.top+address_bar+signal_bar-borderPixels,rect.bottom=window_rect.top+screen_availheight,rect.left=window_rect.left+borderPixels,rect.right=window_rect.left+screen_availwidth-borderPixels,rect},getMicClass:function(ao){for(var micclass=ao.GetAttrSync("micclass");Array.isArray(micclass);)micclass=micclass[0];return micclass},isContainerMicclass:function(micclass){return"Browser"===micclass||"Page"===micclass||"Frame"===micclass},map:function(obj,func,thisArg){return thisArg=thisArg||this,Array.isArray(obj)?obj.map(func,thisArg):func.call(thisArg,obj)},objectFromArray:function(arr,value){var obj=Object.create(null);return arr.forEach(function(key){obj[key]=value}),obj},inherit:function(child,base,properties){var baseP=base.prototype;child.prototype=Object.create(baseP);var childP=child.prototype;childP.constructor=child,Util.extend(childP,properties)},functionStringify:function(func){return"function"!=typeof func?null:"("+func.toString()+")();"},convertXmlStrToJson:function(xmlDoc){return(new X2JS).xml_str2json(xmlDoc)},isInjectableUrl:function(url){return!!url&&!url.match(/^(?:chrome|opera|about|javascript):/)},traverseObject:function(obj,traverseVisitorFunc,parentPath){parentPath=parentPath||"";for(var nodeName in obj){if(!1===traverseVisitorFunc(obj,nodeName,parentPath))return;"object"==typeof obj[nodeName]&&null!=obj[nodeName]&&this.traverseObject(obj[nodeName],traverseVisitorFunc,parentPath+nodeName+"/")}},elemHasClass:function(elem,name){return elem.classList&&elem.classList.contains?elem.classList.contains(name):!!elem.className&&-1!=elem.className.split(/\s+/).indexOf(name)},setTimeout:function(func,timeout){var setTimeoutFunction;if("function"==typeof require)try{require("sdk/timers")&&(setTimeoutFunction=require("sdk/timers").setTimeout)}catch(e){}return setTimeoutFunction||"object"!=typeof window||(setTimeoutFunction=window.setTimeout),setTimeoutFunction=setTimeoutFunction||setTimeout,setTimeoutFunction.apply(null,arguments)},setInterval:function(func,timeout){var setIntervalFunction;if("function"==typeof require)try{require("sdk/timers")&&(setIntervalFunction=require("sdk/timers").setInterval)}catch(e){}return setIntervalFunction||"object"!=typeof window||(setIntervalFunction=window.setInterval),setIntervalFunction=setIntervalFunction||setInterval,setIntervalFunction.apply(null,arguments)},clearInterval:function(id_of_setinterval){var clearIntervalFunction;if("function"==typeof require)try{require("sdk/timers")&&(clearIntervalFunction=require("sdk/timers").clearInterval)}catch(e){}return clearIntervalFunction||"object"!=typeof window||(clearIntervalFunction=window.clearInterval),(clearIntervalFunction=clearIntervalFunction||clearInterval)(id_of_setinterval)},nodeContains:function(rootNode,otherNode){if(null==rootNode||null==otherNode)return!1;if(null!=rootNode.contains)return rootNode.contains(otherNode);if(rootNode===otherNode)return!0;if(rootNode.compareDocumentPosition)return!!(rootNode.compareDocumentPosition(otherNode)&Node.DOCUMENT_POSITION_CONTAINED_BY);for(var currentNode=otherNode.parentNode;currentNode;){if(currentNode===rootNode)return!0;currentNode=currentNode.parentNode}return!1},safeReplace:function(source,search,replacement){return source.replace(search,function(){return replacement})},findAncestor:function(element,pred){for(var elem=element;elem;elem=elem.parentElement)if(pred(elem))return elem},isExtEventRegistered:function(element,eventName){var attr=element.getAttribute("_uft_ext_events_hooked"),json=attr?JSON.parse(attr):null;return!(!json||!json.events)&&json.events.indexOf("on"+eventName.toLowerCase())>=0},startsWith:function(str,sub){return"string"==typeof str&&"string"==typeof sub&&(str.startsWith?str.startsWith(sub):0==str.indexOf(sub))},isFrameXSS:function(frameElem,containerWin){var frameSrc=frameElem.src;return Util.startsWith(frameSrc,"https")||Util.startsWith(frameSrc,"http")?Util.startsWith(frameSrc,containerWin.location.origin+"/"):"gap://ready"!==frameSrc},safeConsoleError:function(str){var func=console.error||console.log;func&&func.call(console,str)},safeConsoleWarn:function(str){var func=console.warn||console.log;func&&func.call(console,str)},valMatchReg:function(actualValue,expectReg){return new RegExp("^\\s*(?:"+expectReg+")\\s*$","i").test(actualValue)}},Constants={noCoordinate:-9999},RtIdUtils={IsRuntimeId:function(webId){return!!webId&&("object"==typeof webId&&("browser"in webId&&"page"in webId&&"frame"in webId&&"object"in webId&&(webId.browser>=-1&&webId.page>=-1&&webId.frame>=-1||(!!RtIdUtils.IsRTIDExtension(webId)||!!RtIdUtils.IsRTIDTestingTool(webId)))))},IsRTIDAgent:function(rtid){return-1===rtid.browser&&-1===rtid.page&&-1===rtid.frame&&null===rtid.object},IsRTIDBrowser:function(rtid){return-1!==rtid.browser&&-1===rtid.page&&-1===rtid.frame&&null===rtid.object},IsRTIDPage:function(rtid){return-1!==rtid.browser&&-1!==rtid.page&&-1===rtid.frame&&null===rtid.object},IsRTIDFrame:function(rtid){return-1!==rtid.browser&&-1!==rtid.page&&-1!==rtid.frame&&null===rtid.object},IsRTIDAO:function(rtid){return-1!==rtid.browser&&-1!==rtid.page&&-1!==rtid.frame&&null!==rtid.object},IsRTIDExtension:function(rtid){return RtIdUtils._IsRTIDEqualToControl(rtid,RtIdUtils.GetExtensionRtId())},IsRTIDTestingTool:function(rtid){return RtIdUtils._IsRTIDEqualToControl(rtid,RtIdUtils.GetTestingToolRtId())},IsRTIDDaemon:function(rtid){return RtIdUtils._IsRTIDEqualToControl(rtid,RtIdUtils.GetDaemonRtId())},_IsRTIDEqualToControl:function(rtid,controlRtId){return rtid.browser===controlRtId.browser&&rtid.page===controlRtId.page&&rtid.frame===controlRtId.frame&&!rtid.object},IsRTIDEqual:function(rtid1,rtid2){return!(!this.IsRuntimeId(rtid1)||!this.IsRuntimeId(rtid2))&&(rtid1.browser===rtid2.browser&&(rtid1.page===rtid2.page&&(rtid1.frame===rtid2.frame&&(!(!this.IsRTIDAO(rtid1)&&this.IsRTIDAO(rtid2)||this.IsRTIDAO(rtid1)&&!this.IsRTIDAO(rtid2))&&(rtid1.object===rtid2.object||rtid1.object.entry===rtid2.object.entry&&rtid1.object.frameCockie===rtid2.object.frameCockie)))))},GetExtensionRtId:function(){return{browser:-2,page:-2,frame:-2,object:null}},GetTestingToolRtId:function(){return{browser:-5,page:-5,frame:-5,object:null}},GetDaemonRtId:function(){return{browser:-7,page:-7,frame:-7,object:null}},GetAgentRtid:function(){return{browser:-1,page:-1,frame:-1,object:null}},GetBrowserRtid:function(rtid){var clonedRtid=Util.deepObjectClone(rtid);return this.IsRuntimeId(clonedRtid)&&(clonedRtid.page=-1,clonedRtid.frame=-1,clonedRtid.object=null),clonedRtid}},ReadyState2Status={unintialized:0,complete:4,loading:1,interactive:4};MultipleResponses.prototype={_logger:null,_numOfResponses:-1,callback:function(func){var self=this;return function(){--self._numOfResponses,self._logger.trace("callback called - waiting for ",self._numOfResponses);var done=0===self._numOfResponses;switch(arguments.length){case 0:return func.call(self,done);case 1:return func.call(self,done,arguments[0]);default:var args=[done].concat(Util.makeArray(arguments));return func.apply(self,args)}}}};var AttrPartialValueUtil={IsPartialValue:function(val){return val&&"partial"===val.type},WrapValue:function(attrName,val,attachedData){return{type:"partial",attr:attrName,value:val,data:attachedData}},GetValue:function(wrappedValue,logger){return logger=logger||LoggerUtilSettings.getEmptyLogger(),Util.assert(AttrPartialValueUtil.IsPartialValue(wrappedValue),"AttrPartialValueUtil.GetValue: Received an object which is not a wrapped Partial value",logger),wrappedValue.value},GetAttachedData:function(wrappedValue,logger){return logger=logger||LoggerUtilSettings.getEmptyLogger(),Util.assert(AttrPartialValueUtil.IsPartialValue(wrappedValue),"AttrPartialValueUtil.GetValue: Received an object which is not a wrapped Partial value",logger),wrappedValue.data}},StatusUtil={OK:"OK",OBJECT_NOT_FOUND:"ObjectNotFound",OBJECT_NOT_UNIQUE:"ObjectNotUnique",isUnexpected:function(status){if(!status)return!1;switch(status){case StatusUtil.OK:case StatusUtil.OBJECT_NOT_FOUND:case StatusUtil.OBJECT_NOT_UNIQUE:return!1}return!0}},ControlLearnType={Yes:0,No:1,IfChildren:2},ChildrenLearnType={Yes:0,No:1,LetMeSupply:2};"undefined"!=typeof exports&&(exports.Util=Util);var SpecialObject={_create:function(type,params){var ret={specialObj:!0,type:type};return params&&Util.extend(ret,params),ret},CreateDescription:function(description){return this._create("recorded_description",{description:description})},CreateDotObj:function(id){return this._create("object",{id:id})},CreateElementRequest:function(uid,asyncId){return this._create("DotObjMarkerElementRequest",{objUID:uid,dotUtilObjAsyncID:asyncId})},CreateDocumentRequest:function(asyncId){return this._create("DotObjMarkerDocumentRequest",{dotUtilObjAsyncID:asyncId})},CreateReferenceRequest:function(ref){return this._create("DotObjMarkerReferenceRequest",{objRef:ref})},CreateDotObjInHTML:function(cookie,asyncId){return this._create("DotObjInHTML",{cookie:cookie,dotUtilObjAsyncID:asyncId})},CreateMMFile:function(html){return this._create("writeMMFile",{html:html})},CreateFrameSource:function(path,source){return this._create("saveFrameSource",{fullPath:path,frameSource:source})},CreateTime:function(time){return this._create("UTCTime",{year:time.getUTCFullYear(),month:time.getUTCMonth()+1,day:time.getUTCDate(),hour:time.getUTCHours(),minute:time.getUTCMinutes(),second:time.getUTCSeconds(),milliseconds:time.getUTCMilliseconds()})},CreateAsyncRequest:function(cookie){return this._create("AsyncRequest",{cookie:cookie,onTimeout:null})},CreateProcessId:function(){return this._create("processId")},CreateEventId:function(event,id){return this._create("event id",{point:{x:event.clientX,y:event.clientY},name:event.type,sourceId:id,index:(new Date).getTime()%1e6})},CreateBase64:function(value){return this._create("Base64",{data:value})}},Description={_logger:new LoggerUtil("Common.Description"),GetIDsByDescription:function(desc,candidateFunc,optionalParamsObj,resultCallback){this._logger.trace("GetIDsByDescription: Started with the following description:",desc);var data=desc||{};delete data["Kit Id"],data.xpath&&delete data._xpath,data._xpath?(data.xpath=data._xpath,delete data._xpath,this.findObjId(data,candidateFunc,optionalParamsObj,function(children){this._logger.debug("GetIDsByDescription: using _xpath (",data.xpath,") returned ",children?children.length:"[undefined]"," matches"),delete data.xpath,Util.isUndefined(children)||1!==children.length?this.findObjId(data,candidateFunc,optionalParamsObj,resultCallback):resultCallback(children)}.bind(this))):this.findObjId(data,candidateFunc,optionalParamsObj,resultCallback)},GetIDsByDescriptionSync:function(desc,candidateFunc,optionalParamsObj){this._logger.trace("GetIDsByDescriptionSync: Started with the following description:",desc);var data=desc||{};if(delete data["Kit Id"],data.xpath&&delete data._xpath,data._xpath){data.xpath=data._xpath,delete data._xpath;var children=this.findObjIdSync(data,candidateFunc,optionalParamsObj);if(this._logger.debug("GetIDsByDescriptionSync: using _xpath (",data.xpath,") returned ",children?children.length:"[undefined]"," matches"),delete data.xpath,children&&1===children.length)return children}return this.findObjIdSync(data,candidateFunc,optionalParamsObj)},_removeDuplicateAOs:function(agentObjects){return Array.isArray(agentObjects)?agentObjects.filter(function(ao,index,arr){return Util.arrayFindIndex(arr,function(candidate){return candidate._elem===ao._elem})===index}):agentObjects},_findObjIdInternal:function(filterFunc,desc,candidateFunc,additionalParamsObj,resultCallback){this._logger.trace("_findObjIdInternal: Called"),additionalParamsObj=additionalParamsObj||{};var children=candidateFunc(desc);additionalParamsObj.extraAOs&&(children=children.concat(additionalParamsObj.extraAOs));var filter=additionalParamsObj.filter||Util.identity,filteredChildren=children.filter(filter);return additionalParamsObj.learn&&(filteredChildren=this._filterWebExtAOForLearn(filteredChildren)),filterFunc(filteredChildren,desc,resultCallback)},findObjId:function(desc,candidateFunc,additionalParamsObj,resultCallback){var self=this;this._findObjIdInternal(Description.filterAOList.bind(this),desc,candidateFunc,additionalParamsObj,function(resAOs){return resultCallback(self._removeDuplicateAOs(resAOs))})},findObjIdSync:function(desc,candidateFunc,additionalParamsObj){var aos=this._findObjIdInternal(Description.filterAOListSync.bind(this),desc,candidateFunc,additionalParamsObj);return this._removeDuplicateAOs(aos)},filterAOList:function(aos,filter,resultCallback){var resAOs=[],attrsNum=Object.keys(filter).length;if(aos.length*attrsNum==0)return void resultCallback(aos);var allAttrsResManager=new MultipleResponses(aos.length);aos.forEach(function(ao){var queryAttrs=this.transformFilter(filter),aoQueryMsg=new Msg("QUERY_ATTR",ao.getID(),queryAttrs);ao.onMessage(aoQueryMsg,allAttrsResManager.callback(function(doneForAllAOs,aoQueryMsgRes){this._logger.trace("filterAOList: Got following response message from the AO: ",aoQueryMsgRes),this._areAttrsEqual(aoQueryMsgRes._data,filter)&&resAOs.push(ao),doneForAllAOs&&resultCallback(resAOs)}.bind(this)))},this)},filterAOListSync:function(aos,filter){var attrsNum=Object.keys(filter).length;return 0===aos.length||0===attrsNum?aos:aos.filter(function(ao){var queryAttrs=this.transformFilter(filter),attrsValResult=ao.QueryAttributesSync(queryAttrs);return this._logger.trace("filterAOList: Got the following response message from the AO: ",attrsValResult),this._areAttrsEqual(attrsValResult,filter)},this)},_areAttrsEqual:function(attrVals,otherAttrVals){return!Object.keys(attrVals).some(function(attrName){var attrValue=attrVals[attrName],otherAttrValue=otherAttrVals[attrName];if(!(this._MatchFunctions[attrName]?this._MatchFunctions[attrName](attrValue,otherAttrValue,this._logger):this._MatchFunctions.matchByValType(attrValue,otherAttrValue,this._logger)))return!0},this)},transformFilter:function(filter){var res_filter={};return Object.keys(filter).forEach(function(field){switch(field){case"":case"url without form data":break;case"WEB_PN_ID":("string"==typeof filter.WEB_PN_ID||filter.WEB_PN_ID&&filter.WEB_PN_ID.isRegExp)&&(res_filter.WEB_PN_ID=filter.WEB_PN_ID);break;case"attribute":case"style":var attr_pairs=filter[field];res_filter[field]=[],attr_pairs.forEach(function(attr_pair){var attributeName=attr_pair[0].regExQuery||attr_pair[0];res_filter[field].push(attributeName)});break;default:res_filter[field]=filter[field]}}),res_filter},_Selectors:[function(desc,output,rootElem){var name="html tag";if(desc[name]&&!desc.xpath&&!desc.css&&!desc[name].isRegExp){var root=rootElem||document;output.push(Util.makeArray(root.getElementsByTagName(desc[name]))),delete desc[name]}},function(desc,output,rootElem){var name="xpath";if(desc[name]){var root=rootElem||document,it=document.evaluate(desc[name].regExQuery||desc[name],root,null,XPathResult.ANY_TYPE,null);delete desc[name];for(var e,elements=[];e=it.iterateNext();)elements.push(e);output.push(elements)}},function(desc,output,rootElem){var name="css";if(desc[name]){var root=rootElem||document;output.push(Util.makeArray(root.querySelectorAll(desc[name].regExQuery||desc[name]))),delete desc[name]}}],GetCandidateElements:function(desc,rootElem){var selectorsMatches=[];switch(this._Selectors.forEach(function(selectorFunc){selectorFunc(desc,selectorsMatches,rootElem)}),selectorsMatches.length){case 0:var root=rootElem||document;return Util.makeArray(root.getElementsByTagName("*"));case 1:return selectorsMatches[0]}selectorsMatches.forEach(function(arr){arr.forEach(function(elem){elem._FitSelectorCount=(elem._FitSelectorCount||0)+1})});var ret=selectorsMatches[0].filter(function(elem){return elem._FitSelectorCount===selectorsMatches.length});return selectorsMatches.forEach(function(arr){arr.forEach(function(elem){delete elem._FitSelectorCount})}),ret},GetCandidateAOsForContent:function(parentID,optionalRootElem,desc){var micclass,elements=this.GetCandidateElements(desc,optionalRootElem);return desc&&(micclass=desc.micclass),elements.map(function(e){return content.kitsManager.createAO(e,parentID,!1,micclass)})},_MatchFunctions:{matchByValType:function(actualVal,expectedVal,logger){return!Util.isNullOrUndefined(actualVal)&&!Util.isNullOrUndefined(expectedVal)&&(AttrPartialValueUtil.IsPartialValue(expectedVal)?this.partialValueMatch(actualVal,expectedVal,logger):Util.isRect(expectedVal)?this.rectangleMatch(actualVal,expectedVal,logger):expectedVal.isRegExp?this.regExMatch(actualVal,expectedVal,logger):this.stringVals(actualVal,expectedVal,logger))},micclass:function(actualVal,expectedVal,logger){expectedVal=expectedVal.regExQuery||expectedVal,expectedVal=expectedVal.toUpperCase(),actualVal=Array.isArray(actualVal)?actualVal:[actualVal];var filtered=actualVal.filter(function(actualMicClass){return actualMicClass.toUpperCase()===expectedVal}),match=filtered.length>0;return logger&&logger.debug("_MatchFunctions.micclass: perform case-insensitive check between '",actualVal,"' and '",expectedVal,"'. Match: ",match),match},regExMatch:function(actualVal,expectedVal,logger){return logger&&logger.debug("matchAttr: Match is regular expression with:",expectedVal.regExQuery),Util.valMatchReg(actualVal,expectedVal.regExQuery)},rectangleMatch:function(actualVal,expectedVal){return Util.isEqualRects(expectedVal,actualVal)},partialValueMatch:function(actualVal,expectedVal,logger){return!(!AttrPartialValueUtil.IsPartialValue(actualVal)||!AttrPartialValueUtil.IsPartialValue(expectedVal))&&this.matchByValType(AttrPartialValueUtil.GetValue(actualVal),AttrPartialValueUtil.GetValue(expectedVal),logger)},attribute:function(actualVal,expectedVal,logger){return this.matchAttributeOrStyle(actualVal,expectedVal,logger)},style:function(actualVal,expectedVal,logger){return this.matchAttributeOrStyle(actualVal,expectedVal,logger)},matchAttributeOrStyle:function(actualVal,expectedVal,logger){return actualVal=Array.isArray(actualVal)?actualVal:[actualVal],expectedVal=Array.isArray(expectedVal)?expectedVal:[expectedVal],Util.assert(actualVal.length===expectedVal.length,"There are different number of values in actual from expected",logger),!expectedVal.some(function(expectedPropVal,propIndex){if(expectedPropVal=expectedPropVal[1],!this.matchByValType(actualVal[propIndex],expectedPropVal,logger))return!0},this)},stringVals:function(actualVal,expectedVal){return actualVal.trim&&(actualVal=actualVal.trim()),expectedVal.trim&&(expectedVal=expectedVal.trim()),actualVal.toUpperCase&&expectedVal.toUpperCase?actualVal.toUpperCase()===expectedVal.toUpperCase():actualVal===expectedVal},disabled:function(actualVal,expectedVal){return actualVal==expectedVal}},buildReturnMsg:function(msgType,to,aos,logger){var resMsg=new Msg(msgType,to,{WEB_PN_ID:[]});switch(aos.length){case 0:logger&&logger.trace("buildReturnMsg: Object not found"),resMsg._data.WEB_PN_ID=[],resMsg.status="ObjectNotFound";break;case 1:logger&&logger.trace("buildReturnMsg: Object is found"),resMsg._data.WEB_PN_ID=[aos[0].getID()];break;default:resMsg._data.WEB_PN_ID=[];for(var id_set={},i=0;i<aos.length;++i){var id=aos[i].getID(),strID=JSON.stringify(id);id_set[strID]||(id_set[strID]=!0,resMsg._data.WEB_PN_ID.push(id))}resMsg.status=resMsg._data.WEB_PN_ID.length>1?"ObjectNotUnique":"OK"}return resMsg},getAttributeInfo:function(propertyFullName){var seperatorIndex=propertyFullName.indexOf("/");return seperatorIndex<0?{name:propertyFullName.toLowerCase(),data:null}:{name:propertyFullName.substring(0,seperatorIndex).toLowerCase(),data:propertyFullName.substring(seperatorIndex+1)}},_getAttrsFromIdentificationProps:function(identificationAttributesObj,attributeCategory){this._logger.trace("_getAttrsFromIdentificationProps: started");var attrTypeKeys;attrTypeKeys=attributeCategory?Array.isArray(attributeCategory)?attributeCategory:[attributeCategory]:["mandatory","assistive","baseFilter","optionalFilter"];var attrObj={};return attrTypeKeys.forEach(function(attrType){identificationAttributesObj[attrType].forEach(function(attr){attrObj[attr]=null},this)},this),attrObj},createRecordDescription:function(agentObject,objIdentificationProps){this._logger.trace("createRecordDescription: started");var descriptionObj={},micclass=Util.getMicClass(agentObject);descriptionObj["logical name"]=this._getLogicalName(agentObject),descriptionObj.properties=this._getMandatoryProperties(agentObject,objIdentificationProps);for(var key in descriptionObj.properties)Util.isNullOrUndefined(descriptionObj.properties[key])&&delete descriptionObj.properties[key];var aoArr=[];if(Util.isContainerMicclass(micclass)){if("Frame"===micclass||"Browser"===micclass){var assistiveAttrsObj=Description._getAttrsFromIdentificationProps(objIdentificationProps,"assistive");Object.keys(assistiveAttrsObj).length>0&&(assistiveAttrsObj=agentObject.QueryAttributesSync(assistiveAttrsObj),Util.extend(descriptionObj.properties,assistiveAttrsObj))}}else aoArr=Description.GetIDsByDescriptionSync(Util.shallowObjectClone(descriptionObj.properties),Description.GetCandidateAOsForContent.bind(Description,agentObject.getID(),null),null),Util.assert(aoArr.length>0,"createRecordDescription: mandatory description returned no matches for micclass: "+micclass,this._logger),this._logger.trace("createRecordDescription: Received AO # ",aoArr.length);if(aoArr.length>1){var aoArrWithAssistive=this._getAOArrayWithAssistiveProperties(descriptionObj.properties,agentObject,objIdentificationProps);null!==aoArrWithAssistive&&(aoArr=aoArrWithAssistive),this._logger.trace("createRecordDescription: Added Assistive properties to description: ",descriptionObj),Util.assert(aoArr.length>0,"createRecordDescription: after assistive description, GetIDsByDescriptionSync returned no matches for micclass: "+micclass,this._logger)}return(aoArr.length>1||"Frame"===micclass)&&(descriptionObj.selector=this._getSelector(objIdentificationProps.selector,agentObject,aoArr)),descriptionObj["smart identification properties"]=this._getSmartIdProperties(objIdentificationProps,agentObject),descriptionObj.additionalInfo=this._getAdditionalInfoProperties(objIdentificationProps,agentObject),this._isXpathSupported(agentObject)&&(descriptionObj.properties._xpath=agentObject.GetAttrSync("_xpath")),descriptionObj.properties.micclass=micclass,SpecialObject.CreateDescription(descriptionObj)},createTestObjectDescription:function(agentObject,objIdentificationProps,callback){this._logger.trace("createTestObjectDescription: started");var descSpecialObject=Description.createRecordDescription(agentObject,objIdentificationProps),description=descSpecialObject.description;if(this._logger.info("Test object original description:",description),"Frame"===Util.getMicClass(agentObject)){var msg=new Msg("SRVC_FIX_FRAME_DESCRIPTION",agentObject.getID(),{description:description});return void agentObject.onMessage(msg,function(resMsg){descSpecialObject.description=resMsg._data.description,callback(descSpecialObject)}.bind(this))}this._fixPartialValuesForDescription(agentObject,description,function(updatedDescription){descSpecialObject.description=updatedDescription,callback(descSpecialObject)})},_fixPartialValuesForDescription:function(agentObject,description,callback){this._logger.trace("_fixPartialValuesForDescription: started");var queryAttrObj={};if(Object.keys(description.properties).forEach(function(prop){AttrPartialValueUtil.IsPartialValue(prop)&&(queryAttrObj[prop]=null)}),Object.keys(description["smart identification properties"]).forEach(function(prop){AttrPartialValueUtil.IsPartialValue(prop)&&(queryAttrObj[prop]=null)}),this._logger.trace("PartialValue is queryAttrObj = ",queryAttrObj),0==Object.keys(queryAttrObj).length)callback(description);else{var queryAttrMsg=new Msg("QUERY_ATTR",agentObject.getID(),queryAttrObj);agentObject.onMessage(queryAttrMsg,function(resMsg){Object.keys(resMsg._data).forEach(function(propName){description.properties[propName]&&(description.properties.propName=resMsg._data.propName),description["smart identification properties"].propName&&(description["smart identification properties"].propName=resMsg._data.propName)}),callback(description)})}},_isXpathSupported:function(agentObject){return!(Util.isContainerMicclass(Util.getMicClass(agentObject))||!Util.isNullOrUndefined(agentObject._control))},createEmptyRecordDescription:function(ao){this._logger.trace("createEmptyRecordDescription: called");var micclass=Util.getMicClass(ao);return{"logical name":micclass,"smart identification properties":{},properties:{micclass:micclass},selector:null}},_getMandatoryProperties:function(agentObject,objIdentificationProps){this._logger.trace("_getMandatoryProperties: called");var micclass=Util.getMicClass(agentObject),mandatoryAttrsObj=Description._getAttrsFromIdentificationProps(objIdentificationProps,"mandatory");return mandatoryAttrsObj=agentObject.QueryAttributesSync(mandatoryAttrsObj),mandatoryAttrsObj.micclass=micclass,mandatoryAttrsObj},_getLogicalName:function(agentObject){this._logger.trace("_getLogicalName: called");var logicalName=agentObject.GetAttrSync("logical name")||"";if(logicalName=logicalName.trim(),0===logicalName.length)return Util.getMicClass(agentObject);logicalName=logicalName.substring(0,30);var indexOfWhitespace=logicalName.indexOf(" ",21);return indexOfWhitespace>=0&&(logicalName=logicalName.substring(0,indexOfWhitespace)),logicalName=logicalName.replace(/\"/g,"'"),logicalName=logicalName.replace(/:=/g,":-"),logicalName=logicalName.replace(/@@/g,"@-")},_getSelector:function(selector,agentObject,candidateAoArr){this._logger.trace("_getSelector: called for selector: ",selector);var selectorValue;return"index"===selector?selectorValue=Description._getIndexOrdinal(agentObject,candidateAoArr):this._logger.error("_getSelector default case for selector ",selector),this._logger.trace("_getSelector: Adding Selector '",selector,"' with value: ",selectorValue),{name:selector,value:selectorValue}},_isForceAddingFrameSelector:function(){return window.frames.length>0},_getIndexOrdinal:function(agentObject,candidateAoArr){this._logger.trace("_getIndexOrdinal: called.");var rtidToFind=agentObject.getID();if("Frame"===Util.getMicClass(agentObject))return AttrPartialValueUtil.WrapValue("index",null,{frameRtid:rtidToFind,forceSelector:this._isForceAddingFrameSelector()});var index=Util.arrayFindIndex(candidateAoArr,function(elem){return RtIdUtils.IsRTIDEqual(rtidToFind,elem.getID())},this);return Util.assert(-1!==index,"_getIndexOrdinal: finding the index of the runtime id failed",this._logger),index},_getAOArrayWithAssistiveProperties:function(propertiesObj,agentObject,objIdentificationProps){this._logger.trace("_getAOArrayWithAssistiveProperties: called");for(var assistiveAttrNamesArr=objIdentificationProps.assistive,length=assistiveAttrNamesArr.length,aoArr=null,i=0;i<length;i++){var attr=assistiveAttrNamesArr[i],attrVal=agentObject.GetAttrSync(attr);if(propertiesObj[attr]=attrVal,aoArr=Description.GetIDsByDescriptionSync(Util.shallowObjectClone(propertiesObj),Description.GetCandidateAOsForContent.bind(Description,agentObject.getID(),null),null),Util.assert(aoArr.length>0,"_getAssistiveProperties: GetIDsByDescriptionSync returned no matches for attrs: "+JSON.stringify(propertiesObj),this._logger),1===aoArr.length)break}return aoArr},_getSmartIdProperties:function(objIdentificationProps,agentObject){this._logger.trace("_getSmartIdProperties: called.");var smartIdProps=Description._getAttrsFromIdentificationProps(objIdentificationProps,["baseFilter","optionalFilter"]);return smartIdProps=agentObject.QueryAttributesSync(smartIdProps),smartIdProps.micclass=Util.getMicClass(agentObject),smartIdProps},_getAdditionalInfoProperties:function(objIdentificationProps,agentObject){this._logger.trace("_getAdditionalInfoProperties: called.");var additionalInfoProps={};return objIdentificationProps.additionalInfo&&(additionalInfoProps=Description._getAttrsFromIdentificationProps(objIdentificationProps,["additionalInfo"]),additionalInfoProps=agentObject.QueryAttributesSync(additionalInfoProps)),additionalInfoProps},_filterWebExtAOForLearn:function(aoList){aoList=aoList.reverse();for(var aoDeleteMask=[],index=0;index<aoList.length;++index){var ao=aoList[index];switch(ao.getChildrenLearnType()){case ChildrenLearnType.No:for(var i2=0;i2<index;++i2){var ao2=aoList[i2];!aoDeleteMask[i2]&&Util.nodeContains(ao._elem,ao2._elem)&&(aoDeleteMask[i2]=!0)}break;case ChildrenLearnType.LetMeSupply:for(var childrenSupplied=ao.getChildrenForLearn(ao._elem)||[],i2=0;i2<index;++i2){var ao2=aoList[i2];!aoDeleteMask[i2]&&Util.nodeContains(ao._elem,ao2._elem)&&childrenSupplied.indexOf(ao2._elem)<0&&(aoDeleteMask[i2]=!0)}}}aoList=aoList.filter(function(ao,index){return!aoDeleteMask[index]}),aoDeleteMask=[];for(var index=0;index<aoList.index;++index){var ao=aoList[index];switch(ao.getControlLearnType()){case ControlLearnType.No:aoDeleteMask[index]=!0;break;case ControlLearnType.IfChildren:for(var hasValidChild=!1,i2=0;i2<index;++i2)if(!aoDeleteMask[i2]&&Util.nodeContains(ao._elem,aoList[i2]._elem)){hasValidChild=!0;break}aoDeleteMask[i2]=!hasValidChild}}return aoList=aoList.filter(function(ao,index){return!aoDeleteMask[index]}),aoList.reverse()}};WebIdContainer.prototype={_logger:null,_container:null,add:function(idToAdd,objectWithId){if(this._logger.trace("WebIdContainer.add: Called"),!this._validateId(idToAdd))return void this._logger.error("WebIdContainer.add: Id NOT valid, unable to add to container.");if(!objectWithId)return void this._logger.error("WebIdContainer.add: object is invalid");try{var idArray=this._getArrayRepresentationOfId(idToAdd);this._createObjectPath(this._container,idArray);this._getObjectContainerByPath(this._container,idArray)[idArray.length-1]=objectWithId
}catch(e){throw this._logger.error("WebIdContainer.add: Failed.\nStack:"+e.stack),e}},remove:function(idToRemove){this._logger.trace("WebIdContainer.remove: Called on ",idToRemove);try{return this._getObject(idToRemove,!0)}catch(e){throw this._logger.error("WebIdContainer.remove: Failed on ",idToRemove,"\nStack:",e.stack),e}},find:function(idToFind){this._logger.trace("WebIdContainer.find: Called on ",idToFind);try{return this._getObject(idToFind,!1)}catch(e){throw this._logger.error("WebIdContainer.find: Failed on ",idToFind,"\nStack:",e.stack),e}},_createObjectPath:function(containerArr,pathArray){0!==pathArray.length&&(containerArr[pathArray[0]]||(containerArr[pathArray[0]]=[]),this._createObjectPath(containerArr[pathArray[0]],pathArray.slice(1)))},_getObjectContainerByPath:function(containerArray,pathArray){return containerArray[pathArray[0]]?1===pathArray.length?containerArray:this._getObjectContainerByPath(containerArray[pathArray[0]],pathArray.slice(1)):null},_validateId:function(webId){return RtIdUtils.IsRuntimeId(webId)},_getArrayRepresentationOfId:function(id){var agentObjId=-1;return null!==id.object&&(agentObjId=id.object.entry),[id.browser,id.page,id.frame,agentObjId]},_getObject:function(objectId,isRemoveFromContainer){if(!this._validateId(objectId))return this._logger.error("WebIdContainer._getObject: Id NOT valid. _getObject failed."),null;var idArray=this._getArrayRepresentationOfId(objectId),lastLevelArray=this._getObjectContainerByPath(this._container,idArray);if(!lastLevelArray)return this._logger.trace("WebIdContainer._getObject: Id ",objectId," not found in container."),null;var lastIndex=idArray.length-1,objToBeRemoved=lastLevelArray[lastIndex];return isRemoveFromContainer&&(lastLevelArray[lastIndex]=null),objToBeRemoved}},AsyncCommunicationHelper.prototype={_logger:null,_pendingAckForAsynMsgs:[],_timerID:-1,_nextMessageID:0,_listeners:null,_options:null,updateMessageWithNeededInfo:function(msg){Util.isUndefined(msg._ComAsyncInfo)||this._logger.error("updateMessageWithNeededInfo: there is already asyncID on this message please handle it"),msg._ComAsyncInfo={id:++AsyncCommunicationHelper.prototype._nextMessageID}},addAsyncMsgToQueue:function(msg,destinationChannelId){this._logger.trace("addAsyncMsgToQueue: Started"),this._pendingAckForAsynMsgs.push({msg:msg,sendTime:new Date,destinationChannel:destinationChannelId}),-1===this._timerID&&(this._timerID=Util.setInterval(this.onResendTimer.bind(this),this._options.timeout)),this._logger.trace("addAsyncMsgToQueue: Finished")},onAckForAsyncMsg:function(msg){this._logger.trace("onAckForAsyncMsg: Started for message id:"+msg._ComAsyncInfo.id),this.removeMessageFromAsyncQueue(msg),this._logger.trace("onAckForAsyncMsg: Finished")},removeMessageFromAsyncQueue:function(msg){this._logger.trace("removeMessageFromAsyncQueue: Started");var foundMsg=this._pendingAckForAsynMsgs.filter(function(queuedMsg){return!(!queuedMsg.msg._ComAsyncInfo||!msg._ComAsyncInfo)&&queuedMsg.msg._ComAsyncInfo.id===msg._ComAsyncInfo.id});if(1!==foundMsg.length)return void this._logger.error("removeMessageFromAsyncQueue: Async message not queued or there is too manay of them length=",foundMsg.length,"\nCurrent Message:",msg,"\nAsync Queue:",this._pendingAckForAsynMsgs);var elementIndex=this._pendingAckForAsynMsgs.indexOf(foundMsg[0]);this._pendingAckForAsynMsgs.splice(elementIndex,1),0===this._pendingAckForAsynMsgs.length&&(Util.clearInterval(this._timerID),this._timerID=-1),delete msg._ComAsyncInfo,this._logger.trace("removeMessageFromAsyncQueue: End")},addListener:function(eventName,listenerObj){this._logger.info("addListener: called"),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerObj)},removeListener:function(eventName,listenerObj){if(this._logger.info("removeListener: called"),!this._listeners[eventName])return void this._logger.error("removeListener: Trying to remove listener that is not registered");var listenerIdx=this._listeners[eventName].indexOf(listenerObj);if(-1===listenerIdx)return void this._logger.error("removeListener: Removing unknown listener");this._inMiddleOfEvent?this._listeners[eventName][listenerIdx].toBeDeleted=!0:this._listeners[eventName].splice(listenerIdx,1)},dispatchEvent:function(eventName){var args=Util.makeArray(arguments);args.splice(0,1);var funcName="on"+eventName,listeners=this._listeners[eventName];this._inMiddleOfEvent=!0;for(var i=0;i<listeners.length;++i)listeners[i].toBeDeleted||listeners[i][funcName].apply(listeners[i],args);delete this._inMiddleOfEvent,this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return!listener.toBeDeleted})},setAckMessage:function(msg){msg._ComAsyncInfo&&msg._ComAsyncInfo.id&&(this._logger.trace("setAckMessage: Started for message id:"+msg._ComAsyncInfo.id),this.removeMessageFromAsyncQueue(msg),this._logger.trace("setAckMessage: Finished"))},onResendTimer:function(){this._logger.trace("onResendTimer: Started");var timedoutMessages=this._pendingAckForAsynMsgs.filter(function(waitingForAckMsg){return(new Date).getTime()-waitingForAckMsg.sendTime.getTime()>=this._options.timeout},this);this.notifyTimedOutMessages(timedoutMessages),this._logger.trace("onResendTimer: Finished")},onDestinationHasDisconnected:function(destinationId){this._logger.info("onDestinationHasDisconnected:",destinationId," Has disconnected");var pendingMessages=this._pendingAckForAsynMsgs.filter(function(pendingMessgaeInfo){return null!=pendingMessgaeInfo.destinationChannel&&pendingMessgaeInfo.destinationChannel===destinationId},this);this.notifyTimedOutMessages(pendingMessages),this._logger.trace("onDestinationHasDisconnected: finished")},notifyTimedOutMessages:function(timedoutMessages){timedoutMessages.forEach(function(timedOutMessage){this.removeMessageFromAsyncQueue(timedOutMessage.msg),this.dispatchEvent("MessageTimedOut",timedOutMessage.msg)},this)},getPendingMsgs:function(targetId){return this._pendingAckForAsynMsgs.filter(function(waitingForAckMsg){return waitingForAckMsg.msg.targetId===targetId}).map(function(waitingForAckMsg){return waitingForAckMsg.msg})},_initializeOptions:function(options){options=options||{},this._options={timeout:options.timeout||2e3}}},EventDispatcher.prototype={_listeners:null,addListener:function(eventName,listenerFunction){this._logger.trace("addListener: called for event "+eventName),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerFunction)},removeListener:function(eventName,listenerFunction){if(this._logger.trace("removeListener: called for event "+eventName),!this._listeners[eventName]||-1===this._listeners[eventName].indexOf(listenerFunction))return void this._logger.warn("removeListener: Trying to remove listener that is not registered");this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return listener!==listenerFunction})},removeAllListeners:function(){this._logger.info("removeAllListeners: called"),this._listeners=[]},_dispatchEvent:function(eventName){if(this._logger.trace("_dispatchEvent: called for event: "+eventName),!this._listeners[eventName])return void this._logger.info("_dispatchEvent: no listeners found for event: "+eventName);var args=Util.makeArray(arguments).slice(1);this._listeners[eventName].forEach(function(listener){listener.apply(listener,args)})}},"undefined"!=typeof exports&&(exports.EventDispatcher=EventDispatcher),MessageChannelComChannel.prototype={id:-1,_listeners:null,_knownTargets:[],_asyncHelper:null,_nextContentContextId:0,_connectionReceivedIds:{},_mode:null,_logger:null,_pageProxies:[],_messageChannel:null,_clientTabId:null,init:function(){switch(this._logger.trace("init called"),this._mode){case"content":this._logger.trace("init started listening for Content messages"),this._messageChannel=new MessageChannel,this._messageChannel.port1.onmessage=this._onMessage.bind(this),this._messageChannel.port1.start();break;case"extension":this._logger.trace("init started listening for Extension messages"),window.addEventListener("message",this._onMessage.bind(this),!1);break;default:this._logger.error("init: Unsupported context! init failed.")}},_sendMessageHelper:function(msg){this._logger.trace("sendMessage: send to: ",msg.targetId," - message:",msg);var proxy=null,shouldUseSyncDispatching=!1;switch(this._mode){case"content":proxy=this._messageChannel.port1,MessageChannelComChannel.prototype._ext&&(shouldUseSyncDispatching=!0);break;case"extension":this._knownTargets[msg.targetId]&&(proxy=this._knownTargets[msg.targetId]),MessageChannelComChannel.prototype._content&&MessageChannelComChannel.prototype._content.id===msg.targetId&&(shouldUseSyncDispatching=!0)}return proxy?(this._updateMessageWithNeededInfo(msg),shouldUseSyncDispatching?void this._sendMessageInThisContext(proxy,msg):(-1===this.id||this.id>=1?this._doPostMessage(proxy,msg):this._logger.trace("sendMessage: ComChannel still not ready. Message sending is delayed"),void this._addRequestAsyncMsgToQueue(msg))):void this._logger.error("sendMessage: No Proxy found. Returning - sending message failed !")},_sendMessageInThisContext:function(proxy,msgToSend){this._logger.trace("_sendMessageInThisContext: sending message locally");var otherMessageChannel="extension"===this._mode?MessageChannelComChannel.prototype._content:MessageChannelComChannel.prototype._ext;this._addRequestAsyncMsgToQueue(msgToSend),otherMessageChannel._onMessage({data:msgToSend,srcElement:proxy})},_envelopeMsg:function(msgData,client,type,msgEv){this._logger.trace("_envelopeMsg: called");var targetId="content"===this._mode?-1:client,theMsg=msgEv||{};return theMsg.sourceId=this.id,theMsg.data=msgData,theMsg.targetId=targetId,theMsg.client=client,theMsg.type=type,theMsg},sendMessage:function(msg,destTargetId){this._logger.trace("sendMessage: called");var msgToSend=this._envelopeMsg(msg,destTargetId,"request");this._sendMessageHelper(msgToSend)},sendEvent:function(msg,destTargetId){this._logger.trace("sendEvent: called");var msgToSend=this._envelopeMsg(msg,destTargetId,"event");this._sendMessageHelper(msgToSend)},addListener:function(eventName,listenerFunction){this._logger.trace("addListener: called for event: "+eventName),this._listeners[eventName]||(this._listeners[eventName]=[]),-1===this._listeners[eventName].indexOf(listenerFunction)&&this._listeners[eventName].push(listenerFunction)},removeListener:function(eventName,listenerFunction){if(this._logger.trace("removeListener: called"),!this._listeners[eventName])return void this._logger.trace("removeListener: Trying to remove listener that is not registered");this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return listener!==listenerFunction})},dispatchEvent:function(eventName,client){this._logger.trace("dispatchEvent: called for event "+eventName);var args=Util.makeArray(arguments).slice(2);"function"==typeof args[args.length-1]?args.splice(args.length-1,0,client):args.push(client),this._listeners[eventName]&&this._listeners[eventName].forEach(function(listener){listener.apply(this,args)})},_onMessage:function(msgEv){var msgData=msgEv.data;if(msgData.targetId&&msgData.targetId===this.id)switch(this._logger.trace("_onMessage: Received a message from: ",msgData.sourceId," - the msg: ",msgData),msgData.type){case"connect":this._onConnect(msgData,msgEv.ports[0]);break;case"connectResponse":this._onConnectResponse(msgData);break;case"disconnect":this._onDisconnect(msgData,msgEv.srcElement);break;case"response":this._setAckMessage(msgData);case"event":this._logger.trace("_onMessage: This is response message: sourceId="+msgData.sourceId+" , targetId="+msgData.targetId),this.dispatchEvent(msgData.type,this._getClient(msgEv.srcElement,msgData.sourceId),msgData.data);break;case"request":this._logger.trace("_onMessage: This is request message"),this._handleRequest(this._getClient(msgEv.srcElement,msgData.sourceId),msgEv);break;default:this._logger.trace("_onMessage: unhandled message format: "+msgData.type)}},connect:function(){switch(this._logger.trace("connect: called"),this._mode){case"extension":break;case"content":var connectMsg={type:"connect",sourceId:this.id,targetId:-1,_debugInfo:{url:location.href}};this._logger.trace("connect: dispatching connect message: ",connectMsg),window.top.postMessage(connectMsg,"*",[this._messageChannel.port2])}},disconnect:function(){switch(this._logger.trace("disconnect: called "),this._mode){case"extension":this._logger.error("disconnect: houston we have a problem");break;case"content":var disconnectMsg={type:"disconnect",sourceId:this.id,targetId:-1,_debugInfo:{url:location.href}};this._logger.trace("disconnect: dispatching Disconnect message: ",disconnectMsg),this._doPostMessage(this._messageChannel.port1,disconnectMsg)}},_onConnect:function(message,port){this._logger.trace("_onConnect: called with request: ",message);var returnMsg={type:"connectResponse",targetId:message.sourceId,sourceId:this.id};if(this._connectionReceivedIds[message.sourceId])this._logger.info("_onConnect: Received two connection requests from the same content: "+message.sourceId+" which was already given the value: "+this._connectionReceivedIds[message.sourceId]),returnMsg.allocatedId=this._connectionReceivedIds[message.sourceId];else if(message.sourceId>=1)this._logger.info("_onConnect: Received a connection request from an already intialized frame: "+message.sourceId),returnMsg.allocatedId=message.sourceId,this._knownTargets[message.sourceId].onmessage=null,this._knownTargets[message.sourceId]=port,this._knownTargets[message.sourceId].onmessage=this._onMessage.bind(this);else{var newClientId=this._setTargetId(port);this._logger.trace("_onConnect: Newly Connected Target Id: "+newClientId),port.onmessage=this._onMessage.bind(this),this._knownTargets[newClientId]=port;var client=this._getClient(port,newClientId);this._logger.debug("_onConnect: dispatching 'clientConnected' to ",client),this.dispatchEvent("clientConnected",client),this._connectionReceivedIds[message.sourceId]=newClientId,returnMsg.allocatedId=newClientId}this._logger.trace("_onConnect: dispatching connection response: ",returnMsg),this._doPostMessage(port,returnMsg)},_onConnectResponse:function(message){this._logger.trace("_onConnectResponse: Connection Response: ",message),Util.assert(this.id<1||this.id===message.allocatedId,"_onMessage: connectResponse: received id: "+message.allocatedId+" while my id is: "+this.id,this._logger),this.id=message.allocatedId,this.dispatchEvent("connected",this.id)},_onDisconnect:function(message,target){this._logger.trace("_onDisconnect: Received Disconnection From: ",message);var clientId=message.sourceId;if(Util.assert(clientId>=0,"_onDisconnect: Error while trying to disconnect - received an invalid sourceId: "+clientId,this._logger),!(clientId<1)||(this._logger.info("_onDisconnect: Received a disconnection request from a Frame that didn't initialize yet: "+clientId+" - overriding the id with: "+this._connectionReceivedIds[clientId]),clientId=this._connectionReceivedIds[clientId])){delete this._knownTargets[clientId],delete this._connectionReceivedIds[clientId];var client={tabID:this._clientTabId.id,windowId:this._clientTabId.windowId,id:clientId};this._logger.debug("clientDisconnected: dispatching 'clientDisconnected' to ",client),this.dispatchEvent("clientDisconnected",client)}},_handleRequest:function(client,msgEv){function sendResponse(resMsg){var msg=msgEv.data;this._logger.trace("sendResponse: Dispatching response to: "+msg.sourceId),resMsg.status||(resMsg.status="OK");var msgToSend=this._envelopeMsg(resMsg,msg.sourceId,"response",msg);this._sendMessageHelper(msgToSend)}if(this._logger.trace("_handleRequest: dispatching a REQUEST message"),this._listeners.message){var msgData=msgEv.data.data;try{this.dispatchEvent("message",client,msgData,sendResponse.bind(this))}catch(e){this._logger.error("_handleRequest: Got Exception:"+e+" Details: "+(e.Details||"No details found in exception")+"\nStack:"+e.stack),e.message?msgData.status=e.message:msgData.status="ERROR",sendResponse.call(this,msgData)}}},onMessageTimedOut:function(timedOutMsg){this._logger.warn("onMessageTimedOut: the following message has timed out !!!:",timedOutMsg.data),this.dispatchEvent("MessageTimedOut",timedOutMsg.client,timedOutMsg.data)},_getClient:function(target,contentId){var client={};switch(this._mode){case"content":break;case"extension":if(target){if(!this._clientTabId)return void this._logger.error("_getClient: no clientTabId is set");client={tabID:this._clientTabId.id,windowId:this._clientTabId.windowId,id:contentId}}}return client},_setTargetId:function(target){return++MessageChannelComChannel.prototype._nextContentContextId},_onContentUnloaded:function(){this._logger.trace("_onContentUnloaded: Called"),Util.assert("content"===this._mode,"_onContentUnloaded: Called not from Content!",this._logger),this.disconnect()},_doPostMessage:function(port,msg){port.postMessage(msg)},setClientTabId:function(clientTabId){this._clientTabId=clientTabId},_updateMessageWithNeededInfo:function(msg){this._asyncHelper&&"request"===msg.type&&this._asyncHelper.updateMessageWithNeededInfo(msg)},_addRequestAsyncMsgToQueue:function(msg){this._asyncHelper&&"request"===msg.type&&this._asyncHelper.addAsyncMsgToQueue(msg)},_setAckMessage:function(msg){this._asyncHelper&&this._asyncHelper.setAckMessage(msg)}},PostMessageComChannel.prototype={id:-1,_listeners:null,_knownTargets:[],_asyncHelper:null,_nextContentContextId:0,_connectionReceivedIds:{},_mode:null,_logger:null,_pageProxies:[],_connectTimerId:null,init:function(){switch(this._logger.trace("init called"),this._mode){case"content":null==PostMessageComChannel.prototype._ext&&window.addEventListener("unload",this._onContentUnloaded.bind(this),!1);case"extension":window.addEventListener("message",this._onMessage.bind(this),!1);break;default:this._logger.error("init: Unsupported context! init failed.")}},_sendMessageHelper:function(msg){this._logger.trace("sendMessage: send to: ",msg.targetId," - message:",msg);var windowProxy=null,shouldUseSyncDispatching=!1;switch(this._mode){case"content":-1,windowProxy=window.top,PostMessageComChannel.prototype._ext&&(shouldUseSyncDispatching=!0);break;case"extension":this._knownTargets[msg.targetId]&&(windowProxy=this._knownTargets[msg.targetId]),PostMessageComChannel.prototype._content&&PostMessageComChannel.prototype._content.id===msg.targetId&&(shouldUseSyncDispatching=!0)}return windowProxy?("request"===msg.type&&this._asyncHelper.updateMessageWithNeededInfo(msg),shouldUseSyncDispatching?void this._sendMessageInThisContext(windowProxy,msg):(this._logger.prettyTrace("sendMessage: Sending the following object:\n",msg),-1===this.id||this.id>=1?windowProxy.postMessage(msg,"*"):this._logger.trace("sendMessage: ComChannel still not ready. Message sending is delayed"),void("request"===msg.type&&this._asyncHelper.addAsyncMsgToQueue(msg)))):void this._logger.error("sendMessage: NO Proxy found. Returning - sending message failed !")},_sendMessageInThisContext:function(proxy,msgToSend){this._logger.trace("_sendMessageInThisContext: sending message locally");var otherMessageChannel="extension"===this._mode?PostMessageComChannel.prototype._content:PostMessageComChannel.prototype._ext;"request"===msgToSend.type&&this._asyncHelper.addAsyncMsgToQueue(msgToSend),otherMessageChannel._onMessage({data:msgToSend,source:proxy})},_envelopeMsg:function(msgData,client,type,msgEv){this._logger.trace("_envelopeMsg: called");var targetId="content"===this._mode?-1:client,theMsg=msgEv||{};return theMsg.sourceId=this.id,theMsg.data=msgData,theMsg.targetId=targetId,theMsg.client=client,theMsg.type=type,theMsg.comChannelId="_PostMessageComChannel_",theMsg},sendMessage:function(msg,destTargetId){this._logger.trace("sendMessage: called");var msgToSend=this._envelopeMsg(msg,destTargetId,"request");this._sendMessageHelper(msgToSend)},sendEvent:function(msg,destTargetId){this._logger.trace("sendEvent: called");var msgToSend=this._envelopeMsg(msg,destTargetId,"event");this._sendMessageHelper(msgToSend)},addListener:function(eventName,listenerFunction){this._logger.trace("addListener: called"),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerFunction)},removeListener:function(eventName,listenerFunction){if(this._logger.trace("removeListener: called"),!this._listeners[eventName])return void this._logger.trace("removeListener: Trying to remove listener that is not registered");this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return listener!==listenerFunction})},dispatchEvent:function(eventName,client){this._logger.trace("dispatchEvent: called for event "+eventName);var args=Util.makeArray(arguments).slice(2);"function"==typeof args[args.length-1]?args.splice(args.length-1,0,client):args.push(client),this._listeners[eventName]&&this._listeners[eventName].forEach(function(listener){listener.apply(this,args)})},_onMessage:function(msgEv){var msgData=msgEv.data;if(msgData&&"_PostMessageComChannel_"===msgData.comChannelId){var sourceWindow=msgEv.source;if(msgData.targetId===this.id){if(!sourceWindow)return void this._logger.error("_onMessage: Received a message without a source window \n"+(new Error).stack);switch(this._logger.trace("_onMessage: Received a message from: "+msgData.sourceId),msgData.type){case"connect":this._onConnect(msgData,sourceWindow);break;case"connectResponse":this._onConnectResponse(msgData);break;case"disconnect":this._onDisconnect(msgData,sourceWindow);break;case"response":this._asyncHelper.setAckMessage(msgData);case"event":this._logger.trace("_onMessage: Mesasge of type '"+msgData.type+"' : sourceId="+msgData.sourceId+" , targetId="+msgData.targetId),this.dispatchEvent(msgData.type,this._getClient(sourceWindow,msgData.sourceId),msgData.data);break;case"request":this._logger.trace("_onMessage: This is request message"),this._handleRequest(this._getClient(sourceWindow,msgData.sourceId),msgEv)}}}},connect:function(){switch(this._logger.trace("connect: called "),this._mode){case"extension":break;case"content":var connectMsg={sourceId:this.id,targetId:-1,_debugInfo:{url:location.href},type:"connect",comChannelId:"_PostMessageComChannel_"};this._logger.trace("connect: dispatching connect message: ",connectMsg),window.top.postMessage(connectMsg,"*"),this._connectTimerId=Util.setTimeout(this._onConnectTimeout.bind(this),1e3)}},disconnect:function(){switch(this._logger.trace("disconnect: called "),this._mode){case"extension":this._logger.error("disconnect: houston we have a problem");break;case"content":var disconnectMsg={type:"disconnect",sourceId:this.id,targetId:-1,_debugInfo:{url:location.href},comChannelId:"_PostMessageComChannel_"};this._logger.trace("disconnect: dispatching Disconnect message: ",disconnectMsg),window.top.postMessage(disconnectMsg,"*")}},_onConnect:function(message,sourceWindow){this._logger.trace("_onConnect: called with request: ",message);var returnMsg={targetId:message.sourceId,sourceId:this.id};if(this._connectionReceivedIds[message.sourceId])this._logger.info("_onConnect: Received two connection requests from the same content: "+message.sourceId+" which was already given the value: "+this._connectionReceivedIds[message.sourceId]),returnMsg.allocatedId=this._connectionReceivedIds[message.sourceId];else if(message.sourceId>=1)this._logger.info("_onConnect: Received a connection request from an already intialized frame: "+message.sourceId),returnMsg.allocatedId=message.sourceId;else{var newClientId=this._setTargetId(sourceWindow);if(this._logger.trace("_onConnect: Newly Connected Target Id: "+newClientId),Util.isNullOrUndefined(newClientId))return void this._logger.trace("_onConnect: did not set target id - ignoring");this._knownTargets[newClientId]=sourceWindow;var client=this._getClient(sourceWindow,newClientId);this._logger.debug("_onConnect: dispatching 'clientConnected' to ",client),this.dispatchEvent("clientConnected",client),this._connectionReceivedIds[message.sourceId]=newClientId,returnMsg.allocatedId=newClientId}returnMsg.type="connectResponse",returnMsg.comChannelId="_PostMessageComChannel_",this._logger.trace("_onMessage: connect: dispatching connection response: ",returnMsg),sourceWindow.postMessage(returnMsg,"*")},_onConnectResponse:function(message){this._logger.trace("_onConnectResponse: Connection Response: ",message),Util.assert(!(this.id>=1&&this.id!==message.allocatedId),"_onMessage: connectResponse: received id: "+message.allocatedId+" while my id is: "+this.id,this._logger),window.clearTimeout(this._connectTimerId),this._connectTimerId=null,this.id=message.allocatedId,this.dispatchEvent("connected",this.id)},_onConnectTimeout:function(){this._logger.trace("_onConnectTimeout: called"),window.clearTimeout(this._connectTimerId),this._connectTimerId=null,this.dispatchEvent("connectError",this.id,"timeout")},_onDisconnect:function(message,sourceWindow){this._logger.trace("_onDisconnect: Received Disconnection From: ",message);var clientId=message.sourceId;Util.assert(clientId>=0,"_onDisconnect: Error while trying to disconnect - received an invalid sourceId: "+clientId,this._logger),clientId<1&&(this._logger.info("_onDisconnect: Received a disconnection request from a Frame that didn't initialize yet: "+clientId+" - overriding the id with: "+this._connectionReceivedIds[clientId]),clientId=this._connectionReceivedIds[clientId]),delete this._knownTargets[clientId];var client=this._getClient(sourceWindow,clientId);this._logger.debug("clientDisconnected: dispatching 'clientDisconnected' to ",client),this.dispatchEvent("clientDisconnected",client)},_handleRequest:function(client,msgEv){function sendResponse(resMsg){var msg=msgEv.data;this._logger.trace("sendResponse: Dispatching response to: "+msg.sourceId),resMsg.status||(resMsg.status="OK");var msgToSend=this._envelopeMsg(resMsg,msg.sourceId,"response",msg);this._sendMessageHelper(msgToSend)}if(this._logger.trace("_handleRequest: dispatching a REQUEST message"),this._listeners.message)try{this.dispatchEvent("message",client,msgEv.data.data,sendResponse.bind(this))}catch(e){var resData=msgEv.data.data;this._logger.error("_handleRequest: Got Exception:",e," Details: ",e.Details||"No details found in exception","\nStack:",e.stack,"\nfor message: ",msgEv.data),e.message?resData.status=e.message:resData.status="ERROR",sendResponse.call(this,resData)}},onMessageTimedOut:function(timedOutMsg){this._logger.warn("onMessageTimedOut: the following message has timed out !!!:",timedOutMsg.data),this.dispatchEvent("MessageTimedOut",timedOutMsg.client,timedOutMsg.data)},_getClient:function(target,contentId){var client={};switch(this._mode){case"content":break;case"extension":if(target){if(!this._clientTabId)return void this._logger.error("_getClient: no clientTabId is set");client={tabID:this._clientTabId.id,windowId:this._clientTabId.windowId,id:contentId}}}return client},_setTargetId:function(sourceWindow){return++PostMessageComChannel.prototype._nextContentContextId},_onContentUnloaded:function(){this._logger.trace("_onContentUnloaded: Called"),Util.assert("content"===this._mode,"_onContentUnloaded: Called not from Content!",this._logger),this.disconnect()},setClientTabId:function(clientTabId){this._logger.trace("setClientTabId: settings: ",clientTabId),this._clientTabId=clientTabId}};var ExtChannelEvent={MESSAGE:"message",RESPONSE:"response",CONNECTED:"connected",DISCONNECTED:"disconnected"},InnerChannelEvent={MESSAGE:"message",RESPONSE:"response",OPEN:"open",CLOSE:"close",ERROR:"error"},ExtComChannelUtil={getHandlerForMessage:function(msg){switch(msg._msgType){case"EVENT_INSPECT_ELEMENT":case"EVENT_INSPECT_CANCEL":return"AutInspection";case"EVENT_RECORD":return"Record";case"WEBEXT_REPORT_LINE":return"Replay";default:return"Query"}}};RemoteComChannelStrategy.prototype={_createInnerChannel:function(){return new WebSocketComChannel},_sendRegistrationMessage:function(){var msg=new Msg("REGISTER_AGENT",RtIdUtils.GetDaemonRtId(),{});this.sendEvent(msg)}},MobileCenterComChannelStrategy.prototype={_createInnerChannel:function(){return new MobileCenterComChannel}},WebSocketComChannel.prototype={_logger:null,_connection:null,_listeners:null,_waitingMessages:null,_timerId:-1,_serverUrl:null,supportReconnect:function(){return!0},init:function(){this._logger.trace("init")},getComChannelID:function(){return this._logger.trace("getComChannelID: called"),"WebSocketComChannel"},connect:function(serverUrl){this._logger.trace("connect: trying to connect to web socket server "+serverUrl);try{this._serverUrl=serverUrl,this._connection=new window[this.WEBSOCKET_OBJECT_NAME](serverUrl),this._connection.onopen=this._wsOnOpen.bind(this),this._connection.onclose=this._wsOnClose.bind(this),this._connection.onmessage=this._wsOnMessage.bind(this),this._connection.onerror=this._wsOnError.bind(this)}catch(e){throw this._logger.trace("failed to connect to web socket server "+serverUrl+", error: "+e+"\nStack:"+e.stack),this._clearWaitingMessagesList(),this._serverUrl=null,e}},disconnect:function(){this._logger.trace("disconnect: close connection to web socket server "+this._getServerInfo()),this._isConnectionClosed()||(this._connection.close(),this._clearWaitingMessagesList()),this._connection&&(this._connection.onopen=null,this._connection.onclose=null,this._connection.onmessage=null,this._connection.onerror=null,this._connection=null),this._serverUrl=null},sendMessage:function(msg){var strMsg=JSON.stringify(msg);this._logger.trace("sendMessage: called for "+this._getServerInfo()+", msg: "+strMsg),this._shouldAddToWaitingList()?(this._addMessageToWaitingList(strMsg),this._turnOnWatingTimer()):this._send(strMsg)},addListener:function(eventName,listenerFunction){this._logger.trace("addListener: called for event '"+eventName+"'"),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerFunction)},removeListener:function(eventName,listenerFunction){if(this._logger.trace("removeListener: called for event '"+eventName+"'"),!this._listeners[eventName]||-1===this._listeners[eventName].indexOf(listenerFunction))return void this._logger.warn("removeListener: Trying to remove listener that is not registered");this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return listener!==listenerFunction})},removeAllListeners:function(){this._logger.info("removeAllListeners: called for ",this.getComChannelID()),this._listeners=[]},_shouldAddToWaitingList:function(){this._logger.trace("_shouldAddToWaitingList: called");var result=!this._connection||this._connection.readyState===this._connection.CONNECTING;return this._logger.debug("_shouldAddToWaitingList: returns "+result+". Connection state: "+(this._connection?this._connection.readyState:"not available")),result},_addMessageToWaitingList:function(msg){this._logger.trace("_addMessageToWaitingList: connection is not opened yet - add message to the waiting list");var waitingEnvelope={msg:msg,time:new Date};this._waitingMessages.push(waitingEnvelope)},_turnOnWatingTimer:function(){-1===this._timerId&&(this._logger.trace("_turnOnWatingTimer: turn on the timer"),this._timerId=Util.setInterval(this._onWaitingTimer.bind(this),5e3))},_turnOffWatingTimer:function(){-1!==this._timerId&&(this._logger.trace("_turnOffWatingTimer: turn off the timer"),Util.clearInterval(this._timerId),this._timerId=-1)},_onWaitingTimer:function(){this._logger.trace("_onWaitingTimer: started. Review waiting times of the messages in waiting list ["+this._waitingMessages.length+"]");var timedoutMessages=this._getTimedoutMessages();this._removeMessagesFromWaitingList(timedoutMessages),0===this._waitingMessages.length&&this._turnOffWatingTimer(),this._logger.trace("_onWaitingTimer: finished")},_getTimedoutMessages:function(){return this._logger.trace("_getTimedoutMessages: called"),this._waitingMessages.filter(function(envelope){
var timespanInMS=(new Date).getTime()-envelope.time.getTime();return new Date(timespanInMS).getUTCSeconds()>30})},_removeMessagesFromWaitingList:function(messages){this._logger.trace("_removeMessagesFromWaitingList: called to remove ",messages.length," message(s)"),messages.forEach(function(envelope){this._logger.warn("_removeMessagesFromWaitingList: remove waiting message ",envelope," from the waiting list");var index=this._waitingMessages.indexOf(envelope);-1!==index&&this._waitingMessages.splice(index,1)},this)},_send:function(strMsg){this._logger.trace("_send: Inner Send message called for web socket server ",this._getServerInfo.bind(this),", msg: ",strMsg),this._isConnectionOpen()||(this._logger.error("Cannot send message to the web socket server "+this._getServerInfo()+" due to the invalid connection state: "+this._connection.readyState),ErrorReporter.ThrowGeneralError()),this._connection.send(strMsg)},_wsOnOpen:function(event){this._logger.trace("_wsOnOpen: Connection to web socket server ",this._getServerInfo.bind(this)," has been opened",event),this._turnOffWatingTimer(),this._dispatchEvent(InnerChannelEvent.OPEN),this._processWaitingMessages()},_wsOnClose:function(event){this._logger.trace("_wsOnClose: Connection to web socket server ",this._getServerInfo.bind(this)," has been closed. ",event),this._clearWaitingMessagesList(),this._dispatchEvent(InnerChannelEvent.CLOSE)},_wsOnError:function(error){this._logger.warn("_wsOnError: Error occured: ",error," for server ",this._getServerInfo.bind(this)),this._dispatchEvent(InnerChannelEvent.ERROR,error)},_wsOnMessage:function(event){this._logger.trace("_wsOnMessage: Message received from the server ",this._getServerInfo.bind(this),": ",event),"message"===event.type?this._dispatchEvent(InnerChannelEvent.MESSAGE,event.data):"error"===event.type?this._dispatchEvent(InnerChannelEvent.ERROR,event):this._logger.warn("_wsOnMessage: Unexpected message type: "+event.type)},_getServerInfo:function(){return"[Url: "+this._serverUrl+"]"},_isConnectionOpen:function(){return!Util.isNullOrUndefined(this._connection)&&this._connection.readyState===this._connection.OPEN},_isConnectionClosed:function(){return!!Util.isNullOrUndefined(this._connection)||this._connection.readyState===this._connection.CLOSED},_dispatchEvent:function(eventName){if(this._logger.trace("_dispatchEvent: called for event: "+eventName),!this._listeners[eventName])return void this._logger.info("_dispatchEvent: no listeners found for event: "+eventName);var args=Util.makeArray(arguments);args.splice(0,1),this._listeners[eventName].forEach(function(listener){listener.apply(listener,args)})},_processWaitingMessages:function(){this._sendWaitingMessages(),this._clearWaitingMessagesList()},_sendWaitingMessages:function(){this._logger.trace("_sendWaitingMessages: called for "+this._waitingMessages.length+" waiting messages"),this._waitingMessages.forEach(function(envelope){this._send(envelope.msg)}.bind(this))},_clearWaitingMessagesList:function(){this._logger.trace("_clearWaitingMessagesList: called. Remove "+this._waitingMessages.length+" waiting messages"),this._waitingMessages=[],this._turnOffWatingTimer()},_getWebSocketObjectName:function(){return"WebSocket"in window?"WebSocket":"MozWebSocket"in window?"MozWebSocket":null}},Object.defineProperty(WebSocketComChannel.prototype,"WEBSOCKET_OBJECT_NAME",{value:WebSocketComChannel.prototype._getWebSocketObjectName(),configurable:!0,writable:!1});var InnerChannelMsgType={REQUEST:"request",VOIDREQUEST:"voidRequest",RESPONSE:"response"};ExternalComChannel.prototype={_listeners:null,_innerChannel:null,_logger:null,_nextUid:0,_pendingMessages:null,shouldConnect:function(){return this._innerChannel.shouldConnect?this._innerChannel.shouldConnect():"unsupported"},init:function(){this._logger.trace("init: called"),this._initInnerChannel(),Object.defineProperty(this,"id",{value:-1,writable:!1}),this._logger.trace("init: completed with channel id "+this.id)},addListener:function(eventName,listenerFunction){this._logger.trace("addListener: called for event "+eventName),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerFunction)},removeListener:function(eventName,listenerFunction){if(this._logger.trace("removeListener: called for event "+eventName),!this._listeners[eventName]||-1===this._listeners[eventName].indexOf(listenerFunction))return void this._logger.warn("removeListener: Trying to remove listener that is not registered");this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return listener!==listenerFunction})},connect:function(){this._logger.trace("connect: started");var serverURL=this._getConnectionURL();this._logger.debug("connect: Going to connect to server:"+serverURL),this._innerChannel.disconnect();try{this._innerChannel.connect(serverURL)}catch(e){this._logger.error("connect: exception occurred during connection to "+serverURL+": Error: "+e+"\nStack:"+e.stack)}},disconnect:function(){this._logger.trace("disconnect: called"),this._innerChannel.disconnect()},sendMessage:function(msg){this._logger.prettyDebug("sendMessage: ==========> ",msg),this._sendMessageInternal(msg,InnerChannelMsgType.REQUEST)},sendEvent:function(msg){this._logger.prettyDebug("sendEvent: ==========> ",msg),this._sendMessageInternal(msg,InnerChannelMsgType.VOIDREQUEST)},onMessage:function(receivedData){this._logger.trace("onMessage: called for message ",receivedData);var channelMessage=null;if(null===(channelMessage="object"==typeof receivedData?receivedData:Util.parseJSON(receivedData,this._logger)))return void this._logger.warn("onMessage: parsed message is null");this._logger.trace("onMessage: channelMessage=",channelMessage),this._processIncomingChannelMessage(channelMessage)},onOpen:function(){this._logger.trace("onOpen: called"),this.onConnectionOpened(),this._dispatchEvent(ExtChannelEvent.CONNECTED,this)},onConnectionOpened:function(){this._logger.trace("onConnectionOpened: called. sending registration message."),this._sendRegistrationMessage()},onClose:function(){this._logger.trace("onClose: called"),this.onConnectionClose(),this._dispatchEvent(ExtChannelEvent.DISCONNECTED,this)},onConnectionClose:function(){},onError:function(error){this._logger.error("onError: channel error occured. error: "+error)},transformToChannelMessage:function(request){if(this._logger.trace("transformToChannelMessage: called"),Util.isNullOrUndefined(request))return request;var requestData=request.data,channelMessage=request;return channelMessage.data={data:requestData,format:"WebMessageFormat"},channelMessage.handlerType=ExtComChannelUtil.getHandlerForMessage(requestData),channelMessage},getChannelType:function(){return"EXTERNAL"},_initInnerChannel:function(){this._logger.trace("_initInnerChannel: called"),this._innerChannel.addListener(InnerChannelEvent.MESSAGE,this.onMessage.bind(this)),this._innerChannel.addListener(InnerChannelEvent.OPEN,this.onOpen.bind(this)),this._innerChannel.addListener(InnerChannelEvent.CLOSE,this.onClose.bind(this)),this._innerChannel.addListener(InnerChannelEvent.ERROR,this.onError.bind(this))},_sendMessageInternal:function(msg,type){this._logger.trace("_sendMessageInternal: called for ",msg);var request=this._prepareRequest(msg,type),channelMessage=this.transformToChannelMessage(request);this._innerChannel.sendMessage(channelMessage)},_prepareRequest:function(msg,type){return{type:type||InnerChannelMsgType.REQUEST,uid:this._getNewUid(),data:msg}},_prepareResponse:function(msg,requestUid){return{type:InnerChannelMsgType.RESPONSE,uid:requestUid,data:msg}},_processIncomingChannelMessage:function(channelMessage){switch(this._logger.trace("_processIncomingChannelMessage: processing message [#"+channelMessage.uid+"] of type '"+channelMessage.type+"'"),channelMessage.type){case InnerChannelMsgType.REQUEST:this._processRequest(channelMessage);break;case InnerChannelMsgType.VOIDREQUEST:this._processVoidRequest(channelMessage);break;case InnerChannelMsgType.RESPONSE:this._processResponse(channelMessage);break;default:this._logger.error("_processIncomingChannelMessage: unsupported message type ["+channelMessage.type+"] - dropping the message")}},_processRequest:function(channelMessage){this._logger.trace("_processRequest: called");var uid=null;try{uid=channelMessage.uid;var innerData=this._extractPayloadFromChannelMessage(channelMessage);this._logger.prettyDebug("Receiving Request id=: ",uid," <========== ",innerData),this._dispatchEvent(ExtChannelEvent.MESSAGE,innerData,null,function(resMsg){this._logger.trace("_processRequest: got response for request ",uid," - send it"),this._logger.prettyDebug("Sending Response id=: ",uid," ==========> ",resMsg);var responseChannelMessage=this._generateResponseMsg(resMsg,uid);this._innerChannel.sendMessage(responseChannelMessage)}.bind(this))}catch(e){this._logger.error("_processRequest: ",e),channelMessage.type=InnerChannelMsgType.RESPONSE,innerData&&(innerData.status=e.message||"ERROR"),this._logger.trace("_processRequest: send the message back with ERROR status"),this._logger.prettyDebug("Sending Error Response id=: ",uid," ==========> ",channelMessage),this._innerChannel.sendMessage(channelMessage)}},_processVoidRequest:function(channelMessage){this._logger.trace("_processVoidRequest: called");var uid=channelMessage.uid,logger=this._logger;this._dispatchEvent(ExtChannelEvent.MESSAGE,this._extractPayloadFromChannelMessage(channelMessage),null,function(resMsg){logger.trace("_processVoidRequest: request ",uid," completed. Result: ",resMsg)})},_processResponse:function(channelMessage){this._logger.trace("_processResponse: called");var innerMsg=this._extractPayloadFromChannelMessage(channelMessage);this._dispatchEvent(ExtChannelEvent.RESPONSE,innerMsg)},_extractPayloadFromChannelMessage:function(channelMessage){return this._logger.trace("_extractPayloadFromChannelMessage: called"),channelMessage.data.data},_dispatchEvent:function(eventName){if(this._logger.trace("_dispatchEvent: called for event: "+eventName),!this._listeners[eventName])return void this._logger.trace("_dispatchEvent: no listeners found for event: "+eventName);var args=Util.makeArray(arguments);args.splice(0,1),this._listeners[eventName].forEach(function(listener){listener.apply(this,args)})},_getNewUid:function(){return ExternalComChannel.prototype._nextUid++},toString:function(){return"ExternalComChannel"},_getConnectionURL:function(){var defaultDaemonPort="8822",daemonServerPort=ext.app.getSettingValue("UFT_daemonPort")||defaultDaemonPort;return"ws://"+(ext.app.getSettingValue("UFT_daemonAddress")||"127.0.0.1")+":"+daemonServerPort},_generateResponseMsg:function(resMsg,uid){resMsg.status=resMsg.status?resMsg.status:"OK";var response=this._prepareResponse(resMsg,uid);return this.transformToChannelMessage(response)},_applyStrategy:function(strategy){if(this._logger.trace("_applyStrategy: called"),!Util.isNullOrUndefined(strategy))for(var prop in strategy)"function"==typeof strategy[prop]&&(this._logger.debug("_applyStrategy: "+(this[prop]?"override":"add")+" method "+prop),this[prop]=strategy[prop])},_createInnerChannel:function(){return new WebSocketComChannel},_sendRegistrationMessage:function(){}},window._QTP=window._QTP||{},window._QTP.defaultObjectIdentificationProperties={browser:{assistive:[],baseFilter:["micclass"],mandatory:["micclass"],optionalFilter:["name","title","openurl","opentitle","hasstatusbar","hasmenubar","hastoolbar","openedbytestingtool","number of tabs"],selector:"creationtime"},frame:{assistive:[],baseFilter:["micclass"],mandatory:["micclass","name","url without form data"],optionalFilter:["name","title","url"],selector:"index"},image:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["alt","html tag","image type","micclass"],optionalFilter:["alt","image type","html id","name","file name","class","visible","width","height"],selector:"index"},link:{assistive:["role"],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","text"],optionalFilter:["text","html id","class","name","href","visible"],selector:"index"},page:{assistive:[],baseFilter:["micclass"],mandatory:["micclass","url without form data"],optionalFilter:["title","url"],selector:"index"},viewlink:{assistive:[],baseFilter:[],mandatory:["html tag","innertext","micclass"],optionalFilter:[],selector:"index"},webarea:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["alt","html tag","micclass"],optionalFilter:["alt","html id","map name","class","href","coords","visible"],selector:"index"},webaudio:{assistive:["html id","src","current source"],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","sources"],optionalFilter:["html id","src","sources","current source","duration","autoplay","loop","class","visible"],selector:"index"},webbutton:{assistive:["role"],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","name","type"],optionalFilter:["name","type","html id","value","class","visible"],selector:"index"},webcheckbox:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","name","type"],optionalFilter:["name","type","html id","value","class","visible"],selector:"index"},webedit:{assistive:[],baseFilter:["html tag","micclass","type"],mandatory:["html tag","micclass","name","type"],optionalFilter:["name","html id","max length","default value","class","rows","visible"],selector:"index"},webelement:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["html tag","innertext","micclass"],optionalFilter:["html id","class","innertext","visible"],selector:"index"},webfile:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","name","type"],optionalFilter:["name","type","html id","class","default value","visible"],selector:"index"},weblist:{assistive:["role"],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","name"],optionalFilter:["name","html id","class","default value","items count","visible items","visible"],selector:"index"},webnumber:{assistive:["html id"],baseFilter:["html tag","micclass","type"],mandatory:["html tag","micclass","name","type"],optionalFilter:["html id","name","class","default value","min","max","step","visible"],selector:"index"},webradiogroup:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","name"],optionalFilter:["name","html id","class","items count","visible"],selector:"index"},webrange:{assistive:["html id"],baseFilter:["html tag","micclass","type"],mandatory:["html tag","micclass","name","type"],optionalFilter:["html id","name","class","default value","min","max","step","visible"],selector:"index"},webtable:{assistive:[],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass"],optionalFilter:["html id","border"],selector:"index"},webvideo:{assistive:["html id","src","current source"],baseFilter:["html tag","micclass"],mandatory:["html tag","micclass","sources"],optionalFilter:["html id","src","sources","current source","duration","autoplay","loop","class","visible"],selector:"index"},webmenu:{assistive:["html id","role"],baseFilter:[],mandatory:["html tag","micclass","name"],optionalFilter:[],selector:"index"},webtabstrip:{assistive:["html id","role"],baseFilter:[],mandatory:["html tag","micclass","name"],optionalFilter:[],selector:"index"},webtree:{assistive:["html tag","role"],baseFilter:[],mandatory:["micclass","name"],optionalFilter:[],selector:"index"}};var defaultEventConfig={_attr_names:["EN_CONFIG_DATA","WEB_PN_ALWAYS_CONNECT_MOUSE_DOWN_UP"],_data:{EN_CONFIG_DATA:'<XML><Object Name="Any Web Object"><Event Name="onclick" Listen="2" Record="2"/><Event Name="oncontextmenu" Listen="2" Record="2"/><Event Name="ondragstart" Listen="2" Record="2"/><Event Name="ondrop" Listen="2" Record="2"/><Event Name="onkeydown" Listen="1" Record="2"/><Event Name="onmouseover" Listen="2" Record="1"/><Event Name="onmouseup" Listen="2" Record="1"><Property Name="button" Value="2" Listen="2" Record="2"/><Property Name="button" Value="4" Listen="2" Record="2"/></Event><Event Name="onsubmit" Listen="1" Record="2"/></Object><Object Name="Image"><Event Name="onclick" Listen="1" Record="2"/><Event Name="onmouseover" Listen="2" Record="6"/></Object><Object Name="Link"><Event Name="onclick" Listen="1" Record="2"/></Object><Object Name="WebArea"><Event Name="onclick" Listen="1" Record="2"/><Event Name="onmouseover" Listen="2" Record="6"/></Object><Object Name="WebButton"><Event Name="onclick" Listen="1" Record="2"/></Object><Object Name="WebCheckBox"><Event Name="onclick" Listen="1" Record="2"/><Event Name="onchange" Listen="1" Record="2"/></Object><Object Name="WebEdit"><Event Name="onblur" Listen="1" Record="2"/><Event Name="oninput" Listen="1" Record="2"/><Event Name="onchange" Listen="1" Record="2"/><Event Name="onfocus" Listen="1" Record="2"/><Event Name="onpropertychange" Listen="0" Record="2"><Property Name="propertyName" Value="value" Listen="1" Record="2"/></Event><Event Name="onsubmit" Listen="1" Record="2"/></Object><Object Name="WebElement"><Event Name="onclick" Listen="1" Record="2"/></Object><Object Name="WebFile"><Event Name="onblur" Listen="1" Record="2"/><Event Name="onfocus" Listen="1" Record="2"/></Object><Object Name="WebList"><Event Name="onblur" Listen="1" Record="2"/><Event Name="onchange" Listen="1" Record="2"/><Event Name="onfocus" Listen="1" Record="2"/></Object><Object Name="WebNumber"><Event Name="onblur" Listen="1" Record="2"/><Event Name="onchange" Listen="1" Record="2"/><Event Name="onfocus" Listen="1" Record="2"/></Object><Object Name="WebRadioGroup"><Event Name="onclick" Listen="1" Record="2"/><Event Name="onchange" Listen="1" Record="2"/></Object><Object Name="WebRange"><Event Name="onchange" Listen="1" Record="2"/></Object><Object Name="WebMenu"><Event Name="onclick" Listen="1" Record="2"/></Object><Object Name="WebTabStrip"><Event Name="onclick" Listen="1" Record="2"/></Object><Object Name="WebTree"><Event Name="onclick" Listen="1" Record="2"/></Object></XML>',WEB_PN_ALWAYS_CONNECT_MOUSE_DOWN_UP:1},_msgType:"SRVC_SET_EVENT_CONFIGURATION",_to:{browser:-1,frame:-1,object:null,page:-1}},PositionRelatedPropertyNames={x:"horizontal",y:"vertical",abs_x:"horizontal",abs_y:"vertical",width:"horizontal",height:"vertical"};Util.inherit(MobileCenterComChannel,EventDispatcher,{_mobileCenter:null,_responseCallbacks:null,_uid:-1,_initializeTime:null,init:function(){this._logger.trace("init"),this._initializeTime=new Date,this._mobileCenter.onStartRecord=this._onStartRecord.bind(this),this._mobileCenter.onStopRecord=this._onStopRecord.bind(this),this._mobileCenter.onStartReplay=this._onStartReplay.bind(this),this._mobileCenter.onStopReplay=this._onStopReplay.bind(this),this._mobileCenter.onRequest=this._onRequest.bind(this),this._mobileCenter.onFindElement=this._onFindElement.bind(this)},connect:function(){this._logger.trace("connect: called"),this._mobileCenter.connect(this._onConnect.bind(this)),this._dispatchEvent(InnerChannelEvent.OPEN),Util.setTimeout(function(){}.bind(this),200)},disconnect:function(){this._logger.trace("disconnect: called")},sendMessage:function(msg){"response"===msg.type?(this._onOutgoingMessage(msg),this._sendResponse(msg)):this.sendEvent(msg)},sendEvent:function(eventMsg){this._onOutgoingMessage(eventMsg);var strMsg=JSON.stringify(eventMsg);this._logger.info("sendEvent: called msg : "+strMsg),this._mobileCenter.sendEvent({data:strMsg},function(err){err&&this._logger.error("sendEvent: error: ",err," while sending: ",eventMsg)}.bind(this))},_onConnect:function(err){err&&this._logger.error("_onConnect: error connecting")},_createGlobalVariablesMsg:function(data){var names=[],values=[];return Object.keys(data).forEach(function(key){names.push(key),values.push(data[key])}),new Msg("SRVC_SET_GLOBAL_VARIABLES",RtIdUtils.GetAgentRtid(),{name:[names],value:[values]})},_onStartRecord:function(eventCallback){this._logger.info("_onStartRecord: called");var startRecordMsg=this._createGlobalVariablesMsg({WebActivityState:1,objectidentificationproperties:JSON.stringify(window._QTP.defaultObjectIdentificationProperties),testingtool:"hpmc",isTouchEnabled:!0,enablewebrolebasedkit:!0});this._dispatchMsgHelper({data:startRecordMsg},function(ignoreParameter){this._dispatchMsgHelper({data:defaultEventConfig},function(){this._logger.info("callback on _onStartRecord"),this._hasStartedRecord||(this._hasStartedRecord=!0,Util.setTimeout(eventCallback,500))}.bind(this),"request")}.bind(this),"request")},_onStopRecord:function(eventCallback){this._logger.info("_onStopRecord: called");var stopRecordMsg=this._createGlobalVariablesMsg({WebActivityState:0});this._dispatchMsgHelper({data:stopRecordMsg},function(ignoreParameter){eventCallback()},"request")},_onStartReplay:function(eventCallback){this._logger.info("_onStartReplay: called");var startReplayMsg=this._createGlobalVariablesMsg({isTouchEnabled:!0,enablewebrolebasedkit:!0});this._dispatchMsgHelper({data:startReplayMsg},eventCallback,"request")},_onStopReplay:function(eventCallback){this._logger.info("_onStopReplay: called"),eventCallback()},_onRequest:function(requestMsg,responseCallback){if(this._logger.trace("_onRequest: called requestMsgStr : ",requestMsg),"string"==typeof requestMsg.data){var webData=JSON.parse(requestMsg.data);(webData||webData.data)&&(this._onIncomingMessage(webData),this._dispatchMsgHelper(webData,responseCallback,"request"))}},_onFindElement:function(query,callback){if(this._logger.trace("onFindElement query =",query),query&&query.location){if(new Date-this._initializeTime<200)return void Util.setTimeout(this._onFindElement.bind(this,query,callback),200);this._onIncomingMessage(query);var setObjIdentificationPropertiesMsg=this._createGlobalVariablesMsg({objectidentificationproperties:JSON.stringify(window._QTP.defaultObjectIdentificationProperties),enablewebrolebasedkit:!0});this._dispatchMsgHelper({data:setObjIdentificationPropertiesMsg},function(ignoreParameter){var defaultPageId={browser:this._mobileBrowserId,page:0,frame:-1,object:null},msg=new Msg("QUERY_OBJ_CLIENT_POINT_TO_ID",defaultPageId,{pos:query.location});this._logger.trace("onFindElement msg=",msg),this._dispatchMsgHelper({data:msg},function(error,result){callback(error,[result])},"request")}.bind(this),"request")}},_sendResponse:function(msg){if(Util.isNullOrUndefined(msg.uid))return void this._logger.error("_sendResponse cannot get the uid");var responseCallback=this._responseCallbacks[msg.uid];if(!responseCallback)return void this._logger.error("_sendResponse fail to get the responseCallback");responseCallback(null,{result:JSON.stringify(msg)}),delete this._responseCallbacks[msg.uid]},_dispatchMsgHelper:function(msgdata,responseCallback,type){var callbackId=this._storeResponseCallback(responseCallback),msg={uid:callbackId,type:type,data:msgdata};this._logger.trace("_onDispatchEvent msg=",msg),this._dispatchEvent(InnerChannelEvent.MESSAGE,msg)},_storeResponseCallback:function(responseCallback){return this._responseCallbacks[++this._uid]=responseCallback,this._uid},_isPositionNode:function(obj,nodeName){var isRectNodeName=PositionRelatedPropertyNames[nodeName],isNumber="number"==typeof obj[nodeName];return isRectNodeName&&isNumber},_convertInboundPositionValue:function(parentNode,propertyName,parentPath){var oldVal=parentNode[propertyName];if(oldVal===Constants.noCoordinate)return void this._logger.trace("_convertInboundPositionValue: skipping noCoordinate in '"+parentPath+propertyName+"'");parentNode[propertyName]=this._mobileCenter.convertDeviceToLogicalValue(parentNode[propertyName]),this._logger.trace("_convertInboundPositionValue: converted '"+parentPath+propertyName+"' from "+oldVal+" to "+parentNode[propertyName])},_convertOutboundPositionValue:function(parentNode,propertyName,parentPath){var oldVal=parentNode[propertyName],screenRatioType=this._getScreenRatioType(propertyName);parentNode[propertyName]=this._mobileCenter.convertLogicalToDeviceValue(parentNode[propertyName],screenRatioType),this._logger.trace("_convertOutboundPositionValue: converted '"+parentPath+propertyName+"' from "+oldVal+" to "+parentNode[propertyName]+" - screen ratio type: "+screenRatioType)},_getScreenRatioType:function(propertyName){switch(PositionRelatedPropertyNames[propertyName]){case"horizontal":return this._mobileCenter.ScreenRatioType.X;case"vertical":return this._mobileCenter.ScreenRatioType.Y;default:return this._logger.error("_getScreenRatioType: unknown property name: "+propertyName),null}},_onIncomingMessage:function(msg){Util.traverseObject(msg,function(parentNode,nodeName,parentPath){this._isPositionNode(parentNode,nodeName)&&this._convertInboundPositionValue(parentNode,nodeName,parentPath)}.bind(this))},_onOutgoingMessage:function(msg){Util.traverseObject(msg,function(parentNode,nodeName,parentPath){this._isPositionNode(parentNode,nodeName)&&this._convertOutboundPositionValue(parentNode,nodeName,parentPath)}.bind(this))}});var webViewId={id:1e3,windowId:1};EmbeddedBrowserAPI.prototype={_logger:null,name:"EmbeddedBrowser",initialFrameCounter:Math.round(32767*Math.random()),_clientTabId:null,getAllTabs:function(tabIdFilter,callbackFunction){this._logger.trace("getAllTabs: called"),callbackFunction([this.createTab(this._clientTabId)])},deleteCookies:function(finishedCallback){this._logger.error("deleteCookies: unsupported")},createComChannel:function(){var comChannel=new MessageChannelComChannel("extension");return comChannel.setClientTabId(this._clientTabId),comChannel},createExternalComChannel:function(){return new ExternalComChannel(RemoteComChannelStrategy.prototype)},gettingValue:function(key){return{}},getLogSettingsObject:function(){return{}},createTab:function(browserTab){return this._logger.trace("createTab: started"),new EmbeddedBrowserTab(browserTab)},getSettingValue:function(key){this._logger.warn("getSettingValue: unimplemented. called for key: "+key)}},EmbeddedBrowserTab.prototype={_logger:null,id:-1,windowId:-1,getTabProperty:function(attrName,successCallback,failCallback){failCallback("NotImplemented")},getState:function(successCallback,failCallback){this._logger.trace("getState: started. Returning Hardcoded Complete."),successCallback(ReadyState2Status.complete)},getNumberOfTabs:function(successCallback,failCallback){this._logger.trace("getNumberOfTabs: started. Returning hardcoded 1"),successCallback(1)},isActive:function(successCallback,failCallback){this._logger.trace("isActive: started"),successCallback(!0)},navigate:function(url,successCallback,failCallback){this._logger.debug("navigate: called. Return unsupported."),failCallback("unsupported")},select:function(successCallback,failCallback){this._logger.debug("select: called. Return unsupported."),failCallback("unsupported")},createNewTab:function(){this._logger.error("createNewTab: unsupported")},close:function(successCallback,failCallback){this._logger.error("close: unsupported"),failCallback("unsupported")},getWindowRect:function(successCallback,failCallback){this._logger.trace("getWindowRect: started"),failCallback("unsupported")}},Util.inherit(MobileCenterBrowserAPI,EmbeddedBrowserAPI,{createExternalComChannel:function(){return new ExternalComChannel(MobileCenterComChannelStrategy.prototype)},createTab:function(browserTab){return this._logger.trace("createTab: started"),new MobileCenterBrowserTab(browserTab)},ignoreBrowserDescription:!1}),Util.inherit(MobileCenterBrowserTab,EmbeddedBrowserTab,{getPageRect:function(successCallback,failCallback){var rect={left:0,top:0,right:window.outerWidth||window.innerWidth,bottom:window.outerHeight||window.innerHeight};this._logger.info("[getPageRect] - call back with rect: ",rect),successCallback(rect)}}),Browser.prototype={_associatedTab:null,_creationTime:null,_logger:null,_settings:null,_pageId:null,_openData:null,_recordTransactionQueue:[],_openedbytestingtool:!1,init:function(){this._logger.info("init: Started");var page=new Page(this._associatedTab,Util.shallowObjectClone(this.id));this._pageId=page.getID();var browserInfo={hwnd:0,version:this.getVersion(),browserSessionId:this.getBrowserSessionId(),WEB_PN_ID:this.getID()},msg=new Msg("EVENT_BROWSER_CREATE",ext.dispatcher.getParentDispatcherID(),browserInfo);ext.dispatcher.sendEvent(msg)},destroy:function(){var browserInfo={hwnd:0,WEB_PN_ID:this.getID()},destroyPageMsg=new Msg("EVENT_BROWSER_DESTROY",Util.shallowObjectClone(this._pageId),browserInfo);ext.dispatcher.sendEvent(destroyPageMsg);var notificationMsg=new Msg("EVENT_BROWSER_DESTROY",ext.dispatcher.getParentDispatcherID(),browserInfo);ext.dispatcher.sendEvent(notificationMsg),ext.dispatcher.removeListener("clientRegistered",this),ext.dispatcher.removeListener("Message",this)},onMessage:function(msg,resultCallback){this._logger.trace("onMessage Started with\n",msg),this[msg._msgType]||(this._logger.error("onMessage Unhandled msg: ",msg._msgType),ErrorReporter.ThrowNotImplemented("Browser."+msg._msgType)),this[msg._msgType](msg,resultCallback)},QUERY_ATTR:function(msg,resultCallback){function addToContentQueryMessage(contentQueryMsg,valNameMappingObj,attrName,attrVal){this._logger.trace("addToContentQueryMessage: Started for attribute: "+attrName);var requestedAttr=attrName;for(var mappedAttr in valNameMappingObj)if(valNameMappingObj[mappedAttr]===attrName){this._logger.trace("addToContentQueryMessage: Found name mapping from: "+attrName+" to: "+mappedAttr),requestedAttr=mappedAttr;break}return contentQueryMsg._data[requestedAttr]=attrVal,contentQueryMsg}function queryAttrFromPage(msg,contentQueryMsg,valNameMappingObj,resultCallback){var logger=this._logger;this._logger.trace("queryAttrFromPage: Called. Need to query the content sending mesage to content"),contentQueryMsg._data.hasOwnProperty("title")&&!contentQueryMsg._data.hasOwnProperty("url")&&(contentQueryMsg._data.url=null,contentQueryMsg._extra="url"),this.DispatchMsgToPage(contentQueryMsg,function(resMsg){logger.trace("queryAttrFromPage: Got the following response ",resMsg),contentQueryMsg._data.hasOwnProperty("title")&&contentQueryMsg._data.hasOwnProperty("url")&&(resMsg._data.title||(resMsg._data.title=resMsg._data.url)),contentQueryMsg._extra&&(delete resMsg._data[contentQueryMsg._extra],delete contentQueryMsg._data.url,delete contentQueryMsg._extra),mergeMessages(msg,resMsg,valNameMappingObj),resultCallback(msg)})}this._logger.trace("QUERY_ATTR: Started");var contentQueryMsg=new Msg(MSG_TYPES.QUERY,null,{}),valNameMapping={},numOfResponses=Object.keys(msg._data).length;if(0===numOfResponses)return this._logger.error("QUERY_ATTR: called on 0 attributes"),void resultCallback(msg);var multiResponses=new MultipleResponses(numOfResponses);for(var valName in msg._data)this.GetAttr(valName,msg,valNameMapping,multiResponses.callback(function(keyName,isDone,attrVal){if(attrVal&&attrVal.askPage&&(contentQueryMsg=addToContentQueryMessage.call(this,contentQueryMsg,valNameMapping,keyName,msg._data[keyName])),this._logger.debug("QUERY_ATTR:"+keyName+"="+attrVal),msg._data[keyName]=attrVal,isDone){if(Object.keys(contentQueryMsg._data).length>0)return this._logger.trace("QUERY_ATTR: Need to ask content for the rest of requested properties"),void queryAttrFromPage.call(this,msg,contentQueryMsg,valNameMapping,resultCallback);this._logger.trace("QUERY_ATTR: finished"),resultCallback(msg)}}.bind(this,valName)))},_attrs:{micclass:function(){return[["Browser","Container"]]},"wasted time":function(){return 0},hwnd:function(){return this._associatedTab.hwnd||0},top_level_hwnd:function(){if(this._associatedTab.getTopLevelHwnd)return this._associatedTab.getTopLevelHwnd()},version:function(){return this.getVersion()},"application version":function(){return this._attrs.version.call(this)},creationtime:function(){return SpecialObject.CreateTime(this._creationTime)},openedbytestingtool:function(){return this._openedbytestingtool},browserid:function(){return this.getID()},openurl:function(){return this._openData?this._openData.url:""},opentitle:function(){return this._openData?this._openData.title:""},
"page hwnd":function(){return null},browsersessionid:function(){return this.getBrowserSessionId()}},GetAttrSync:function(property){this._logger.trace("GetAttrSync: query property "+property);var func=this._attrs[property];return func?func.call(this):(this._logger.error("GetAttrSync: attribute "+property+" is unsupported"),null)},_getBrowserProperty:function(attrName,msg,resultCallback){function successCallback(attrValue){resultCallback(attrValue)}function failCallback(){resultCallback({askPage:!0})}this._associatedTab.getTabProperty(attrName,successCallback,failCallback)},GetAttr:function(property,msg,valNameMapping,resultCallback){this._logger.trace("GetAttr: query property "+property);var val,logger=this._logger,lcProperty=property.toLowerCase(),syncAttrFunc=this._attrs[lcProperty];if(syncAttrFunc)return void resultCallback(syncAttrFunc.call(this));switch(lcProperty){case"state":case"state_ignoring_frames":return void this._getBrowserState(lcProperty,resultCallback);case"frame from point":return void this.DispatchMsgToPage(msg,function(resMsg){val=resMsg._data["frame from point"],val&&val.browser&&(val=this.mergeWithBrowserRTID(val)),resultCallback(val)}.bind(this));case"name":valNameMapping.title="name";case"title":case"url":case"logical name":this._getBrowserProperty(lcProperty,msg,resultCallback);break;case"url no protocol":var urlRequestMsg=new Msg(MSG_TYPES.QUERY,this.getID(),{url:null});this.QUERY_ATTR(urlRequestMsg,function(resMsg){if(!resMsg._data.url)return resultCallback("");var urlTokens=resMsg._data.url.split("://");resultCallback(1===urlTokens.length?urlTokens[0]:urlTokens[1])});break;case"number of tabs":return logger.trace("number of tabs: started"),void this._associatedTab.getNumberOfTabs(resultCallback,function(errMsg){logger.error("Browser.GetAttr['number of tabs']: failed: ",errMsg),resultCallback(0)});case"abs_x":var queryRectX=new Msg("QUERY_ATTR",this.getID(),{rect:null});this.QUERY_ATTR(queryRectX,function(resMsg){resultCallback(resMsg._data.rect.left)});break;case"abs_y":var queryRectY=new Msg("QUERY_ATTR",this.getID(),{rect:null});this.QUERY_ATTR(queryRectY,function(resMsg){resultCallback(resMsg._data.rect.top)});break;case"rect":return void this.getBrowserRect(resultCallback);case"width":return void this.getBrowserRect(function(browserRect){resultCallback(browserRect.right-browserRect.left)});case"height":return void this.getBrowserRect(function(browserRect){resultCallback(browserRect.bottom-browserRect.top)});case"isactive":this.isActive(resultCallback);break;case"elementinterface":ErrorReporter.ThrowNotImplemented();break;case"tab screen capture":this._captureScreenShot(resultCallback);break;case"windowid":resultCallback(this._associatedTab.windowId);break;case"frame from hwnd":case"all_qtp_slv_cookies":resultCallback({askPage:!0});break;default:this._logger.debug("GetAttr called for an unknown property: "+property),resultCallback&&resultCallback()}},_getBrowserState:function(propName,resCallback){function getPageState(){logger.trace("_getBrowserState.getPageState: Called");var contentQueryMsg=new Msg(MSG_TYPES.QUERY,null,Util.objectFromArray([propName],null));this.DispatchMsgToPage(contentQueryMsg,function(resMsg){var status=resMsg._data[propName];logger.trace("_getBrowserState.getPageState: Result: "+status),resCallback(status)})}function getStateSuccessCallback(status){logger.trace("_getBrowserState.getStateSuccessCallback: received callback with status "+status);var reqData={AN_METHOD_NAME:"BROWSER_DIALOG_EXISTS",value:null},reqMsg=new Msg(MSG_TYPES.SRVC_INVOKE_METHOD,this.getID(),reqData);ext.dispatcher.sendMessage(reqMsg,null,null,function(msg){return!0===msg._data.value?(logger.trace("dialog exists, state: result: ",status),void resCallback(status)):status!==ReadyState2Status.complete?(logger.trace("state: result: ",status),void resCallback(status)):this._associatedTab.isInjectable?void this._associatedTab.isInjectable(function(result){logger.debug("_getBrowserState.getStateSuccessCallback: is Tab Injectable? ",result),result?getPageState.call(this):resCallback(ReadyState2Status.complete)}.bind(this),getPageState.bind(this)):(logger.debug("_getBrowserState.getStateSuccessCallback: Tab doesn't support isInjectable API, dispatch to page"),void getPageState.call(this))}.bind(this))}function getStateErrorCallback(errorMsg){logger.warn("_getBrowserState.getStateErrorCallback: trying to get state of unknown tab: "+this._associatedTab.id),this.handleError(errorMsg);var failedStatus=ReadyState2Status.unintialized;logger.trace("_getBrowserState: Sending failure result : "+failedStatus),resCallback(failedStatus)}var logger=this._logger;logger.trace("_getBrowserState: started"),this._associatedTab.getState(getStateSuccessCallback.bind(this),getStateErrorCallback.bind(this))},getBrowserRect:function(resultCallback){if(this._logger.trace("getBrowserRect: Started"),this._associatedTab.isEmulatingDevice)return void this._associatedTab.getWindowRect(resultCallback,function(errorMsg){this._logger.error(errorMsg.toString()),resultCallback({left:0,top:0,right:0,bottom:0})}.bind(this));var msgToPage=new Msg(MSG_TYPES.QUERY,null,{window_rect:null});this.DispatchMsgToPage(msgToPage,function(resMsg){resultCallback(resMsg._data.window_rect)})},getVersion:function(){return Util.browserApplicationVersion(this._logger)},getBrowserSessionId:function(){return this._creationTime.getTime().toString()},SRVC_SET_GLOBAL_VARIABLES:function(msg,resultCallback){this._logger.trace("SRVC_SET_GLOBAL_VARIABLES: Started");var agentMsg=new Msg(msg._msgType,RtIdUtils.GetAgentRtid(),msg._data);ext.dispatcher.sendMessage(agentMsg,null,null,Util.identity),resultCallback(msg)},SRVC_SET_GLOBAL_VARIABLES_INTERNAL:function(msg,resultCallback){this._logger.trace("SRVC_SET_GLOBAL_VARIABLES_INTERNAL: Started");var new_settings=msg._data;this._settings=this._settings||{};for(var prop in new_settings)Object.defineProperty(this._settings,prop,{value:new_settings[prop],writable:!1,configurable:!0,enumerable:!0});if(Util.isNullOrUndefined(this._pageId))return void resultCallback(msg);var newMsg=new Msg(msg._msgType,Util.shallowObjectClone(this._pageId),new_settings);this.DispatchMsgToPage(newMsg,function(){resultCallback(msg)})},SRVC_SET_EMULATOR_DEVICE:function(msg,resultCallback){function emulatorTabSuccessCallback(){this._logger.trace("SRVC_SET_EMULATOR_DEVICE: received successful response");var setGlobalMsg=new Msg("SRVC_SET_GLOBAL_VARIABLES_INTERNAL",msg._to,{isTouchEnabled:this._associatedTab.isEmulatedDeviceTouchEnabled},msg._tab);this.SRVC_SET_GLOBAL_VARIABLES_INTERNAL(setGlobalMsg,function(){resultCallback(msg)})}function emulatorTabErrorCallback(errorMsg){this.handleError(errorMsg),this._logger.error("SRVC_SET_EMULATOR_DEVICE: set emulator device failed"),msg.status="ERROR",resultCallback(msg)}if(this._logger.trace("SRVC_SET_EMULATOR_DEVICE: Started"),msg._data.EMULATORDEVICE){var emulationSettings=msg._data.EMULATORDEVICE;if(ext.app.updateEmulationStatu)return void ext.app.updateEmulationStatu(this._associatedTab,emulationSettings,emulatorTabSuccessCallback.bind(this),emulatorTabErrorCallback.bind(this));this._logger.warn("InvokeMethod: unknown method updateEmulationStatu"),ErrorReporter.ThrowMethodNotFound()}this._logger.error("The input parameter do not inlculde valid EMULATORDEVICE field."),emulatorTabErrorCallback.call(this,"Emulator device invalid")},SRVC_HIGHLIGHT_OBJECT:function(msg,resultCallback){this._logger.trace("SRVC_HIGHLIGHT_OBJECT: Called"),resultCallback(msg),this.DispatchMsgToPage(msg,function(){resultCallback(msg)})},SRVC_HIGHLIGHT_MATCHES:function(msg,resultCallback){if(this._logger.trace("SRVC_HIGHLIGHT_MATCHES: Called"),Util.isNullOrUndefined(msg._data.WEB_PN_ID)||msg._data.WEB_PN_ID.length<1)return this._logger.warn("SRVC_HIGHLIGHT_MATCHES: no element"),resultCallback(msg);this.DispatchMsgToPage(msg,resultCallback)},SRVC_GET_OBJ_DESCRIPTION:function(msg,resultCallback){this._logger.trace("Browser: SRVC_GET_OBJ_DESCRIPTION msg=",msg);var oldMsgType=msg._msgType;msg._msgType="SRVC_GET_BROWSER_DESCRIPTION_INTERNAL",this.DispatchMsgToPage(msg,function(resMsg){resMsg._msgType=oldMsgType,this._fixDescription(resMsg._data.objDescription.description,function(){resultCallback(resMsg)})}.bind(this))},_mergeValue:function(msg,key,val){msg._data[key]?(Util.isUndefined(msg._data[key].length)&&(msg._data[key]=[[msg._data[key]]]),msg._data[key][0]=msg._data[key][0].concat([val])):msg._data[key]=val},QUERY_DIRECT_CHILD_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_DIRECT_CHILD_DESC_TO_ID called on ",msg),this.matchPageDescToId(msg,resultCallback)},QUERY_REPOSITORY_DESC2ID_DIRECT:function(msg,resultCallback){this._logger.trace("QUERY_REPOSITORY_DESC2ID_DIRECT: Strted"),this.matchPageDescToId(msg,resultCallback)},QUERY_REPOSITORY_DESC2ID:function(msg,resultCallback){this._logger.trace("QUERY_REPOSITORY_DESC2ID: Started");var pageMsg=new Msg(msg._msgType,null,msg._data);this.DispatchMsgToPage(pageMsg,function(resultMsg){this._logger.trace("QUERY_REPOSITORY_DESC2ID received async result"),msg._data.WEB_PN_ID=[this.getPageId()].concat(resultMsg._data.WEB_PN_ID),msg.status=resultMsg.status,resultCallback(msg)}.bind(this))},warnUnimplemented:function(name){this._logger.warn("Called unimplemented "+name)},SRVC_LOAD_KIT:function(msg,resultCallback){var progid=msg._data.progid;switch(this._logger.trace("SRVC_LOAD_KIT: started on "+progid),progid){case"Mercury.WebKit":return resultCallback(msg);case"Mercury.WebExtKit":return this.DispatchMsgToPage(msg,resultCallback);default:return this.warnUnimplemented("Browser.SRVC_LOAD_KIT: "+progid),resultCallback(msg)}},SRVC_LOAD_EXT_TOOLKIT:function(msg,resultCallback){function returnResult(resMsg){resMsg._data={},self._logger.trace("SRVC_LOAD_EXT_TOOLKIT: returning result: ",resMsg),resultCallback(resMsg)}this._logger.trace("SRVC_LOAD_EXT_TOOLKIT: Started");var self=this;Util.isNullOrUndefined(msg._data.name)||Util.isNullOrUndefined(msg._data.TOOLKIT)?returnResult(msg):this.DispatchMsgToPage(msg,returnResult)},_createDialogErrorCallback:function(msg,callback,name){return function(errorMessage,errorCode){msg.status=errorCode||"ERROR",this._logger.warn(name+" Failed: "+errorMessage),callback(msg)}.bind(this)},_featureNotImplemented:function(name,msg,callback){this._logger.debug("Browser doesn't support "+name),msg.status="NotImplemented",callback(msg)},SRVC_SET_EVENT_CONFIGURATION:function(msg,resultCallback){this._logger.trace("SRVC_SET_EVENT_CONFIGURATION: Started");var agentMsg=new Msg(msg._msgType,RtIdUtils.GetAgentRtid(),msg._data);ext.dispatcher.sendMessage(agentMsg,null,null,Util.identity),resultCallback(msg)},SRVC_SET_EVENT_CONFIGURATION_INTERNAL:function(msg,resultCallback){this._logger.trace("SRVC_SET_EVENT_CONFIGURATION_INTERNAL: Started"),this.DispatchMsgToPage(msg,resultCallback)},invokeMethods:{ZERO_WASTED_TIME:Util.identityWithCallback,BROWSER_DISABLE_KIT:Util.identityWithCallback,BROWSER_ENABLE_KIT:Util.identityWithCallback,SET_OPENEDBYQT_FLAG:function(msg,resultCallback){this._openedbytestingtool=!0,resultCallback(msg)},BROWSER_HANDLE_DIALOG:function(msg,callback){if(!ext.app.handleDialog)return this._featureNotImplemented("handleDialog",msg,callback);var accept=msg._data.name,text=msg._data.value;ext.app.handleDialog(this._associatedTab.id,accept,text,function(res){callback(msg)},this._createDialogErrorCallback(msg,callback,"BROWSER_HANDLE_DIALOG"))},BROWSER_DIALOG_EXISTS:function(msg,callback){if(!ext.app.dialogExists)return this._featureNotImplemented("dialogExists",msg,callback);ext.app.dialogExists(this._associatedTab.id,function(result){msg._data.value=result,callback(msg)},this._createDialogErrorCallback(msg,callback,"BROWSER_DIALOG_EXISTS"))},BROWSER_GET_DIALOG_TEXT:function(msg,callback){if(!ext.app.getDialogText)return this._featureNotImplemented("getDialogText",msg,callback);ext.app.getDialogText(this._associatedTab.id,function(result){msg._data.text=result,callback(msg)},this._createDialogErrorCallback(msg,callback,"BROWSER_GET_DIALOG_TEXT"))},BROWSER_IS_SIBLING_TAB_METHOD_NAME:function(msg,resultCallback){this._logger.trace("BROWSER_IS_SIBLING_TAB_METHOD_NAME: called"),Util.assert(RtIdUtils.IsRTIDBrowser(msg._data.WEB_PN_ID),"BROWSER_IS_SIBLING_TAB_METHOD_NAME contains no other browser data",this._logger);var queryWinIdMsg=new Msg("QUERY_ATTR",msg._data.WEB_PN_ID,{windowId:null}),self=this;ext.dispatcher.sendMessage(queryWinIdMsg,msg._to,null,function(result){var isSibling=result._data.windowId===self._associatedTab.windowId;msg._data.value=isSibling,resultCallback(msg)})},BROWSER_RESIZE:function(msg,resultCallBack){if(this._logger.trace("BROWSER_RESIZE: Started"),!this._associatedTab.resize)return this._featureNotImplemented("resize",msg,resultCallBack);this._associatedTab.resize(msg._data.width,msg._data.height,function(){resultCallBack(msg)},this.handleError.bind(this))}},isActive:function(callback){this._logger.trace("isActive: Started");var isActiveErrorCallback=function(asyncCookie,errMsg){this._logger.error("Browser.isActive: this._associatedTab.isActive failed."),callback(!1)};this._associatedTab.isActive(callback,isActiveErrorCallback.bind(this))},SRVC_INVOKE_METHOD:function(msg,resultCallback){var name=msg._data.AN_METHOD_NAME,func=this.invokeMethods[name];func||ErrorReporter.ThrowNotImplemented("Browser.invokeMethod: "+name),func.call(this,msg,resultCallback)},SRVC_TAKE_SCREENSHOT:function(msg,callback){if(this._logger.trace("SRVC_TAKE_SCREENSHOT: Started"),this._associatedTab.takeScreenshot){var rect=msg._data&&msg._data.rect?msg._data.rect:null;this._associatedTab.takeScreenshot(rect,function(image){msg._data.type="png",msg._data.data=image,callback(msg)}.bind(this),function(error){this._logger.error("SRVC_TAKE_SCREENSHOT: failed: "+error),msg.status="ERROR",callback(msg)}.bind(this))}else msg.status="ERROR",callback(msg)},SRVC_MAKE_OBJ_VISIBLE:function(msg,callbackResult){this._logger.trace("SRVC_MAKE_OBJ_VISIBL: Started");var selectTabSuccessCallback=function(){this._logger.trace("SRVC_MAKE_OBJ_VISIBLE: received successful response"),callbackResult(msg)},selectTabErrorCallback=function(errorMsg){this.handleError(errorMsg),this._logger.error("SRVC_MAKE_OBJ_VISIBLE: select failed"),callbackResult(msg)};this._associatedTab.select(selectTabSuccessCallback.bind(this),selectTabErrorCallback.bind(this))},_dispatchMsgToPageWhenLoadingComplete:function(resultCallback){var executeAccordingToPageStatus=function(loadingCallback,completeCallback){var msg=new Msg("QUERY_ATTR",this.getPageId(),{state:""});this.DispatchMsgToPage(Util.shallowObjectClone(msg),function(msg){msg._data.state===ReadyState2Status.complete?completeCallback&&completeCallback():loadingCallback&&loadingCallback()})}.bind(this),pageLoadingCallback=function(){var timerId=Util.setInterval(function(){executeAccordingToPageStatus(null,function(){Util.clearInterval(timerId),resultCallback()})},500)};Util.setTimeout(function(){executeAccordingToPageStatus(pageLoadingCallback,resultCallback)},2e3)},CMD_BROWSER_BACK:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_BACK: Called");var executed=!1;this._dispatchMsgToPageWhenLoadingComplete(function(){executed||(executed=!0,this.DispatchMsgToPage(msg,resultCallback))}.bind(this))},CMD_BROWSER_FORWARD:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_FORWARD: Called");var executed=!1;this._dispatchMsgToPageWhenLoadingComplete(function(){executed||(executed=!0,this.DispatchMsgToPage(msg,resultCallback))}.bind(this))},CMD_BROWSER_NAVIGATE:function(msg,resultCallback){var logger=this._logger;logger.trace("CMD_BROWSER_NAVIGATE: started");var url=msg._data.url;logger.trace("Navigate: Got url "+url),url.match(/^\w+:\/\//)||url.match(/^about:/)||url.match(/^javascript:/)||(logger.trace("Navigate: URL with no protocol, default to http"),url="http://"+url);var errorCallback=function(errorMsg){switch(errorMsg){case"unsupported":logger.trace("CMD_BROWSER_NAVIGATE received unsupported error, dispatching to Content as Fallback"),msg._data.url=url,this.DispatchMsgToPage(msg,resultCallback);break;default:this.handleError(errorMsg),msg.status="ERROR",resultCallback(msg)}};this._associatedTab.navigate(url,resultCallback.bind(this,msg),errorCallback.bind(this))},CMD_BROWSER_REFRESH:function(msg,resultCallBack){this._logger.trace("CMD_BROWSER_REFRESH: Called");var successCallback=function(){resultCallBack(msg)},errorCallback=function(errorMsg){switch(errorMsg){case"unsupported":return void this.DispatchMsgToPage(msg,resultCallBack);default:this.handleError(errorMsg)}resultCallBack(msg)};this._associatedTab.reload(successCallback,errorCallback.bind(this))},CMD_BROWSER_OPEN_NEW_TAB:function(msg,resultCallBack){this._associatedTab.createNewTab(),resultCallBack(msg)},CMD_BROWSER_CLOSE:function(msg,resultCallBack){this._logger.trace("Closing tab "+this._associatedTab.id);var browserCloseSuccessCallback=function(){resultCallBack(msg)},browserCloseErrorCallback=function(errorMsg){switch(errorMsg){case"unsupported":break;default:this.handleError(errorMsg)}resultCallBack(msg)};this._associatedTab.close(browserCloseSuccessCallback.bind(this),browserCloseErrorCallback.bind(this))},CMD_BROWSER_CLOSE_ALL_TABS:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_CLOSE_ALL_TABS: Started and dispatch the request to agent"),"function"==typeof ext.app.closeAllTabs?ext.app.closeAllTabs(msg,resultCallback):(msg._to=RtIdUtils.GetAgentRtid(),ext.dispatcher.sendMessage(msg,msg._to,null,resultCallback))},CMD_BROWSER_FULLSCREEN:function(msg,resultCallback){if(this._logger.trace("CMD_BROWSER_FULLSCREEN called"),!this._associatedTab.fullScreen)return this._logger.error("CMD_BROWSER_HOME: not implemented"),msg.status="NotImplemented",void resultCallback(msg);this._associatedTab.fullScreen(function(){resultCallback(msg)},function(){this.handleError(error),msg.status="ERROR",resultCallback(msg)}.bind(this))},CMD_BROWSER_HOME:function(msg,resultCallback){if(this._logger.trace("CMD_BROWSER_HOME: called"),!this._associatedTab.goHome)return this._logger.error("CMD_BROWSER_HOME: not implemented"),msg.status="NotImplemented",void resultCallback(msg);this._associatedTab.goHome(function(){resultCallback(msg)},function(){this.handleError(error),msg.status="ERROR",resultCallback(msg)}.bind(this))},CMD_BROWSER_DELETE_COOKIES:function(msg,resultCallBack){var domain;msg._data&&(domain=msg._data.text),this._logger.trace("Removing cookies"+(domain?" for: "+domain:"")),ext.app.deleteCookies(domain,function(){this._logger.trace("Removing cookies finished successfully"),resultCallBack(msg)}.bind(this))},CMD_BROWSER_CLEAR_CACHE:function(msg,resultCallBack){this._logger.trace("Clearing cache"),ext.app.clearCache(function(){this._logger.trace("Clearing cache finished successfully"),resultCallBack(msg)}.bind(this))},CMD_SPY_START:function(msg,resultCallback){this._logger.trace("CMD_SPY_START: Started"),this.DispatchMsgToPage(msg,resultCallback)},CMD_SPY_END:function(msg,resultCallback){this._logger.trace("CMD_SPY_END: Started"),this.DispatchMsgToPage(msg,resultCallback)},CMD_MONITOR_MOUSE_START:function(msg,resultCallback){this._logger.trace("CMD_MONITOR_MOUSE_START: Started"),this.DispatchMsgToPage(msg,resultCallback)},CMD_MONITOR_MOUSE_END:function(msg,resultCallback){this._logger.trace("CMD_MONITOR_MOUSE_START: Started"),this.DispatchMsgToPage(msg,resultCallback)},SRVC_BATCH_QUERYATTR:function(msg,resCallback){this._logger.trace("SRVC_BATCH_QUERYATTR: Started");var objIds=Array.isArray(msg._data.WEB_PN_ID)?msg._data.WEB_PN_ID[0]:[msg._data.WEB_PN_ID],resMsg=new Msg(msg._msgType,msg._to,{}),attrNames=msg._data.name;delete msg._data.name,attrNames=Array.isArray(attrNames)?attrNames[0]:[attrNames],this._logger.debug("SRVC_BATCH_QUERYATTR: Going to batch query for the following fields"+attrNames);var batchInfo=[];objIds.forEach(function(id,idIndex){batchInfo[id.frame]||(batchInfo[id.frame]={indices:[],msgs:[]}),batchInfo[id.frame].indices.push(idIndex);var tmpMsg=new Msg(MSG_TYPES.QUERY,id,{}),indexInData=1;attrNames.forEach(function(attrName){switch(attrName){case"attribute":case"style":this._data[attrName]||(this._data[attrName]=[]);var keyNames=Array.isArray(msg._data.data)?msg._data.data[0][indexInData]:msg._data.data;this._data[attrName].push(keyNames),indexInData+=2;break;case"data":return;default:this._data[attrName]=null}},tmpMsg),batchInfo[id.frame].msgs.push(tmpMsg)},this),batchInfo[-1]&&(batchInfo.push(batchInfo[-1]),null!==batchInfo[-1].msgs[0]._to.object&&this._logger.error("SRVC_BATCH_QUERYATTR: There are messages for page with no content ID"));var ndigits=(""+objIds.length).length;if(batchInfo.length<1)return this._logger.error("SRVC_BATCH_QUERYATTR: there are no Objects to query ???!?!?"),void resCallback(msg);var numOfResponses=batchInfo.filter(Util.identity).length,waitForAllMessages=new MultipleResponses(numOfResponses);batchInfo.forEach(function(info){var tmpMsg=new Msg("INTERNAL_BATCH_QUERYATTR",Util.shallowObjectClone(info.msgs[0]._to),{});tmpMsg._to.object=null,tmpMsg._data.msgs=info.msgs,tmpMsg._data.indices=info.indices,this._logger.trace("SRVC_BATCH_QUERYATTR: Going to send the following msg:",tmpMsg);var logger=this._logger;ext.dispatcher.sendMessage(tmpMsg,null,"chrome",waitForAllMessages.callback(function(isDone,frameResMsg){frameResMsg._data.msgs.forEach(function(objResMsg,index){var objIDIndex=tmpMsg._data.indices[index],key=Util.padLeft(objIDIndex,ndigits);resMsg._data[key]=[[]],attrNames.forEach(function(attrName,attrIndex){var val=objResMsg._data[attrName];if(null===val||Util.isUndefined(val))resMsg._data[key][0][attrIndex]="VT_EMPTY";else{var attrValue=null;Array.isArray(val)?(attrValue=val[0],objResMsg._data[attrName]=objResMsg._data[attrName].slice(1)):attrValue=val,resMsg._data[key][0][attrIndex]="boolean"==typeof attrValue||"number"==typeof attrValue?attrValue:attrValue.toString()}})},frameResMsg),isDone&&(logger.debug("SRVC_BATCH_QUERYATTR: Thats it finished waiting lets wrap it up"),resCallback(resMsg))}))},this)},QUERY_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_DESC_TO_ID called on:\n",msg),this.matchPageDescToId(msg,function(resMsg){0===resMsg._data.WEB_PN_ID.length?(this._logger.trace("QUERY_DESC_TO_ID: No direct child (Page) found - look for the object under the Page."),this.DispatchMsgToPage(msg,resultCallback)):resultCallback(resMsg)}.bind(this))},matchPageDescToId:function(msg,resultCallback){this._logger.trace("matchPageDescToId called on:\n",msg),null===msg._data&&(msg._data={});var matchDescMsg=new Msg("MATCH_DESC_TO_ID",null,msg._data);this.DispatchMsgToPage(matchDescMsg,function(resultMsg){this._logger.trace("matchPageDescToId received async result");var result=new Msg(msg._msgType,msg._to);result._data=resultMsg._data,resultCallback(result)}.bind(this))},CMD_BROWSER_EMBED_SCRIPT:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_EMBED_SCRIPT: Started"),this.DispatchMsgToPage(msg,resultCallback)},getID:function(){return{browser:this._associatedTab.id,page:-1,frame:-1,object:null}},DispatchMsgToPage:function(msg,resultCallback){this._logger.trace("DispatchMsgToPage: Started with message:\n",msg,"\nDispatching to page: ",this.getPageId());var oldTarget=msg._to;msg._to=this.getPageId();var logger=this._logger;ext.dispatcher.sendMessage(msg,null,"chrome",function(resMsg){logger.trace("DispatchMsgToPage: Async Result message:\n",resMsg),resMsg._to=oldTarget,resultCallback(resMsg)})},getPageId:function(){return Util.shallowObjectClone(this._pageId)},mergeWithBrowserRTID:function(runtimeID){return runtimeID.browser=this.getID().browser,runtimeID},handleError:function(error){switch(this._logger.trace("handleError: called with error="+error),error){case"tab doesnt exist":var notifyMSg=new Msg("NOTIFY_BROWSER_IS_NOT_VALID",RtIdUtils.GetAgentRtid(),{WEB_PN_ID:this.getID()});ext.dispatcher.sendMessage(notifyMSg,null,null,Util.identity);break;default:this._logger.error("handleError: unsupported error = ",error)}},_captureScreenShot:function(resultCallback){this._logger.trace("captureScreenShot: Started"),this._associatedTab.captureTabVisibleArea(function(dataURI){var resValue=dataURI.split(",");resultCallback(SpecialObject.CreateBase64(resValue[1]))},this.handleError.bind(this))},_initOpenData:function(registrationData){this._logger.trace("initOpenData: Called"),this._openData||(this._openData={title:registrationData.title,url:registrationData.url},this._logger.trace("initOpenData: Initialize _openData with ",this._openData))},onclientRegistered:function(client,registrationData,registrationResData){this._logger.info("onNewContentConnected: Called"),this._associatedTab.id===client.tabID&&(registrationData.isPage&&(this._logger.info("onclientRegistered: Got registration from page"),this._initOpenData(registrationData)),registrationResData._settings=this._settings)},_calculatePartialProperties:function(properties,callback){this._logger.trace("_calculatePartialProperties: Called");var partialAttrKeysArr=Object.keys(properties).filter(function(attr){return AttrPartialValueUtil.IsPartialValue(properties[attr])},this);if(0===partialAttrKeysArr.length)return void callback(properties);var attrObj=Util.objectFromArray(partialAttrKeysArr,null),queryAttrMsg=new Msg(MSG_TYPES.QUERY,this.getID(),attrObj);this.QUERY_ATTR(queryAttrMsg,function(resMsg){Util.extend(properties,resMsg._data),callback(properties)})},_calculateBrowserAttributes:function(msg,callback){if(this._logger.trace("_calculateBrowserAttributes: Called"),ext.app.ignoreBrowserDescription)return this._logger.debug("_calculateBrowserAttributes: No need to calculate Browser attributes since that it seems we're in a Container not a Browser. Continue."),void callback(msg);var recordedDescArr=msg._data["recorded description"][0],browserIndex=Util.arrayFindIndex(recordedDescArr,function(specialObj){return"Browser"===specialObj.description.properties.micclass},this);Util.assert(browserIndex>=0,"_calculateBrowserAttributes: Could not find browser description in recorded description",this._logger);var description=recordedDescArr[browserIndex].description;this._fixDescription(description,function(){callback(msg)})},_fixDescription:function(description,callback){this._calculatePartialProperties(description.properties,function(resProperties){description.properties=resProperties,this._calculatePartialProperties(description["smart identification properties"],function(resSmartIdProps){description["smart identification properties"]=resSmartIdProps;var creationTimeName="creationtime",creationTimeVal=this.GetAttrSync(creationTimeName);description.selector={name:creationTimeName,value:creationTimeVal},callback()}.bind(this))}.bind(this))},EVENT_RECORD:function(msg){this._logger.trace("EVENT_RECORD: Called"),this._recordTransactionQueue=[],this._calculateBrowserAttributes(msg,function(resMsg){resMsg._to=ext.dispatcher.getParentDispatcherID(),ext.dispatcher.sendEvent(resMsg)}.bind(this))},EVENT_INTERNAL_RECORD_QUEUE:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE: Called"),this._recordTransactionQueue.push(msg)},EVENT_INTERNAL_RECORD_DISPATCH_QUEUE:function(msg){function dispatchEventAndHandleNext(eventQueue,eventIndex,eventMsg){eventMsg._msgType="EVENT_RECORD",eventMsg._to=ext.dispatcher.getParentDispatcherID(),ext.dispatcher.sendEvent(eventMsg),eventIndex!==eventQueue.length-1&&this._calculateBrowserAttributes(transactionQueue[eventIndex+1],dispatchEventAndHandleNext.bind(this,transactionQueue,eventIndex+1))}this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE: Called");var transactionQueue=this._recordTransactionQueue;transactionQueue.push(msg),this._recordTransactionQueue=[],this._calculateBrowserAttributes(transactionQueue[0],dispatchEventAndHandleNext.bind(this,transactionQueue,0))},EVENT_INTERNAL_RECORD_QUEUE_CLEAR:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE_CLEAR: Called"),this._recordTransactionQueue=[]},EVENT_INTERNAL_SEND_BROWSER_INFO:function(msg){this._logger.trace("EVENT_INTERNAL_SEND_BROWSER_INFO: called"),msg._to=this.getPageId(),ext.dispatcher.sendEvent(msg)}},FrameTree.prototype={_logger:null,page:null,hasFrames:function(){return ext.dispatcher.getNumberOfClients(this.page.getTabId())>1},_buildTree:function(rtidsToExclude,resultCallback){if(rtidsToExclude=Array.isArray(rtidsToExclude)?rtidsToExclude:[rtidsToExclude],this.page._contentID<0)return this._logger.debug("_buildTree: no Page, returning the empty tree"),void resultCallback({id:null,children:[]});var msg=new Msg("buildLayoutTree",this.page.getID(),{exclude:rtidsToExclude});this.page._DispatchToOurContent(msg,function(resMsg){"ERROR"===resMsg.status&&(resMsg._data={id:null,children:[]}),resultCallback(resMsg._data)})},traverse:function(nodeFunc,shouldStopTraversalPredicate,thisObj,resCallback){this._logger.trace("traverse started"),this.traverseExcluding(nodeFunc,shouldStopTraversalPredicate,thisObj,[],resCallback)},traverseExcluding:function(nodeFunc,shouldStopTraversalPredicate,thisObj,rtidsToExclude,resCallback){thisObj=thisObj||window,this._logger.trace("traverseExcluding started"),this._buildTree(rtidsToExclude,function(frameTree){this._logger.trace("traverse build tree: \n"+JSON.stringify(frameTree)),this._traverseTree(frameTree,nodeFunc,shouldStopTraversalPredicate,[],thisObj,resCallback)}.bind(this))},_traverseTree:function(node,nodeFunc,shouldStopTraversalPredicate,path,thisObj,resultCallback){nodeFunc.call(thisObj,node,path,function(result){if(shouldStopTraversalPredicate.call(thisObj,result))return void resultCallback(result);var children=node.children||[];children=children.reverse();var i=-1,callOnChild=function(){if(i++,0===children.length)return void resultCallback(result);var child=children.pop();if(null===child.id)return void callOnChild();this._traverseTree(child,nodeFunc,shouldStopTraversalPredicate,path.concat(i),thisObj,function(result){if(shouldStopTraversalPredicate.call(thisObj,result))return void resultCallback(result);callOnChild()})}.bind(this);callOnChild()}.bind(this))}},Page.prototype={_logger:null,_tab:null,_contentID:-1,_frameCreationCount:-1,_frames:null,_scriptsToEmbed:[],_browserId:null,_objIdentificationProps:null,_extToolkits:null,onMessage:function(msg,resultCallback){this._logger.trace("onMessage: called"),this[msg._msgType]||(this._logger.trace("onMessage Unhandled msg\n",msg),ErrorReporter.ThrowNotImplemented("Page."+msg._msgType)),this[msg._msgType](msg,resultCallback)},INTERNAL_BATCH_QUERYATTR:function(msg,resultCallback){if(this._logger.trace("INTERNAL_BATCH_QUERYATTR: started with ",msg),0===msg._data.msgs.length)return this._logger.error("INTERNAL_BATCH_QUERYATTR: no messages found"),void resultCallback(msg);var logger=this._logger,responses=new MultipleResponses(msg._data.msgs.length);msg._data.msgs.forEach(function(currMsg,i,arr){logger.debug("INTERNAL_BATCH_QUERYATTR: process message #",i,": ",currMsg),(RtIdUtils.IsRTIDFrame(currMsg._to)||RtIdUtils.IsRTIDAO(currMsg._to))&&logger.error("INTERNAL_BATCH_QUERYATTR: this is a content message! we don't expect it here"),this.onMessage(currMsg,responses.callback(function(isLast,resMsg){logger.debug("INTERNAL_BATCH_QUERYATTR: got result for message #"+i),arr[i]=resMsg,isLast&&(logger.debug("INTERNAL_BATCH_QUERYATTR: got result for all the messages. Invoke callback passing ",msg),resultCallback(msg))}))},this)},QUERY_ATTR:function(msg,resultCallBack){if(!resultCallBack)return void this._logger.error("QUERY_ATTR: Called without callback! Message: ",msg);var addToRequestToContentMessage=function(contentMessage,valName,valNameMapping,origValue){contentQueryMsg||(contentQueryMsg=new Msg(MSG_TYPES.QUERY,msg._to),contentQueryMsg._data={});var reqKey=valName;for(var k in valNameMapping)if(valNameMapping[k]===valName){reqKey=k;break}return contentQueryMsg._data[reqKey]=origValue,contentQueryMsg},numOfAttrs=Object.keys(msg._data).length;if(0===numOfAttrs)return this._logger.error("QUERY_ATTR: called on 0 attributes"),void resultCallBack(msg)
;this._logger.trace("QUERY_ATTR: Started for ",msg);var contentQueryMsg=null,valNameMapping={},multiResponses=new MultipleResponses(numOfAttrs);for(var valName in msg._data)this.GetAttr(valName,msg,valNameMapping,multiResponses.callback(function(keyName,done,val){if(this._logger.debug("QUERY_ATTR:",keyName,"=",val),val&&val.askContent?(this._logger.trace("QUERY_ATTR: Adding ",keyName," to content message"),contentQueryMsg=addToRequestToContentMessage(contentQueryMsg,keyName,valNameMapping,msg._data[keyName])):msg._data[keyName]=val,done){if(!contentQueryMsg)return void resultCallBack(msg);this._logger.debug("QUERY_ATTR: Need to query the content sending mesage to content: ",contentQueryMsg);var logger=this._logger;this._DispatchToOurContent(contentQueryMsg,function(resMsg){logger.trace("QUERY_ATTR: Got the following response ",resMsg),mergeMessages(msg,resMsg,valNameMapping),resultCallBack(msg)})}}.bind(this,valName)))},GetAttr:function(property,msg,valNameMapping,resultCallback){function defaultQuery(){this._contentID<0?(this._logger.warn("GetAttr: property= ",property," is calculated using content, but there's no registered content."),resultCallback(null)):resultCallback({askContent:!0})}switch(this._logger.trace("GetAttr: Started for property=",property),property.toLowerCase()){case"micclass":resultCallback("Page");break;case"frame from point":this.getFrameIDFromPoint(msg,resultCallback);break;case"hwnd":resultCallback(this._tab.hwnd||0);break;case"parent":valNameMapping.WEB_PN_ID="parent",resultCallback(this._browserId);break;case"state":case"state_ignoring_frames":this.pageState(msg,resultCallback);break;case"screen_rect":case"rect":this.getScreenRect(resultCallback);break;case"view_x":case"view_y":resultCallback(0);break;case"all_qtp_slv_cookies":this._getAllSlvCookies(resultCallback);break;case"frame from hwnd":this._getAllSlvCookies(function(windows){var wnd=msg._data["frame from hwnd"][0][0];this._logger.trace("GetAttr('frame from hwnd') got window list: "+windows+" looking for "+wnd),-1!==windows.indexOf(wnd)?resultCallback(this.getID()):resultCallback()}.bind(this));break;case"logical name":this._tab.getTabProperty("logical name",resultCallback,defaultQuery.bind(this));break;default:defaultQuery.call(this)}},pageState:function(msg,resultCallback){if(this._logger.trace("pageState: Started"),this._contentID<0)return this._logger.debug("pageState: Page with no content Id. State is Loading."),void resultCallback(ReadyState2Status.loading);if("state_ignoring_frames"in msg._data){this._logger.debug("pageState: ignore frames");var stateRequest=new Msg("QUERY_ATTR",this.getID(),{state:null});return void this._DispatchToOurContent(stateRequest,function(resStateMsg){resultCallback(resStateMsg._data.state)})}if(!ext.dispatcher.isIdle(msg._to.browser))return this._logger.info("pageState: isIdle returned false - so returning Status: Loading (1)"),void resultCallback(ReadyState2Status.loading);this._frames.traverse(function(node,path,traverseCallback){try{if(null===node.id)return void traverseCallback(ReadyState2Status.complete);var request=new Msg("QUERY_ATTR",Util.shallowObjectClone(node.id),{state:null});this._sendToContent(request,null,function(resMsg){traverseCallback(resMsg._data.state||-1)})}catch(ex){this._logger.warn("pageState: got exception from content: "+ex+" \n(wait for rebuild layout)"),traverseCallback(ReadyState2Status.loading)}}.bind(this),function(state){return state!==ReadyState2Status.complete},this,resultCallback)},getFrameIDFromPoint:function(msg,resultCallback){if(this._logger.trace("getFrameIDFromPoint: started ",msg),!this._frames.hasFrames())return this._logger.debug("getFrameIDFromPoint: dont have frames return our id"),void resultCallback(this.getID());var screentPoint=msg._data["frame from point"];this.GetAttr("screen_rect",msg,null,function(pageRect){this._logger.trace("getFrameIDFromPoint: GetAttr screen_rect received response now calculate point and dispatch to content");var pt={x:screentPoint.x-pageRect.left,y:screentPoint.y-pageRect.top},contentMsg=new Msg(MSG_TYPES.FRAME_FROM_POINT,this.getID(),{point:pt});this._DispatchToOurContent(contentMsg,function(resMsg){resultCallback(resMsg._data.WEB_PN_ID)})}.bind(this))},_getFrameIDFromClientPoint:function(point,resultCallback){if(this._logger.trace("_getFrameIDFromClientPoint: started ",point),!this._frames.hasFrames())return this._logger.debug("_getFrameIDFromClientPoint: dont have frames return our id"),void resultCallback(this.getID());var contentMsg=new Msg(MSG_TYPES.FRAME_FROM_POINT,this.getID(),{point:point});this._DispatchToOurContent(contentMsg,function(resMsg){resultCallback(resMsg._data.WEB_PN_ID)})},QUERY_OBJ_POINT_TO_ID:function(msg,resultCallback){return this._logger.trace("QUERY_OBJ_POINT_TO_ID:"),this._DispatchToOurContent(msg,resultCallback)},QUERY_OBJ_CLIENT_POINT_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_OBJ_CLIENT_POINT_TO_ID: started for point: ",msg._data),this._getFrameIDFromClientPoint(msg._data.pos,function(rtid){this._logger.trace("QUERY_OBJ_CLIENT_POINT_TO_ID: ",rtid),-1===rtid.frame&&(rtid.frame=this._contentID);var queryObjFrameMsg=new Msg("QUERY_OBJ_CLIENT_POINT_TO_ID",rtid,msg._data);this._sendToContent(queryObjFrameMsg,null,resultCallback)}.bind(this))},QUERY_DESC_TO_ID:function(msg,resultCallback){function queryEveryFrames(node,path,traverseCallback){function mergeFrameMsg(frameMsg){frameMsg._data.WEB_PN_ID=Array.isArray(frameMsg._data.WEB_PN_ID)?frameMsg._data.WEB_PN_ID:[frameMsg._data.WEB_PN_ID],1===frameMsg._data.WEB_PN_ID.length&&(storedMsg._data.WEB_PN_ID=storedMsg._data.WEB_PN_ID.concat(frameMsg._data.WEB_PN_ID)),traverseCallback(storedMsg)}if(null===node.id)return this._logger.trace("frame is uninjectable return"),void traverseCallback(msg);var frameMsg=new Msg(storedMsg._msgType,Util.shallowObjectClone(node.id),Util.shallowObjectClone(storedMsg._data));this._sendToContent(frameMsg,null,mergeFrameMsg)}function frameTraverseCallback(){0===storedMsg._data.WEB_PN_ID.length&&(storedMsg.status="ObjectNotFound",this._logger.info("QUERY_DESC_TO_ID found no object")),1===storedMsg._data.WEB_PN_ID.length&&(storedMsg.status="OK"),storedMsg._data.WEB_PN_ID.length>1&&(storedMsg.status="ObjectNotUnique",this._logger.info("QUERY_DESC_TO_ID find multiple objects")),resultCallback(storedMsg)}this._logger.trace("QUERY_DESC_TO_ID: Started");var storedMsg=Util.deepObjectClone(msg);storedMsg._data.WEB_PN_ID=[],this._DispatchToOurContent(msg,function(resMsg){"ObjectNotFound"!==resMsg.status?resultCallback(msg):this._frames.traverse(queryEveryFrames.bind(this),Util.alwaysFalse,this,frameTraverseCallback.bind(this))}.bind(this))},SRVC_GET_OBJ_DESCRIPTION:function(msg,resultCallback){return this._logger.trace("SRVC_GET_OBJ_DESCRIPTION:"),this._DispatchToOurContent(msg,resultCallback)},SRVC_GET_BROWSER_DESCRIPTION_INTERNAL:function(msg,resultCallback){return this._logger.trace("SRVC_GET_BROWSER_DESCRIPTION_INTERNAL:"),this._DispatchToOurContent(msg,resultCallback)},QUERY_DIRECT_CHILD_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_DIRECT_CHILD_DESC_TO_ID got:\n",msg);var filterMsg=new Msg(MSG_TYPES.MATCH_DESC_TO_ID,this.getID(),msg._data);filterMsg._data.WEB_PN_ID=[],this.sendMessageToFrames(filterMsg,!1,function(resMsg){this._logger.trace("QUERY_DIRECT_CHILD_DESC_TO_ID Returned:\n",resMsg),mergeMessages(msg,resMsg),resultCallback(msg)}.bind(this))},QUERY_REPOSITORY_DESC2ID:function(msg,resultCallback){this._logger.trace("QUERY_REPOSITORY_DESC2ID: Started");var desc=Util.shallowObjectClone(msg._data);msg._data.WEB_PN_ID=[],this._frames.traverse(function(node,path,traverseCallback){if(null===node.id)return void traverseCallback(msg);node.id.frame!==this._contentID&&msg._data.WEB_PN_ID.push(Util.shallowObjectClone(node.id));var frameMsg=new Msg(msg._msgType,Util.shallowObjectClone(node.id),Util.shallowObjectClone(desc));this._sendToContent(frameMsg,null,function(frameMsg){frameMsg._data.WEB_PN_ID=Array.isArray(frameMsg._data.WEB_PN_ID)?frameMsg._data.WEB_PN_ID:[frameMsg._data.WEB_PN_ID],msg._data.WEB_PN_ID=msg._data.WEB_PN_ID.concat(frameMsg._data.WEB_PN_ID),traverseCallback(msg)})},Util.alwaysFalse,this,resultCallback)},MATCH_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("MATCH_DESC_TO_ID: Started"),Description.filterAOList([this],msg._data,function(children){resultCallback(Description.buildReturnMsg(msg._msgType,msg._to,children,this._logger))}.bind(this))},invokeMethods:{DOC_EXECUTE_SCRIPT:function(msg,resultCallback){this._logger.trace("DOC_EXECUTE_SCRIPT: started"),this._DispatchToOurContent(msg,resultCallback)},SAVE_FRAME_SOURCE_NOT_RECURSIVE:function(msg,resultCallback){this._logger.trace("SAVE_FRAME_SOURCE_NOT_RECURSIVE: started"),this._DispatchToOurContent(msg,resultCallback)},GET_ID_FROM_SOURCE_INDEX:function(msg,resultCallback){this._logger.warn("Page.GET_ID_FROM_SOURCE_INDEX is not implemented"),resultCallback(msg)}},SRVC_INVOKE_METHOD:function(msg,resultCallback){var name=msg._data.AN_METHOD_NAME,func=this.invokeMethods[name];func||ErrorReporter.ThrowNotImplemented("invokeMethod: "+name),func.call(this,msg,resultCallback)},SRVC_HIGHLIGHT_OBJECT:function(msg,resultCallback){this._logger.trace("SRVC_HIGHLIGHT_OBJECT: Called"),this._DispatchToOurContent(msg,resultCallback)},SRVC_HIGHLIGHT_MATCHES:function(msg,resultCallback){this._logger.trace("SRVC_HIGHLIGHT_MATCHES: Called");var elems=msg._data.WEB_PN_ID;if(Util.isNullOrUndefined(elems)||elems.length<1)return this._logger.warn("SRVC_HIGHLIGHT_MATCHES: no element"),resultCallback(msg);var multiResponses=new MultipleResponses(elems.length);elems.forEach(function(elem){var highlightMsg=new Msg("SRVC_HIGHLIGHT_OBJECT",elem,{});ext.dispatcher.sendMessage(highlightMsg,elem,null,multiResponses.callback(function(isDone,resultMsg){isDone&&resultCallback(msg)}))})},SRVC_GET_TEXT:function(msg,resultCallback){return this._logger.trace("SRVC_GET_TEXT:"),this._DispatchToOurContent(msg,resultCallback)},CMD_BROWSER_BACK:function(msg,resultCallBack){this._logger.trace("CMD_BROWSER_BACK: Called"),this._DispatchToOurContent(msg,resultCallBack)},CMD_BROWSER_FORWARD:function(msg,resultCallBack){this._logger.trace("CMD_BROWSER_FORWARD: Called"),this._DispatchToOurContent(msg,resultCallBack)},CMD_BROWSER_REFRESH:function(msg,resultCallBack){this._logger.trace("CMD_BROWSER_REFRESH: Called"),this._DispatchToOurContent(msg,resultCallBack)},CMD_BROWSER_NAVIGATE:function(msg,resultCallback){return this._DispatchToOurContent(msg,resultCallback)},CMD_BROWSER_EMBED_SCRIPT:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_EMBED_SCRIPT: Started");var jsScript=msg._data.text;this._scriptsToEmbed.push(jsScript),this.sendMessageToFrames(msg,!1,resultCallback)},CMD_SPY_START:function(msg,resultCallback){this._logger.trace("CMD_SPY_START: Started"),this.sendMessageToFrames(msg,!1,resultCallback)},CMD_SPY_END:function(msg,resultCallback){this._logger.trace("CMD_SPY_END: Started"),this.sendMessageToFrames(msg,!1,resultCallback)},CMD_MONITOR_MOUSE_START:function(msg,resultCallback){this.sendMessageToFrames(msg,!1,resultCallback)},CMD_MONITOR_MOUSE_END:function(msg,resultCallback){var screenPoint=msg._data.pos;this.sendMessageToFrames(msg,!1,function(resMsg){screenPoint&&resMsg._data.pos&&(window.screenX=screenPoint.x-resMsg._data.pos.x,window.screenY=screenPoint.y-resMsg._data.pos.y),resultCallback(resMsg)})},SRVC_LOAD_KIT:function(msg,resultCallback){if(this._logger.trace("SRVC_LOAD_KIT: started on "+msg._data.progid),"Mercury.WebExtKit"===msg._data.progid){if(this._extToolkits.length>0)return this._logger.trace("SRVC_LOAD_KIT: send toolkits to frame for WebExtKit"),msg._data.toolkits=this._extToolkits.slice(0),this.sendMessageToFrames(msg,!1,resultCallback);this._logger.trace("Page.SRVC_LOAD_KIT: no toolkit for web extensibility")}resultCallback(msg)},SRVC_LOAD_EXT_TOOLKIT:function(msg,resultCallback){if(this._logger.trace("SRVC_LOAD_EXT_TOOLKIT: Started"),!this._extToolkits.some(function(item){return msg._data.name===item.name})){var XMLJsonObject=Util.convertXmlStrToJson(msg._data.TOOLKIT);null!==XMLJsonObject&&(this._logger.trace("SRVC_LOAD_EXT_TOOLKIT: add toolkit "+msg._data.name+" to the list"),this._extToolkits.push({name:msg._data.name,description:XMLJsonObject,jsFunctions:msg._data.JSFUNCTION||[],jsScripts:msg._data.text||[]}))}resultCallback(msg)},onclientRegistered:function(client,registrationData,registrationResData){this._logger.info("onclientRegistered: on page for tab ",this._tab.id," and client is: ",client," with the following info:",registrationData),this._tab.id===client.tabID&&(registrationData.isPage&&(this._logger.info("onclientRegistered: Got registration from page content"),this._contentID=client.id),registrationResData.frameCount=++this._frameCreationCount,registrationResData.scriptsToEmbed=this._scriptsToEmbed,registrationResData.extToolkits=this._extToolkits,registrationResData._parentPageId=Util.shallowObjectClone(this.id),registrationResData._frameId=Util.shallowObjectClone(this.id),registrationResData._frameId.frame=client.id)},getID:function(){var resRTID=Util.shallowObjectClone(this._browserId);return resRTID.page=this.getPageIdentifier(),resRTID},getPageIdentifier:function(){return 0},_DispatchToOurContent:function(msg,resultCallback){if(this._logger.trace("_DispatchToOurContent: Started with ",msg),this._contentID<0)return this._logger.warn("_DispatchToOurContent: Page has no content, do nothing"),void resultCallback(msg);var processed=!1,lastContentId=this._contentID,resultCallbackWrapper=function(theMsg){processed=!0,resultCallback(theMsg)};Util.setTimeout(function checkProceed(){processed||(this._contentID!=lastContentId?(this._logger.warn("_DispatchToOurContent: Page's content is changed, just callback it as FAIL."),msg.status="ERROR",resultCallback(msg)):Util.setTimeout(checkProceed.bind(this),1e3))}.bind(this),1e3),this._sendToContent(msg,this._contentID,resultCallbackWrapper)},_sendToContent:function(msg,target,resultCallBack){this._logger.trace("_sendToContent: Asking the content for:",msg,", and Target:",target);var origFrame=msg._to.frame;"number"==typeof target&&(msg._to.frame=target),this._logger.debug("_sendToContent: Going to send to the following frame id: ",msg._to.frame);var reqestMsg=msg;ext.dispatcher.sendMessage(msg,null,"chrome",function(resMsg){this._logger.debug("_sendToContent: Got the following response:",resMsg),resMsg=this._updateRTIDIfNeeded(resMsg),reqestMsg=mergeMessages(reqestMsg,resMsg,null,this._logger),reqestMsg._to.frame=origFrame,resultCallBack(reqestMsg)}.bind(this))},_updateRTIDIfNeeded:function(msg){this._logger.trace("_updateRTIDIfNeeded: Started");var data=msg._data;if(data&&data.WEB_PN_ID){this._logger.debug("_updateRTIDIfNeeded: The message contains RTIDs that needs to be updated");var pageID=this.getPageIdentifier();Array.isArray(data.WEB_PN_ID)?data.WEB_PN_ID.forEach(function(id){this.mergeWebRuntimeID(id,pageID)},this):this.mergeWebRuntimeID(data.WEB_PN_ID,pageID),this._logger.debug("_updateRTIDIfNeeded: After updating the RTIDs ",data.WEB_PN_ID)}return msg},areAllPropertiesFilled:function(msg){var data=msg._data;for(var p in data)if(null===data[p])return!1;return!0},sendMessageToFrames:function(message,stopOnReply,resultCallback){this._logger.trace("sendMessageToFrames: Started"),this._frames.traverse(function(node,path,traverseCallback){if(null===node.id)return void traverseCallback(message);this._sendToContent(message,node.id.frame,traverseCallback)},stopOnReply?this.areAllPropertiesFilled:Util.alwaysFalse,this,resultCallback)},onclientUnRegistered:function(client){this._logger.trace("onclientUnRegistered: Page for tab=",this._tab.id," ,client=",client),client.tabID===this._tab.id&&client.id===this._contentID&&(this._logger.info("removeFrame: Page has disconnected"),this._contentID=-1)},mergeWebRuntimeID:function(runtimeID){runtimeID.frame===this._contentID&&(runtimeID.frame=-1)},SRVC_SET_GLOBAL_VARIABLES_INTERNAL:function(msg,resultCallback){msg._data.objectidentificationproperties&&(this._objIdentificationProps=JSON.parse(msg._data.objectidentificationproperties)),this.sendMessageToFrames(msg,!1,resultCallback)},SRVC_SET_EVENT_CONFIGURATION_INTERNAL:function(msg,resultCallback){this._logger.trace("SRVC_SET_EVENT_CONFIGURATION_INTERNAL: Started"),this.sendMessageToFrames(msg,!1,resultCallback)},SRVC_SAVE_HTML_SOURCE:function(msg,resultCallback){var baseFileName=msg._data.WEB_N_SSV_FRAME_BASE_NAME;msg._data={},msg._data.WEB_N_SSV_FRAME_SRC_MMF_HANDLES=[[]],msg._data.WEB_N_SSV_FRAME_SRC_MMF_SIZES=[[]],msg._data.WEB_N_SSV_FRAME_BASE_URLS=[[]],msg._data.WEB_N_SSV_FRAME_INTERNAL_NAMES=[[]],msg._data.WEB_N_SSV_FRAME_URLS=[[]],msg._data.WEB_N_SSV_FRAME_NAMES=[[]],msg._data.WEB_N_SSV_FRAME_INDEX=[[]];var frameCount=0;this._frames.traverse(function(node,path,traverseCallback){node.id&&this._contentID!==node.id.frame?(msg._data.WEB_N_SSV_FRAME_INDEX[0].push("0."+path.join(".")),msg._data.WEB_N_SSV_FRAME_INTERNAL_NAMES[0].push(baseFileName+"f"+path.join("f"))):(msg._data.WEB_N_SSV_FRAME_INDEX[0].push("0"),msg._data.WEB_N_SSV_FRAME_INTERNAL_NAMES[0].push(baseFileName));var data={"url without form data":null,"User-input in Post data":null,"Non user-input in Post data":null,"User input in Get data":null,"Non user-input in Get data":null,"All data in Get method":null,html_info:null,name:null,url:null},tmpMsg=new Msg(MSG_TYPES.QUERY,Util.shallowObjectClone(node.id),data);++frameCount,this._sendToContent(tmpMsg,null,function(frameResSourceMsg){data=frameResSourceMsg._data,msg._data.WEB_N_SSV_FRAME_SRC_MMF_HANDLES[0].push(data.html_info.MMF_HANDLE),msg._data.WEB_N_SSV_FRAME_SRC_MMF_SIZES[0].push(data.html_info.MMF_HANDLE.html.length),msg._data.WEB_N_SSV_FRAME_BASE_URLS[0].push(data.html_info.FRAME_BASE_URL),delete data.html_info,msg._data.WEB_N_SSV_FRAME_URLS[0].push(data.url),msg._data.WEB_N_SSV_FRAME_NAMES[0].push(data.name),delete data.url,delete data.name;for(var key in data)msg._data[key]=msg._data[key]||[[]],msg._data[key][0].push(data[key]);traverseCallback()})},Util.alwaysFalse,this,function(){msg._data.AN_PROCESS_ID=SpecialObject.CreateProcessId(),msg._data.WEB_N_SSV_TOTAL=frameCount,msg._data.WEB_N_SSV_STATIC_SAVE=!1,resultCallback(msg)})},SRVC_TAKE_SCREENSHOT:function(msg,callbackResult){this._logger.trace("SRVC_TAKE_SCREENSHOT: Started");var browserId={browser:msg._to.browser,page:-1,frame:-1,object:null},browserMsg=Util.deepObjectClone(msg);browserMsg._to=browserId,ext.dispatcher.sendMessage(browserMsg,null,null,function(resultMsg){msg._data=resultMsg._data,msg.status=resultMsg.status,callbackResult(msg)})},SRVC_MAKE_OBJ_VISIBLE:function(msg,callbackResult){this._logger.trace("SRVC_MAKE_OBJ_VISIBLE: started");var browserMsg=new Msg("SRVC_MAKE_OBJ_VISIBLE",Util.shallowObjectClone(this._browserId));ext.dispatcher.sendMessage(browserMsg,null,null,function(){this._logger.trace("SRVC_MAKE_OBJ_VISIBLE: received response"),msg._data.hwnd=0,this.GetAttr("screen_rect",msg,null,function(rect){msg._data.rect=rect,callbackResult(msg)})}.bind(this))},SRVC_GET_SCREEN_RECT:function(msg,resultCallback){this._logger.trace("SRVC_GET_SCREEN_RECT: started"),this._DispatchToOurContent(msg,resultCallback)},getScreenRect:function(resultCallback){this._logger.trace("getScreenRect: started");var logger=this._logger;if(this._tab.getPageRect)return this._logger.trace("getScreenRect: asking tab for Page rect"),void this._tab.getPageRect(resultCallback,function(errorMsg){logger.error("getScreenRect: "+errorMsg),resultCallback({left:0,top:0,right:0,bottom:0})});var heightWidthMsg=new Msg("QUERY_ATTR",this.getID(),{innerHeight:null,outerHeight:null,innerWidth:null,outerWidth:null,window_rect:null});this._DispatchToOurContent(heightWidthMsg,function(resMsg){var rect=Util.calculateTabRect(resMsg._data,this._logger);resultCallback(rect)})},getTabId:function(){return this._tab.id},getParentId:function(){return Util.shallowObjectClone(this._browserId)},INTERNAL_QUERY_PAGE_CONTENT_ID:function(msg){var contentId=this.getID();return contentId.frame=this._contentID,msg._data.contentId=contentId,msg},EVENT_BROWSER_DESTROY:function(msg){return this._logger.info("destroy: Called"),ext.dispatcher.removeListener("clientRegistered",this),ext.dispatcher.removeListener("clientUnRegistered",this),ext.dispatcher.removeListener("Message",this),msg},SRVC_FIX_FRAME_DESCRIPTION:function(msg,callback){var frameRtid=msg._data.frameRtid,description=msg._data.description;this._fixFrameDescription(frameRtid,description,function(updatedDescription){msg._data.description=updatedDescription,callback(msg)})},_getAllFramesWithMatchingProperties:function(excludedFrameRtid,properties,callback){this._logger.trace("_getAllFramesWithProperties: Called");var frameRtid=excludedFrameRtid,queryFrameByDescMsg=new Msg(MSG_TYPES.MATCH_DESC_TO_ID,this.getID(),Util.shallowObjectClone(properties));queryFrameByDescMsg._data.WEB_PN_ID=[];var nodeFunc=function(node,path,traverseCallback){if(RtIdUtils.IsRTIDEqual(frameRtid,node.id)||RtIdUtils.IsRTIDEqual(frameRtid,node.previousId))return this._logger.trace("_getAllFramesWithProperties: traverse node func: Found frame with id ",frameRtid),queryFrameByDescMsg._data.WEB_PN_ID.push(frameRtid),void traverseCallback(queryFrameByDescMsg);this._sendToContent(queryFrameByDescMsg,node.id.frame,function(){traverseCallback(queryFrameByDescMsg)}.bind(this))}.bind(this),isAlreadyCallback=!1;this._frames.traverseExcluding(nodeFunc,Util.alwaysFalse,this,frameRtid,function(resMsg){isAlreadyCallback=!0,callback(resMsg._data.WEB_PN_ID)}.bind(this));var _logger=this._logger;Util.setTimeout(function(){isAlreadyCallback||(_logger.warn("_getAllFramesWithMatchingProperties timeout send callback with empty object"),callback([]))},4e3)},_calculateFrameIndexSelector:function(description,callback){this._logger.trace("_calculateFrameIndexSelector: Called"),Util.assert("Frame"===description.properties.micclass,"_calculateFrameIndexSelector: Calculating partial selector for a non-Frame agent-object is not supported",this._logger);var properties=description.properties,selectorPartialVal=AttrPartialValueUtil.GetAttachedData(description.selector.value),frameRtid=selectorPartialVal.frameRtid,forceAddingSelector=selectorPartialVal.forceSelector;this._logger.trace("_calculateFrameIndexSelector: Finding selector for frame id: ",frameRtid),this._getAllFramesWithMatchingProperties(frameRtid,properties,function(rtidArr){if(forceAddingSelector||rtidArr.length>1){var indexVal=Util.arrayFindIndex(rtidArr,function(rtid){return RtIdUtils.IsRTIDEqual(frameRtid,rtid)},this);indexVal>=0?(this._logger.trace("_calculateFrameIndexSelector: Adding selector for frame ",frameRtid," - index selector val: ",indexVal),description.selector.value=indexVal):(this._logger.error("_calculateFrameIndexSelector: failed to calculate index selector for frame: ",frameRtid),delete description.selector)}else this._logger.trace("_calculateFrameIndexSelector: There is no need to add selector, force adding is: ",forceAddingSelector," - Candidate Frame # is ",rtidArr.length),delete description.selector;callback(description)}.bind(this))},_calculateFrameSelector:function(description,callback){switch(this._logger.trace("_calculateFrameSelector: Called"),Util.assert(description.selector&&AttrPartialValueUtil.IsPartialValue(description.selector.value),"_calculateFrameSelector: frame does not have required selector information",this._logger),description.selector.name){case"index":this._calculateFrameIndexSelector(description,callback);break;default:this._logger.error("_calculateFrameSelector: selector '"+description.selector.name+"' not handled for Frame."),delete description.selector,callback(description)}},_calculateFrameAssistiveProperties:function(properties,assistivePropsArr,allPropertiesVals,frameRtid,callback){function assistivePropertiesAlgorithm(assistivePropertyIndex,candidateRtIdsArr){switch(candidateRtIdsArr.length){case 0:Util.assert(!1,"_calculateFrameAssistiveProperties: assistivePropertiesAlgorithm received a result with no frames !",this._logger),callback(properties);break;case 1:this._logger.trace("_calculateFrameAssistiveProperties: assistivePropertiesAlgorithm: got to 1 result. finishing."),callback(properties);break;default:if(assistivePropertyIndex<assistivePropsArr.length){var nextAssistivePropName=assistivePropsArr[assistivePropertyIndex];properties[nextAssistivePropName]=allPropertiesVals[nextAssistivePropName],this._getAllFramesWithMatchingProperties(frameRtid,properties,assistivePropertiesAlgorithm.bind(this,assistivePropertyIndex+1))}else this._logger.trace("_calculateFrameAssistiveProperties: assistivePropertiesAlgorithm: finished adding assistive properties, no uniqueness is found. Candidate #"+candidateRtIdsArr.length),callback(properties)}}this._logger.trace("_calculateFrameAssistiveProperties: Called"),this._getAllFramesWithMatchingProperties(frameRtid,properties,assistivePropertiesAlgorithm.bind(this,0))},_calculateFrameDescription:function(msg,callback){this._logger.trace("_calculateFrameDescription: Called");var recordedDescriptionArr=msg._data["recorded description"][0],frameIndex=Util.arrayFindIndex(recordedDescriptionArr,function(descSpecialObj){return"Frame"===descSpecialObj.description.properties.micclass},this);if(-1===frameIndex)return this._logger.trace("_calculateFrameDescription: No Frame in description"),void callback(msg);var frameDescriptionSpecialObj=recordedDescriptionArr[frameIndex],frameRtid=msg._data.WEB_PN_ID[0][frameIndex];Util.assert(RtIdUtils.IsRTIDFrame(frameRtid),"_calculateFrameDescription: runtime id in index "+frameIndex+" doesn't contain a frame rtid. rtid= "+JSON.stringify(frameRtid),this._logger),this._fixFrameDescription(frameRtid,frameDescriptionSpecialObj.description,function(updatedDescription){frameDescriptionSpecialObj.description=updatedDescription,callback(msg)}.bind(this))},_fixFrameDescription:function(frameRtid,description,callback){var identificationProps=this._objIdentificationProps.frame,mandatoryPropsArr=identificationProps.mandatory||[],assistivePropsArr=identificationProps.assistive||[],allPropertiesValues=description.properties,mandatoryProperties={};mandatoryPropsArr.forEach(function(propName){mandatoryProperties[propName]=allPropertiesValues[propName]}),this._calculateFrameAssistiveProperties(mandatoryProperties,assistivePropsArr,allPropertiesValues,frameRtid,function(resultProperties){description.properties=resultProperties,this._calculateFrameSelector(description,function(updatedDescription){callback(updatedDescription)}.bind(this))}.bind(this))},EVENT_RECORD:function(msg){this._logger.trace("EVENT_RECORD: Called"),this._handleRecordEvent(msg)},EVENT_INTERNAL_RECORD_QUEUE:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE: Called"),this._handleRecordEvent(msg)},EVENT_INTERNAL_RECORD_DISPATCH_QUEUE:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_DISPATCH_QUEUE: Called"),this._handleRecordEvent(msg)},EVENT_INTERNAL_RECORD_QUEUE_CLEAR:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE_CLEAR: Called"),msg._to=this.getParentId(),ext.dispatcher.sendEvent(msg)},EVENT_INTERNAL_SEND_BROWSER_INFO:function(msg){if(this._logger.trace("EVENT_INTERNAL_SEND_BROWSER_INFO: Called"),this._contentID<0)return void this._logger.trace("EVENT_INTERNAL_SEND_BROWSER_INFO: Page has no content.");msg._to.frame=this._contentID,ext.dispatcher.sendEvent(msg)},_getAllSlvCookies:function(callback){var description=new Msg("QUERY_DESC_TO_ID",this.getID(),{"html tag":"OBJECT"});description._attr_names="html tag";var self=this;this.QUERY_DESC_TO_ID(description,function(msg){if("OK"!==msg.status||!msg._data.WEB_PN_ID||0===msg._data.WEB_PN_ID.length)return callback("");var remaining=msg._data.WEB_PN_ID.length,cookies=[];msg._data.WEB_PN_ID.forEach(function(id){var cookieMsg=new Msg("QUERY_ATTR",id,{qtp_slv_cookie:null});self.QUERY_ATTR(cookieMsg,function(resultMsg){var cookie=resultMsg._data.qtp_slv_cookie;cookie&&cookies.push(cookie),0==--remaining&&callback(cookies.join(";"))})})})},_handleRecordEvent:function(msg){this._logger.trace("_handleRecordEvent: Called"),this._calculateFrameDescription(msg,function(resMsg){this._logger.trace("_handleRecordEvent: Callback: Finished calculating partial attributes. Sending event to parent."),resMsg._to=this.getParentId(),ext.dispatcher.sendEvent(resMsg)}.bind(this))}},BrowserRecorder.prototype={_logger:null,_knownTabs:null,_destroyedTabs:[],_tabsReplacedMap:null,_eventData:null,_lastRemoveInfo:null,onTabReplaced:function(newTabId,oldTabId){this._logger.trace("onTabReplaced: replacing tab id: "+oldTabId+" with tab id: "+newTabId),this._tabsReplacedMap[oldTabId]=newTabId},onAddressBarNavigation:function(tabId,url){this._logger.trace("onAddressBarNavigation: started with tab id: "+tabId+" and url: "+url),this._onEventReceived(tabId,"navigate",url)},onReload:function(tabId){this._logger.trace("onReload: started with tab id: "+tabId),this._onEventReceived(tabId,"Refresh")},onBack:function(tabId,isFrameNavigation){this._logger.trace("onBack: started with tab id: "+tabId),this._onEventReceived(tabId,"Back"),isFrameNavigation&&this._askBrowserForData(tabId)},onForward:function(tabId,isFrameNavigation){this._logger.trace("onForward: started with tab id: "+tabId),this._onEventReceived(tabId,"Forward"),isFrameNavigation&&this._askBrowserForData(tabId)},onUserOpenedNewTab:function(openerTabId){this._logger.trace("onUserOpenedNewTab: started with tab id: "+openerTabId);var tabId=this._getUpdatedTabId(openerTabId);this._onEventReceived(tabId,"OpenNewTab"),this._askBrowserForData(tabId)},onUserClosedTab:function(closedTabId,removeInfo){this._logger.trace("onUserClosedTab: started with tab id: "+closedTabId);var tabId=this._getUpdatedTabId(closedTabId),browserToBeClosed=this._knownTabs[tabId];if(this._destroyedTabs[tabId]=browserToBeClosed,this._lastRemoveInfo&&this._lastRemoveInfo.isWindowClosing&&removeInfo&&this._lastRemoveInfo.windowId===removeInfo.windowId)this._logger.trace("onUserClosedTab: tab is closed by window close, so skipping record since CloseAllTabs was recorded.");else{var eventName=removeInfo&&removeInfo.isWindowClosing?"CloseAllTabs":"Close";this._onEventReceived(tabId,eventName)}this._lastRemoveInfo=removeInfo},onBrowserInformationReceived:function(tabId,browserInfo){this._logger.trace("onBrowserInformationReceived: started with tab id: "+tabId),tabId=this._getUpdatedTabId(tabId),this._eventData[tabId]||(this._eventData[tabId]={}),this._eventData[tabId].data=browserInfo,this._dispatchRecordEvent(tabId)},_askBrowserForData:function(tabId){var browser=this._knownTabs[tabId],recordMsg=new Msg("EVENT_INTERNAL_SEND_BROWSER_INFO",browser.getID(),{});browser.onMessage(recordMsg)},_onEventReceived:function(tabId,eventName,url){this._logger.trace("_onEventReceived: started with tab id: "+tabId+", event name: "+eventName+" and url: "+url),tabId=this._getUpdatedTabId(tabId),this._eventData[tabId]||(this._eventData[tabId]={}),this._eventData[tabId].name=eventName,this._eventData[tabId].url=url,this._dispatchRecordEvent(tabId),Util.setTimeout(function(){this._eventData[tabId]&&(this._logger.warn("_onEventReceived: clearing event data of: "+this._eventData[tabId].name+" - tab id: "+tabId),this._eventData[tabId].name=null)}.bind(this),1e4)},_getUpdatedTabId:function(tabId){if(this._tabsReplacedMap[tabId]){var newTabId=this._tabsReplacedMap[tabId];return this._logger.trace("_getUpdatedTabId: tab id: "+tabId+" was replaced with tab id: "+newTabId),newTabId}return tabId},_createRecordData:function(ao){this._logger.trace("_createRecordData: started");var micclass=Util.getMicClass(ao),objDesc=Description.createEmptyRecordDescription(ao),description=SpecialObject.CreateDescription(objDesc);return{WEB_PN_ID:[[ao.getID()]],micclass:[[micclass]],"recorded description":[[description]],"event id":[[]]}},_dispatchRecordEvent:function(tabId){if(this._logger.trace("_dispatchRecordEvent: Called for tabId: "+tabId),
!Util.isNullOrUndefined(this._eventData[tabId])&&!Util.isNullOrUndefined(this._eventData[tabId].name)){var browser=this._knownTabs[tabId];browser||(browser=this._destroyedTabs[tabId]),Util.assert(browser,"_dispatchRecordEvent: Browser is undefined",this._logger);var data=this._eventData[tabId].data;if(Util.isNullOrUndefined(data)){if(browser.GetAttrSync("openurl").length>0)return;this._logger.trace("_dispatchRecordEvent: Creating an empty record description for uninitialized browser: "+tabId),data=this._createRecordData(browser)}this._logger.prettyDebug("_dispatchRecordEvent: Recording Navigation: ",this._eventData[tabId]);var eventName=this._eventData[tabId].name,url=this._eventData[tabId].url;delete this._eventData[tabId];var eventId=SpecialObject.CreateEventId({clientX:0,clientY:0,type:eventName},browser.getID());data["event id"][0][0]=eventId,data.event=eventName,data.text=eventName,data.url=url;var recordMsg=new Msg("EVENT_RECORD",browser.getID(),data);browser.onMessage(recordMsg)}}},Agent.prototype={_logger:null,_knownTabs:{},_inspectionMode:null,_settings:null,_eventConfigCache:null,_browserRecorder:null,onMessage:function(msg,resultCallback){if(this._logger.trace("onMessage: Started with message ",msg),!this[msg._msgType])return void this._dispatchMessageToAllBrowsers(msg,resultCallback);this[msg._msgType](msg,resultCallback)},SRVC_SET_CLASS2WITYPE_OBJ:function(msg,resultCallback){resultCallback(msg)},SRVC_SET_ENUM2STRINGMAP_OBJ:function(msg,resultCallback){resultCallback(msg)},SRVC_GET_ALL_BROWSERS:function(msg,resultCallback){var resultArr=[];this._getTargetBrowsers().forEach(function(browser){resultArr.push(browser.getID())}.bind(this)),1===resultArr.length?msg._data.WEB_PN_ID=resultArr[0]:msg._data.WEB_PN_ID=[resultArr],resultCallback(msg)},SRVC_INVOKE_METHOD:function(msg,resultCallback){var name=msg._data.AN_METHOD_NAME,func=this.invokeMethods[name];if(func)return void func.call(this,msg,resultCallback);ErrorReporter.ThrowNotImplemented("Browser.invokeMethod: "+name)},NOTIFY_BROWSER_IS_NOT_VALID:function(msg,resultCallback){var browserTabID=msg._data.WEB_PN_ID.browser;this.destroyBrowser(browserTabID),resultCallback(msg)},CMD_BROWSER_CLOSE_ALL_TABS:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_CLOSE_ALL_TABS: Started");var closeTabMsg=new Msg("CMD_BROWSER_CLOSE",msg._to,{});this._dispatchMessageToAllBrowsers(closeTabMsg,resultCallback)},SRVC_SET_GLOBAL_VARIABLES:function(msg,resultCallback){this._logger.trace("SRVC_SET_GLOBAL_VARIABLES: Started"),this._settings=this._readSettingsFromMsg(msg),Util.assert(this._settings,"SRVC_SET_GLOBAL_VARIABLES: Received empty settings",this._logger),null!=this._settings.WebActivityState&&this._handleWebActivityState(this._settings.WebActivityState);var newSettingsMsg=new Msg("SRVC_SET_GLOBAL_VARIABLES_INTERNAL",this.getID(),this._settings);this._dispatchMessageToAllBrowsers(newSettingsMsg,function(){resultCallback(msg)})},_readSettingsFromMsg:function(msg){this._logger.trace("_readSettingsFromMsg: Started");var settingPropName,variables=msg._data,new_settings={};if(Array.isArray(variables.name))for(var i=0;i<variables.name[0].length;++i)settingPropName="webactivitystate"==variables.name[0][i]?"WebActivityState":variables.name[0][i],new_settings[settingPropName]=variables.value[0][i];else settingPropName="webactivitystate"==variables.name?"WebActivityState":variables.name,new_settings[settingPropName]=variables.value;return new_settings},_handleWebActivityState:function(webActivityState){function setIdleMode(){this._inspectionMode=null,this._browserRecorder=null}switch(this._logger.trace("_handleWebActivityState: Started"),webActivityState){case 0:this._logger.trace("_handleWebActivityState: Idle mode set"),setIdleMode.call(this);break;case 1:this._logger.trace("_handleWebActivityState: Record started"),this._inspectionMode="record",this._browserRecorder||(this._browserRecorder=new BrowserRecorder(this._knownTabs));break;case 2:this._logger.trace("_handleWebActivityState: Replay started"),ext.app.runStarted&&ext.app.runStarted(),setIdleMode.call(this);break;default:this._logger.error("_handleWebActivityState: setting mode to idle. Unhandled WebActivityState: "+webActivityState),setIdleMode.call(this)}},SRVC_SET_EVENT_CONFIGURATION:function(msg,resultCallback){this._logger.trace("SRVC_SET_EVENT_CONFIGURATION: Started");var config=this._parseEventConfig(msg._data.EN_CONFIG_DATA);this._eventConfigCache=config;var newMsg=new Msg("SRVC_SET_EVENT_CONFIGURATION_INTERNAL",msg._to,{config:config});this._dispatchMessageToAllBrowsers(newMsg,function(){resultCallback(msg)})},_parseEventConfig:function(xml){this._logger.trace("_parseEventConfig: called.");var json=Util.convertXmlStrToJson(xml);if(!json)return this._logger.error("_parseEventConfig: Faile to convert configuration from XML to JSON! "+msg._data.EN_CONFIG_DATA),null;var config={};return Util.map(json.XML.Object,function(micclassConfig,args){var micclass=micclassConfig._Name.toLowerCase();config[micclass]={},Util.map(micclassConfig.Event,function(eventConfig){config[micclass][eventConfig._Name]={listen:parseInt(eventConfig._Listen),record:parseInt(eventConfig._Record)}})}),config},_setInspectionMode:function(msg,resultCallback){switch(this._logger.trace("_setInspectionMode: Called."),msg._msgType){case"CMD_SPY_START":this._inspectionMode="spy";break;case"CMD_SPY_END":this._inspectionMode=null;break;default:return this._logger.error("_setInspectionMode called with unknown msg type: "+msg._msgType),void resultCallback(msg)}this._dispatchMessageToAllBrowsers(msg,resultCallback)},_onAddressBarNavigation:function(tabId,url){this._logger.trace("_setInspectionMode: Called."),this._doInRecord(function(){this._browserRecorder.onAddressBarNavigation(tabId,url)})},_onSpySuspended:function(){this._logger.trace("_onSpySuspended: Called.");var msg=new Msg("CMD_SPY_END",this.getID(),{});this._setInspectionMode(msg,Util.identity)},_onSpyResumed:function(){this._logger.trace("_onSpyResumed: Called.");var msg=new Msg("CMD_SPY_START",this.getID(),{});this._setInspectionMode(msg,Util.identity)},CMD_SPY_START:function(msg,resultCallback){this._logger.trace("CMD_SPY_START: Called."),ext.app.setInteractionMode?ext.app.setInteractionMode("spy"):this._logger.debug("CMD_SPY_START: Browser doesn't support InteractionMode"),this._setInspectionMode(msg,resultCallback)},CMD_SPY_END:function(msg,resultCallback){this._logger.trace("CMD_SPY_END: Called."),ext.app.setInteractionMode?ext.app.setInteractionMode("normal"):this._logger.debug("CMD_SPY_END: Browser doesn't support InteractionMode"),this._setInspectionMode(msg,resultCallback)},CMD_MONITOR_MOUSE_START:function(msg,resultCallback){this._logger.trace("CMD_MONITOR_MOUSE_START called"),this._dispatchMessageToAllBrowsers(msg,resultCallback)},CMD_MONITOR_MOUSE_END:function(msg,resultCallback){this._logger.trace("CMD_MONITOR_MOUSE_END called"),this._dispatchMessageToAllBrowsers(msg,resultCallback)},invokeMethods:{BROWSER_GET_ACTIVE_TAB_FOR_BROWSER_FRAME_WND:function(msg,resultCallback){function dispatchResult(browserResultArr){var returnMsg=Description.buildReturnMsg(msg._msgType,msg._to,browserResultArr,this._logger);delete returnMsg.status,resultCallback(returnMsg)}this._logger.trace("BROWSER_GET_ACTIVE_TAB_FOR_BROWSER_FRAME_WND: Started"),Description.filterAOList(this._getTargetBrowsers(),{isActive:!0},function(candidateActiveBrowsersArr){if(this._logger.trace("BROWSER_GET_ACTIVE_TAB_FOR_BROWSER_FRAME_WND.filterAOList: returned with "+candidateActiveBrowsersArr.length+" candidates"),candidateActiveBrowsersArr.length<=0)return void dispatchResult.call(this,candidateActiveBrowsersArr);var candidateBrowsersArr=[],normalBrowsersArr=[];candidateActiveBrowsersArr.forEach(function(browser){browser._associatedTab&&browser._associatedTab._emulatingDevice?candidateBrowsersArr.push(browser):normalBrowsersArr.push(browser)}),Description.filterAOList(normalBrowsersArr,{rect:msg._data.rect},function(candidateNormalBrowsersArr){if(candidateNormalBrowsersArr.length>0&&(candidateBrowsersArr=candidateBrowsersArr.concat(candidateNormalBrowsersArr)),candidateBrowsersArr.length<=1)return void dispatchResult.call(this,candidateBrowsersArr);this._logger.trace("BROWSER_GET_ACTIVE_TAB_FOR_BROWSER_FRAME_WND More than one candidate browser found by rect - let's try to find by name");var browserTitle=msg._data.title.replace(" - Google Chrome","");browserTitle=browserTitle.replace(" - Mozilla Firefox",""),browserTitle=browserTitle.replace(" - Microsoft Edge",""),Description.filterAOList(candidateBrowsersArr,{title:browserTitle},function(filteredBrowsersArr){if(0===filteredBrowsersArr.length)return this._logger.debug("BROWSER_GET_ACTIVE_TAB_FOR_BROWSER_FRAME_WND: No match found trying to see if the URL is the given title"),void Description.filterAOList(candidateBrowsersArr,{"url no protocol":browserTitle},dispatchResult.bind(this));dispatchResult(filteredBrowsersArr)}.bind(this))}.bind(this))}.bind(this))},CALL_UPDATE_OF_ALL_FRAMES:function(msg,resultCallback){this._logger.trace("CALL_UPDATE_OF_ALL_FRAMES: called"),resultCallback(msg)}},_mergeValue:function(msg,key,val){msg._data[key]?(Util.isUndefined(msg._data[key].length)&&(msg._data[key]=[[msg._data[key]]]),msg._data[key][0]=msg._data[key][0].concat([val])):msg._data[key]=val},_getTargetBrowsers:function(){var browserArr=[];return Object.keys(this._knownTabs).forEach(function(tabId){var browser=this._knownTabs[tabId];browser&&browserArr.push(browser)}.bind(this)),browserArr},_dispatchMessageToAllBrowsers:function(msg,resultCallback){this._logger.trace("_dispatchMessageToAllBrowsers: started");var logger=this._logger,targetBrowsers=this._getTargetBrowsers().filter(Util.identity);if(0===targetBrowsers.length)return this._logger.info("_dispatchMessageToAllBrowsers: No Target browsers to dispatch message to, Returning."),void resultCallback(msg);var multiResponses=new MultipleResponses(targetBrowsers.length);targetBrowsers.forEach(function(browser){this._logger.trace("onMessage: Requesting browser ",browser.getID());var browserMsg=new Msg(msg._msgType,browser.getID(),msg._data);browser.onMessage(browserMsg,multiResponses.callback(function(isDone,resultMsg){mergeMessages(msg,resultMsg),isDone&&(logger.trace("_dispatchMessageToAllBrowsers: returned with message: ",msg),resultCallback(msg))}))},this)},UpdateKnownBrowsers:function(){this._logger.trace("UpdateKnownBrowsers: Called.");var filterKnownTabs=function(tabId){return!this._knownTabs[tabId]};ext.app.getAllTabs(filterKnownTabs.bind(this),function(tabsArr){this._logger.trace("UpdateKnownBrowsers: getAllTabs returned"),tabsArr.forEach(function(tab){this._logger.trace("UpdateKnownBrowsers: Creating browser for tabId = "+tab.id),this.createBrowser(tab)}.bind(this))}.bind(this))},createBrowser:function(tab){if(this._logger.info("createBrowser: called for tab Id: "+tab.id),this._knownTabs[tab.id])return void this._logger.info("createBrowser: We have already created browser for tab: "+tab.id);var shouldConnect=ext.dispatcher.shouldConnectExternal();"unsupported"===shouldConnect&&(shouldConnect=!this.hasOpenedTabs()&&!ext.dispatcher.isConnectPerformed),shouldConnect&&(this._logger.info("createBrowser: First time browser is created going to create the Testing Tools communication channel"),ext.dispatcher.connect()),this._knownTabs[tab.id]=new Browser(tab),this._knownTabs[tab.id].init()},destroyBrowser:function(tabId){this._logger.info("destroyBrowser: called with tab Id: "+tabId),Util.isUndefined(this._knownTabs[tabId])||null===this._knownTabs[tabId]||(this._knownTabs[tabId].destroy(),delete this._knownTabs[tabId])},hasOpenedTabs:function(){return 0!==this._getTargetBrowsers().length},onclientRegistered:function(client,registrationInfo,registrationResData){this._logger.info("onclientRegistered: Started for client:\n",client,"\nregistrationInfo=\n",registrationInfo);var tabID=client.tabID;registrationResData.inspectionMode=this._inspectionMode,registrationResData.globalVariables=this._settings,registrationResData.eventConfig=this._eventConfigCache,registrationResData.ignoreBrowserDescription=!!ext.app.ignoreBrowserDescription,this._knownTabs[tabID]||(this._logger.debug("onclientRegistered: Got registration from unknown tab with id:"+tabID),registrationResData.status="pending")},_onTabCreated:function(tab){this._logger.info("_onTabCreated: called for tab id: "+tab.id),this.createBrowser(tab)},_onTabClosed:function(tabId){this._logger.info("_onTabClosed: called for tab Id: "+tabId),this.destroyBrowser(tabId)},_onTabReplaced:function(newTabId,oldTabId){this._logger.trace("_onTabReplaced: replacing tab "+oldTabId+" with tab "+newTabId),this._doInRecord(function(){this._browserRecorder.onTabReplaced(newTabId,oldTabId)})},_onReload:function(tabId){this._logger.trace("_onReload: called for tab id: "+tabId),this._doInRecord(function(){this._browserRecorder.onReload(tabId)})},_onForward:function(tabId,isFrameNavigation){this._logger.trace("_onReload: called for tab id: "+tabId),this._doInRecord(function(){this._browserRecorder.onForward(tabId,isFrameNavigation)})},_onBack:function(tabId,isFrameNavigation){this._logger.trace("_onReload: called for tab id: "+tabId),this._doInRecord(function(){this._browserRecorder.onBack(tabId,isFrameNavigation)})},_onUserOpenedNewTab:function(openerTabId){this._logger.trace("_onUserOpenedNewTab: called for opener tab id: "+openerTabId),this._doInRecord(function(){this._browserRecorder.onUserOpenedNewTab(openerTabId)})},_onUserClosedTab:function(tabId,removeInfo){this._doInRecord(function(){this._browserRecorder.onUserClosedTab(tabId,removeInfo)})},CMD_BROWSER_RUN_ENDED:function(msg,resultCallback){ext.app.runEnded&&ext.app.runEnded(),resultCallback(msg)},getID:function(){return{browser:-1,page:-1,frame:-1,object:null}},QUERY_IDS_TO_ATTRS:function(msg,resultCallback){var ids=msg._data.WEB_PN_ID;Array.isArray(ids)?ids=ids[0]:null!==ids&&(ids=[ids]);var prop;for(prop in msg._data)"WEB_PN_ID"!==prop&&(msg._data[prop]=[[[]]]);if(null===ids)return msg._data.WEB_PN_ID=[],void resultCallback(msg);var newData={};for(prop in msg._data)"WEB_PN_ID"!==prop&&(newData[prop]=null);for(var multiResponses=new MultipleResponses(ids.length),multiResponsesCallback=multiResponses.callback(function(done,rtnMsg){this._logger.trace("QUERY_IDS_TO_ATTRS: QUERY_ATTR message's callback invoked. All done: "+done);for(var prop in newData){var val=rtnMsg._data[prop];Array.isArray(val)?msg._data[prop][0][0].push(val[0]):msg._data[prop][0][0].push(val)}done&&(this._logger.trace("QUERY_IDS_TO_ATTRS: Finished quering all the runtids going to 'fix' the message rtids"),Array.isArray(msg._data.WEB_PN_ID)&&(msg._data.WEB_PN_ID=msg._data.WEB_PN_ID[0]),resultCallback(msg))}.bind(this)),i=0;i<ids.length;i++){var newMsg=new Msg(MSG_TYPES.QUERY,Util.shallowObjectClone(ids[i]),Util.shallowObjectClone(newData));ext.dispatcher.sendMessage(newMsg,null,"chrome",multiResponsesCallback)}},EVENT_INTERNAL_RECORD_BROWSER_INFO:function(msg){if(!this._browserRecorder)return void this._logger.warn("EVENT_INTERNAL_RECORD_BROWSER_INFO: BrowserRecorder is empty");this._browserRecorder.onBrowserInformationReceived(msg._data.WEB_PN_ID[0][0].browser,msg._data)},_registerAppEvent:function(eventName,callback){ext.app[eventName]?(ext.app[eventName](callback),this._logger.trace("registerAppEvent: Registered for '"+eventName+"' event.")):this._logger.info("registerAppEvent: Current Browser doesn't support the '"+eventName+"' event.")},_doInRecord:function(func){"record"===this._inspectionMode&&(Util.assert(this._browserRecorder,"_doInRecord: BrowserRecorder is empty during Recording",this._logger),func.call(this))}},ExtDispatcher.prototype={isConnectPerformed:!1,_logger:null,_externalComChannel:null,_inboundChromeCOM:null,_knownClients:[],_nextMessageID:0,_responseCallbacks:null,_listeners:null,_currentGlobalErrorHandler:null,shouldConnectExternal:function(){return this._externalComChannel.shouldConnect()},connect:function(){this._logger.info("connect: Started"),this.isConnectPerformed=!0,this._connectExternalComChannel(),this._logger.info("connect finished: with daemon channel id ",this._externalComChannel.id)},disconnect:function(){this._logger.trace("disconnect: Called"),this._externalComChannel.disconnect(),this._inboundChromeCOM.disconnect(),this.isConnectPerformed=!1},onUnload:function(){this._externalComChannel&&this._externalComChannel.disconnect()},sendMessage:function(msg,target,forceCOMType,resultCallback){return this._logger.trace("sendMessage: Going to send \n ",msg,"\nto:\n",target),target=target||msg._to,this._isLocalTarget(target)?this._dispatchMessageLocally(msg,resultCallback):this._dispatchMessageExternally(msg,target,forceCOMType,resultCallback)},sendEvent:function(msg,target){if(this._logger.prettyTrace("sendEvent: Going to send \n ",msg,"\nto:\n",target),target=target||msg._to,this._isLocalTarget(target))return this._dispatchMessageLocally(msg,Util.identity);this._logger.trace("_dispatchMessageExternally: dispatching event to an external context");var comChannel=this._getTargetCOMChannel(target);this._transformMessageIfNeeded(msg,target),comChannel.sendEvent(msg,target.frame)},getParentDispatcherID:function(){return RtIdUtils.GetTestingToolRtId()},isIdle:function(tabID){return this._logger.trace("isIdle: Started for tab=",tabID),0===(this._knownClients[tabID]||[]).filter(function(p){return!p.attached}).length},getNumberOfClients:function(tabID){return this._logger.info("getNumberOfClients: started"),this._knownClients[tabID].length},addListener:function(eventName,listenerObj){switch(this._logger.info("addListener: called"),eventName){case"Message":this._logger.trace("addListener Message for ",listenerObj.id),this._listeners[eventName]||(this._listeners[eventName]=new WebIdContainer),this._listeners[eventName].add(listenerObj.id,listenerObj);break;default:this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerObj)}},removeListener:function(eventName,listenerObj){if(this._logger.info("ExtDispatcher.removeListener: called"),!this._listeners[eventName])return void this._logger.error("ExtDispatcher.removeListener: Trying to remove listener that is not registered");switch(eventName){case"Message":if(!this._listeners[eventName].remove(listenerObj.id))return void this._logger.error("removeListener: Removing unknown listener");break;default:var listenerIdx=this._listeners[eventName].indexOf(listenerObj);if(-1===listenerIdx)return void this._logger.error("removeListener: Removing unknown listener");this._inMiddleOfEvent?this._listeners[eventName][listenerIdx].toBeDeleted=!0:this._listeners[eventName].splice(listenerIdx,1)}},dispatchEvent:function(eventName){if(this._logger.info("dispatchEvent: called for event: ",eventName),!this._listeners[eventName])return void this._logger.trace("dispatchEvent: no listeners found for event: ",eventName);var args=Util.makeArray(arguments);args.splice(0,1);var funcName="on"+eventName,listeners=this._listeners[eventName];this._inMiddleOfEvent=!0;for(var i=0;i<listeners.length;++i)listeners[i].toBeDeleted||listeners[i][funcName].apply(listeners[i],args);delete this._inMiddleOfEvent,this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return!listener.toBeDeleted})},onClientConnect:function(client){this._logger.info("onClientConnect started for client=",client),this._knownClients[client.tabID]&&0!==this._knownClients[client.tabID].length||(this._logger.info("onClientConnect: First frame registration for this page for tab:",client.tabID),this._knownClients[client.tabID]=[]),this._knownClients[client.tabID].push(client),this._logger.info("onClientConnect: Finished")},onClientDisconnect:function(client){this._logger.info("onClientDisconnect: Removing Client ",client),client=this._getClientFromSender(client);var tabId=client.tabID,content=this._knownClients[tabId],index=content.indexOf(client);if(-1===index)return void this._logger.error("onClientDisconnect: disconnect on non existint client");content.splice(index,1),this.dispatchEvent("clientUnRegistered",client),this._logger.info("onClientDisconnect: Finished")},onMessage:function(msg,sender,resultCallback){this._logger.prettyTrace("onMessage: Received message: \n",msg),this._setGlobalErrorHandler(msg,resultCallback);try{this._onMessageInternal(msg,sender,resultCallback)}finally{this._resetGlobalErrorHandler()}},_onMessageInternal:function(msg,sender,resultCallback){this._logger.trace("_onMessageInternal: Called");var func=this._messageHandlers[msg._msgType];return func?func.call(this,msg,sender,resultCallback):this._handleDefaultMessageDispatch(msg,resultCallback)},onAsyncMessage:function(msg,sender,callback){this._logger.trace("onAsyncMessage: started with message:\n",msg);var client=this._getClientFromSender(sender);this.onMessage(msg,client,callback)},onEvent:function(msg,sender){this._logger.trace("onEvent: started with message:\n",msg),this._onMessageInternal(msg,sender,Util.identity)},onResponseMessage:function(msg,client){this._logger.prettyTrace("onResponseMessage: Started with the following message:\n",msg);var asyncInfo=msg._extAsyncInfo;if(delete msg._extAsyncInfo,!asyncInfo)return void this._logger.debug("onResponseMessage: The message has no async information");if(Util.isNullOrUndefined(asyncInfo.id))return void this._logger.debug("onResponseMessage: asyncInfo does not contain a cookie id");if(!this._responseCallbacks[asyncInfo.id])return void this._logger.debug("onResponseMessage: No call back info for message with async Cookie =",asyncInfo.id);StatusUtil.isUnexpected(msg.status)&&this._logger.error("onResponseMessage: Got error message response. Process anyway. Status: ",msg.status,". Message: ",msg),delete this._responseCallbacks[asyncInfo.id].origMsg._extAsyncInfo;var func=this._responseCallbacks[asyncInfo.id].func;this._currentGlobalErrorHandler=this._responseCallbacks[asyncInfo.id].globalErrorHandler;try{msg.delay?(delete msg.delay,ext.app.isNewMsgDelayEnabled?Util.setTimeout(func.bind(null,msg),120):func(msg)):func(msg)}catch(e){this._logger.error("onResponseMessage: Got Exception:"+e+" Details: "+(e.Details||"")+". Call global error callback\nStack:"+e.stack),this._currentGlobalErrorHandler?this._currentGlobalErrorHandler(e):this._logger.warn("onResponseMessage: global error callback is not set")}this._resetGlobalErrorHandler(),delete this._responseCallbacks[asyncInfo.id]},onRequestTimedout:function(requestMsg,clientId){this._logger.warn("onRequestTimedout: Destination ",clientId," on message ",requestMsg),requestMsg.status="TimedOut",this.onResponseMessage(requestMsg,clientId)},_getTargetCOMChannel:function(target,forceCOMType){switch(this._logger.trace("_getTargetCOMChannel: Started for target:",target," forceCOMType is:",forceCOMType),forceCOMType){case"chrome":return this._inboundChromeCOM;case"daemon":case"uft":return this._externalComChannel}return RtIdUtils.IsRTIDTestingTool(target)?this._externalComChannel:RtIdUtils.IsRTIDDaemon(target)?this._externalComChannel:RtIdUtils.IsRTIDFrame(target)||RtIdUtils.IsRTIDAO(target)?this._inboundChromeCOM:void this._logger.error("_getTargetCOMChannel: no COMChannel has returned for rtid: ",target,". Error Stack: "+(new Error).stack)},_getClientFromSender:function(sender){return this._logger.trace("_getClientFromSender: started"),(this._knownClients[sender.tabID]||[]).filter(function(client){return sender.id===client.id})[0]},_isLocalTarget:function(target){return!!RtIdUtils.IsRuntimeId(target)&&!!(RtIdUtils.IsRTIDAgent(target)||RtIdUtils.IsRTIDBrowser(target)||RtIdUtils.IsRTIDPage(target))},_messageHandlers:{REGISTER_FRAME:function(msg,sender,resultCallback){this._logger.info("_messageHandlers.REGISTER_FRAME: Got Registration for tab:",sender.tabID,", sender id:",sender.id);var registrationInfo=msg._data;registrationInfo.frameID=sender.id;var registrationResData={};if(this.dispatchEvent("clientRegistered",sender,registrationInfo,registrationResData),0===Object.keys(registrationResData).length)return void this._logger.warn("_messageHandlers.REGISTER_FRAME: Got error during registration of + "+JSON.stringify(sender)+" going to ignore it.");registrationResData.tabID=sender.tabID,registrationResData.logSettings=LoggerUtilSettings.getLogSettings(),msg._data=registrationResData,resultCallback(msg)},"Frame Attached":function(msg,sender,resultCallback){this._logger.trace("_messageHandlers['Frame Attached']: Got 'Frame Attached' for frameID: ",msg._data.frameID),sender.attached=!0,resultCallback(msg)},EVENT_INSPECT_ELEMENT:function(msg,sender,resultCallback){this._logger.trace("_messageHandlers.EVENT_INSPECT_ELEMENT: started");var inspectMsg=new Msg("EVENT_INSPECT_ELEMENT",msg._data.WEB_PN_ID[0]);this.sendEvent(inspectMsg,this.getParentDispatcherID()),resultCallback(msg)},EVENT_INSPECT_CANCEL:function(msg,sender,resultCallback){this._logger.trace("_messageHandlers.EVENT_INSPECT_CANCEL: started");var inspectMsg=new Msg("EVENT_INSPECT_CANCEL",this.getParentDispatcherID(),{});this.sendEvent(inspectMsg,this.getParentDispatcherID()),resultCallback(msg)},WEBEXT_REPORT_LINE:function(msg,sender,resultCallback){this._logger.trace("_messageHandlers.WEBEXT_REPORT_LINE: started"),this.sendEvent(msg,this.getParentDispatcherID()),resultCallback(msg)},SRVC_BATCH_QUERYATTR:function(msg,sender,resultCallback){var objIds=Array.isArray(msg._data.WEB_PN_ID)?msg._data.WEB_PN_ID[0]:[msg._data.WEB_PN_ID];if(!objIds)return void this._logger.error("_messageHandlers.SRVC_BATCH_QUERYATTR: Received SRVC_BATCH_QUERYATTR with no data");this._logger.trace("_messageHandlers.SRVC_BATCH_QUERYATTR: Fixing browser id for SRVC_BATCH_QUERYATTR message to be ",objIds[0].browser),msg._to.browser=objIds[0].browser,this._handleDefaultMessageDispatch(msg,resultCallback)}},_handleDefaultMessageDispatch:function(msg,resultCallback){this._UftToChromeRtid(msg),this._logger.trace("_handleMessageDispatch: sending direct message to ",msg._to),this._isLocalTarget(msg._to)?this._dispatchMessageLocally(msg,function(result){this._logger.prettyTrace("_handleMessageDispatch: received response from Local AO: [ASYNC] \n",result),this._ChromeToUftRtid(result),resultCallback(result)}.bind(this)):(this._logger.prettyTrace("_handleMessageDispatch: sending message to content:\n",msg),ext.dispatcher.sendMessage(msg,null,"chrome",function(result){this._logger.prettyTrace("_handleMessageDispatch: received message from content: [ASYNC]\n",result),this._ChromeToUftRtid(result),resultCallback(result)}.bind(this)))},_dispatchMessageLocally:function(msg,returnResult){this._logger.trace("_dispatchMessageLocally: dispatching ",returnResult?"Async ":"Sync"," message to locally, content: ",msg);var targetAO=RtIdUtils.IsRTIDAgent(msg._to)?ext.agent:this._listeners.Message.find(msg._to);return targetAO?msg=targetAO.onMessage(msg,returnResult):(this._logger.error("_dispatchMessageLocally: unable to find target AO in container for: ",msg._to),msg.status="ERROR",void returnResult(msg))},_dispatchMessageExternally:function(msg,target,forceCOMType,resultCallback){this._logger.trace("_dispatchMessageExternally: dispatching message to an external context");var comChannel=this._getTargetCOMChannel(target,forceCOMType);return resultCallback&&(Util.isUndefined(msg._extAsyncInfo)||this._logger.error("sendMessage: There is already asyncCookie on this message please handle it"),msg._extAsyncInfo={id:++ExtDispatcher.prototype._nextMessageID},this._responseCallbacks[msg._extAsyncInfo.id]={func:resultCallback,origMsg:msg,globalErrorHandler:this._currentGlobalErrorHandler}),this._transformMessageIfNeeded(msg,target),comChannel.sendMessage(msg,target.frame)},_getAllClients:function(){var clients=[];return this._knownClients.forEach(function(clientsInTab){clients=clients.concat(clientsInTab)}),clients},_connectExternalComChannel:function(){this._logger.trace("_connectToDaemonComChannel: called"),this._externalComChannel.connect()},_setExternalComChannel:function(){this._logger.trace("_setExternalComChannel: called"),this._externalComChannel=ext.app.createExternalComChannel(),this._externalComChannel.init(),this._externalComChannel.addListener("message",this.onMessage.bind(this)),this._externalComChannel.addListener("response",this.onResponseMessage.bind(this))},_transformMessageIfNeeded:function(msg,target){target=target||msg._to,this._getTargetCOMChannel(target)===this._externalComChannel&&(this._logger.trace("_transformMessageIfNeeded: transforming message with target: ",target),this._ChromeToUftRtid(msg))},_UftToChromeRtid:function(msg){var aoContainer=this._listeners.Message,logger=this._logger,shouldBeChanged=function(rtid){return rtid&&rtid.object&&-1===rtid.frame},changeRtid=function(rtid){if(shouldBeChanged(rtid)){var pageObjId={browser:rtid.browser,page:rtid.page,frame:-1,object:null},pageAO=aoContainer.find(pageObjId);if(!pageAO)return void logger.error("_UftToChromeRtid::changeRtid: Page ",pageObjId," doesn't exist in container");logger.trace("_UftToChromeRtid.changeRtid: changing from rtid ",rtid),rtid.frame=pageAO._contentID,logger.trace("_UftToChromeRtid.changeRtid: changed to rtid ",rtid)}};if(msg&&(changeRtid(msg._to),msg._data&&msg._data.WEB_PN_ID)){var objIds=Array.isArray(msg._data.WEB_PN_ID)?msg._data.WEB_PN_ID:[msg._data.WEB_PN_ID];objIds=Array.isArray(objIds[0])?objIds[0]:objIds,objIds.forEach(function(id){changeRtid(id)})}},_ChromeToUftRtid:function(msg){function shouldRevert(rtid){if(rtid&&rtid.object){var pageObjId={browser:rtid.browser,page:rtid.page,frame:-1,object:null},pageAO=aoContainer.find(pageObjId);return pageAO?pageAO._contentID===rtid.frame:void logger.error("_ChromeToUftRtid::changeshouldRevertRtid: Page ",pageObjId," doesn't exist in container")}return!1}function revertRtid(rtid){shouldRevert(rtid)&&(logger.trace("_ChromeToUftRtid.revertRtid: reverting the rtid.frame of ",rtid),rtid.frame=-1,logger.trace("_ChromeToUftRtid.revertRtid: rtid reverted to  ",rtid))}var aoContainer=this._listeners.Message,logger=this._logger;if(msg){if(revertRtid(msg._to),RtIdUtils.IsRTIDTestingTool(msg._to)){var toVal=Array.isArray(msg._data.WEB_PN_ID)?msg._data.WEB_PN_ID[0]:msg._data.WEB_PN_ID;msg._to=Array.isArray(toVal)?toVal[0]:toVal,Util.assert(RtIdUtils.IsRuntimeId(msg._to),"_ChromeToUftRtid: failed to change the 'to' part of message: "+JSON.stringify(msg),this._logger)}if(msg._data){if(msg._data.WEB_PN_ID){(Array.isArray(msg._data.WEB_PN_ID)?msg._data.WEB_PN_ID:[msg._data.WEB_PN_ID]).forEach(function(id){revertRtid(id)})}msg._data.ancestor&&revertRtid(msg._data.ancestor)}}},_resetGlobalErrorHandler:function(){this._currentGlobalErrorHandler=null},_setGlobalErrorHandler:function(msg,resultCallback){this._currentGlobalErrorHandler=function(origMsg,error){origMsg.status="ERROR",origMsg.details=error?error.message:null,resultCallback(origMsg)}.bind(this,msg)}};var ext=null;!function(){function getCurrentApi(){if(window._QTP&&window._QTP.WebDriverInfo)return WebDriverBrowserAPI;if("undefined"!=typeof window){if(window.chrome&&window.chrome.extension)return ChromeAPI;if(window.safari&&window.safari.extension)return SafariAPI}return"undefined"!=typeof FirefoxAPI?FirefoxAPI:void 0!==MobileCenterBrowserAPI?MobileCenterBrowserAPI:"undefined"!=typeof JavaFXBrowserAPI?JavaFXBrowserAPI:"undefined"!=typeof LFTEmbeddedBrowserAPI?LFTEmbeddedBrowserAPI:void 0}if("undefined"==typeof window||window===window.top){var logger=new LoggerUtil("BackGroundExt");if(ext)return void logger.warn("Initializing extension more than once");ext={};var currentApi=getCurrentApi(),logSettingsObject=currentApi?currentApi.prototype.getLogSettingsObject():{};LoggerUtilSettings.setSettings(logSettingsObject),ext.bgLogger=logger,ext.bgLogger.trace("BackGround Was Loaded"),ext.app=function(){try{return currentApi?(ext.bgLogger.info("API found: "+currentApi.name),new currentApi):(ext.bgLogger.error("initApi(): No Browser API!"),null)}catch(e){ext.bgLogger.error("error when create app, e = "+e)}}(),
ext.dispatcher=new ExtDispatcher,ext.agent=new Agent,ext.agent.UpdateKnownBrowsers(),ext.onUnload=function(){ext.dispatcher.onUnload()},"undefined"!=typeof exports&&(exports.ext=ext)}}();var ContentUtils={findFrameElemByID:function(id,doc,logger){logger=logger||ContentUtils.getEmptyLogger(),logger.trace("findFrameElemByID: called to find frame with id ",id),Util.assert(doc,"findFrameElemByID: received empty document !",logger);for(var childs=doc.querySelectorAll("IFRAME,FRAME"),i=0;i<childs.length;++i)if(ContentUtils.isInjectableFrame(childs[i],logger)){if(childs[i].__QTP__OBJ&&RtIdUtils.IsRTIDEqual(childs[i].__QTP__OBJ.comID,id))return logger.debug("findFrameElemByID: frame found"),childs[i];childs[i].__QTP__OBJ||logger.warn("findFrameElemByID: frame doesn't have __QTP__OBJ")}else{var contentDoc=childs[i].contentDocument;if(!contentDoc){logger.warn("findFrameElemByID: unable to receive content document of uninjectable frame");continue}var foundChild=ContentUtils.findFrameElemByID(id,contentDoc,logger);if(foundChild)return foundChild}return logger.warn("findFrameElemByID: couldn't find frame with id ",id," - returning NULL"),null},isInjectableFrame:function(frameElement,logger){return logger=logger||ContentUtils.getEmptyLogger(),logger.debug("isInjectableFrame: called"),frameElement.contentWindow?ContentUtils.isInjectable(frameElement.contentWindow,logger):(logger.debug("isInjectableFrame: chrome < 25. Result  -> "+!!frameElement.__QTP__OBJ),!Util.isNullOrUndefined(frameElement.__QTP__OBJ))},isInjectable:function(win,logger){if(logger=logger||ContentUtils.getEmptyLogger(),logger.trace("isInjectable: called"),BrowserServices.isSpecialUninjectablePage(logger))return logger.debug("isInjectable: BrowserServices says -> false"),!1;if(win===win.parent)return logger.debug("isInjectable: at page -> true"),!0;try{if(!win.frameElement)return logger.debug("isInjectable: XSS -> true"),!0}catch(err){return logger.debug("isInjectable: XSS -> true"),!0}if("OBJECT"===win.frameElement.tagName)return logger.info("isInjectable: This is not a frame, this is an object element (unsupported) -> false"),!1;var src=win.frameElement.src;return null==src?(logger.error("isInjectable: frameElement.src is undefined -> false"),!1):BrowserServices.isAboutBlankFrameInjectable?(logger.debug("isInjectable: -> true (isAboutBlankFrameInjectable); src:"+win.frameElement.src),!0):""===src?(logger.debug("isInjectable: -> true (source is an empty string)"),!0):src.match(/^about:/)||src.match(/^javascript:/)?(logger.debug("isInjectable: -> false ("+src+")"),!1):(logger.debug("isInjectable: -> true"),!0)},getEmptyLogger:function(){return{trace:function(msg){},prettyTrace:function(msg){},debug:function(msg){},prettyDebug:function(msg){},warn:function(msg){},info:function(msg){},error:function(msg){}}},isHTMLElement:function(elem,logger){return!Util.isNullOrUndefined(elem)&&elem instanceof HTMLElement},getElementClientRect:function(elem,logger){if(logger=logger||ContentUtils.getEmptyLogger(),logger.trace("getElementClientRect: called"),!ContentUtils.isHTMLElement(elem))return logger.error("getElementClientRect: Received invalid element. returning."),null;var rect=elem.getBoundingClientRect();return{top:Math.floor(rect.top),left:Math.floor(rect.left),right:Math.floor(rect.right),bottom:Math.floor(rect.bottom)}},getCenterPoint:function(elem){var rect=elem.getBoundingClientRect();return{x:Math.floor(rect.left+rect.width/2),y:Math.floor(rect.top+rect.height/2)}},ElementBorder:function(elem){this.overlay=document.createElement("div"),Util.extend(this.overlay.style,{position:"absolute",display:"none",border:"4px solid #444444",boxSizing:"content-box",zIndex:"9999"}),document.body.appendChild(this.overlay),elem&&this.wrap(elem)},highlightElement:function(elem,resultCallback,msg){function drawRect(){if(++count>6)return border.remove(),void resultCallback(msg);count%2?border.show():border.hide(),Util.setTimeout(drawRect,150)}var border=new this.ElementBorder(elem),count=0;drawRect()},highlightElements:function(elems,resultCallback,msg){var borders=[];elems.forEach(function(elem){var border=new this.ElementBorder(elem);border.show(),borders.push(border)},this),Util.setTimeout(function(){borders.forEach(function(border){border.remove()}),resultCallback(msg)},3e3)},overrideJSDialogs:function(){var wasAccepted={alert:function(){return!0},prompt:function(result){return null!==result},confirm:function(result){return result}};Object.keys(wasAccepted).forEach(function(name){var orig=window[name];window[name]=function(msg,optional){var result=orig.call(this,msg,optional),data={type:name,accepted:wasAccepted[name](result)};return"string"==typeof result&&result&&(data.text=result),window.dispatchEvent(new CustomEvent("DialogHandled",{detail:data})),result},window[name].toString=function(){return orig.toString()}})},runOnDocSync:function(func,args,logger){if(args=args||[],logger=logger||ContentUtils.getEmptyLogger(),BrowserServices.isRunningInPageContext)return logger.trace("runOnDocSync: already in page context"),func.apply(null,args);var script="("+func.toString()+")("+args.map(JSON.stringify).join(",")+")";logger.trace("runOnDocSync: Started: "+script);var ev=document.createEvent("Events");ev.initEvent("_QTP_Run_Script_With_Attr",!0,!1),window.document.documentElement.setAttribute("_QTP_Script",script),window.document.documentElement.setAttribute("_QTP_Result",JSON.stringify({res:null,ex:null})),window.dispatchEvent(ev);var res=JSON.parse(window.document.documentElement.getAttribute("_QTP_Result"));return window.document.documentElement.removeAttribute("_QTP_Result"),window.document.documentElement.removeAttribute("_QTP_Script"),res.ex&&logger.error("runOnDocSync: got exception: "+res.ex),res.res},isTouchEnabled:function(){var sawTouchEvents=!1,sawMouseOver=!1;return window.addEventListener("touchstart",function detectTouchEvents(e){sawTouchEvents=!0,window.removeEventListener("touchstart",detectTouchEvents,!0)},!0),window.addEventListener("mouseover",function detectMouseOver(){sawMouseOver=!0,window.removeEventListener("mouseover",detectMouseOver,!0)},!0),function(){return content.settings.isTouchEnabled&&!sawMouseOver||sawTouchEvents||BrowserServices.isTouchSupported}}(),isWebRoleBasedKitEnabled:function(){return content.settings.enablewebrolebasedkit||BrowserServices.isWebRoleBasedKitEnabled},getTargetElem:function(elem){return"LABEL"===elem.tagName&&elem.control?elem.control:elem},getLabelsFromControl:function(control){if(document.createElement("input").labels)ContentUtils.getLabelsFromControl=function(elem){return elem.labels};else{var labelable=Util.objectFromArray(["BUTTON","INPUT","KEYGEN","METER","OUTPUT","PROGRESS","SELECT","TEXTAREA"],!0);ContentUtils.getLabelsFromControl=function(elem){if(!labelable[elem.tagName])return[];var labels;if(elem.id){var allLabels=Util.makeArray(document.querySelectorAll("label"));allLabels&&(labels=allLabels.filter(function(e){return e.htmlFor===elem.id}))}return elem.parentElement&&"LABEL"===elem.parentElement.tagName&&(labels&&0!=labels.length?-1===labels.indexOf(elem.parentElement)&&(labels=labels.concat(elem.parentElement)):labels=[elem.parentElement]),labels||[]}}return ContentUtils.getLabelsFromControl(control)},getAccNameFromControl:function(control){var id=control.getAttribute("aria-labelledby");id&&(id=id.split(" ")[0]);var elemById=id&&document.getElementById(id),text=elemById&&Util.cleanSpecialChars(elemById.textContent);return text||((text=Util.cleanSpecialChars(control.getAttribute("aria-label")))||"")},fireEvent:function(target,event,data,logger,relatedTarget){switch(logger=logger||ContentUtils.getEmptyLogger(),logger.trace("fireEvent: fire event ",event," with data ",data),event){case"focus":target.focus();break;case"blur":target.blur();break;case"submit":return void target.submit();case"click":if(!content.settings.replayonlyclick){if(ContentUtils.isTouchEnabled()){var point=this.pointRelativeToElem(target,this._positionFromData(data)),sim=new SimulateGesture,startCancelled=!sim.addTouch(target,point),endCancelled=!sim.removeTouches();if(startCancelled||endCancelled)return void logger.debug("fireEvent: touch event was cancelled. returning.")}this.fireEvent(target,"focus",data),this.fireEvent(target,"mousedown",data),this.fireEvent(target,"mouseup",data)}}var evt=this._createEvent(event,target,data,logger,relatedTarget);evt?(logger.trace("fireEvent: dispatch event "+evt.type+" on element "+target),target.dispatchEvent(evt)):logger.warn("fireEvent: no event was created for "+event)},_createEvent:function(event,target,data,logger,relatedTarget){var type=this._getEventType(event);if(!type)return logger.error("_createEvent: unknown event "+event),null;var evt=document.createEvent(type);switch(type){case"HTMLEvents":case"MutationEvents":case"UIEvents":return evt.initEvent(event,!0,!0),evt;case"MouseEvents":var button=this._getButton(data["event button"]),point=ContentUtils.pointRelativeToElem(target,this._positionFromData(data));return relatedTarget=relatedTarget||document.body,evt.initMouseEvent(event,!0,!0,null,null,null,null,point.x,point.y,!1,!1,!1,!1,button,relatedTarget),evt;case"KeyboardEvent":var key=data.key;if(key&&"function"==typeof evt.initKeyboardEvent){var keyCode=key.charCodeAt(0);""===evt.locale?evt.initKeyboardEvent(event,!0,!0,document.defaultView,key,0,data.modifiers||"",data.repeat||0,""):evt.initKeyboardEvent(event,!0,!0,document.defaultView,key,key,0,data.modifiers||"",data.repeat||0);try{delete evt.keyCode,Object.defineProperty(evt,"keyCode",{value:keyCode,writable:!0,enumerable:!0,configurable:!0}),delete evt.which,Object.defineProperty(evt,"which",{value:keyCode,writable:!0,enumerable:!0,configurable:!0})}catch(e){logger.warn("_createEvent: define 'keyCode' and 'which' property in keyboardEvent fails exception = "+e)}}else evt.initEvent(event,!0,!0);return evt}return null},_positionFromData:function(data){if(data.pos)return data.pos;var pt={x:Constants.noCoordinate,y:Constants.noCoordinate};return"x"in data&&(pt.x=data.x),"y"in data&&(pt.y=data.y),pt},pointRelativeToElem:function(elem,pos){var rect=elem.getBoundingClientRect(),x=pos.x!==Constants.noCoordinate?pos.x:rect.width/2,y=pos.y!==Constants.noCoordinate?pos.y:rect.height/2;return{x:rect.left+x,y:rect.top+y}},_getButton:function(uftValue){switch(uftValue){case 2:return 1;case 1:return 2}return 0},_getEventType:function(eventName){switch(eventName){case"domfocusin":case"domfocusout":case"domactivate":return"UIEvents";case"click":case"dblclick":case"mouseenter":case"mouseleave":case"mousedown":case"mouseup":case"mouseover":case"mousemove":case"mouseout":case"contextmenu":case"pointerover":case"pointerout":return"MouseEvents";case"domsubtreemodified":case"domnodeinserted":case"domnoderemoved":case"domnoderemovedfromdocument":case"domnodeinsertedintodocument":case"domattrmodified":case"domcharacterdatamodified":return"MutationEvents";case"load":case"unload":case"abort":case"error":case"select":case"change":case"submit":case"reset":case"focus":case"blur":case"resize":case"scroll":case"input":return"HTMLEvents";case"keydown":case"keypress":case"keyup":return"KeyboardEvent"}},evalInDocument:function(exp,doc){doc=doc||document;var scriptText="function"==typeof exp?Util.functionStringify(exp):exp,node=doc.getElementsByTagName("head")[0]||doc.documentElement,script=doc.createElement("script");script.type="text/javascript",script.setAttribute("nonce","UftNonceMagicAllowInlineScript"),script.appendChild(doc.createTextNode(scriptText)),node.appendChild(script,node.firstChild),node.removeChild(script)},protectCallbackAgainstPrematureNavigation:function(callback,msg,logger,name){function canceled(){logger&&logger.warn("protectCallbackAgainstPrematureNavigation: Unload recieved with uncalled callback: "+name),wasCalled||(wasCalled=!0,callback(msg))}var wasCalled=!1;return window.addEventListener("beforeunload",canceled,!0),function(message){wasCalled?logger&&logger.error("protectCallbackAgainstPrematureNavigation: callback was called after page unload: "+name):(window.removeEventListener("beforeunload",canceled,!0),callback(message))}},createCrossOriginCustomEvent:function(eventType,eventDetail){if(BrowserServices.createCrossOriginCustomEvent)return BrowserServices.createCrossOriginCustomEvent(eventType,eventDetail);var event;if(CustomEvent)event=new CustomEvent(eventType,eventDetail);else{event=document.createEvent("CustomEvent"),eventDetail||(eventDetail={});var bubbles=eventDetail.bubbles||!1,cancelable=eventDetail.cancelable||!1;event.initCustomEvent(eventType,bubbles,cancelable,eventDetail.detail)}return event},getVisibleTextContent:function(elem){var dupElem=elem.cloneNode(!0);return Util.makeArray(dupElem.getElementsByTagName("script")).forEach(function(script){script.parentElement.removeChild(script)}),Util.cleanTextProperty(dupElem.textContent).trim()}};ContentUtils.ElementBorder.prototype={overlay:null,elem:null,show:function(){this.overlay.style.display="block"},hide:function(){this.overlay.style.display="none"},wrap:function(elem){function pixels(n){return n+"px"}if(this.elem===elem)return!1;this.elem=elem;var border=4,rect=elem.getBoundingClientRect();rect.width||rect.height||(rect=elem.parentElement.getBoundingClientRect());var top,left,width=rect.width-2*border,height=rect.height-2*border;if(elem===window.frameElement){top=0,left=0;var borderWidth=parseInt(getComputedStyle(elem).borderWidth.match(/(\d+)px/)[1],10);"number"==typeof borderWidth&&(width-=2*borderWidth,height-=2*borderWidth)}else top=rect.top+window.pageYOffset,left=rect.left+window.pageXOffset;return Util.extend(this.overlay.style,{top:pixels(top),left:pixels(left),width:pixels(width),height:pixels(height)}),this.overlay.style.borderStyle="solid",this.show(),!0},run:function(f){return f(this.overlay)},remove:function(){this.overlay&&(document.body.removeChild(this.overlay),this.elem=null,this.overlay=null)}},GestureDetector.prototype={_logger:null,_detectors:null,_listeners:null,fireEvent:function(event,info){this._listeners.forEach(function(listener){listener(event.target,info)}),this._detectors.forEach(function(d){d.discard()})},addListener:function(listener){-1===this._listeners.indexOf(listener)&&this._listeners.push(listener)},isSingleTouch:function(event){return event.touches&&1===event.touches.length},_addEvent:function(e){switch(e.type){case"touchstart":this._detectors.forEach(function(d){d.touchStart(e)});break;case"touchmove":this._detectors.forEach(function(d){d.touchMove(e)});break;case"touchend":this._detectors.forEach(function(d){d.touchEnd(e)});break;case"touchcancel":this._detectors.forEach(function(d){d.touchCancel(e)});break;default:this._logger.warn("addEvent: unexpected event type - "+e.type)}}},GestureDetector.prototype.SwipePanDetector=function(owner){this._owner=owner,this._logger=new LoggerUtil("Content.SwipePanDetector"),this._logger.trace("Created")},GestureDetector.prototype.SwipePanDetector.prototype={_owner:null,_logger:null,_info:null,_constants:{minDistance:50,maxOffsetRatio:.2,initialMaxOffset:30,maxDuration:1500,maxScroll:10},discard:function(){this._info=null},_deltaX:function(){return Math.abs(this._info.startX-this._info.x)},_deltaY:function(){return Math.abs(this._info.startY-this._info.y)},_rectArea:function(rect){return rect.width*rect.height},touchStart:function(e){if(this._owner.isSingleTouch(e)){this._info&&this._logger.warn("touchStart: Overwriting existing touch event");var touch=e.touches[0],rect=e.target.getBoundingClientRect();this._info={direction:null,target:e.target,start:e.timeStamp,startX:touch.pageX,startY:touch.pageY,startScrollPosition:{x:window.scrollX,y:window.scrollY},startPosition:{left:rect.left,top:rect.top}}}},touchMove:function(e){if(this._info){if(!this._owner.isSingleTouch(e))return this.discard();var duration=e.timeStamp-this._info.start;if(duration>this._constants.maxDuration)return this._logger.trace("touchMove: Timeout exceeded "+duration),this.discard();this._processTouch(e.touches[0])}},touchEnd:function(e){this._info&&e.changedTouches.length&&this._processTouch(e.changedTouches[0])&&this._shouldFire(e)?this._fireEvent(e):this.discard()},touchCancel:function(e){this.touchEnd(e)},_processTouch:function(touch){if(!this._info)return!1;switch(this._info.x=touch.pageX,this._info.y=touch.pageY,this._info.direction){case null:return this._deltaX()>this._constants.minDistance?this._deltaY()>this._getMaxOffset(this._deltaX())?(this._logger.trace("_processTouch: Not swipe, too much offset "+this._deltaY()+" - current distance: "+this._deltaX()),this._markAsDiagonal()):(this._logger.trace("_processTouch: Deducing Swipe direction to be horizontal"),this._info.direction="horizontal",!0):!(this._deltaY()>this._constants.minDistance)||(this._deltaX()>this._getMaxOffset(this._deltaY())?(this._logger.trace("_processTouch: Not swipe, too much offset "+this._deltaX()+" - current distance: "+this._deltaY()),this._markAsDiagonal()):(this._logger.trace("_processTouch: Deducing Swipe direction to be vertical"),this._info.direction="vertical",!0));case"vertical":return!(this._deltaX()>this._getMaxOffset(this._deltaY()))||(this._logger.trace("_processTouch: Not vertical swipe, too much offset "+this._deltaX()+" - current distance: "+this._deltaY()),this._markAsDiagonal());case"horizontal":return!(this._deltaY()>this._getMaxOffset(this._deltaX()))||(this._logger.trace("_processTouch: Not horizontal swipe, too much offset "+this._deltaY()+" - current distance: "+this._deltaX()),this._markAsDiagonal());case"diagonal":return!0;default:this._logger.error("_processTouch: unexpected direction: "+this._direction)}return!0},_markAsDiagonal:function(){return this._info.direction="diagonal",!0},_getMaxOffset:function(currentDistance){return Math.max(this._constants.initialMaxOffset,this._constants.maxOffsetRatio*currentDistance)},_updateDirectionFromElementMotion:function(e){if(e.target===this._info.target){var rect=e.target.getBoundingClientRect();if(this._info.startPosition.left!==rect.left&&this._info.startPosition.top===rect.top)return 0!==this._deltaX()&&(this._logger.trace("_updateDirectionFromElementMotion: direction is horizontal due to offset change of "+(this._info.startPosition.left-rect.left)),this._info.direction="horizontal",!0);if(this._info.startPosition.left===rect.left&&this._info.startPosition.top!==rect.top)return 0!==this._deltaY()&&(this._logger.trace("_updateDirectionFromElementMotion: direction is vertical due to offset change of "+(this._info.startPosition.top-rect.top)),this._info.direction="vertical",!0)}},_didScrollingOccur:function(e){var startScrollPosition=this._info.startScrollPosition,scrollX=startScrollPosition.x-window.scrollX;if(Math.abs(scrollX)>this._constants.maxScroll)return this._logger.debug("_didScrollingOccur: window has scrolled horizontaly by "+scrollX),!0;var scrollY=startScrollPosition.y-window.scrollY;return Math.abs(scrollY)>this._constants.maxScroll&&(this._logger.debug("_didScrollingOccur: window has scrolled vertically by "+scrollY),!0)},_shouldFire:function(e){if(!this._info)return!1;if(this._didScrollingOccur(e))return!1;if(!this._info.direction&&this._updateDirectionFromElementMotion(e))return!0;switch(this._info.direction){case"horizontal":return!(this._deltaX()<this._constants.minDistance)||(this._deltaY()>this._constants.minDistance?(this._logger.trace("_shouldFire: Changing from horizontal swipe to pan"),this._markAsDiagonal()):(this._logger.trace("_shouldFire: Not horizontal swipe, distance has shrunk"),!1));case"vertical":return!(this._deltaY()<this._constants.minDistance)||(this._deltaX()>this._constants.minDistance?(this._logger.trace("_shouldFire: Changing from vertical swipe to pan"),this._markAsDiagonal()):(this._logger.trace("_shouldFire: Not vertical swipe, distance has shrunk"),!1));case null:case"diagonal":return this._deltaX()>this._constants.minDistance||this._deltaY()>this._constants.minDistance?(this._logger.trace("_shouldFire: Pan over minDistance"),this._markAsDiagonal()):(this._logger.trace("_shouldFire: with direction "+this._info.direction+" still under minDistance"),!1);default:this._logger.error("_shouldFire: unexpected direction: "+this._info.direction)}return!1},_fireEvent:function(e){var direction,distance;switch(this._info.direction){case"horizontal":distance=this._info.x-this._info.startX,direction=distance>0?"Right":"Left";break;case"vertical":distance=this._info.y-this._info.startY,direction=distance>0?"Down":"Up";break;case"diagonal":var args={event:"pan",x:Math.round(this._info.startX-this._info.x),y:Math.round(this._info.startY-this._info.y),duration:e.timeStamp-this._info.start};return this._logger.trace("_fireEvent: Pan ",args),this._owner.fireEvent(e,args)}var absDistance=Math.round(Math.abs(distance)),args={event:"swipe",direction:"move"+direction,duration:e.timeStamp-this._info.start,distance:absDistance};this._logger.trace("_fireEvent: Swipe ",args),this._owner.fireEvent(e,args)}},GestureDetector.prototype.TapDetector=function(owner){this._owner=owner,this._logger=new LoggerUtil("Content.TapDetector"),this._logger.trace("Created")},GestureDetector.prototype.TapDetector.prototype={_owner:null,_logger:null,_info:null,_constants:{maxOffset:10,tapMaxTime:750},discard:function(){this._info=null},touchStart:function(e){if(!this._owner.isSingleTouch(e))return void this.discard();this._info&&this._logger.warn("touchStart: overwrting existing info");var touch=e.touches[0];this._info={x:touch.pageX,y:touch.pageY,start:e.timeStamp}},touchMove:function(e){if(this._info)return this._owner.isSingleTouch(e)?void this._processTouch(e.touches[0]):(this._logger.warn("touchMove: got irrelevant move, should have been discareded in touchStart"),this.discard())},touchEnd:function(e){if(this._info&&e.changedTouches.length&&this._processTouch(e.changedTouches[0]))return void this._fireEvent(e);this.discard()},touchCancel:function(e){return this.touchEnd(e)},_processTouch:function(touch,timeStamp){return!(Math.abs(touch.pageX-this._info.x)>this._constants.maxOffset||Math.abs(touch.pageY-this._info.y)>this._constants.maxOffset)||(this._logger.trace("touchMove: discarded, too much offset or too little time"),this.discard(),!1)},_fireEvent:function(e){var duration=e.timeStamp-this._info.start,eventName=duration<this._constants.tapMaxTime?"tap":"longTap",args={event:eventName,duration:duration,clientX:this._info.x,clientY:this._info.y};this._logger.trace("_fireEvent: ",eventName," ",args),this._owner.fireEvent(e,args)}},GestureDetector.prototype.PinchDetector=function(owner){this._owner=owner,this._logger=new LoggerUtil("Content.PinchDetector"),this._logger.trace("Created")},GestureDetector.prototype.PinchDetector.prototype={_owner:null,_logger:null,_info:null,_constants:{maxOffset:100,minScaleDiff:.1},discard:function(){this._info=null},touchStart:function(e){switch(e.touches&&e.touches.length){case 1:this._info={start:e.timeStamp};break;case 2:this._info||(this._info={start:e.timeStamp}),this._info.pos=this._center(e.touches),this._info.initialDistance=this._distance(e.touches);break;default:this.discard()}},touchMove:function(e){if(!this._info||!this._info.pos)return!1;if(2!==e.touches.length)return this._logger.trace("touchMove: Discarding pinch, touch count is "+e.touches),this.discard();var pos=this._center(e.touches),moved=this._distance([pos,this._info.pos]);return moved>this._constants.maxOffset?(this._logger.trace("touchMove: discarding pinch, center point moved by "+moved),this.discard()):(this._info.currentDistance=this._distance(e.touches),!0)},touchEnd:function(e){if(!this._info||!this._info.pos)return!1;if(1!==e.touches.length)return this._logger.trace("touchEnd: discarding pinch, ended with touch count = "+e.touches.length),this.discard();var scale=this._info.currentDistance/this._info.initialDistance;if(scale&&Math.abs(1-scale)>this._constants.minScaleDiff){var args={event:"pinch",scale:scale,duration:e.timeStamp-this._info.start};this._logger.trace("touchEnd: recording pinch ",args),this._owner.fireEvent(e,args)}else this._logger.trace("touchEnd: not recording pinch, scale is ",scale)},touchCancel:function(e){return this._info&&this._logger.warn("Discarding pinch, got 'touchCancel' => event is treated by the browser not the web application."),this.discard()},_distance:function(points){function sq(x){return x*x}return 2!=points.length?0:Math.sqrt(sq(points[0].clientX-points[1].clientX)+sq(points[0].clientY-points[1].clientY))},_center:function(touches){if(2==touches.length)return{clientX:(touches[0].clientX+touches[1].clientX)/2,clientY:(touches[0].clientY+touches[1].clientY)/2}}},SimulateGesture.prototype={_logger:null,_touches:null,addTouch:function(elem,pos){var touch=this._touchInfo(elem,pos||ContentUtils.getCenterPoint(elem),Date.now());return this._touches.push(touch),this._dispatchTouch("touchstart",elem,this._touches,[touch])},move:function(positions){return positions.length!==this._touches.length?void Util.assert(!1,"mismatch between touch and positions count",this._logger):(positions.forEach(function(pos,i){this._touches[i].pos=pos},this),this._dispatchTouch("touchmove",this._touches[0].elem,this._touches,this._touches))},removeTouches:function(){for(var notCancled=!0;this._touches.length;){var touch=this._touches.pop(),curr=this._dispatchTouch("touchend",touch.elem,this._touches,[touch]);notCancled=notCancled&&curr}return notCancled},_touchInfo:function(element,pos,id){return{elem:element,pos:pos,id:id}},_dispatchTouch:function(type,elem,touches,changed){function ensureHasId(elem,hint){return!elem.id&&(elem.id="__fakeIdForUFT#"+hint,!0)}function clearIdIfNeeded(t){t.definedId&&(t.elem.id="",t.definedId=!1)}function serializableTouches(touches){return touches.map(function(t){return t.definedId=ensureHasId(t.elem,t.id),{elemId:t.elem.id,touchId:t.id,pos:t.pos}})}function dispatchTouchEvent(type,elemId,safeTouches,safeChanged){function createTouchList(touches){var serialized=touches&&touches.map(function(t){return createTouch(document.getElementById(t.elemId),t.pos.x,t.pos.y,t.touchId)});return document.createTouchList?serialized&&serialized.length?document.createTouchList.apply(document,serialized):document.createTouchList():Array.isArray(serialized)?serialized:[serialized]}function createTouch(element,x,y,touchId){var pageX=document.body.scrollLeft+x,pageY=document.body.scrollTop+y,touchInfo={view:window,target:element,identifier:touchId,pageX:pageX,pageY:pageY,clientX:x,clientY:y};return document.createTouch?document.createTouch(window,element,touchId,pageX,pageY,x,y):"function"==typeof Touch?new Touch(touchInfo):touchInfo}var element=document.getElementById(elemId),event=document.createEvent("Event");return event.initEvent(type,!0,!0),event.touches=createTouchList(safeTouches),event.changedTouches=createTouchList(safeChanged),event.targetTouches=createTouchList(safeTouches),event.view=event.view||document.defaultView,element.dispatchEvent(event)}var idWasCreated=ensureHasId(elem,"target");try{var safeTouches=serializableTouches(touches),safeChanged=serializableTouches(changed);return ContentUtils.runOnDocSync(dispatchTouchEvent,[type,elem.id,safeTouches,safeChanged])}finally{idWasCreated&&(elem.id=""),touches.forEach(clearIdIfNeeded),changed.forEach(clearIdIfNeeded)}}},Recorder.prototype={_logger:null,frame:null,isRecording:null,recordingEvents:null,_stopPropagation:!1,_handlerFunc:function(ev){if(this.isRecording){if(!ev.target)return void this._logger.warn("_handlerFunc: got event without target. Event type: "+ev.type);if(ev.target===window||ev.target===document)return void this._logger.trace("_handlerFunc: got event on the Window object or Document Object. Ignoring. Event type: "+ev.type);this._logger.trace("_handlerFunc: got event of type: "+ev.type+" for target: "+ev.target.tagName),this._updateAoInfo(ev.target),this._stopPropagation=!1,this._aoInfo.aoArray.some(function(ao){return ao.ReceiveEvent(this,ev),this._stopPropagation},this)}},_recordGesture:function(elem,info){this.isRecording&&(this._updateAoInfo(elem),this._stopPropagation=!1,this._aoInfo.aoArray.some(function(ao){return ao.ReceiveGesture(this,info,elem),this._stopPropagation},this))},_updateAoInfo:function(elem){var previousAoInfo=this._aoInfo;previousAoInfo&&previousAoInfo.element===elem||(this._aoInfo={aoArray:content.kitsManager.createRecordAOArray(elem,this.frame.id),element:elem},previousAoInfo&&previousAoInfo.aoArray.forEach(function(ao){ao.ReceiveEventEnded(this)},this),this._aoInfo.aoArray.forEach(function(ao){ao.ReceiveEventStarted(this)},this))},_EVENT_CONFIG_ENUM:{TYPES:{EVT_NEVER:0,EVT_ANYCASE:1,EVT_HANDLER:2,EVT_BEHAVIOR:4,EVT_BEHAVIOR_OR_HANDLER:6,EVS_DELETE:0,EVS_DISABLE:1,EVS_ENABLE:2,EVS_ON_NEXT_EVENT:4,EVS_ENABLE_ON_NEXT_EVENT:6,ERD_IGNORE:0,ERD_RECORD:1,ERD_CONTINUE:2},RESERVED_EVENTS:Util.objectFromArray(["ondragend","onkeyup","onselect","ontextInput"],!0)},_eventConfig:{"any web object":{onclick:{listen:2,record:2},oncontextmenu:{listen:2,record:2},ondragstart:{listen:2,record:2},ondrop:{listen:2,record:2},onkeydown:{listen:1,record:2},onmouseover:{listen:2,record:1},onmouseup:{listen:2,record:1}},image:{onclick:{listen:1,record:2},onmouseover:{listen:2,record:6}},link:{onclick:{listen:1,record:2}},webarea:{onclick:{listen:1,record:2},onmouseover:{listen:2,record:6}},webbutton:{onclick:{listen:1,record:2}},webcheckbox:{onclick:{listen:1,record:2}},webedit:{onblur:{listen:1,record:2},onchange:{listen:1,record:2},onfocus:{listen:1,record:2},onpropertychange:{listen:0,record:2},onsubmit:{listen:1,record:2}},webfile:{onblur:{listen:1,record:2},onfocus:{listen:1,record:2}},weblist:{onblur:{listen:1,record:2},onchange:{listen:1,record:2},onfocus:{listen:1,record:2}},webnumber:{onblur:{listen:1,record:2},onchange:{listen:1,record:2},onfocus:{listen:1,record:2}},webradiogroup:{onclick:{listen:1,record:2}},webtab:{onclick:{listen:1,record:2}},webtree:{onmousedown:{listen:1,record:2},onclick:{listen:1,record:2}},webmenu:{onclick:{listen:1,record:2}},webrange:{onchange:{listen:1,record:2}}},updateEventConfig:function(config){this._logger.trace("updateEventConfig() set event configuration with: "+config),config&&(this._eventConfig=config)},isEventAllowedByConfig:function(ao,ev){this._logger.trace("isEventAllowedByConfig() got event of type: "+ev.type);var isAllowed=!1,micclasses=ao._micclass,handlerName="on"+ev.type,_checkEach=function(micclass){if(micclass=micclass.toLowerCase(),!this._eventConfig[micclass])return!0;var micclassConfig=this._eventConfig[micclass];if(!micclassConfig[handlerName])return!0;var handlerConfig=micclassConfig[handlerName];switch(this._makeRecordDecision(handlerConfig,ao._hasDOMHandler(handlerName))){case this._EVENT_CONFIG_ENUM.TYPES.ERD_RECORD:return isAllowed=!0,!1;case this._EVENT_CONFIG_ENUM.TYPES.ERD_IGNORE:return!1;case this._EVENT_CONFIG_ENUM.TYPES.ERD_CONTINUE:return!0}return!0};return _checkEach.call(this,ao.GetAttrSync("html tag"))&&micclasses.every(_checkEach,this),!!this._EVENT_CONFIG_ENUM.RESERVED_EVENTS[handlerName]||isAllowed},_makeRecordDecision:function(handlerConfig,hasDOMHandler){var t=this._EVENT_CONFIG_ENUM.TYPES;switch(handlerConfig.listen){case t.EVT_NEVER:case t.EVT_BEHAVIOR:return t.ERD_IGNORE;case t.EVT_HANDLER:case t.EVT_BEHAVIOR_OR_HANDLER:if(!hasDOMHandler)return t.ERD_IGNORE;break;case t.EVT_ANYCASE:break;default:this._logger.warn("_makeRecordDecision: Unknown listening type:"+handlerConfig.listen)}switch(handlerConfig.record){case t.EVS_DISABLE:case t.EVS_DELETE:return t.ERD_IGNORE;case t.EVS_ON_NEXT_EVENT:case t.EVS_ENABLE_ON_NEXT_EVENT:case t.EVS_ENABLE:return t.ERD_RECORD;default:return this._logger.warn("_makeRecordDecision: Unknown recording type:"+handlerConfig.record),t.ERD_CONTINUE}},startRecord:function(){this.isRecording||(this._logger.info("startRecord: starting recording"),this.isRecording=!0,this._startMonitoringSynthesizedEvents(),this.sendBrowserRecordInfo())},stopRecord:function(){this.isRecording&&(this._logger.info("stopRecord: stopping recording"),
this.isRecording=!1,this._stopMonitoringSynthesizedEvents())},sendRecordEvent:function(ao,event,params){this._logger.trace("sendRecordEvent: called: ",params),this._sendRecordEventHelper("EVENT_RECORD",ao,event,params)},queueRecordEvent:function(ao,event,params){this._logger.trace("queueRecordEvent: called"),this._sendRecordEventHelper("EVENT_INTERNAL_RECORD_QUEUE",ao,event,params)},sendRecordEventWithQueue:function(ao,event,params){this._logger.trace("sendRecordEventWithQueue: called"),this._sendRecordEventHelper("EVENT_INTERNAL_RECORD_DISPATCH_QUEUE",ao,event,params)},discardQueuedRecordEvents:function(){this._logger.trace("discardQueuedRecordEvents: called");var msg=new Msg("EVENT_INTERNAL_RECORD_QUEUE_CLEAR",this.frame.getID(),{});content.dispatcher.sendEvent(msg)},stopCurrentPropagation:function(){this._stopPropagation=!0},_createObjectDescription:function(ao,micclass){var objIdentificationProps=this.frame.getObjIdentificationProps(micclass);return this._shouldAddPositionInfo(micclass)&&(objIdentificationProps.additionalInfo=["abs_x","abs_y","height","width"]),Description.createRecordDescription(ao,objIdentificationProps)},_shouldAddPositionInfo:function(micclass){return!Util.isContainerMicclass(micclass)},_createRecordData:function(ao,event,params){this._logger.trace("_createRecordData: started");var micclass=Util.getMicClass(ao),description=this._createObjectDescription(ao,micclass);this._logger.trace("_createRecordData: AO Data: ",description.description);var recordData={WEB_PN_ID:[[ao.getID()]],micclass:[[micclass]],"recorded description":[[description]]};if(!Util.isNullOrUndefined(event)){var eventID=SpecialObject.CreateEventId(event,ao.getID());recordData["event id"]=[[eventID]]}return Util.extend(recordData,params),recordData},_sendRecordEventHelper:function(msgType,ao,event,params){if((!params||!params.force_record)&&this._isSynthesizedEvent())return void this._logger.info("sendRecordEvent: ignoring synthesized event");var recordData=this._createRecordData(ao,event,params),msg=new Msg(msgType,this.frame.getID(),recordData);content.dispatcher.sendEvent(msg)},sendRecordExtEvent:function(ao,methodName,params){var recordData=this._createRecordData(ao),msg=new Msg("EVENT_RECORD",this.frame.getID(),recordData);msg._data.WEBEXT_PN_METHOD_NAME=methodName,msg._data.WEBEXT_PN_PARAMETERS=params,content.dispatcher.sendEvent(msg)},sendBrowserRecordInfo:function(){if(this.isRecording){var micclass=Util.getMicClass(this.frame);if("Page"===micclass){var browserContentHelper=new BrowserContentHelper(this.frame);this._logger.trace("_sendBrowserRecordInfo: creating message to dispatch");var recordData=this._createRecordData(browserContentHelper,{type:"",clientX:0,clientY:0});recordData.pageDescription=this._createObjectDescription(this.frame,micclass);var msg=new Msg("EVENT_INTERNAL_RECORD_BROWSER_INFO",RtIdUtils.GetAgentRtid(),recordData);content.dispatcher.sendEvent(msg)}}},_startMonitoringSynthesizedEvents:function(){BrowserServices.shouldOverrideDispatchEvent&&(this._logger.debug("_startMonitoringSynthesizedEvents: Going to override CreateEvent function"),BrowserServices.isRunningInPageContext?this._wrapEventDispatchers():ContentUtils.evalInDocument(this._wrapEventDispatchers))},_stopMonitoringSynthesizedEvents:function(){BrowserServices.shouldOverrideDispatchEvent&&(this._logger.debug("_stopMonitoringSynthesizedEvents: Going to restore CreateEvent function"),BrowserServices.isRunningInPageContext?this._unwrapEventDispatchers():ContentUtils.evalInDocument(this._unwrapEventDispatchers))},_wrapEventDispatchers:function(){function wrap(obj,funcName){var orig=obj[funcName];obj[funcName]=function(){for(var argsArray=new Array(arguments.length),i=0;i<arguments.length;i++)argsArray[i]=arguments[i];return dispatcherHelper.call(this,orig,argsArray)},window._QTP.EventDispatchers.push({obj:obj,name:funcName,orig:orig})}function dispatcherHelper(origFunc,args){var result;window._QTP.synthesizedEventsCount++;try{result=origFunc.apply(this,args)}finally{window._QTP.synthesizedEventsCount--}return result}window._QTP||(window._QTP={}),Array.isArray(window._QTP.EventDispatchers)||(window._QTP.EventDispatchers=[],window._QTP.synthesizedEventsCount=window._QTP.synthesizedEventsCount||0,wrap(HTMLElement.prototype,"dispatchEvent"),wrap(HTMLElement.prototype,"click"),wrap(document,"dispatchEvent"),wrap(window,"dispatchEvent"))},_unwrapEventDispatchers:function(){window._QTP&&(Array.isArray(window._QTP.EventDispatchers)&&window._QTP.EventDispatchers.forEach(function(wrappedData){wrappedData.obj[wrappedData.name]=wrappedData.orig},this),delete window._QTP.EventDispatchers,window._QTP.synthesizedEventsCount=0)},_isSynthesizedEvent:function(){return!!BrowserServices.shouldOverrideDispatchEvent&&ContentUtils.runOnDocSync(function(){return window._QTP&&window._QTP.synthesizedEventsCount})}},FrameCommunicationChannel.prototype={_logger:null,id:null,_closestAncestorID:null,_parentId:null,_listeners:null,init:function(initInfo){this._logger.info("init: called with: ",initInfo),this.id=Util.shallowObjectClone(initInfo.frameID),FrameCommunicationChannelInHTMLContext._comID=Util.shallowObjectClone(initInfo.frameID),content.domSubscriber.startNamespace(),content.domSubscriber.addUtilityObject("FrameCommunicationChannelInHTMLContext ",FrameCommunicationChannelInHTMLContext),content.domSubscriber.endNamespace(),window.addEventListener("message",this.onMessage.bind(this))},_sendMessageHelper:function(eventType,msg,destinationId){this._logger.prettyTrace("_sendMessageHelper: send to: ",destinationId," - message: ",msg);var target;target=RtIdUtils.IsRTIDEqual(this._closestAncestorID,destinationId)?null:destinationId;var reqMsg={source:"FrameCommunicationChannel",msgType:eventType,target:target,data:msg};window.postMessage(reqMsg,"*")},sendMessage:function(msg,destinationId){this._logger.trace("sendMessage: called"),this._sendMessageHelper("request",msg,destinationId)},sendEvent:function(msg,destinationId){this._logger.trace("sendEvent: called"),this._sendMessageHelper("event",msg,destinationId)},addListener:function(eventName,listenerFunction){this._logger.trace("addListener: called"),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerFunction)},removeListener:function(eventName,listenerFunction){if(this._logger.trace("addListener: called"),!this._listeners[eventName])return void this._logger.error("removeListener: Trying to remove listener that is not registered");this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return listener!==listenerFunction})},dispatchEvent:function(eventName){this._logger.trace("dispatchEvent: called for event "+eventName);var args=Util.makeArray(arguments);if(args.splice(0,1),!this._listeners[eventName])return this._logger.warn("dispatchEvent: no listeners found for event: "+eventName),null;var res=null;return this._listeners[eventName].forEach(function(listener){res=listener.apply(this,args)}),res},onMessage:function(msgEventObj){var msg=Util.deepObjectClone(msgEventObj.data);if("object"==typeof msg&&"FrameCommunicationChannelInHTMLContext"===msg.source)try{switch(msg.msgType){case"contentUnsupoortedACK":this.unSupportedContentHandler();break;case"MarkDispatcherInfo":this.putDescendantInfoOnFrameElem(msg);break;case"frameBornAck":this.contentDispatcherAttachedEventHandler(msg);break;case"request":this.handleRequest(msg);break;case"response":this.handleResponse(msg);break;case"event":this._logger.trace("onMessage: Got the following 'event': ",msg),this.dispatchEvent("event",msg.data)}}catch(ex){this._logger.error("messageHandlerInContent: Got exception "+ex+"\nStack:"+ex.stack)}},handleRequest:function(msg){this._logger.prettyTrace("handleRequest: Received the following message: ",msg);var targetTo=msg.data._to;if(targetTo.frame!==this.id.frame)return void this._logger.trace("handleRequest: message is not the target of this frame current =",this.id," target =",targetTo);var logger=this._logger;try{this.dispatchEvent("message",msg.data,null,function(res){msg.data=res,msg.source="FrameCommunicationChannel",msg.msgType="response",logger.trace("handleRequest: Going to send the following response:",msg),window.postMessage(msg,"*")})}catch(e){logger.error("handleRequest: Exception occurred. Send error message back. Exception:"+e+"\nStack:"+e.stack),msg.data.status="ERROR",msg.data.details=e?e.message:null,msg.source="FrameCommunicationChannel",msg.msgType="response",window.postMessage(msg,"*")}},handleResponse:function(msg){this._logger.trace("handleResponse: Got the following response: ",msg),this.dispatchEvent("response",msg.data)},connect:function(connectionInfo){if(this._logger.trace("connect: Started with the following connection info ",connectionInfo),this._closestAncestorID={browser:-1,page:-1,frame:-1,object:null},connectionInfo.isPage)this.dispatchEvent("connected");else{var bornMsg={source:"FrameCommunicationChannel",msgType:"Notify_Dispatcher_Created",data:{comID:Util.shallowObjectClone(this.id)}};window.postMessage(bornMsg,"*")}},disconnect:function(){},contentDispatcherAttachedEventHandler:function(msg){this._logger.info("contentDispatcherAttachedEventHandler: Started"),this._closestAncestorID=msg.data.closestAncestorID,this.dispatchEvent("connected")},unSupportedContentHandler:function(){this._logger.error("unSupportedContentHandler: Unsupported Frame on "+document.location.href),this.dispatchEvent("connected")},putDescendantInfoOnFrameElem:function(msg){this._logger.trace("putDescendantInfoOnFrameElem: Started with the following message:",msg);var framePath=msg.data.framePath,frameElem=this.getFrameElemFromPath(document,framePath);if(!frameElem)return void this._logger.error("putDescendantInfoOnFrameElem: Failed to find frame element!!!!!");frameElem.__QTP__OBJ||(frameElem.__QTP__OBJ={});var qtpObj=frameElem.__QTP__OBJ,comID=msg.data.frameCOMID;"comID"in qtpObj&&qtpObj.comID!==comID?(this._logger.info("putDescendantInfoOnFrameElem: frame had another COM ID registered, setting previous value to = ",qtpObj.comID),qtpObj.previousComID=qtpObj.comID):qtpObj.comID===comID&&this._logger.info("putDescendantInfoOnFrameElem: frame already had this COM ID registered: ",qtpObj.comID),this._logger.debug("putDescendantInfoOnFrameElem: Updating frame element with comID:",comID),qtpObj.comID=comID},getFrameElemFromPath:function(doc,framePath){if(Util.assert(framePath.length>0,"getFrameElemFromPath: FrameElement not found!",this._logger),framePath.length<=0)return null;var child=framePath.pop(),frameElems=doc.querySelectorAll("IFRAME,FRAME");return 0===framePath.length?frameElems[child]:this.getFrameElemFromPath(frameElems[child].contentDocument,framePath)}};var FrameCommunicationChannelInHTMLContext={_comID:-1,onMessageFromContent:function(msgEventObj){var msg=msgEventObj.data;if("object"==typeof msg&&("FrameCommunicationChannel"===msg.source||"FrameCommunicationChannelInHTMLContext"===msg.source))try{switch(msg.msgType){case"Notify_Dispatcher_Created":_logger.info("onMessageFromContent: Received Notify_Dispatcher_Created"),this.sendBornMessageToParents(msg.data.comID);break;case"descendantBorn":_logger.info("FrameCommunicationChannelInHTMLContext.onMessageFromContent: Received descendantBorn"),this.descendantBorn(msgEventObj.source,msg.data);break;case"contentUnsupoortedACK":_logger.error("FrameCommunicationChannelInHTMLContext.onMessageFromContent: Received contentUnsupoortedACK"),window.clearTimeout(msg.data.timerID);break;case"frameBornAck":window.clearTimeout(msg.data.timerID),this.closestParentWindow=msgEventObj.source;break;case"response":case"request":case"event":this.dispatchMessage(msg)}}catch(ex){_logger.error("FrameCommunicationChannelInHTMLContext.onMessageFromContent: Got Exception ",ex,"\n handling the message:",msg,"\nStack:",ex.stack)}},dispatchMessage:function(msg){if("FrameCommunicationChannel"===msg.source)if(_logger.trace("dispatchMessage: Got a message the message:\n ",msg,"\n Dispatching it"),msg.source="FrameCommunicationChannelInHTMLContext",null===msg.target)msg.target=this._comID,this.closestParentWindow.postMessage(msg,"*");else{var childID=msg.target;msg.target=null;var childFrame=ContentUtils.findFrameElemByID(childID,document,_logger);if(!childFrame)return void _logger.error("dispatchMessage: Failed to find child frame !!!");childFrame.contentWindow.postMessage(msg,"*")}},sendBornMessageToParents:function(comID,retryNum){if(Util.assert(window.parent!==window,"We are page, how come we're here?",_logger),retryNum=retryNum||0,_logger.info("sendBornMessageToParents: sending to all ancestors "+(0!==retryNum?" (Retry num "+retryNum+")":"")),retryNum>=20){_logger.error("sendBornMessageToParents: Frame ("+window.location.href+") Exceeds the number of retries (20) Send back unsupported frame");var ackMsg={msgType:"contentUnsupoortedACK",source:"FrameCommunicationChannelInHTMLContext",data:{timerID:null}};return void window.postMessage(ackMsg,"*")}for(var ackTimerId=Util.setTimeout(this.sendBornMessageToParents.bind(this,comID,retryNum+1),500),msg={msgType:"descendantBorn",source:"FrameCommunicationChannelInHTMLContext",data:{frameCOMID:comID,timerID:ackTimerId}},win=window,i=0;win!==win.parent;)win=win.parent,++i,msg.data.generation=i,_logger.trace("sendBornMessageToParents: sending to ancestors #",i," The following message ",msg),win.postMessage(msg,"*")},descendantBorn:function(source,childBornInfo){if(_logger.trace("descendantBorn: Started"),!source)return void _logger.info("FrameCommunicationChannelInHTMLContext.descendantBorn: Got born message from a child that dead.");for(var descendantId=childBornInfo.frameCOMID,win=source,p=win.parent;p!==window.self&&!ContentUtils.isInjectable(p,this._logger);)p=p.parent;if(p!==window.self)return void _logger.debug("descendantBorn: This is not the closest injected ancsetor, do nothing");_logger.debug("descendantBorn: This is the closest injected ancsetor");for(var curr=win,windowPath=[];curr!==window.self;)windowPath.push(curr),curr=curr.parent;var frameSearchRes=this.getFrameElemFromWindowPath(window.self,windowPath),frameElemPath=frameSearchRes.path,frameElem=frameSearchRes.elem;if(!frameElem){_logger.error("descendantBorn: Recursive frame finding function failed");var unsupportedAckMsg={msgType:"contentUnsupoortedACK",source:"FrameCommunicationChannelInHTMLContext",data:{timerID:childBornInfo.timerID}};return void source.postMessage(unsupportedAckMsg,"*")}frameElem.__QTP__OBJ||(frameElem.__QTP__OBJ={});var qtpObj=frameElem.__QTP__OBJ,comID=descendantId;"comID"in qtpObj&&qtpObj.comID!==comID?(_logger.info("descendantBorn: frame had another COM ID registered, previous value = ",qtpObj.comID),qtpObj.previousComID=qtpObj.comID):qtpObj.comID===comID&&_logger.info("descendantBorn: frame already had this COM ID registered: ",qtpObj.comID),_logger.info("descendantBorn: Updating frame element with comID:",descendantId),qtpObj.comID=descendantId,_logger.debug("descendantBorn: Going to ask the content context to mark this frame");var markMsg={msgType:"MarkDispatcherInfo",source:"FrameCommunicationChannelInHTMLContext",data:{framePath:frameElemPath,frameCOMID:descendantId}};window.postMessage(markMsg,"*");var ackMsg={msgType:"frameBornAck",source:"FrameCommunicationChannelInHTMLContext",data:{closestAncestorID:this._comID,timerID:childBornInfo.timerID}};source.postMessage(ackMsg,"*")},getFrameElemFromWindowPath:function(parent,path){if(0===path.length)return Util.assert(!1,"getFrameElemFromWindowPath: FrameElement not found!",_logger),{};for(var child=path.pop(),frameElems=parent.document.querySelectorAll("IFRAME,FRAME"),i=0;i<frameElems.length;++i)if(frameElems[i].contentWindow===child){if(0===path.length)return{path:[i],elem:frameElems[i]};var res=this.getFrameElemFromWindowPath(child,path);return{path:res.path?res.path.concat([i]):null,elem:res.elem}}return{}}},BrowserServices={createComChannel:function(logger){return logger&&logger.trace("BrowserServices.createComChannel: started for EmbeddedBrowser"),new MessageChannelComChannel("content")},getLoadTime:function(logger){return logger&&logger.warn("BrowserServices.getLoadTime: started for EmbeddedBrowser - Currently Unsupported, returning 0"),0},isSpecialUninjectablePage:function(logger){return!1},isAboutBlankFrameInjectable:!0,shouldOverrideDispatchEvent:!0,isRunningInPageContext:!0,coordinatesAreRelativeToPage:!0,shouldSendWebExtReportWithResponse:!0};BrowserServices.isTouchSupported=!0,BrowserServices.isWebRoleBasedKitEnabled=!0,BrowserServices.isFrameSupportXSS=!0,ContentDispatcher.prototype={_chromeChannel:null,_responseCallbacks:null,_frameComChannel:null,_listeners:null,_nextMessageID:0,_initData:{},_currentGlobalErrorHandler:null,init:function(){},connect:function(initData){this._logger.info("connect: going to connect to extension"),this._chromeChannel.init(),this._initData=initData,this._chromeChannel.connect()},sendMessage:function(msg,target,forceCOMType,responseCallback){if(this._logger.trace("sendMessage: Going to send \n ",msg,"\nto:\n",target),target=target||msg._to,this._isRTIDInOurContent(target))return this._logger.trace("sendMessage: The target is located locally"),this._dispatchMessageLocally(msg,responseCallback);this._logger.trace("sendMessage: The target is external, looking for the right communication channel to it");var comChannel=this._getTargetCOMChannel(target,forceCOMType);Util.isUndefined(msg._ContentAsyncInfo)||this._logger.error("sendMessage : there is already asyncID on this message please handle it"),responseCallback&&(msg._ContentAsyncInfo={id:++ContentDispatcher.prototype._nextMessageID},this._responseCallbacks[msg._ContentAsyncInfo.id]={func:responseCallback,origMsg:msg,globalErrorHandler:this._currentGlobalErrorHandler}),comChannel.sendMessage(msg,target),this._logger.trace("sendMessage: Finished")},sendEvent:function(msg,target){if(this._logger.trace("sendEvent: Going to send \n ",msg,"\nto:\n",target),target=target||msg._to,this._isRTIDInOurContent(target))return this._logger.trace("sendEvent: The target is located locally"),this._dispatchMessageLocally(msg,Util.identity);this._logger.trace("sendEvent: The target is external, looking for the right communication channel to it");var comChannel=this._getTargetCOMChannel(target);Util.assert(comChannel,"sendEvent: failed to retrieve target communciation channel for: "+target,this._logger),comChannel.sendEvent(msg,target)},getContainingContextID:function(){return this._frameComChannel._closestAncestorID},getParentDispatcherID:function(){return RtIdUtils.GetExtensionRtId()},onComChannelConnected:function(){this._logger.trace("onComChannelConnected: Called"),this._resetGlobalErrorHandler(),this._sendFrameRegistrationMessage()},onComChannelConnectionFailed:function(reason){switch(this._logger.warn("onComChannelConnectionFailed: Called: ",reason),reason){case"timeout":this._logger.trace("onComChannelConnectionFailed: Timeout - Reconnecting"),this._chromeChannel.connect();break;default:this._logger.error("onComChannelConnectionFailed: Unknown Connection Failure Reason")}},onMessageTimedOut:function(timedOutMsg){switch(this._logger.warn("onResendTimer:\n",timedOutMsg,"\n Has Timed out!!!"),this._resetGlobalErrorHandler(),timedOutMsg._msgType){case MSG_TYPES.REGISTER_FRAME:if(this._registrationRetryNum=this._registrationRetryNum?++this._registrationRetryNum:1,this._registrationRetryNum>=60)return void this._logger.warn("onMessageTimedOut: The number of retries has exceed going to stop registration");this.connect(timedOutMsg._data);break;case"Frame Attached":this.sendMessage(timedOutMsg);break;default:this._logger.error("onResendTimer: Unsupported message type:",timedOutMsg._msgType)}this._logger.trace("onResendTimer: Finished")},onMessage:function(msg,sender,resultCallback){this._logger.trace("onMessage: Started with ",msg),this._setGlobalErrorHandler(msg,resultCallback);try{this._onMessageInternal(msg,sender,resultCallback)}finally{this._resetGlobalErrorHandler()}},onEvent:function(msg,sender){this._logger.trace("onMessage: Started with ",msg),this._onMessageInternal(msg,sender,Util.identity)},_onMessageInternal:function(msg,sender,resultCallback){switch(this._logger.trace("_onMessageInternal: Started with ",msg),msg._msgType){case"SRVC_SET_GLOBAL_VARIABLES_INTERNAL":this._setSettings(msg._data);default:this._dispatchMessageLocally(msg,resultCallback)}},onResponseMessage:function(msg){this._logger.prettyTrace("onResponseMessage: Started with the following message:\n",msg);var asyncInfo=msg._ContentAsyncInfo;if(delete msg._ContentAsyncInfo,!asyncInfo)return void this._logger.debug("onResponseMessage: The message has no async info");if(Util.isNullOrUndefined(asyncInfo.id))return void this._logger.error("onResponseMessage: asyncInfo does not contain a cookie id");if(!this._responseCallbacks[asyncInfo.id])return void this._logger.error("onResponseMessage: No call back info for message with async Cookie =",asyncInfo.id);if(delete this._responseCallbacks[asyncInfo.id].origMsg._ContentAsyncInfo,!this._responseCallbacks[asyncInfo.id].func)return void this._logger.debug("onResponseMessage: No call back for message with async Cookie =",asyncInfo.id);var func=this._responseCallbacks[asyncInfo.id].func;this._currentGlobalErrorHandler=this._responseCallbacks[asyncInfo.id].globalErrorHandler;try{func(msg)}catch(e){this._logger.error("onResponseMessage: Got exception, Call global error callback - Stack: ",e),this._currentGlobalErrorHandler?this._currentGlobalErrorHandler(e):this._logger.warn("onResponseMessage: global error callback is not set")}this._resetGlobalErrorHandler(),delete this._responseCallbacks[asyncInfo.id]},disconnect:function(){this._logger.trace("disconnect: Started"),this._chromeChannel.disconnect()},addListener:function(eventName,listenerObj){this._logger.info("addListener: called"),this._listeners[eventName]||(this._listeners[eventName]=[]),this._listeners[eventName].push(listenerObj)},removeListener:function(eventName,listenerObj){if(this._logger.info("removeListener: called"),!this._listeners[eventName])return void this._logger.error("removeListener: Trying to remove listener that is not registered");var listenerIdx=this._listeners[eventName].indexOf(listenerObj);if(-1===listenerIdx)return void this._logger.error("removeListener: Removing unknown listener");this._inMiddleOfEvent?this._listeners[eventName][listenerIdx].toBeDeleted=!0:this._listeners[eventName].splice(listenerIdx,1)},dispatchEvent:function(eventName){if(!this._listeners[eventName])return void this._logger.trace("dispatchEvent: no listeners found for event: ",eventName);var args=Util.makeArray(arguments);args.splice(0,1);var funcName="on"+eventName,listeners=this._listeners[eventName];this._inMiddleOfEvent=!0;for(var i=0;i<listeners.length;++i)listeners[i].toBeDeleted||listeners[i][funcName].apply(listeners[i],args);delete this._inMiddleOfEvent,this._listeners[eventName]=this._listeners[eventName].filter(function(listener){return!listener.toBeDeleted})},_getTargetCOMChannel:function(target,forceCOMType){switch(this._logger.trace("_getTargetCOMChannel: Started for target:",target," forceCOMType is:",forceCOMType),forceCOMType){case"chrome":return this._chromeChannel;case"frame":return this._frameComChannel}return this._isRTIDInOurContent(target)?(this._logger.error("_getTargetCOMChannel: The RTID is in our content no need for COM Channel"),null):RtIdUtils.IsRTIDExtension(target)?this._chromeChannel:RtIdUtils.IsRTIDFrame(target)||RtIdUtils.IsRTIDAO(target)?this._frameComChannel:RtIdUtils.IsRTIDPage(target)||RtIdUtils.IsRTIDBrowser(target)||RtIdUtils.IsRTIDAgent(target)?this._chromeChannel:void this._logger.error("_getTargetCOMChannel: no COMChannel has returned!!!")},_dispatchMessageLocally:function(msg,resultCallback){var ao=this._getTargetAOAccordingToRTID(msg._to);if(!ao)return this._logger.error("_dispatchMessageLocally: _getTargetAOAccordingToRTID  didn't find AO in container"),msg.status="ERROR",void(resultCallback&&resultCallback(msg));var extAsyncInfo=msg._extAsyncInfo,globalErrorHandler=this._currentGlobalErrorHandler,logger=this._logger;ao.onMessage(msg,function(resMsg){extAsyncInfo&&(resMsg._extAsyncInfo=extAsyncInfo);try{resultCallback&&resultCallback(resMsg)}catch(e){logger.error("_dispatchMessageLocally: Exception occurred in ao.onMessage's on response - call global error callback. ",e.stack),globalErrorHandler?globalErrorHandler(e):logger.warn("_dispatchMessageLocally: global error callback is not set")}})},_isRTIDInOurContent:function(id){if(!RtIdUtils.IsRTIDAO(id)&&!RtIdUtils.IsRTIDFrame(id))return!1;var ourFrameID=content.frame.getID();return ourFrameID.frame===id.frame&&((id.page===ourFrameID.page||-1===ourFrameID.page)&&(id.browser===ourFrameID.browser||-1===ourFrameID.browser))},_getTargetAOAccordingToRTID:function(targetRTID){if(this._logger.trace("_getTargetAOAccordingToRTID: Started for target RTID:",targetRTID),!this._isRTIDInOurContent(targetRTID))return this._logger.error("_getTargetAOAccordingToRTID: This RTID is not for us no AO will be returned"),null;if(null===targetRTID.object)return this._logger.trace("_getTargetAOAccordingToRTID: The target is Frame AO"),content.frame;this._logger.trace("_getTargetAOAccordingToRTID: The target is regular AO");var associatedElement=content.rtidManager.GetElementFromID(targetRTID.object);return associatedElement instanceof DotObjJSProxy?associatedElement:associatedElement instanceof Range?content.kitsManager.createVirtualTextAO(associatedElement,content.frame.getID()):content.kitsManager.createAO(associatedElement,content.frame.getID())},_setSettings:function(newSettings){this._logger.trace("_setSettings: Started"),content.settings=content.settings||{};for(var p in newSettings)Object.defineProperty(content.settings,p,{value:newSettings[p],writable:!1,configurable:!0,enumerable:!0})},_onRegistrationResult:function(msg){this._logger.info("_onRegistrationResult: Started");var regResult=msg._data;if(this._logger.debug("_onRegistrationResult: Registration result for tabID is ",regResult.tabID),"pending"===regResult.status)return this._logger.debug("_onRegistrationResult: registration status is pending, Browser is not ready. Wait."),void Util.setTimeout(this._sendFrameRegistrationMessage.bind(this),500);LoggerUtilSettings.setSettings(regResult.logSettings),content.domSubscriber.initHTMLLogger(regResult.logSettings),this._setSettings(regResult._settings),this.dispatchEvent("RegistrationResult",regResult),this._frameComChannel.init({frameID:content.frame.getID()}),this._frameComChannel.connect({isPage:this._initData.isPage})},onFrameCOMChannelConnected:function(){this._logger.info("onFrameCOMChannelConnected: Started"),this._resetGlobalErrorHandler(),DotObjUtil.InstallDotObjectSupport();var frameAttachMessage=new Msg("Frame Attached",this.getParentDispatcherID(),{frameID:content.frame.getID()});this._logger.info("onFrameCOMChannelConnected: Dispatching Frame Attached Message: ",function(){return JSON.stringify(content.frame.getID())}),this.sendMessage(frameAttachMessage),void 0!==PageProxy&&PageProxy.install()},_resetGlobalErrorHandler:function(){this._currentGlobalErrorHandler=null},_setGlobalErrorHandler:function(msg,resultCallback){this._currentGlobalErrorHandler=function(origMsg,error){origMsg.status="ERROR",origMsg.details=error?error.message:null,resultCallback(origMsg)}.bind(this,msg)},_sendFrameRegistrationMessage:function(){var registerFrameMsg=new Msg(MSG_TYPES.REGISTER_FRAME,this.getParentDispatcherID(),this._initData);this.sendMessage(registerFrameMsg,null,null,this._onRegistrationResult.bind(this))}},DotObjJSProxy.prototype={_logger:null,_obj:null,_id:null,type:"NPObjDispWrapper",_nextId:0,_callbackMap:{},onMessage:function(msg,resultCallback){if(this._logger.trace("onMessage: Started with message ",msg),!this[msg._msgType])return this._logger.error("onMessage: Unsupported message type: ",msg._msgType),msg.status="ERROR",void resultCallback(msg);this[msg._msgType](msg,resultCallback)},getID:function(){return Util.shallowObjectClone(this._id)},DOT_OBJ_BUILD_INFO:function(msg,resultCallback){this._logger.trace("DOT_OBJ_BUILD_INFO: started");var requestMsg=new Msg("DOT_OBJ_BUILD_INFO",{},{objToOperate:this._obj}),logger=this._logger;this._dispatchToHandlerInPage(requestMsg,function(resMsg){logger.trace("DOT_OBJ_BUILD_INFO: received result");var resObj=resMsg._data.result,resultName=Object.keys(resObj)||[],resultVal=[];resultName.forEach(function(key){resultVal.push(resObj[key])}),msg._data.name=[resultName],msg._data.value=[resultVal],msg.status=resMsg.status,resultCallback(msg)})},DOT_OBJ_GET_PROPERTY:function(msg,resultCallback){this._logger.trace("DOT_OBJ_GET_PROPERTY: started for property: "+msg._data.name);var requestMsg=new Msg("DOT_OBJ_GET_PROPERTY",{},{propName:msg._data.name,objToOperate:this._obj});this._dispatchToHandlerInPageAndHandleResponse(requestMsg,msg,resultCallback)},DOT_OBJ_PUT_PROPERTY:function(msg,resultCallback){this._logger.trace("PutProperty: Started for property:"+msg._data.name+" value:"+msg._data.data);var arg=this._unwrapDotObjIfNeeded(msg._data.data),requestMsg=new Msg("DOT_OBJ_PUT_PROPERTY",{},{propName:msg._data.name,objToOperate:this._obj,valToPut:arg});this._dispatchToHandlerInPageAndHandleResponse(requestMsg,msg,resultCallback)},DOT_OBJ_CALL_METHOD:function(msg,resultCallback){if("NativePropertyBatchQuery"===msg._data.name)this._nativeBatchQuery(msg,resultCallback);else{this._logger.trace("CallMethod: Started for: "+msg._data.name);var args=Array.isArray(msg._data.data)?msg._data.data:[msg._data.data];args=args.map(function(arg){return this._unwrapDotObjIfNeeded(arg)},this);var requestMsg=new Msg("DOT_OBJ_CALL_METHOD",{},{methodName:msg._data.name,objToOperate:this._obj,args:args});this._dispatchToHandlerInPageAndHandleResponse(requestMsg,msg,resultCallback)}},_dispatchToHandlerInPage:function(requestMsg,resultCallback){this._logger.trace("_dispatchToHandlerInPage: started");var callbackId=++DotObjJSProxy.prototype._nextId;this._callbackMap[callbackId]=resultCallback,requestMsg.dotObjAsyncId=callbackId;var ev=ContentUtils.createCrossOriginCustomEvent("_QTP_Dot_Object",{detail:requestMsg});window.dispatchEvent(ev)},_dispatchToHandlerInPageAndHandleResponse:function(requestMsg,originalMsg,resultCallback){this._logger.trace("_dispatchToHandlerInPageAndHandleResponse: started"),requestMsg._data.manageReturnValueIfNeeded=!0,this._dispatchToHandlerInPage(requestMsg,function(originalMsg,resMsg){this._logger.trace("_dispatchToHandlerInPageAndHandleResponse: returned");var result=resMsg._data.result;if("object"==typeof result){var proxy=new DotObjJSProxy(result,this.getID());result=SpecialObject.CreateDotObj(proxy.getID())}originalMsg.status=resMsg.status,originalMsg._data.value=result,resultCallback(originalMsg)}.bind(this,originalMsg))},_unwrapDotObjIfNeeded:function(arg){if(this._logger.trace("_unwrapDotObjIfNeeded: started"),RtIdUtils.IsRuntimeId(arg)){var dotObjProxy=content.rtidManager.GetElementFromID(arg.object);return Util.assert(dotObjProxy instanceof DotObjJSProxy,"_unwrapDotObjIfNeeded: trying to unwrap an object which is not a dotObj proxy",this._logger),dotObjProxy.getWrappedObject()}return arg},getWrappedObject:function(){return this._obj},ResultMsgHandler:function(resEvent){var resMsg=resEvent.detail;if("DOT_OBJ_RESULT"!==resMsg._msgType)return this._logger.error("ResultMsgHandler: Received unknown message type: "+resMsg._msgType),!0;var callback=this._callbackMap[resMsg.dotObjAsyncId];delete this._callbackMap[resMsg.dotObjAsyncId],callback&&callback(resMsg)},_nativeBatchQuery:function(msg,resultCallback){var args=msg._data.data[0],requestMsg=new Msg(msg._data.name,{},{objToOperate:this._obj,args:args});this._dispatchToHandlerInPage(requestMsg,function(resultMsg){msg._data.value=[[]],msg._data.value[0]=resultMsg._data.result.map(function(value){var dotObjectPropertyValue=value;if("object"==typeof value){var proxy=new DotObjJSProxy(value,this.getID())
;dotObjectPropertyValue=SpecialObject.CreateDotObj(proxy.getID())}return dotObjectPropertyValue},this),msg.status="OK",resultCallback(msg)}.bind(this))}};var DotObjUtil={_logger:null,_callbacks:{},_nextUID:-1,_nextAsyncID:0,WrapElement:function(element,parentId,resCallback){var markObjRequest=SpecialObject.CreateElementRequest(this._getElementUID(),++this._nextAsyncID);element.setAttribute("uft-uid",markObjRequest.objUID),this.sendToDotObjectManager(markObjRequest,function(dotObjManagerCookie){var proxy=new DotObjJSProxy(dotObjManagerCookie,parentId);resCallback(SpecialObject.CreateDotObj(proxy.getID()))})},WrapDocument:function(element,parentId,resCallback){var markObjRequest=SpecialObject.CreateDocumentRequest(++this._nextAsyncID);this.sendToDotObjectManager(markObjRequest,function(dotObjManagerCookie){var proxy=new DotObjJSProxy(dotObjManagerCookie,parentId);resCallback(SpecialObject.CreateDotObj(proxy.getID()))})},InstallDotObjectSupport:function(){this._logger=new LoggerUtil("Content.DotObjUtil "),this._logger.info("InstallDotObjectSupport: Started going to install the Dot Object manager into HTML context"),window.addEventListener("UFT_DOT_OBJ_MARK_RESULT",this.onDotObjectMarkResult.bind(this),!1),content.domSubscriber.startNamespace(),content.domSubscriber.addUtilityObject("DotObjectManagerInHTMLContext",DotObjectManagerInHTMLContext,{_QTP_Dot_Object:"onMessageFromDotObjectInstance",UFT_DOT_OBJ_ADD_TO_MANAGED_OBJ:"onAddObjectToManage"}),content.domSubscriber.endNamespace()},sendToDotObjectManager:function(dataToSend,resultCallback){this._logger.trace("sendToDotObjectManager: Goint to send the following info to the mager:",dataToSend),this._callbacks[dataToSend.dotUtilObjAsyncID]=resultCallback;var markEvent=ContentUtils.createCrossOriginCustomEvent("UFT_DOT_OBJ_ADD_TO_MANAGED_OBJ",{detail:dataToSend});window.dispatchEvent(markEvent)},onDotObjectMarkResult:function(eventObj){var markResultDetails=eventObj.detail;if(this._logger.trace("onDotObjectMarkResult: Got the following mark result from the manager:",markResultDetails),!this._callbacks[markResultDetails.dotUtilObjAsyncID])return void this._logger.error("onDotObjectMarkResult: Got result without any request!!!");var callback=this._callbacks[markResultDetails.dotUtilObjAsyncID];delete this._callbacks[markResultDetails.dotUtilObjAsyncID],delete markResultDetails.dotUtilObjAsyncID,callback(markResultDetails)},_getElementUID:function(){return"UFT_"+(new Date).UTC+ ++this._nextUID}},DotObjectManagerInHTMLContext={_managedObjs:[],_nextToken:0,NativePropertyBatchQuery:function(msg,obj){var props=msg._data.args,res=props.map(function(prop){var propValue=this._getDomPropertyValue(obj,prop);return"object"==typeof propValue||Util.isLegacyObject(propValue)?this._addObjectToBeManaged(SpecialObject.CreateReferenceRequest(propValue)):propValue},this);return msg._data.manageReturnValueIfNeeded=!1,res},_getDomPropertyValue:function(obj,prop){var propValue=obj[this.getCaseInsensitiveName(prop,obj)];return null===propValue&&(propValue=""),propValue},onMessageFromDotObjectInstance:function(msgEvent){_logger.trace("onMessageFromDotObjectInstance: Started");var msg=msgEvent.detail;if(!this[msg._msgType])return void _logger.error("onMessageFromDotObjectInstance: Goi Unknown type of message:"+msg._msgType);var resMsg={_msgType:"DOT_OBJ_RESULT",_to:Util.shallowObjectClone(msg._to),_data:msg._data};try{_logger.trace("onMessageFromDotObjectInstance: Handling the following request:",msg);var obj=this._obtainObjectToOperateOn(msg),resultVal=this[msg._msgType](msg,obj);msg._data.manageReturnValueIfNeeded&&("object"==typeof resultVal||Util.isLegacyObject(resultVal))&&(_logger.debug("DotObjJSProxy.DotObjectHandler: The return value is an object lets add it to managed objects"),resultVal=this._addObjectToBeManaged(SpecialObject.CreateReferenceRequest(resultVal))),resMsg._data.result=resultVal}catch(e){_logger.error("DotObjJSProxy.DotObjectHandler: There was an exception - exception message: "+e.message+"\nStack:"+e.stack),resMsg.status=this._getStatusFromException(e),resMsg.ex=e.message}resMsg.dotObjAsyncId=msg.dotObjAsyncId;var ev=new CustomEvent("_DOT_OBJ_RESULT",{detail:resMsg});return window.dispatchEvent(ev),!1},onAddObjectToManage:function(msgEvent){var objToManageDetails=msgEvent.detail;_logger.trace("onAddObjectToManage: Got the following object to mark:",objToManageDetails),Util.assert(objToManageDetails.specialObj,"onAddObjectToManage: Got Mark event on non special obj!",_logger);var res=this._addObjectToBeManaged(objToManageDetails),resultEvent=objToManageDetails.resultEventName||"UFT_DOT_OBJ_MARK_RESULT";_logger.trace("onAddObjectToManage: Going to send the following result: ",res," using the evnet ",resultEvent);var ev=new CustomEvent(resultEvent,{detail:res});window.dispatchEvent(ev)},getObjectToManage:function(objToManageDetails){switch(_logger.trace("getObjectToManage: Started for object type:"+objToManageDetails.type),objToManageDetails.type){case"DotObjMarkerElementRequest":var elements=document.querySelectorAll('[uft-uid*="'+objToManageDetails.objUID+'"]');if(0===elements.length)return _logger.error("onAddObjectToManage: Failed find element to manage"),null;elements.length>1&&_logger.warn("getObjectToManage: there are more than one element with UID:"+objToManageDetails.objUID+" Their number is:"+elements.length);var element=elements[0];return element.removeAttribute("uft-uid"),element;case"DotObjMarkerDocumentRequest":return document;case"DotObjMarkerReferenceRequest":return objToManageDetails.objRef;default:return _logger.error("getObjectToManage: Unsupported type of object to manage"),null}},getCaseInsensitiveName:function(name,obj){if(name in obj)return name;var uc=name.toUpperCase();for(var p in obj)if(uc===p.toUpperCase())return p;return name},handleCallMethod:function(obj,methodName,args){if(Array.isArray(obj))switch(methodName){case"item":if("number"==typeof args[0])return obj[args[0]]}if(!(methodName in obj))throw new Error("MethodNotFound");return args=args.map(function(arg){return this._getManagedObjectIfPresent(arg)},this),obj[methodName].apply(obj,args)},DOT_OBJ_BUILD_INFO:function(msg,obj){var res={};for(var prop in obj)try{if(Util.isLegacyObject(obj[prop]))continue;var type=typeof obj[prop];null===obj[prop]&&(type="string"),res[prop]=type}catch(ex){_logger.warn("Faile on property:"+prop+" The error is:"+ex)}return res.toString="function",Array.isArray(obj)&&(res.item="function"),res},DOT_OBJ_GET_PROPERTY:function(msg,obj){return this._getDomPropertyValue(obj,msg._data.propName)},DOT_OBJ_PUT_PROPERTY:function(msg,obj){_logger.trace("DotObjectHandler: Got message for DOT_OBJ_PUT_PROPERTY"),obj[this.getCaseInsensitiveName(msg._data.propName,obj)]=msg._data.valToPut,delete msg._data.valToPut},DOT_OBJ_CALL_METHOD:function(msg,obj){_logger.trace("DotObjectHandler: Got message for DOT_OBJ_CALL_METHOD");var methodName=this.getCaseInsensitiveName(msg._data.methodName,obj);return this.handleCallMethod(obj,methodName,msg._data.args)},_obtainObjectToOperateOn:function(msg){var dotObjManagerToken=msg._data.objToOperate;return Util.assert(dotObjManagerToken.specialObj,"DotObjectManagerInHTMLContext._obtainObjectToOperateOn: Got object token which is not supported",this._logger),delete msg._data.objToOperate,this._managedObjs[dotObjManagerToken.cookie]},_addObjectToBeManaged:function(objToManageDetails){var objToManage=this.getObjectToManage(objToManageDetails),res=SpecialObject.CreateDotObjInHTML(++this._nextToken,objToManageDetails.dotUtilObjAsyncID);return _logger.trace("DotObjectManagerInHTMLContext.onAddObjectToManage: Adding the object and returning the following info:",res),this._managedObjs[res.cookie]=objToManage,res},_getManagedObjectIfPresent:function(objToManageDetails){return objToManageDetails instanceof Object&&!0===objToManageDetails.specialObj&&objToManageDetails.hasOwnProperty("cookie")&&objToManageDetails.hasOwnProperty("type")?this._managedObjs[objToManageDetails.cookie]:objToManageDetails},_getStatusFromException:function(e){return"MethodNotFound"===e.message?e.message:"ERROR"}},HTMLLogger={_threshold:4e4,_appenderList:[],_initialized:!1,trace:function(msg){this._log(1e4,"log",msg)},prettyTrace:function(msg){this._log(1e4,"log",msg)},debug:function(msg){this._log(2e4,"log",msg)},prettyDebug:function(msg){this._log(2e4,"log",msg)},info:function(msg){this._log(3e4,"log",msg)},warn:function(msg){this._log(4e4,"warn",msg)},error:function(msg){this._log(5e4,"error",msg)},fatal:function(msg){this._log(6e4,"error",msg)},_addAppender:function(appender){appender&&this._appenderList.push(appender)},_init:function(){this._appenderList=[],this._addAppender(HTMLConsoleAppender),this.remoteLogging&&this.remoteLogging.enabled&&(HTMLWebSocketsAppender.port=this.remoteLogging.port,this._addAppender(HTMLWebSocketsAppender)),this._initialized=!0},_log:function(level,logFunction,logMsg){level<this._threshold||(this._initialized||this._init(),this._appenderList.forEach(function(appender){appender.append(level,logFunction,logMsg)}))}},HTMLConsoleAppender={append:function(level,logFunction,logMsg){var logFunc=console[logFunction]||console.log;logFunc&&logFunc.call(console,logMsg)}},HTMLWebSocketsAppender={_threshold:0,_logWebSocket:null,_enabled:!0,_buffer:"",port:0,_onOpen:function(){this.enabled=!0,this._logWebSocket.send(this._buffer),delete this._buffer},_onClose:function(){delete this._buffer,this.enabled=!1},_onError:function(){delete this._buffer,this.enabled=!1},_connect:function(){this._logWebSocket=new WebSocket("ws://127.0.0.1:"+this.port),this._logWebSocket.onopen=this._onOpen.bind(this),this._logWebSocket.onclose=this._onClose.bind(this),this._logWebSocket.onerror=this._onError.bind(this)},_getFormattedMessage:function(logMsg,level){return(new Date).getTime()+" # "+new Date+" ["+level+"] - "+logMsg},append:function(level,sLevel,logMsg){if(this._enabled)switch(this._logWebSocket||this._connect(),this._logWebSocket.readyState){case this._logWebSocket.CONNECTING:this._buffer+=this._getFormattedMessage(logMsg,sLevel)+"\n";break;case this._logWebSocket.OPEN:this._logWebSocket.send(this._getFormattedMessage(logMsg,sLevel));break;case this._logWebSocket.CLOSING:case this._logWebSocket.CLOSED:delete this._buffer,this.enabled=!1}}};DomRequestSubscriber.prototype={_namespaceScript:"",_htmlLogger:null,addDOMSideEventHandler:function(eventName,func,contextObj,contextObjName){contextObjName=contextObjName||"contextObj",this.handlers+="window.addEventListener('"+eventName+"', (function("+contextObjName+") { return "+func.toString()+";})("+JSON.stringify(contextObj)+"));"},addMessageHandler:function(func,contextObj,contextObjName){this.addDOMSideEventHandler("message",func,contextObj,contextObjName)},injectHandlers:function(){ContentUtils.evalInDocument(this.handlers),this.handlers=""},startNamespace:function(){this._namespaceScript="( function(){",this.addUtilityObject("Util",Util),this.addUtilityObject("SpecialObject",SpecialObject),this.addUtilityObject("HTMLConsoleAppender",HTMLConsoleAppender),this.addUtilityObject("HTMLWebSocketsAppender",HTMLWebSocketsAppender),this.addUtilityObject("_logger",this._htmlLogger),this.addUtilityObject("RtIdUtils",RtIdUtils),this.addUtilityObject("ContentUtils",ContentUtils),this.addUtilityObject("BrowserServices",BrowserServices)},addUtilityObject:function(name,obj,eventHandlers){var objData=JSON.stringify(obj);this._namespaceScript+="var "+name+"="+objData,this._namespaceScript=this._namespaceScript.substring(0,this._namespaceScript.length-1),"{}"!==objData&&(this._namespaceScript+=","),this._addFunctionsFromObj(obj),this._namespaceScript=this._namespaceScript.substring(0,this._namespaceScript.length-1),this._namespaceScript+="};";var eventHandlersToInject=eventHandlers||{};obj.onMessageFromContent&&(eventHandlersToInject.message="onMessageFromContent"),this.addObjectEventHandlers(name,eventHandlersToInject)},addObjectEventHandlers:function(objName,eventHandlers){Object.keys(eventHandlers).forEach(function(eventName){this._namespaceScript+="window.addEventListener('"+eventName+"',"+objName+"."+eventHandlers[eventName]+".bind("+objName+"),false);"}.bind(this))},addFunction:function(func){this._namespaceScript+=func.toString()+";"},addScript:function(script){this._namespaceScript+=script},endNamespace:function(){this._namespaceScript+="})();",ContentUtils.evalInDocument(this._namespaceScript)},initHTMLLogger:function(logSettings){this._htmlLogger=HTMLLogger;var defaultLoggingLevel=logSettings["log:defaultLevel"]||LoggerUtilSettings.DEFAULT_LOG_LEVEL;this._htmlLogger._threshold=log4javascript.Level[defaultLoggingLevel].level,this._htmlLogger.remoteLogging=logSettings.remoteLogging},_addFunctionsFromObj:function(obj){for(var key in obj)"function"==typeof obj[key]&&(this._namespaceScript+=key+":"+obj[key].toString()+",")}},BrowserContentHelper.prototype={_logger:null,_frameAo:null,_attrs:{micclass:function(){return["Browser"]},abs_x:function(){return this._frameAo.GetAttrSync("window_rect").left},abs_y:function(){return this._frameAo.GetAttrSync("window_rect").top}},_attrsFromFrame:{title:"title",url:"url","logical name":"logical name",name:"title",height:"height",width:"width"},getID:function(){return{browser:this._frameAo.getID().browser,page:-1,frame:-1,object:null}},GetAttrSync:function(property){this._logger.trace("GetAttrSync: query property "+property);var func=this._attrs[property];return func?func.call(this):this._attrsFromFrame[property]?this._frameAo.GetAttrSync(this._attrsFromFrame[property]):(this._logger.trace("GetAttrSync: returning partial value for Browser property: "+property),AttrPartialValueUtil.WrapValue(property,null,null))},QueryAttributesSync:function(attrsObj){this._logger.trace("QueryAttributesSync: called for attributes: ",attrsObj);var attrsObjRes={};return Object.keys(attrsObj).forEach(function(attr){attrsObjRes[attr]=this.GetAttrSync(attr)},this),attrsObjRes}},ElementInspector.prototype={_logger:null,_frameId:null,_handlers:null,_outliner:null,_init:function(frameId){this._logger=new LoggerUtil("Content.ElementInspector"),this._frameId=frameId,this._handlers={};var mouseEvents=["click","dblclick","mousedown","mouseup","mouseover"],defaultHandler=this._eventHandler.bind(this);mouseEvents.forEach(function(name){this._handlers[name]=defaultHandler},this),this._handlers.mousemove=this._mouseMove.bind(this),this._handlers.mouseout=this._mouseOut.bind(this),this._handlers.keydown=this._keyDown.bind(this),this._handlers.keyup=this._keyUp.bind(this)},startSpy:function(msg,resultCallback){this._internalStartSpy(),resultCallback(msg)},_internalStartSpy:function(){this._logger.trace("startSpy: called"),this._outliner=new ContentUtils.ElementBorder,this._outliner.run(function(elem){elem.style.cursor="pointer"}),Object.keys(this._handlers).forEach(function(h){document.addEventListener(h,this._handlers[h],!0)},this)},stopSpy:function(msg,resultCallback){this._internalStopSpy(),resultCallback(msg)},_internalStopSpy:function(){this._logger.trace("stopSpy: called"),this._outliner.remove(),this._outliner=null,Object.keys(this._handlers).forEach(function(h){document.removeEventListener(h,this._handlers[h],!0)},this)},_eventHandler:function(ev){if(this._logger.trace("_eventHandler: called"),ev.metaKey)return void this._logger.trace("handler is paused, exiting");ev.stopPropagation(),ev.preventDefault(),"click"===ev.type&&this._inspect(ev)},_addTitle:function(elem){var self=this;content.kitsManager.createAO(elem,this._frameId).GetAttr("micclass",null,function(micclasses){var micclass=Array.isArray(micclasses)?micclasses[0]:micclasses;self._outliner.run(function(overlay){overlay.title="Class Name: "+micclass+"\nhtml tag: "+elem.tagName})})},_inspect:function(ev){this._outliner.hide();var point={x:ev.clientX,y:ev.clientY};this._getObjectFromClientPoint(point,function(resMsg){this._logger.trace("_inspect: QUERY_OBJ_CLIENT_POINT_TO_ID result: ",resMsg);var webIdsArr=resMsg._data.WEB_PN_ID;if(!Array.isArray(webIdsArr)||webIdsArr.length<1)return void this._logger.trace("_inspect: QUERY_OBJ_CLIENT_POINT_TO_ID didn't return any Runtime Ids");this._dispatchInspectMsg(webIdsArr.pop())}.bind(this))},_getObjectFromClientPoint:function(point,resultCallback){var queryClientPointMsg=new Msg("QUERY_OBJ_CLIENT_POINT_TO_ID",Util.shallowObjectClone(this._frameId),{pos:point});content.dispatcher.sendMessage(queryClientPointMsg,null,null,resultCallback)},_mouseMove:function(ev){if(ev.metaKey)return void this._outliner.hide();this._internalMouseMove(ev),this._outliner.wrap(elem)&&this._addTitle(elem),this._outliner.show()},_internalMouseMove:function(ev){ev.stopPropagation(),ev.preventDefault(),this._outliner.hide(),document.elementFromPoint(ev.x,ev.y).tagName},_mouseOut:function(ev){ev.relatedTarget||this._outliner.hide()},_dispatchInspectMsg:function(rtid){this._logger.trace("_dispatchInspectMsg: called");var inspectAutMsg=new Msg("EVENT_INSPECT_ELEMENT",content.dispatcher.getParentDispatcherID(),{WEB_PN_ID:[rtid]});content.dispatcher.sendEvent(inspectAutMsg)},_keyDown:function(ev){if(27===ev.keyCode){this._logger.trace("keyDownHandler: Cancelling Spy");var inspectAutMsg=new Msg("EVENT_INSPECT_CANCEL",content.dispatcher.getParentDispatcherID(),{});return void content.dispatcher.sendEvent(inspectAutMsg)}ev.metaKey&&this._outliner.hide()},_keyUp:function(ev){ev.metaKey&&this._outliner.show()}};var FrameInHTMLContext={_id:{},_currentGlobalErrorHandler:null,_callbacks:{},_nextCallbackID:-1,onMessageFromContent:function(msgEventObj){var requestMsg=msgEventObj.data;if("object"==typeof requestMsg&&("Frame"===requestMsg.source||"FrameInHTMLContext"===requestMsg.source))switch(requestMsg.msgType){case"request":this.handleRequest(msgEventObj.source,requestMsg);break;case"response":this.handleResponse(requestMsg)}},RunOnDocEventHandler:function(msgEvent){var msg=msgEvent.detail;try{var result=this._embedRunScriptHelper(msg._data.script);if(Util.isFunction(result)||Util.isLegacyObject(result)||result&&(Util.isObject(result)||Array.isArray(result))){_logger.debug("FrameInHTMLContext.RunOnDocEventHandler: The result is object lets notify the .Object manager");var request=SpecialObject.CreateReferenceRequest(result);return void this.sendRequestToDotObjectManager(request,function(dotObjToken){_logger.trace("FrameInHTMLContext.RunOnDocEventHandler: Going to send back the following result:"+Util.jsonStringify(dotObjToken,_logger)),msg._data.result=dotObjToken;var ev=new CustomEvent("_QTP_RUN_SCRIPT_RESULT",{detail:msg});window.dispatchEvent(ev)})}msg._data.result=result}catch(e){msg._data.ex=e}_logger.trace("FrameInHTMLContext.RunOnDocEventHandler: Going to send back the following result:"+Util.jsonStringify(msg._data.result,_logger));var ev=new CustomEvent("_QTP_RUN_SCRIPT_RESULT",{detail:msg});window.dispatchEvent(ev)},RunOnDocWithAttrEventHandler:function(){var result={};try{var script=window.document.documentElement.getAttribute("_QTP_Script");result.res=this._embedRunScriptHelper(script)}catch(e){result.ex=e.message+"\nstack:"+e.stack}window.document.documentElement.setAttribute("_QTP_Result",JSON.stringify(result))},_embedRunScriptHelper:function(script){function theUftRunScriptHelper(){window._uft_run_script_helper=function(){return"#TheScript#"}}var wrappedScript=Util.functionStringify(theUftRunScriptHelper);wrappedScript=Util.safeReplace(wrappedScript,'"#TheScript#"',script),ContentUtils.evalInDocument(wrappedScript);try{return window._uft_run_script_helper()}finally{delete window._uft_run_script_helper}},onMarkObjectResult:function(eventObj){var dotObjMarkResult=eventObj.detail;if(_logger.trace("FrameInHTMLContext.onMarkObjectResult: started for response info: "+Util.jsonStringify(dotObjMarkResult,_logger)),!Util.isUndefined(dotObjMarkResult.dotUtilObjAsyncID)){if(!this._callbacks[dotObjMarkResult.dotUtilObjAsyncID])return void _logger.error("FrameInHTMLContext.onMarkObjectResult:: There is a callback id ("+dotObjMarkResult.dotUtilObjAsyncID+") that has no callback");var handlerID=dotObjMarkResult.dotUtilObjAsyncID;delete dotObjMarkResult.dotUtilObjAsyncID;try{delete dotObjMarkResult.resultEventName,this._callbacks[handlerID].handler(dotObjMarkResult)}catch(e){_logger.error("FrameInHTMLContext.onMarkObjectResult: Exception occurred when calling the callback."+e)}finally{delete this._callbacks[handlerID]}}},handleRequest:function(source,requestMsg){_logger.trace("FrameInHTMLContext.handleRequest: started for request message: ",requestMsg);var msg=requestMsg.data;if(msg._msgType&&this[msg._msgType]){this._setGlobalErrorHandler(requestMsg,source);try{this[msg._msgType](msg,function(resMsg){_logger.trace("FrameInHTMLContext.handleRequest: the result is:\n",resMsg),requestMsg.msgType="response",requestMsg.source="FrameInHTMLContext",requestMsg.data=resMsg,_logger.trace("FrameInHTMLContext.handleRequest: Going to send the following result:\n",requestMsg),source.postMessage(requestMsg,"*")})}catch(e){_logger.error("FrameInHTMLContext.handleRequest: Error occurred:\n"+e),this._currentGlobalErrorHandler(e)}finally{this._resetGlobalErrorHandler()}}},handleResponse:function(responsetMsg){if(!Util.isUndefined(responsetMsg.frameInHTHMLCallbackID)){if(_logger.prettyTrace("FrameInHTMLContext.handleResponse: started for response message: ",responsetMsg),!this._callbacks[responsetMsg.frameInHTHMLCallbackID])return void _logger.error("FrameInHTMLContext.handleResponse: There is a callback id ("+responsetMsg.frameInHTHMLCallbackID+") that has no callback");this._currentGlobalErrorHandler=this._callbacks[responsetMsg.frameInHTHMLCallbackID].globalErrorHandler;try{this._callbacks[responsetMsg.frameInHTHMLCallbackID].handler(responsetMsg.data)}catch(e){_logger.error("FrameInHTMLContext.handleResponse: Exception occurred when calling the callback. Call global error handler. Exception:"+e),this._currentGlobalErrorHandler?this._currentGlobalErrorHandler(e):_logger.warn("FrameInHTMLContext.handleResponse: global error handler not set")}finally{this._resetGlobalErrorHandler(),delete this._callbacks[responsetMsg.frameInHTHMLCallbackID]}}},sendMessage:function(targetWin,msg,callback){_logger.trace("FrameInHTMLContext.sendMessage: started");var request={frameInHTHMLCallbackID:++this._nextCallbackID,msgType:"request",source:"FrameInHTMLContext",data:msg};this._callbacks[request.frameInHTHMLCallbackID]={handler:callback,globalErrorHandler:this._currentGlobalErrorHandler},targetWin.postMessage(request,"*")},sendRequestToDotObjectManager:function(dataToSend,resCallback){_logger.trace("FrameInHTMLContext.sendRequestToDotObjectManager: Started"),dataToSend.dotUtilObjAsyncID=++this._nextCallbackID,dataToSend.resultEventName="UFT_DOT_OBJ_MARK_FOR_RUNSCRIPT_RESULT",this._callbacks[dataToSend.dotUtilObjAsyncID]={handler:resCallback,globalErrorHandler:null};var dotObjManagerMarkRequestEvent=new CustomEvent("UFT_DOT_OBJ_ADD_TO_MANAGED_OBJ",{detail:dataToSend});window.dispatchEvent(dotObjManagerMarkRequestEvent)},buildLayoutTree:function(msg,callback,win){_logger.trace("FrameInHTMLContext.buildLayoutTree: started for frame with id:"+Util.jsonStringify(this._id,_logger));var comID=null;Util.isUndefined(win)&&(win=window,comID=this._id);var node={id:comID,children:[]},excludRtidsArr=msg._data.exclude?msg._data.exclude:[],frameElemList=Util.makeArray(win.document.querySelectorAll("IFRAME,FRAME")).filter(function(frame){return msg._data.isFrameSupportXSS||Util.isFrameXSS(frame,win)}),framesToProcess=frameElemList.length;if(0===framesToProcess)return _logger.trace("FrameInHTMLContext.buildLayoutTree: There are no frames to process returning the a single node"),msg._data=node,void callback(msg);frameElemList.forEach(function(frameElem,i){function checkIfGotAllResponses(){--framesToProcess>0||(_logger.debug("FrameInHTMLContext.buildLayoutTree: Finished processing the frames calling our callback"),msg._data=node,callback(msg))}function isFrameExcluded(excludedRtIdsArr,currentComId,previousComId){return excludedRtIdsArr.some(function(rtid2Exclude){return RtIdUtils.IsRTIDEqual(currentComId,rtid2Exclude)||RtIdUtils.IsRTIDEqual(previousComId,rtid2Exclude)})}var request={_msgType:msg._msgType,_data:msg._data};if(_logger.debug("FrameInHTMLContext.buildLayoutTree: Procesing frame "+(i+1)+" out of "+frameElemList.length),frameElem.__QTP__OBJ&&frameElem.__QTP__OBJ.comID){if(isFrameExcluded(excludRtidsArr,frameElem.__QTP__OBJ.comID,frameElem.__QTP__OBJ.previousComID))return _logger.trace("FrameInHTMLContext.buildLayoutTree: adding current frame to tree but excluding subtree, frame id: "+Util.jsonStringify(frameElem.__QTP__OBJ.comID,_logger)+" - previous frame id: "+Util.jsonStringify(frameElem.__QTP__OBJ.previousComID,_logger)),node.children[i]={id:frameElem.__QTP__OBJ.comID,previousId:frameElem.__QTP__OBJ.previousComID,children:[],isExcluded:!0},void checkIfGotAllResponses();_logger.debug("FrameInHTMLContext.buildLayoutTree: Sending message to: "+Util.jsonStringify(frameElem.__QTP__OBJ.comID)),this.sendMessage(frameElem.contentWindow,request,function(response){_logger.trace("FrameInHTMLContext.buildLayoutTree: "),node.children[i]=response._data,checkIfGotAllResponses()})}else{_logger.debug("FrameInHTMLContext.buildLayoutTree: Uninjectable frame, need to handle it ourself: "+frameElem.src),frameElem.__QTP__OBJ&&_logger.warn("buildLayoutTree: Got known frame with no COM ID");try{if(!frameElem.contentWindow)return _logger.debug("FrameInHTMLContext.buildLayoutTree: [DEBUG] - Got empty frame, ignoring this frame"),node.children[i]={id:null,children:[]},void checkIfGotAllResponses();if(!frameElem.contentWindow.frameElement)return _logger.error("FrameInHTMLContext.buildLayoutTree: [ERROR] - XSS"),node.children[i]={id:null,children:[]},void checkIfGotAllResponses()}catch(e){return _logger.error("FrameInHTMLContext.buildLayoutTree: [ERROR] - XSS page that we're not injected to: "+frameElem.src),node.children[i]={id:null,children:[]},void checkIfGotAllResponses()}this.buildLayoutTree(request,function(response){_logger.trace("FrameInHTMLContext.buildLayoutTree: Got resoponse "+Util.jsonStringify(response,_logger)),node.children[i]=response._data,checkIfGotAllResponses()},frameElem.contentWindow)}},this)},FRAME_FROM_POINT:function(msg,callback){var point=msg._data.point;_logger.trace("FRAME_FRON_POINT: Started with point {"+point.x+", "+point.y+"}");var e=document.elementFromPoint(point.x,point.y);if(null===e)return _logger.error("element from point returned null for point {"+point.x+", "+point.y+"}"),msg.status="ERROR",void callback(msg);switch(_logger.debug("FRAME_FROM_POINT: Got the following element from point:"+e),e.tagName){case"FRAME":case"IFRAME":var childInfo=this._getChildFrameInfo(e,msg._data.point);return _logger.debug("FRAME_FROM_POINT: Child info for frame: comID->"+Util.jsonStringify(childInfo.comID,_logger)+", point->"+Util.jsonStringify(childInfo.point,_logger)+", elem->"+childInfo.elem),null===childInfo.comID?(_logger.debug("FRAME_FROM_POINT: comID is NULL - return"),void callback(msg)):(msg._to=Util.shallowObjectClone(childInfo.comID),msg._data.point=childInfo.point,void this.sendMessage(e.contentWindow,msg,callback));default:return msg._data.WEB_PN_ID=this._id,void callback(msg)}},_getChildFrameInfo:function(f,point){var res={comID:null,point:point};if(Util.assert(f,"FRAME_FROM_POINT: Abnormal termination of recursion",_logger),!f)return res;var frameClientRect=f.getBoundingClientRect(),style=getComputedStyle(f);if(res.point.y-=frameClientRect.top+parseInt(style.paddingTop,10),res.point.x-=frameClientRect.left+parseInt(style.paddingLeft,10),f.__QTP__OBJ)return res.comID=f.__QTP__OBJ.comID,res;var innerFrameElem=f.contentWindow.document.elementFromPoint(res.point.x,res.point.y);return!innerFrameElem||"IFRAME"!==innerFrameElem.tagName&&"FRAME"!==innerFrameElem.tagName?(_logger.error("FRAME_FROM_POINT: The lowest frame is not injectable"),res):this._getChildFrameInfo(innerFrameElem,res.point)},_resetGlobalErrorHandler:function(){this._currentGlobalErrorHandler=null},_setGlobalErrorHandler:function(requestMsg,src){this._currentGlobalErrorHandler=function(origMsg,error){origMsg.status="ERROR",origMsg.details=error?error.message:null,requestMsg.data=origMsg,requestMsg.msgType="response",requestMsg.source="FrameInHTMLContext",src.postMessage(requestMsg,"*")}.bind(this,requestMsg.data)}},FrameBehavior={_attrs:{"client rect":function(){return{top:Math.floor(this._elem.clientTop),left:Math.floor(this._elem.clientLeft),width:Math.floor(this._elem.clientWidth),height:Math.floor(this._elem.clientHeight)}}},_methods:{"calculate relative rect":function(msg,resultCallback){msg._data.continuePropogation=!0;var width,height,rect=this.GetAttrSync("rect"),clientRect=this.GetAttrSync("client rect"),style=getComputedStyle(this._elem);0===msg._data.rect.bottom&&0===msg._data.rect.right?(width=clientRect.width,height=clientRect.height):(width=msg._data.rect.right-msg._data.rect.left,height=msg._data.rect.bottom-msg._data.rect.top),msg._data.rect.top+=rect.top+clientRect.top+parseInt(style.paddingTop,10),msg._data.rect.left+=rect.left+clientRect.left+parseInt(style.paddingLeft,10),msg._data.rect.bottom=msg._data.rect.top+height<rect.bottom?msg._data.rect.top+height:rect.bottom,msg._data.rect.right=msg._data.rect.left+width<rect.right?msg._data.rect.left+width:rect.right,resultCallback(msg)}}},PageBehavior={_attrs:{},_methods:{"calculate relative rect":function(msg,resultCallback){var logger=this._logger;if(logger.trace("PageBehavior: on command 'calculate relative rect' with ",msg),!msg._data.screen_coord)return msg._data.rect.bottom=Math.max(msg._data.rect.bottom,document.documentElement.getBoundingClientRect().bottom),msg._data.rect.right=Math.max(msg._data.rect.right,document.documentElement.getBoundingClientRect().right),void resultCallback(msg);var pageMsg=new Msg("QUERY_ATTR",msg._data.pageId,{screen_rect:null});content.dispatcher.sendMessage(pageMsg,null,"chrome",function(resMsg){var rect=resMsg._data.screen_rect;logger.trace("PageBehavior: command 'calculate relative rect' got screen_rect from the page: ",rect),msg._data.rect.left+=rect.left,msg._data.rect.top+=rect.top,0===msg._data.rect.right?msg._data.rect.right=rect.right:msg._data.rect.right+=rect.left,0===msg._data.rect.bottom?msg._data.rect.bottom=rect.bottom:msg._data.rect.bottom+=rect.top,logger.trace("PageBehavior: command 'calculate relative rect' calculated result rect: ",msg._data.rect),resultCallback(msg)})},MAKE_VISIBLE:function(msg,resultCallback){resultCallback(msg)}}};Frame.prototype={_isPage:!1,id:null,_callbacks:{},_nextCallbackID:-1,_parentPageId:null,_runOnDocCallbackMap:[],_elementInspector:null,_objIdentificationProps:null,_ignoreBrowserDescription:!1,init:function(){this._logger.trace("Init: Starting frame initialization.");var registrationData={isPage:this._isPage};this.id={browser:-1,page:-1,frame:-1,object:null},content.dispatcher.addListener("RegistrationResult",this),this._isPage?(registrationData.title=this.GetAttrSync("title"),registrationData.url=this.GetAttrSync("url"),content.dispatcher.connect(registrationData)):content.dispatcher.connect(registrationData)},buildLayoutTree:function(msg,callback){if(!this._isPage)return this._logger.error("buildLayoutTree: Method should start from page!!"),void callback(msg);msg._data.isFrameSupportXSS=BrowserServices.isFrameSupportXSS?1:0,this.sendRequestToHTMLContext(msg,callback)},onMessage:function(msg,resultCallback){this._logger.trace("onMessage: Started with the following msg:",msg),this[msg._msgType]||(this._logger.trace("onMessage Unhandled msg: "+msg._msgType),ErrorReporter.ThrowNotImplemented("Frame."+msg._msgType)),this[msg._msgType](msg,resultCallback)},DISPATCH_TO_FRAME_ELEM:function(msg,resCallback){this._logger.trace("DISPATCH_TO_FRAME_ELEM: Started");var ao;if(msg._data.targetIsPage)this._logger.debug("DISPATCH_TO_FRAME_ELEM: Message meant for page"),ao=content.kitsManager.createPageAO(this.getID());else{
this._logger.debug("DISPATCH_TO_FRAME_ELEM: Message meant for Frame element");var associatedElement=ContentUtils.findFrameElemByID(msg._data.frameElemComID,document,this._logger);Util.assert(associatedElement,"DISPATCH_TO_FRAME_ELEM: Couldn't find associated frame element",this._logger),ao=content.kitsManager.createAO(associatedElement,this.getID())}ao.onMessage(msg._data.frameElemMsg,function(resMsg){if(msg._data.frameElemMsg=resMsg,msg._data.frameElemMsg._data.continuePropogation)if(delete msg._data.frameElemMsg._data.continuePropogation,this._isPage){this._logger.debug("DISPATCH_TO_FRAME_ELEM: Propogating to page AO");var ao1=content.kitsManager.createPageAO(this.getID());ao1.onMessage(msg._data.frameElemMsg,function(resMsg2){msg._data.frameElemMsg=resMsg2,resCallback(msg)})}else{this._logger.debug("DISPATCH_TO_FRAME_ELEM: Continue propogation of the message to our parent frame");var parentRequestMsg=new Msg(msg._msgType,content.dispatcher.getContainingContextID(),{});parentRequestMsg._data.frameElemMsg=msg._data.frameElemMsg,parentRequestMsg._data.frameElemComID=this.getID(),content.dispatcher.sendMessage(parentRequestMsg,null,null,function(resMsg){msg._data.frameElemMsg=resMsg._data.frameElemMsg,resCallback(msg)})}else resCallback(msg)}.bind(this))},buildNestedMessage:function(msg){this._logger.debug("buildNestedMessage: Creating message for querying our frame element");var ret=new Msg(MSG_TYPES.DISPATCH_TO_FRAME_ELEM,Util.shallowObjectClone(msg._to),{});return ret._data.frameElemMsg=new Msg(msg._msgType,msg._to,msg._data||{}),ret._to=content.dispatcher.getContainingContextID(),ret._to.frame<0&&(ret._to=this.getID(),ret._data.targetIsPage=!0),ret._data.frameElemComID=this.getID(),ret},getAttrFromParent:function(name,msg,resultCallback){if(this._isPage)return void resultCallback(null);var reqData={};"attribute"===name||"style"===name?reqData=msg._data:reqData[name]=null;var reqMsg=new Msg("QUERY_ATTR",msg._to,reqData),frameElemMsg=this.buildNestedMessage(reqMsg);this._logger.debug("getAttrFromParent: Need to send query for our frame element for: "+name),content.dispatcher.sendMessage(frameElemMsg,null,null,function(resMsg){resultCallback(resMsg._data.frameElemMsg._data[name])})},getElementAttribute:function(prop,origMsg,resCallback){if(this._logger.trace("getElementAttribute: Started for property: "+prop),this._isPage){var ao=content.kitsManager.createPageAO(this.getID()),queyMsg=new Msg("QUERY_ATTR",ao.getID(),{});queyMsg._data[prop]=origMsg._data[prop],ao.onMessage(queyMsg,resCallback)}else this.getAttrFromParent(prop,origMsg,resCallback)},QUERY_ATTR:function(msg,resultCallback){this._logger.trace("QUERY_ATTR: Started");var attrs=Object.keys(msg._data);if(attrs.length<1)return this._logger.warn("QUERY_ATTR: Called with no attributes"),void resultCallback(msg);var multiResponses=new MultipleResponses(attrs.length);attrs.forEach(function(valName){this.GetAttr(valName,msg,multiResponses.callback(function(isDone,val){val=Util.cleanSpecialChars(val),this._logger.trace("QUERY_ATTR:",valName,"=",val),msg._data[valName]=val,isDone&&(this._logger.debug("QUERY_ATTR: Finished querying all the requested attributes"),resultCallback(msg))}.bind(this)))}.bind(this))},INTERNAL_BATCH_QUERYATTR:function(msg,resCallback){if(this._logger.trace("INTERNAL_BATCH_QUERYATTR: Started"),msg._data.msgs.length<1)return this._logger.error("INTERNAL_BATCH_QUERYATTR: Got Batch Query fro no object ?!?!"),void resCallback(msg);var logger=this._logger,waitForAllMessages=new MultipleResponses(msg._data.msgs.length);msg._data.msgs.forEach(function(objMsg,index){content.dispatcher.sendMessage(objMsg,null,null,waitForAllMessages.callback(function(isDone,resMsg){msg._data.msgs[index]=resMsg,isDone&&(logger.debug("INTERNAL_BATCH_QUERYATTR: Finished with all object, let wrap it up"),resCallback(msg))}))},this)},CMD_BROWSER_BACK:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_BACK"),msg.delay=!0,resultCallback(msg),Util.setTimeout(function(){window.history.back()},12)},CMD_BROWSER_FORWARD:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_FORWARD"),msg.delay=!0,resultCallback(msg),Util.setTimeout(function(){window.history.forward()},12)},CMD_BROWSER_REFRESH:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_REFRESH"),msg.delay=!0,resultCallback(msg),window.location.reload()},CMD_BROWSER_NAVIGATE:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_NAVIGATE: started");var url=msg._data.url;msg.delay=!0,resultCallback(msg),window.location.href=url},FRAME_FROM_POINT:function(msg,resultCallback){this._logger.trace("FRAME_FROM_POINT: started"),this.sendRequestToHTMLContext(msg,resultCallback)},_initInspectionMode:function(mode){switch(this._logger.trace("_handleInspectionMode: started with mode: "+mode),this._elementInspector||(BrowserServices.getElementInspector?this._elementInspector=BrowserServices.getElementInspector(this.getID()):this._elementInspector=new ElementInspector(this.getID())),mode){case"spy":this._elementInspector.startSpy();break;case"record":this._startRecord()}},SRVC_SET_GLOBAL_VARIABLES_INTERNAL:function(msg,resultCallback){this._logger.trace("SRVC_SET_GLOBAL_VARIABLES_INTERNAL: Started"),msg._data.objectidentificationproperties&&(this._objIdentificationProps=JSON.parse(msg._data.objectidentificationproperties)),null!=msg._data.WebActivityState&&this._handleWebActivityStateSetting(msg._data.WebActivityState),resultCallback(msg)},SRVC_SET_EVENT_CONFIGURATION_INTERNAL:function(msg,resultCallback){this._logger.trace("SRVC_SET_EVENT_CONFIGURATION: Started"),this._recorder.updateEventConfig(msg._data.config),resultCallback(msg)},_handleWebActivityStateSetting:function(webActivityState){this._logger.trace("_handleWebActivityState: Started"),1===webActivityState?(this._logger.trace("_handleWebActivityState: starting record"),this._startRecord()):(this._logger.trace("_handleWebActivityState: stopping record"),this._stopRecord())},_startRecord:function(){this._recorder.startRecord()},_stopRecord:function(){this._recorder.stopRecord()},_internalSpyStart:function(msg,resultCallback){this._elementInspector?this._elementInspector.startSpy(msg,resultCallback):(this._logger.error("_internalSpyStart: no element inspector found"),resultCallback(msg))},_internalSpyEnd:function(msg,resultCallback){this._elementInspector?this._elementInspector.stopSpy(msg,resultCallback):(this._logger.warn("_internalSpyEnd: no element inspector found"),resultCallback(msg))},CMD_SPY_START:function(msg,resultCallback){this._logger.trace("CMD_SPY_START: Started"),Util.assert(this._elementInspector,"CMD_SPY_START: element inspector is null",this._logger),this._internalSpyStart(msg,resultCallback)},CMD_SPY_END:function(msg,resultCallback){this._logger.trace("CMD_SPY_END: Started"),this._internalSpyEnd(msg,resultCallback)},CMD_MONITOR_MOUSE_START:function(msg,resultCallback){if(!BrowserServices.isSupportMonitorMouseMove)return resultCallback(msg);this._logger.trace("CMD_MONITOR_MOUSE_START: called"),this._internalSpyStart(msg,resultCallback)},CMD_MONITOR_MOUSE_END:function(msg,resultCallback){if(!BrowserServices.isSupportMonitorMouseMove)return resultCallback(msg);this._logger.trace("CMD_MONITOR_MOUSE_END: called"),this._internalSpyEnd(msg,resultCallback)},SRVC_LOAD_KIT:function(msg,resultCallback){var progid=msg._data.progid;this._logger.trace("SRVC_LOAD_KIT: started on "+progid),"Mercury.WebExtKit"===progid?this._loadExtToolkits(msg._data.toolkits):this.warnUnimplemented("Browser.SRVC_LOAD_KIT: "+progid),resultCallback(msg)},QUERY_OBJ_POINT_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_OBJ_POINT_TO_ID: Started"),this._calcRelativeRect(msg,!0,function(frameAbsRect){msg._data.pos.x-=frameAbsRect.left,msg._data.pos.y-=frameAbsRect.top,this._logger.trace("QUERY_OBJ_POINT_TO_ID: After converting to frame coordinates pos={"+msg._data.pos.x+" ,"+msg._data.pos.y+"}"),this.getObjsFromClientPoint(msg),this._logger.trace("QUERY_OBJ_POINT_TO_ID: return msg=",msg),resultCallback(msg)}.bind(this))},QUERY_OBJ_CLIENT_POINT_TO_ID:function(msg,resultCallback){if(this._isPage)return this._logger.trace("QUERY_OBJ_CLIENT_POINT_TO_ID: Started for Page. Point= ",msg._data.pos),this.getObjsFromClientPoint(msg),void resultCallback(msg);this._logger.trace("QUERY_OBJ_CLIENT_POINT_TO_ID: Started for Frame. Point= ",msg._data.pos);var queryAttrMsg=new Msg("QUERY_ATTR",this.getID(),{view_x:null,view_y:null});this.onMessage(queryAttrMsg,function(queryAttrResMsg){BrowserServices.isSupportMonitorMouseMove||(msg._data.pos.x-=queryAttrResMsg._data.view_x,msg._data.pos.y-=queryAttrResMsg._data.view_y,this._logger.trace("QUERY_OBJ_CLIENT_POINT_TO_ID: After converting to frame coordinates pos={"+msg._data.pos.x+" ,"+msg._data.pos.y+"}")),this.getObjsFromClientPoint(msg),BrowserServices.isSupportMonitorMouseMove&&(msg._data.pos.x+=queryAttrResMsg._data.view_x,msg._data.pos.y+=queryAttrResMsg._data.view_y),this._logger.trace("QUERY_OBJ_CLIENT_POINT_TO_ID: return msg=",msg),resultCallback(msg)}.bind(this))},SRVC_GET_OBJ_DESCRIPTION:function(msg,resultCallback){this._logger.trace("Frame: SRVC_GET_OBJ_DESCRIPTION msg=",msg);var micclass=Util.getMicClass(this),objIdentificationProps=this.getObjIdentificationProps(micclass);Description.createTestObjectDescription(this,objIdentificationProps,function(specialDescription){this._logger.trace("Description.createTestObjectDescription return specialDescription=",specialDescription),msg._data.objDescription=specialDescription,resultCallback(msg)}.bind(this))},SRVC_GET_BROWSER_DESCRIPTION_INTERNAL:function(msg,resultCallback){this._logger.trace("Frame: SRVC_GET_BROWSER_DESCRIPTION_INTERNAL msg=",msg);var browserContentHelper=new BrowserContentHelper(this),micclass=Util.getMicClass(browserContentHelper),objIdentificationProps=this.getObjIdentificationProps(micclass);Description.createTestObjectDescription(browserContentHelper,objIdentificationProps,function(specialDescription){this._logger.trace("Description.createTestObjectDescription return specialDescription=",specialDescription),msg._data.objDescription=specialDescription,resultCallback(msg)}.bind(this))},SRVC_FIX_FRAME_DESCRIPTION:function(msg,resultCallback){var description=msg._data.description,pageMsg=new Msg(msg._msgType,this._getParentPageID(),{frameRtid:this.getID(),description:description});content.dispatcher.sendMessage(pageMsg,null,"chrome",function(resMsg){msg._data.description=resMsg._data.description,resultCallback(msg)}.bind(this))},getObjsFromClientPoint:function(msg){var aos=this._getAOFromClientPoint(msg._data.pos);if(0!=aos.length){var ids=aos.map(function(ao){return ao.getID()}),micclass=aos.map(function(ao){return Util.getMicClass(ao)}),containers=this._getContainers(),containerIds=containers.map(function(container){return container.id}),containerMicclass=containers.map(function(container){return container.micclass});msg._data.WEB_PN_ID=containerIds.concat(ids),msg._data.micclass=containerMicclass.concat(micclass)}},_getAOFromClientPoint:function(point){this._logger.debug("_getAOFromClientPoint: called with point=",point);var e=document.elementFromPoint(point.x,point.y);if(e||(e=this._elementFromPointForSelectElement(point)),!e)return this._logger.error("Element from point failed for point: ",point),[];if(e&&"IMG"===e.tagName){var WebAreaElem=this._elementFromPointForWebArea(e,point);Util.isNullOrUndefined(WebAreaElem)||(e=WebAreaElem)}for(var ao=content.kitsManager.createAO(e,this.getID()),aoLists=[];!Util.isNullOrUndefined(ao);)ao.isObjSpyable()&&aoLists.push(ao),ao=ao.getParent();return aoLists.reverse(),aoLists},_elementFromPointForWebArea:function(imgElem,point){var mapName=imgElem.useMap;if(Util.isNullOrUndefined(mapName))return null;0==mapName.indexOf("#")&&(mapName=mapName.substring(1));var elemMap=document.getElementById(mapName);if(Util.isNullOrUndefined(elemMap)){var nodelist=document.getElementsByName(mapName);nodelist&&nodelist.length>0&&(elemMap=nodelist[0])}if(Util.isNullOrUndefined(elemMap))return null;var rectImg=ContentUtils.getElementClientRect(imgElem,this._logger);if(!rectImg)return null;var p={x:point.x,y:point.y};p.y-=rectImg.top,p.x-=rectImg.left;var i=0,elemCount=elemMap.children.length;for(i=0;i<elemCount;++i){var elemArea=elemMap.children[i];if("AREA"===elemArea.tagName&&!Util.isNullOrUndefined(elemArea.coords)){var coords=elemArea.coords.split(",");switch(Util.isNullOrUndefined(elemArea.shape)?"":elemArea.shape.toLowerCase()){case"rect":case"rectangle":if(4!=coords.length)continue;var rect={left:Math.floor(coords[0]),top:Math.floor(coords[1]),right:Math.floor(coords[2]),bottom:Math.floor(coords[3])};if(Util.isPointInRect(p,rect,this._logger))return elemArea;break;case"circ":case"circle":if(3!=coords.length)continue;var circle={x:Math.floor(coords[0]),y:Math.floor(coords[1]),radius:Math.floor(coords[2])};if(Util.isPointInCircle(p,circle,this._logger))return elemArea;break;case"poly":case"polygon":if(Util.isPointInPoly(p,coords,this._logger))return elemArea}}}return null},_getContainers:function(){var containers=[{id:this.getID(),micclass:Util.getMicClass(this)}];if(!this._isPage){var page={id:this._parentPageId,micclass:"Page"};containers.push(page)}if(!this._ignoreBrowserDescription){var browserId={browser:this.getID().browser,page:-1,frame:-1,object:null},browser={id:browserId,micclass:"Browser"};containers.push(browser)}return containers.reverse(),containers},_elementFromPointForSelectElement:function(point){this._logger.warn("_elementFromPointForSelectElement: Started");var selectItems=Util.makeArray(document.getElementsByTagName("select")),resultArr=[];switch(selectItems.forEach(function(selectElement){var rect=ContentUtils.getElementClientRect(selectElement,this._logger);rect&&Util.isPointInRect(point,rect,this._logger)&&resultArr.push(selectElement)},this),resultArr.length){case 0:return this._logger.error("_elementFromPointForSelectElement: Found 0 Select elements that contain the point: ",point),null;case 1:return this._logger.trace("_elementFromPointForSelectElement: Found a good candidate select element - returning it"),resultArr[0];default:return this._logger.error("_elementFromPointForSelectElement: Found more than 1 candidate element - returning null. Number of elements found: "+resultArr.length),null}},_attrs:{title:function(){return"string"==typeof window.document.title?window.document.title:""},url:function(){return window.document.location.href.replace(/\/$/,"")},state:function(){return ReadyState2Status[document.readyState]},micclass:function(){return this._isPage?["Page"]:["Frame"]},name:function(){return window.name},text:function(){return document.body.textContent},outerhtml:function(){return this._getFrameSource().html},outer_html:function(){return this._attrs.outerhtml.call(this)},innertext:function(){return ContentUtils.getVisibleTextContent(document.body)},outertext:function(){var outerText=document.body.outerText;return outerText?Util.cleanTextProperty(outerText):this.GetAttrSync("innertext")},"load time":function(){return Math.round(BrowserServices.getLoadTime(this._logger))},"logical name":function(){return this._isPage?this._attrs.title.call(this):this._attrs.name.call(this)},innerheight:function(){return window.innerHeight},height:function(){return this._attrs.innerheight.call(this)},innerwidth:function(){return window.innerWidth},width:function(){return this._attrs.innerwidth.call(this)},outerheight:function(){return window.outerHeight},outerwidth:function(){return window.outerWidth},"url without form data":function(){var url=this._attrs.url.call(this),pos=url.indexOf("?");return-1!==pos?url.substring(0,pos):url},html_info:function(){var ret=this._getFrameSource();return{MMF_HANDLE:SpecialObject.CreateMMFile(ret.html),FRAME_BASE_URL:ret.baseUrl}},"all text items":function(){return Util.getTextNodesValue(document.body).join(";")},window_rect:function(){return{top:window.screenY,left:window.screenX,right:window.screenX+window.outerWidth||window.innerWidth,bottom:window.screenY+window.outerHeight||window.innerHeight}},"text selection obj":function(){var selection=window.getSelection();if(selection.type&&"range"!==selection.type.toLowerCase())return"";if(0===selection.rangeCount)return"";var range=selection.getRangeAt(0);return 0===range.toString().length?"":content.kitsManager.createVirtualTextAO(range,this.getID()).getID()},"user-input in post data":function(){return""},"non user-input in post data":function(){return""},"user input in get data":function(){return""},"non user-input in get data":function(){return""},"all data in get method":function(){return""},"document size":function(){return null},ssvtype:function(){return null},"frame recursive index":function(){return null}},_attrsAsync:{"html tag":function(msg,resCallback){this.getAttrFromParent("html tag",msg,resCallback)},"html id":function(msg,resCallback){this.getAttrFromParent("html id",msg,resCallback)},visible:function(msg,resCallback){Util.assert(!this._isPage,"_attrsAsync['visible']: unsupported for Page objects",this._logger),this.getAttrFromParent("visible",msg,resCallback)},style:function(msg,resCallback){this.getElementAttribute("style",msg,resCallback)},attribute:function(msg,resCallback){this.getElementAttribute("attribute",msg,resCallback)},rect:function(msg,resCallback){this._calcRelativeRect(msg,!0,resCallback)},x:function(msg,resCallback){this._attrsAsync.abs_x.call(this,msg,resCallback)},abs_x:function(msg,resCallback){this._calcRelativeRect(msg,!0,function(res){resCallback(res.left)})},y:function(msg,resCallback){this._attrsAsync.abs_y.call(this,msg,resCallback)},abs_y:function(msg,resCallback){this._calcRelativeRect(msg,!0,function(res){resCallback(res.top)})},view_x:function(msg,resCallback){this._calcRelativeRect(msg,!1,function(res){resCallback(res.left)})},view_y:function(msg,resCallback){this._calcRelativeRect(msg,!1,function(res){resCallback(res.top)})},elementinterface:function(msg,resCallback){DotObjUtil.WrapDocument(window.document,this.getID(),resCallback)},"text obj from point":function(msg,resCallback){var point=msg._data["text obj from point"],useScreenCoords=!BrowserServices.coordinatesAreRelativeToPage;this._calcRelativeRect(msg,useScreenCoords,function(frameAbsRect){var virtualTxt=this._createVirtualTextAOFromPoint(point.x-frameAbsRect.left,point.y-frameAbsRect.top);virtualTxt?resCallback(virtualTxt.getID()):(this._logger.warn("text obj from point: can not create virtualTxt"),resCallback())}.bind(this))},"all attributes":function(msg,resCallback){Util.assert(!this._isPage,"_attrsAsync['all attributes']: unsupported for Page objects",this._logger),this.getAttrFromParent("all attributes",msg,resCallback)},"all styles":function(msg,resCallback){Util.assert(!this._isPage,"_attrsAsync['all styles']: unsupported for Page objects",this._logger),this.getAttrFromParent("all styles",msg,resCallback)}},QueryAttributesSync:function(attrsObj){this._logger.trace("QueryAttributesSync: called for attributes: ",attrsObj);var attrsObjRes={};return Object.keys(attrsObj).forEach(function(attr){attrsObjRes[attr]=this.GetAttrSync(attr)},this),attrsObjRes},_getTabRect:function(){this._logger.trace("_getTabRect: called"),Util.assert(this._isPage,"_getTabRect: unsupported for frame objects",this._logger);var pageDimensions=this.QueryAttributesSync({innerHeight:null,outerHeight:null,innerWidth:null,outerWidth:null,window_rect:null});return Util.calculateTabRect(pageDimensions,this._logger)},_getPartialPixelsVal:function(property,wrappedVal){this._logger.trace("_getPartialPixelsVal: called");var rectProp,axis;switch(property){case"abs_x":axis="x",rectProp="left";break;case"abs_y":axis="y",rectProp="top";break;default:this._logger.error("_getPartialPixelsVal: unsupported axis value: "+axis)}var val=0,frameRuntimeId=null;AttrPartialValueUtil.IsPartialValue(wrappedVal)&&(val=AttrPartialValueUtil.GetValue(wrappedVal,this._logger),frameRuntimeId=AttrPartialValueUtil.GetAttachedData(wrappedVal,this._logger));var axisPixels=0;if(RtIdUtils.IsRuntimeId(frameRuntimeId)){var frameElem=ContentUtils.findFrameElemByID(frameRuntimeId,document,this._logger);axisPixels=content.kitsManager.createAO(frameElem,this.getID()).GetAttrSync(axis)}var newVal=val+axisPixels;return this._isPage?newVal+this._getTabRect()[rectProp]:AttrPartialValueUtil.WrapValue(property,newVal,this.getID())},_getPartialAttrValFromParent:function(property,wrappedVal){if(this._logger.trace("_getPartialAttrValFromParent: called"),null===wrappedVal)return this._logger.trace("_getPartialAttrValFromParent: returning partial attr for property: "+property),AttrPartialValueUtil.WrapValue(property,null,this.getID());Util.assert(AttrPartialValueUtil.IsPartialValue(wrappedVal),"_getPartialAttrValFromParent: received a value which is not a partial value",this._logger);var frameRtid=AttrPartialValueUtil.GetAttachedData(wrappedVal);Util.assert(RtIdUtils.IsRTIDFrame(frameRtid),"_getPartialAttrValFromParent: received a runtime id whihc is not for frame",this._logger);var frameElem=ContentUtils.findFrameElemByID(frameRtid,document,this._logger);return Util.assert(frameElem,"_getPartialAttrValFromParent: couldn't find a frame with rtid: "+JSON.stringify(frameRtid),this._logger),content.kitsManager.createAO(frameElem,this.getID()).GetAttrSync(property)},_getPartialElementAttributeVal:function(property,wrappedVal){this._logger.trace("_getPartialElementAttributeVal: called");var agentObject=null;if(AttrPartialValueUtil.IsPartialValue(wrappedVal)){var frameRtid=AttrPartialValueUtil.GetAttachedData(wrappedVal),frameElem=ContentUtils.findFrameElemByID(frameRtid,document,this._logger);agentObject=content.kitsManager.createAO(frameElem,this.getID())}else{if(!this._isPage)return AttrPartialValueUtil.WrapValue(property,null,this.getID());agentObject=content.kitsManager.createPageAO(this.getID())}var propInfo=Description.getAttributeInfo(property),queryMsg=new Msg("QUERY_ATTR",agentObject.getID(),{});return queryMsg._data[propInfo.name]=propInfo.data,agentObject.GetAttrSync(propInfo.name,queryMsg)},_getAttrPartialValue:function(property,wrappedVal){switch(Description.getAttributeInfo(property).name){case"abs_x":case"abs_y":return this._getPartialPixelsVal(property,wrappedVal);case"html tag":case"html id":return this._getPartialAttrValFromParent(property,wrappedVal);case"attribute":case"style":return this._getPartialElementAttributeVal(property,wrappedVal);default:this._logger.error("_getAttrPartialValue: unhandled attribute: "+property)}return currentVal},GetAttrSync:function(property){this._logger.trace("GetAttrSync: query property "+property);var propInfo=Description.getAttributeInfo(property),func=this._attrs[propInfo.name];return func?func.call(this):this._attrsAsync[propInfo.name]?this._getAttrPartialValue(property,null):(this._logger.error("GetAttrSync: attribute "+propInfo.name+" is unsupported"),null)},GetAttr:function(property,msg,resCallback){this._logger.trace("GetAttr: query property "+property);var propInfo=Description.getAttributeInfo(property);propInfo.data&&(msg=msg||new Msg(MSG_TYPES.QUERY,this.getID(),{}),msg._data[propInfo.name]=propInfo.data);var syncAttrFunc=this._attrs[propInfo.name];if(syncAttrFunc)return void resCallback(syncAttrFunc.call(this));var asyncAttrFunc=this._attrsAsync[propInfo.name];if(asyncAttrFunc)return void asyncAttrFunc.call(this,msg,resCallback);this._logger.error("GetAttr: Unsupported attribute:"+propInfo.name),resCallback(null)},_getParentPageID:function(){return Util.shallowObjectClone(this._parentPageId)},_calcRelativeRect:function(msg,screen_coord,resultCallback){this._logger.trace("_calcRelativeRect started");var reqData={rect:{top:0,left:0,bottom:0,right:0},pageId:this._getParentPageID(),screen_coord:screen_coord,AN_METHOD_NAME:"calculate relative rect"},reqMsg=new Msg(MSG_TYPES.SRVC_INVOKE_METHOD,msg._to,reqData),msgToFrame=this.buildNestedMessage(reqMsg);content.dispatcher.sendMessage(msgToFrame,null,null,function(resMsg){var rect=resMsg._data.frameElemMsg._data.rect;resultCallback(rect)})},_runOnDoc:function(script,resultCallback){this._logger.trace("_runOnDoc: started");var requestMsg=new Msg("EXECUTE_IN_PAGE",this.getID(),{script:script}),callbackId=++Frame.prototype._nextCallbackID;this._runOnDocCallbackMap[callbackId]=resultCallback,requestMsg.callbackId=callbackId;var ev=ContentUtils.createCrossOriginCustomEvent("_QTP_Run_Script",{detail:requestMsg});window.dispatchEvent(ev)},_runOnDocResult:function(resEvent){this._logger.trace("_runOnDocResult: started");var resMsg=resEvent.detail;if(this._logger.trace("_runOnDocResult received response: ",resMsg),"EXECUTE_IN_PAGE"!==resMsg._msgType)return!0;var callback=this._runOnDocCallbackMap[resMsg.callbackId];delete this._runOnDocCallbackMap[resMsg.callbackId],callback?(this._logger.trace("_runOnDocResult: Callback found - returning result"),callback(resMsg._data)):this._logger.error("_runOnDocResult: No Callback found.")},_runFuncOnDoc:function(f){var res=this._runOnDoc("("+f.toString()+")();");if(Util.isUndefined(res)&&ErrorReporter.ThrowGeneralError(),res.ex)throw res.ex;return res.res},invokeMethods:{GET_ID_FROM_SOURCE_INDEX:function(msg,resultCallback){this._logger.warn("GET_ID_FROM_SOURCE_INDEX is not implemented"),resultCallback(msg)},DOC_EXECUTE_SCRIPT:function(msg,resultCallback){this._logger.trace("DOC_EXECUTE_SCRIPT: Started");var logger=this._logger,rtid=this.getID();this._runOnDoc(msg._data.text,function(resultData){if(logger.debug("DOC_EXECUTE_SCRIPT: Got result for script "+resultData.script),resultData.ex&&(logger.debug("DOC_EXECUTE_SCRIPT: Got Excepion in script:"+resultData.ex),msg._data["JScript Exception"]=resultData.ex.toString()),resultData.result&&(Util.isObject(resultData.result)||Array.isArray(resultData.result))){logger.debug("DOC_EXECUTE_SCRIPT: The result of this script is an object, wrapping it with DotObject proxy object");var proxy=new DotObjJSProxy(resultData.result,rtid);msg._data.value=SpecialObject.CreateDotObj(proxy.getID()),msg._data.activex_interface=!0}else msg._data.value=resultData.result;resultCallback(msg)})},SAVE_FRAME_SOURCE_NOT_RECURSIVE:function(msg,resultCallback){this._logger.trace("SAVE_FRAME_SOURCE_NOT_RECURSIVE: started");var path=msg._data.WEB_N_SSV_PATH,base=msg._data.WEB_N_SSV_FRAME_BASE_NAME,fullPath=path+"\\"+base+".html",frameSource=this._getFrameSource().html;msg._data.result=SpecialObject.CreateFrameSource(fullPath,frameSource),resultCallback(msg)}},SRVC_INVOKE_METHOD:function(msg,resultCallback){this._logger.trace("SRVC_INVOKE_METHOD: started");var name=msg._data.AN_METHOD_NAME,func=this.invokeMethods[name];func||ErrorReporter.ThrowNotImplemented("Frame.invokeMethod: "+name),func.call(this,msg,resultCallback)},getID:function(){return{browser:this.id.browser,page:this.id.page,frame:this.id.frame,object:null}},CMD_BROWSER_EMBED_SCRIPT:function(msg,resultCallback){this._logger.trace("CMD_BROWSER_EMBED_SCRIPT: Started"),ContentUtils.evalInDocument(msg._data.text),resultCallback(msg)},onRegistrationResult:function(registrationData){this._logger.trace("onRegistrationResult: Started with ",registrationData);var scriptArray=registrationData.scriptsToEmbed;if(this._parentPageId=Util.shallowObjectClone(registrationData._parentPageId),this.id=Util.shallowObjectClone(registrationData._frameId),Util.assert(scriptArray,"onRegistrationResult: Frame registration process failed.",this._logger),scriptArray.length){var script=scriptArray.join("\n");this._logger.debug("registerFrameResult: Going to embed the following script:"+script),ContentUtils.evalInDocument(script)}BrowserServices.isDialogHandlingSupported&&(this._logger.debug("registerFrameResult: Going to override JavaScript dialog functions"),ContentUtils.evalInDocument("("+ContentUtils.overrideJSDialogs.toString()+")();")),this._loadExtToolkits(registrationData.extToolkits),this._logger.info("onRegistrationResult: Injecting our HTML component"),FrameInHTMLContext._id=this.id,content.domSubscriber.startNamespace(),content.domSubscriber.addUtilityObject("FrameInHTMLContext",FrameInHTMLContext,{_QTP_Run_Script:"RunOnDocEventHandler",UFT_DOT_OBJ_MARK_FOR_RUNSCRIPT_RESULT:"onMarkObjectResult",_QTP_Run_Script_With_Attr:"RunOnDocWithAttrEventHandler"}),content.domSubscriber.endNamespace(),registrationData.globalVariables&&registrationData.globalVariables.objectidentificationproperties&&(this._objIdentificationProps=JSON.parse(registrationData.globalVariables.objectidentificationproperties)),registrationData.ignoreBrowserDescription&&(this._ignoreBrowserDescription=!0),this._recorder&&registrationData.eventConfig&&this._recorder.updateEventConfig(registrationData.eventConfig),this._initInspectionMode(registrationData.inspectionMode)},_loadExtToolkits:function(extToolkits){!extToolkits||extToolkits.length<=0||(Util.isNullOrUndefined(content.webExtKit)?(content.webExtKit=new WebExtKit(extToolkits),content.kitsManager.LoadKit(content.webExtKit)):content.webExtKit.loadToolkits(extToolkits))},MATCH_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("MATCH_DESC_TO_ID started on",this._isPage?" page with ":" frame with ",msg);var logger=this._logger,internalCallback=function(match){logger.debug("MATCH_DESC_TO_ID - in result callback: matched ",match.length),match.length>0&&(match=match.map(function(m){return m.getID()}),msg._data.WEB_PN_ID=msg._data.WEB_PN_ID.concat(match)),resultCallback(msg)};if(msg._data.micclass&&"Frame"===msg._data.micclass)this._isPage?internalCallback([]):Description.filterAOList([this],msg._data,internalCallback);else{var additonalParams={extraAOs:this._isPage?null:[this]};Description.findObjId(msg._data,Description.GetCandidateAOsForContent.bind(Description,this.getID(),null),additonalParams,internalCallback)}},QUERY_REPOSITORY_DESC2ID:function(msg,resultCallback){this._logger.trace("QUERY_REPOSITORY_DESC2ID: Started");var additonalParams={filter:function(ao){return ao&&(ao.isLearnable()||content.settings.shouldlearnwebelement)},learn:!0};this._internalQueryDescToId(msg,additonalParams,resultCallback)},QUERY_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_DESC_TO_ID: Started"),this._internalQueryDescToId(msg,null,resultCallback)},_internalQueryDescToId:function(msg,optionalParamsObj,resultCallback){this._logger.trace("_internalQueryDescToId: Started"),resultCallback||this._logger.error("_internalQueryDescToId: Called without callback! ",msg),Description.GetIDsByDescription(msg._data,Description.GetCandidateAOsForContent.bind(Description,this.getID(),null),optionalParamsObj,function(filteredAOs){resultCallback(Description.buildReturnMsg(msg._msgType,msg._to,filteredAOs,this._logger))}.bind(this))},_getFrameSource:function(){var _html="",children=document.childNodes,len=children.length,_baseUrl="",bases=document.getElementsByTagName("BASE");bases[0]&&(_baseUrl=bases[0].href);for(var i=0;i<len;i++)if(children[i].nodeType===Node.ELEMENT_NODE)_html+=children[i].outerHTML,_html=_html.replace(/<BASE /g,"<"),_html=_html.replace(/<embed type="application\/x-hp-chrome-agent"[^>]+>/,"");else if(children[i].nodeType===Node.COMMENT_NODE)_html+="\x3c!-- --\x3e";else if(children[i].nodeType===Node.DOCUMENT_TYPE_NODE){var doctype=document.doctype;_html+="<!DOCTYPE "+doctype.name+(doctype.publicId?' PUBLIC "'+doctype.publicId+'"':"")+(doctype.systemId?' "'+doctype.systemId+'"':"")+">"}return{html:_html,baseUrl:_baseUrl}},SRVC_TAKE_SCREENSHOT:function(msg,callback){this._logger.trace("SRVC_TAKE_SCREENSHOT: Started");var queryAttrMsg=new Msg("QUERY_ATTR",this.getID(),{view_x:null,view_y:null,width:null,height:null});this.onMessage(queryAttrMsg,function(queryAttrResMsg){var rect={left:queryAttrResMsg._data.view_x,top:queryAttrResMsg._data.view_y,right:queryAttrResMsg._data.view_x+queryAttrResMsg._data.width,bottom:queryAttrResMsg._data.view_y+queryAttrResMsg._data.height},browserId={browser:msg._to.browser,page:-1,frame:-1,object:null},browserMsg=Util.deepObjectClone(msg);browserMsg._to=browserId,browserMsg._data={rect:rect},
content.dispatcher.sendMessage(browserMsg,null,null,function(resMsg){if(msg._data.data=resMsg._data.data,!BrowserServices.cropedScreenshot){var img=document.createElement("img");img.src="data:image/png;base64,"+resMsg._data.data;var canvas=document.createElement("canvas"),width=canvas.width=rect.right-rect.left,height=canvas.height=rect.bottom-rect.top;canvas.getContext("2d").drawImage(img,rect.left,rect.top,width,height,0,0,width,height),msg._data.data=canvas.toDataURL().replace(/^data:image\/png;base64,/,"")}callback(msg)})})},SRVC_MAKE_OBJ_VISIBLE:function(msg,resultCallback){var msgToFrame=this.buildNestedMessage(msg);content.dispatcher.sendMessage(msgToFrame,null,null,function(resMsg){resultCallback(msg)})},SRVC_GET_TEXT:function(msg,resultCallback){this._logger.trace("SRVC_GET_TEXT: started");var allRange=document.createRange();allRange.setStartBefore(document.body),allRange.setEndAfter(document.body.lastChild);var allTxt=Util.cleanSpecialChars(allRange.toString());allTxt=Util.cleanMultipleSpaces(allTxt);var beforeText=msg._data["text before"]||"",afterText=msg._data["text after"]||"",startPos=0;if(""!==beforeText){var beforeIndex=msg._data.indexoftextbefore||0;if(-1===(startPos=Util.stringNthPosition(allTxt,beforeText,beforeIndex)))return msg._data.text="",void resultCallback(msg);startPos+=beforeText.length}var endPos=startPos;if(""!==afterText&&-1===(endPos=allTxt.indexOf(afterText,startPos)))return msg._data.text="",void resultCallback(msg);var text,txtLength=endPos-startPos,MAX_TEXT_SIZE=65e3;txtLength<MAX_TEXT_SIZE?text=allTxt.substr(startPos,txtLength):(text=allTxt.substr(startPos,MAX_TEXT_SIZE-3),text+="..."),msg._data.text=text,resultCallback(msg)},SRVC_GET_SCREEN_RECT:function(msg,resultCallback){this._calcRelativeRect(msg,!0,function(res){msg._data.rect=res,resultCallback(msg)})},SRVC_HIGHLIGHT_OBJECT:function(msg,resultCallback){this._logger.trace("SRVC_HIGHLIGHT_OBJECT: Called");var frameElem=window.frameElement;if(frameElem&&"FRAME"===frameElem.tagName)ContentUtils.highlightElement(frameElem),resultCallback(msg);else{var msgToFrame=this.buildNestedMessage(msg);content.dispatcher.sendMessage(msgToFrame,null,null,function(resMsg){resultCallback(msg)})}},SRVC_HIGHLIGHT_MATCHES:function(msg,resultCallback){this._logger.trace("SRVC_HIGHLIGHT_MATCHES: Called");var data=msg._data||{},aoToHighlight=data.WEB_PN_ID||[];if(aoToHighlight=aoToHighlight.filter(function(rtid){return rtid.frame===this.id.frame&&RtIdUtils.IsRTIDAO(rtid)},this),aoToHighlight.length>0){this._logger.debug("SRVC_HIGHLIGHT_MATCHES: need to highlight objects from this page ",aoToHighlight);var multiResponses=new MultipleResponses(aoToHighlight.length);return void aoToHighlight.forEach(function(ao){var highlightMsg=new Msg("SRVC_HIGHLIGHT_OBJECT",ao,{});content.dispatcher.sendMessage(highlightMsg,ao,null,multiResponses.callback(function(isDone,resultMsg){isDone&&resultCallback(msg)}))})}this._logger.debug("SRVC_HIGHLIGHT_MATCHES: Going to highlight the frame element");var msgToFrame=this.buildNestedMessage(msg);content.dispatcher.sendMessage(msgToFrame,null,null,function(resMsg){resultCallback(msg)})},_calculatePartialProperties:function(propsObj){Object.keys(propsObj).forEach(function(prop){var val=propsObj[prop];AttrPartialValueUtil.IsPartialValue(val)&&(propsObj[prop]=this._getAttrPartialValue(prop,val))},this)},_calculatePartialAttributes:function(msg){this._logger.trace("_calculatePartialAttributes: Called"),msg._data["recorded description"][0].forEach(function(specialDescriptionObj){var description=specialDescriptionObj.description;this._calculatePartialProperties(description.properties),this._calculatePartialProperties(description["smart identification properties"]),this._calculatePartialProperties(description.additionalInfo)},this)},_isAgentObjectInThisContext:function(aoRtid){var aoRtidCopy=Util.shallowObjectClone(aoRtid);return aoRtidCopy.object=null,RtIdUtils.IsRTIDEqual(this.getID(),aoRtidCopy)},EVENT_RECORD:function(msg){this._logger.trace("EVENT_RECORD: Called"),this._handleRecordEvent(msg)},EVENT_INTERNAL_RECORD_QUEUE:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE: Called"),this._handleRecordEvent(msg)},EVENT_INTERNAL_RECORD_DISPATCH_QUEUE:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_DISPATCH_QUEUE: Called"),this._handleRecordEvent(msg)},EVENT_INTERNAL_RECORD_QUEUE_CLEAR:function(msg){this._logger.trace("EVENT_INTERNAL_RECORD_QUEUE_CLEAR: Called"),msg._to=this._isPage?this._getParentPageID():content.dispatcher.getContainingContextID(),content.dispatcher.sendEvent(msg)},EVENT_INTERNAL_SEND_BROWSER_INFO:function(msg){this._logger.trace("EVENT_INTERNAL_SEND_BROWSER_INFO: Called"),this._recorder.sendBrowserRecordInfo()},_handleRecordEvent:function(msg){this._logger.trace("_handleRecordEvent: Called. IsPage? "+this._isPage),msg._to=this._isPage?this._getParentPageID():content.dispatcher.getContainingContextID(),this._calculatePartialAttributes(msg);var micclass,objIdentificationProps,objDesc,recordedDescriptionArr=msg._data["recorded description"][0],recordedMicclassArr=msg._data.micclass[0],runtimeIdsArr=msg._data.WEB_PN_ID[0],agentObjectRtid=runtimeIdsArr[0];if(this._isAgentObjectInThisContext(agentObjectRtid))for(var recordedElem=content.rtidManager.GetElementFromID(agentObjectRtid.object),parentElem=recordedElem.parentElement;!Util.isNullOrUndefined(parentElem);){var parentAO=content.kitsManager.createAO(parentElem,this.id,!0);parentAO&&parentAO.GetAttrSync("is_container")&&(this._logger.trace("_handleRecordEvent: parent container found, adding its record description"),micclass=Util.getMicClass(parentAO),objIdentificationProps=this.getObjIdentificationProps(micclass),objDesc=Description.createRecordDescription(parentAO,objIdentificationProps),recordedDescriptionArr.push(objDesc),recordedMicclassArr.push(micclass),runtimeIdsArr.push(parentAO.getID())),parentElem=parentElem.parentElement}(this._isPage||this._isAgentObjectInThisContext(agentObjectRtid))&&(this._logger.trace("_handleRecordEvent: Interesting Frame/Page for record. Adding it's data. IsPage? "+this._isPage),micclass=Util.getMicClass(this),objIdentificationProps=this.getObjIdentificationProps(micclass),objDesc=Description.createRecordDescription(this,objIdentificationProps),recordedDescriptionArr.push(objDesc),recordedMicclassArr.push(micclass),runtimeIdsArr.push(this.getID())),this._isPage&&!this._ignoreBrowserDescription&&this._addBrowserRecordData(msg),content.dispatcher.sendEvent(msg)},_addBrowserRecordData:function(msg){var browserContentHelper=new BrowserContentHelper(this),micclass=Util.getMicClass(browserContentHelper),objIdentificationProps=this.getObjIdentificationProps(micclass),objDesc=Description.createRecordDescription(browserContentHelper,objIdentificationProps);msg._data["recorded description"][0].push(objDesc),msg._data.micclass[0].push(micclass),msg._data.WEB_PN_ID[0].push(browserContentHelper.getID())},WEBEXT_RECORD_EVENT:function(msg){if(this._recorder.isRecording){this._logger.trace("WEBEXT_RECORD_EVENT: Started");var ao=content.kitsManager.createAO(content.rtidManager.GetElementFromID(msg._data.WEB_PN_ID.object),this.id,!1);Util.isNullOrUndefined(ao)||this._recorder.sendRecordExtEvent(ao,msg._data.methodName,msg._data.parameters)}},getObjIdentificationProps:function(micclass){return micclass=micclass.toLowerCase(),Util.assert(this._objIdentificationProps,"getObjIdentificationProps: Object identification properties object is empty !",this._logger),this._objIdentificationProps[micclass]},sendRequestToHTMLContext:function(msg,callback){this._logger.trace("sendRequestToHTMLContext: Started");var requestMsg={callbackID:++Frame.prototype._nextCallbackID,msgType:"request",source:"Frame",data:msg};this._callbacks[requestMsg.callbackID]=callback,this._logger.trace("sendRequestToHTMLContext: Going to send to HTML the following request: ",requestMsg),window.postMessage(requestMsg,"*")},_recordDialogHandled:function(event){if(this._logger.trace("_recordDialogHandled: Recording handeling of "+event.detail.type),!this._isPage)return void Util.setTimeout(function(){window.top.dispatchEvent(event)},200);var button=event.detail.accepted?"micOK":"micCancel",commandText="HandleDialog "+button+(event.detail.text?",":""),data={text:commandText,AN_ITEM_TEXT:event.detail.text,"recorded description":[[]],micclass:[[]],WEB_PN_ID:[[]]},msg=new Msg("EVENT_RECORD",this._getParentPageID(),data);this._addBrowserRecordData(msg),content.dispatcher.sendEvent(msg)},responseFromHTMLHandler:function(msgEventObj){var responsetMsg=msgEventObj.data;if("object"==typeof responsetMsg&&"response"===responsetMsg.msgType&&("Frame"===responsetMsg.source||"FrameInHTMLContext"===responsetMsg.source)&&!Util.isUndefined(responsetMsg.callbackID)){if(!this._callbacks[responsetMsg.callbackID])return void this._logger.error("responseHandler: No callback for the given response!");try{this._callbacks[responsetMsg.callbackID](Util.deepObjectClone(responsetMsg.data))}catch(ex){this._logger.error("responseHandler: callback has exception ex ="+ex.message)}finally{delete this._callbacks[responsetMsg.callbackID]}}},_createVirtualTextAOFromPoint:function(x,y){var elem=document.elementFromPoint(x,y),range=new Range;return range.setStartBefore(elem),range.setEndAfter(elem),content.kitsManager.createVirtualTextAO(range,this.getID())}},KitsManager.prototype={_allKits:[],_logger:new LoggerUtil("Content.KitsManager"),LoadKit:function(kit){this._logger.trace("LoadKit: loading kit "+kit.name),KitsManager.prototype._allKits.push(kit)},_kits:null,_initKits:function(){this._kits&&this._kits.allCount===this._allKits.length||(this._kits?this._logger.debug("_initKits: Re-loading kits due to count change, was: "+this._kits.allCount+" now: "+this._allKits.length):this._logger.trace("_initKits: Loading kits, count: "+this._allKits.length),this._kits=this._allKits.filter(function(kit){return kit.relevant()}).sort(function(a,b){return b.priority-a.priority}),this._logger.trace("_initKits: Relevant kits count: "+this._kits.length),this._kits.allCount=this._allKits.length)},createAO:function(element,parentID,noDefault,micclass){this._logger.trace("createAO: creating AO for element ",element.tagName),element||(this._logger.error("createAO: null element, AO not created"),ErrorReporter.ThrowInvalidArg()),this._initKits();for(var i=0;i<this._kits.length;i++){var ao=this._kits[i].createAO(element,parentID,noDefault,micclass);if(ao)return ao}return this._logger.debug("createAO: create AO failed for element ",element.tagName),null},createRecordAOArray:function(element,parentID){this._logger.trace("createRecordAOArray: creating AO for element "+element),element||(this._logger.error("createRecordAOArray: null element, AO not created"),ErrorReporter.ThrowInvalidArg()),this._initKits();for(var i=0;i<this._kits.length;++i)if(this._kits[i].createRecordAOArray){var aoArr=this._kits[i].createRecordAOArray(element,parentID);if(aoArr&&aoArr.length>0)return aoArr}return this._logger.error("createRecordAOArray: create AO failed for element "+element),null},createPageAO:function(parentID){return this._logger.trace("createPageAO: Started"),WebKit.createPageAO(parentID)},createVirtualTextAO:function(range,parentID){return this._logger.trace("createVirtualTextAO: Started"),WebKit.createVirtualTextAO(range,parentID)}},ObjectRTIDManager.prototype={_logger:void 0,_nextEntry:-1,_frameCockie:-1,_knownElements:[],onRegistrationResult:function(registrationResData){this._logger.info("onRegistrationResult: Started for frame cookie "+registrationResData.frameCount),this._frameCockie=registrationResData.frameCount},GetIDForElement:function(element){return this._logger.trace(function(){return"GetIDForElement: Started for "+element.tagName}),element.objRTID?(this._logger.debug("GetIDForElement: No need to create new ID element already known"),element.objRTID):(element.objRTID={entry:++this._nextEntry,frameCockie:this._frameCockie},this._knownElements[element.objRTID.entry]=element,element.objRTID)},GetElementFromID:function(id){return id.frameCockie!==this._frameCockie?(this._logger.error("GetElementFromID: Got ID from a different frame generation!",id),null):id.entry<0||id.entry>this._nextEntry?(this._logger.error("GetElementFromID: Got unknown entry ! id = ",id),null):this._knownElements[id.entry]}},AO.prototype={_parentID:null,_elem:null,_id:null,_attrs:null,_methods:null,_behaviors:null,_micclass:null,_logger:null,_outerAO:null,mergeBehavior:function(behavior){var self=this;this._logger.trace(function(){return"mergeBehavior: merging behavior to AO "+self._elem.tagName}),behavior._micclass&&(this._micclass=behavior._micclass.concat(this._micclass)),this._behaviors.push(behavior);var funcs=behavior._helpers;for(var f in funcs)this[f]=funcs[f]},isLearnable:Util.alwaysFalse,_lazyInit:function(subObj,name){if(!(name in this[subObj]))for(var i=this._behaviors.length-1;i>=0;--i){var b=this._behaviors[i];if(b[subObj]&&name in b[subObj]){this[subObj][name]=b[subObj][name];break}}},_isAttrAsync:function(attrName){switch(attrName){case"screen_rect":case"abs_x":case"abs_y":case"view_x":case"view_y":case"elementinterface":return!0;default:return!1}},_getAttrPartialValue:function(property){Util.assert(this._isAttrAsync(property),"_getAttrPartialValue: called for sync attribute: "+property,this._logger);var val=null;switch(property){case"abs_x":val=this.GetAttrSync("rect").left;break;case"abs_y":val=this.GetAttrSync("rect").top;break;default:return this._logger.error("_getAttrPartialValue: unhandled attribute: "+property),null}return AttrPartialValueUtil.WrapValue(property,val)},GetAttr:function(property,msg,resultCallback){this._logger.trace("GetAttr: query property ",property);var attrInfo=Description.getAttributeInfo(property),propertyName=attrInfo.name;if(attrInfo.data&&(msg=msg||new Msg(MSG_TYPES.QUERY,this.getID(),{}),msg._data[propertyName]=attrInfo.data),this._lazyInit("_attrs",propertyName),!this._attrs[propertyName])return this._logger.debug("GetAttr: unknown attribute ",propertyName),void resultCallback(null);this._isAttrAsync(propertyName)?this._attrs[propertyName].call(this,msg,function(result){resultCallback(Util.cleanSpecialChars(result))}):resultCallback(Util.cleanSpecialChars(this._attrs[propertyName].call(this,msg)))},_hasDOMHandler:function(name){return Util.findAncestor(this._elem,function(e){return!Util.isNullOrUndefined(e.getAttribute(name))})},_quirkyButton:function(button){return[1,4,2][button]},ReceiveEvent:function(recorder,ev){if(!this.UseEventConfiguration(ev)||recorder.isEventAllowedByConfig(this,ev)){Util.isExtEventRegistered(ev.target,ev.type)||this._behaviors.slice().reverse().some(function(behavior){return behavior._eventHandler&&behavior._eventHandler.call(this.getRecordAO(),recorder,ev)},this)}},_warnIfNoTouch:function(msg){ContentUtils.isTouchEnabled()||(msg.status="OkButNotHandled",msg._data.value="NotTouchEnabled")},ReceiveGesture:function(recorder,info,elem){this._behaviors.slice().reverse().some(function(behavior){return behavior._gestureHandler&&behavior._gestureHandler.call(this.getRecordAO(),recorder,info,elem)},this)},ReceiveEventStarted:function(recorder){this._behaviors.slice().reverse().some(function(behavior){return behavior._eventTargetStarted&&behavior._eventTargetStarted.call(this.getRecordAO(),recorder)},this)},ReceiveEventEnded:function(recorder){this._behaviors.slice().reverse().some(function(behavior){return behavior._eventTargetEnded&&behavior._eventTargetEnded.call(this.getRecordAO(),recorder)},this)},GetAttrSync:function(property,msg){this._logger.trace("GetAttrSync: query property "+property);var attrInfo=Description.getAttributeInfo(property),propertyName=attrInfo.name;if(attrInfo.data&&(msg=msg||new Msg(MSG_TYPES.QUERY,this.getID(),{}),msg._data[propertyName]=attrInfo.data),this._lazyInit("_attrs",propertyName),this._attrs[propertyName]){if(this._isAttrAsync(propertyName)){var partialVal=this._getAttrPartialValue(propertyName,msg);return partialVal.value=Util.cleanSpecialChars(AttrPartialValueUtil.GetValue(partialVal)),partialVal}return Util.cleanSpecialChars(this._attrs[propertyName].call(this,msg))}return this._logger.debug("GetAttrSync: unknown attribute "+propertyName),null},QueryAttributesSync:function(attrsObj){this._logger.trace("QueryAttributesSync: called for attributes: ",attrsObj);var attrsObjRes={};return Object.keys(attrsObj).forEach(function(attr){attrsObjRes[attr]=this.GetAttrSync("WEB_PN_ID"===attr?"id":attr)},this),attrsObjRes},QUERY_ATTR:function(msg,resultCallback){this._logger.trace("QUERY_ATTR: called for attributes: ",msg._data);var attrs=Object.keys(msg._data);if(attrs.length<1)return this._logger.warn("QUERY_ATTR: Called with no attributes"),void resultCallback(msg);var multiResponses=new MultipleResponses(attrs.length);attrs.forEach(function(prop){this._logger.debug("QUERY_ATTR: call GetAttr for '"+prop+"' property"),this.GetAttr("WEB_PN_ID"===prop?"id":prop,msg,multiResponses.callback(function(isDone,val){msg._data[prop]=val,this._logger.debug("QUERY_ATTR: (GetAttr callback) "+prop+"="+val),isDone&&(this._logger.debug("QUERY_ATTR: Finished querying all the requested attributes"),resultCallback(msg))}.bind(this)))}.bind(this))},InvokeMethod:function(method,msg,resultCallback){if(this._logger.trace("InvokeMethod: invoking method ",method," for msg ",msg),this._lazyInit("_methods",method),!this._methods[method])return this._logger.warn("InvokeMethod: unknown method "+method),void ErrorReporter.ThrowGeneralError();this._methods[method].call(this,msg,resultCallback)},QUERY_DESC_TO_ID:function(msg,resultCallback){this._logger.trace("QUERY_DESC_TO_ID: Started");var additionalParams={filter:function(childAO){return childAO._elem!=this._elem}.bind(this)};this._internalQueryDescToId(msg,additionalParams,resultCallback)},QUERY_REPOSITORY_DESC2ID:function(msg,resultCallback){this._logger.trace("QUERY_REPOSITORY_DESC2ID: Started");var additonalParams={filter:Util.alwaysFalse,learn:!0};this._internalQueryDescToId(msg,additonalParams,resultCallback)},_internalQueryDescToId:function(msg,optionalParamsObj,resultCallback){this._logger.trace("_internalQueryDescToId: Started"),Description.GetIDsByDescription(msg._data,Description.GetCandidateAOsForContent.bind(Description,this._parentID,this._elem),optionalParamsObj,function(filteredAOs){resultCallback(Description.buildReturnMsg(msg._msgType,msg._to,filteredAOs,this._logger))}.bind(this))},getID:function(){if(this._logger.trace("getID: getting runtime id for element ",function(){return this._elem}.bind(this)),!this._id){this._logger.trace("getID: objID not cached, create it from rtidManager");var elem=this._elem;this._radios&&this._radios.length>0&&(elem=this._radios[0]);var obj_id=content.rtidManager.GetIDForElement(elem);this._id=Util.shallowObjectClone(this._parentID),this._id.object=obj_id}return Util.shallowObjectClone(this._id)},SRVC_TAKE_SCREENSHOT:function(msg,callback){this._logger.trace("SRVC_TAKE_SCREENSHOT: Started");var rect=this.GetAttrSync("rect"),browserId={browser:msg._to.browser,page:-1,frame:-1,object:null};msg._to=browserId,msg._data={rect:rect},content.dispatcher.sendMessage(msg,null,null,function(resMsg){if(!BrowserServices.cropedScreenshot){var img=document.createElement("img");img.src="data:image/png;base64,"+resMsg._data.data;var canvas=document.createElement("canvas"),width=canvas.width=rect.right-rect.left,height=canvas.height=rect.bottom-rect.top;canvas.getContext("2d").drawImage(img,rect.left,rect.top,width,height,0,0,width,height),resMsg._data.data=canvas.toDataURL().replace(/^data:image\/png;base64,/,"")}callback(resMsg)})},SRVC_MAKE_OBJ_VISIBLE:function(msg,callback){var browserRtid=RtIdUtils.GetBrowserRtid(msg._to);if(RtIdUtils.IsRTIDBrowser(browserRtid)){var msgToBrowser=new Msg("SRVC_MAKE_OBJ_VISIBLE",browserRtid,{});content.dispatcher.sendMessage(msgToBrowser,browserRtid,"chrome",function(){})}this.InvokeMethod("MAKE_VISIBLE",msg,callback)},SRVC_HIGHLIGHT_OBJECT:function(msg,callback){this.InvokeMethod("HIGHLIGHT_OBJECT",msg,callback)},SRVC_HIGHLIGHT_MATCHES:function(msg,callback){this.InvokeMethod("HIGHLIGHT_MATCHES",msg,callback)},SRVC_CALL_OBJ_EVENT:function(msg,callback){msg.delay=!0;var callEventMsg=Util.deepObjectClone(msg);ContentUtils.protectCallbackAgainstPrematureNavigation(callback,msg,this._logger,"SRVC_CALL_OBJ_EVENT")(msg),this.InvokeMethod("CALL_EVENT",callEventMsg,Util.identity)},SRVC_EDIT_SET:function(msg,callback){this.InvokeMethod("SET_VALUE",msg,callback)},SRVC_GET_FORM:function(msg,callback){this.InvokeMethod("WEB_GETFORMA",msg,callback)},CMD_LIST_SELECT:function(msg,callback){this.InvokeMethod("LIST_SELECT",msg,callback)},CMD_LIST_DESELECT:function(msg,callback){this.InvokeMethod("LIST_DESELECT",msg,callback)},CMD_LIST_EXTEND_SELECT:function(msg,callback){this.InvokeMethod("LIST_EXTEND_SELECT",msg,callback)},SRVC_GET_SCREEN_RECT:function(msg,callback){this.InvokeMethod("GET_SCREEN_RECT",msg,callback)},QUERY_GET_TABLE_DATA:function(msg,callback){this.InvokeMethod("GET_TABLE_DATA",msg,callback)},SRVC_INVOKE_METHOD:function(msg,callback){this.InvokeMethod(msg._data.AN_METHOD_NAME,msg,callback)},QUERY_OBJ_PARENTS_FROM_ID:function(msg,callback){this._logger.trace("onMessage: Started with: ",msg),msg._data={};var ids=[],aoParentIterator=this;do{ids.push(aoParentIterator.getID()),aoParentIterator=aoParentIterator.getParent()}while(aoParentIterator);msg._data.WEB_PN_ID=ids.reverse(),callback(msg)},SRVC_GET_OBJ_DESCRIPTION:function(msg,resultCallback){this._logger.trace("CommonBehavior: SRVC_GET_OBJ_DESCRIPTION msg=",msg);var micclass=Util.getMicClass(this),objIdentificationProps=content.frame.getObjIdentificationProps(micclass);Description.createTestObjectDescription(this,objIdentificationProps,function(specialDescription){this._logger.trace("Description.createTestObjectDescription return specialDescription=",specialDescription),msg._data.objDescription=specialDescription,resultCallback(msg)}.bind(this))},onMessage:function(msg,resultCallback){this._logger.trace("onMessage: Started with: ",msg),this[msg._msgType]||(this._logger.error("onMessage: Unhandled msg: ",msg._msgType),ErrorReporter.ThrowNotImplemented("AO."+msg._msgType)),this[msg._msgType](msg,resultCallback)},_getTagsTree:function(str_array,element,level){str_array.push(level+" "+element.tagName);for(var children=element.children,i=0;i<children.length;i++)this._getTagsTree(str_array,children[i],level+1)},_fireEvent:function(target,event,data,relatedTarget){return ContentUtils.fireEvent(target,event,data,this._logger,relatedTarget)},_isRealLink:function(){var elem=this._elem;if(!elem.href)return!1;if(this._hasDirectTextChild(elem))return!0;if(this._hasBackgroundImage(elem))return!0;for(var all_children=this._elem.getElementsByTagName("*"),i=0;i<all_children.length;i++){if(this._hasDirectTextChild(all_children[i]))return!0;if(this._hasBackgroundImage(all_children[i]))return!0}return!1},_hasDirectTextChild:function(elem){for(var nodes=elem.childNodes,i=0;i<nodes.length;i++)if(3===nodes[i].nodeType){var text=nodes[i].data;if(text=text.trim(),text.length>0)return!0}return!1},_hasBackgroundImage:function(elem){var backgroundImg=getComputedStyle(elem,null).backgroundImage;return backgroundImg.length>0&&"none"!==backgroundImg},_getAttributes:function(elem,msg){var attrs=msg._data.attribute;return Util.map(attrs,function(attr){var value=elem.getAttribute(attr);return value||(value="tagName"==attr?elem.tagName||"":""),value},this)},_getCSSValues:function(elem,msg){var style=getComputedStyle(elem,null),attrs=msg._data.style;return Util.map(attrs,style.getPropertyValue.bind(style))},_getImageParentAnchor:function(){for(var parent=this._elem.parentNode,tagsAllowedInPath=["FONT","B","I","STRONG","DIV","NOBR","EM","DD","CENTER","SPAN"];parent;){if("A"===parent.tagName)return parent;if(-1===tagsAllowedInPath.indexOf(parent.tagName))break;parent=parent.parentNode}return null},_getParentAO:function(elem){for(var parent=elem.parentElement;parent;parent=parent.parentElement){var pao=content.kitsManager.createAO(parent,this._parentID,!0);if(pao)return pao}return null},_pointRelativeToElem:function(pos){return ContentUtils.pointRelativeToElem(this._elem,pos)},_pan:function(start,delta,interval,steps,msg,callback){function helper(step){var scale=step/steps,pos={x:point.x+delta.x*scale,y:point.y+delta.y*scale};sim.move([pos]),step===steps?(sim.removeTouches(),wrappedCallback(msg)):Util.setTimeout(helper,interval,step+1)}this._logger.trace("_pan ",[start,delta,interval,steps]);var point=this._pointRelativeToElem(start),sim=new SimulateGesture;sim.addTouch(this._elem,point);var wrappedCallback=ContentUtils.protectCallbackAgainstPrematureNavigation(callback,msg,this._logger,"Pan");helper(0)},getParent:function(){return this._getParentAO(this._elem)},isObjSpyable:function(){return!0},getControlLearnType:function(){return ControlLearnType.Yes},getChildrenLearnType:function(){return ChildrenLearnType.Yes},UseEventConfiguration:function(event){return!0},setOuterAO:function(ao){this._outerAO=ao},getRecordAO:function(){return this._outerAO||this}};var AreaBehavior={_micclass:["WebArea"],_attrs:{"logical name":function(){if(this._elem.alt)return this._elem.alt;var img=this._getImageElement();return img?img.src:"WebArea"},"image type":function(){return"Client Side ImageMap"},alt:function(){return this._elem.alt},url:function(){return this._elem.href},href:function(){return this.GetAttrSync("url")},src:function(){var img=this._getImageElement();return img?img.src:""},rect:function(){var img=this._getImageElement(),rect={left:0,top:0,right:0,bottom:0};if(!img)return rect;var img_rect=img.getBoundingClientRect(),coords=this._elem.coords.split(/\s*,\s*/);switch(coords=coords.map(function(e){return parseInt(e,10)}),this._elem.shape.toLowerCase()){case"rect":4===coords.length&&(rect.left=coords[0],rect.top=coords[1],rect.right=coords[2],rect.bottom=coords[3]);break;case"circle":if(3===coords.length){var x=coords[0],y=coords[1],radius=coords[2];if(radius<0)break;rect.left=x-radius,rect.top=y-radius,rect.right=x+radius,rect.bottom=y+radius}break;case"poly":case"polygon":if(coords.length>=2){var x1,x2,y1,y2;x1=x2=coords[0],y1=y2=coords[1];for(var i=2;i<coords.length;i+=2)x1=x1<coords[i]?x1:coords[i],x2=x2>coords[i]?x2:coords[i],y1=y1<coords[i+1]?y1:coords[i+1],y2=y2>coords[i+1]?y2:coords[i+1];rect.left=x1,rect.top=y1,rect.right=x2,rect.bottom=y2}}return{left:Math.round(img_rect.left+rect.left),top:Math.round(img_rect.top+rect.top),right:Math.round(img_rect.left+rect.right),bottom:Math.round(img_rect.top+rect.bottom)}},width:function(){var rect=this.GetAttrSync("rect");return rect.right-rect.left},height:function(){var rect=this.GetAttrSync("rect");return rect.bottom-rect.top},"map name":function(){for(var parent=this._elem;parent&&"MAP"!==parent.tagName;)parent=parent.parentNode;if(parent)return parent.name},coords:function(){return this._elem.coords},coordinates:function(){return this.GetAttrSync("coords")},visible:function(){return!0}},_helpers:{_getImageElement:function(){for(var parent=this._elem;parent&&"MAP"!==parent.tagName;)parent=parent.parentNode;if(parent)for(var name=parent.name,i=0;i<document.images.length;i++)if(document.images[i].useMap.substring(1)===name)return document.images[i]},getParent:function(){var img=this._getImageElement();return content.kitsManager.createAO(img,this._parentID)},isLearnable:Util.alwaysTrue},_eventHandler:function(recorder,ev){if(this._logger.trace("WebArea.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),"click"===ev.type)return recorder.sendRecordEvent(this,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY}}),!0}},AudioBehavior={_micclass:["WebAudio"],_attrs:{name:function(){return"WebAudio"}},_helpers:{isLearnable:Util.alwaysTrue}},ButtonBehavior={_micclass:["WebButton","StdObject"],_attrs:{name:function(){if("INPUT"!==this._elem.tagName)return this._elem.textContent||this._elem.name;if(this._elem.value)return this._elem.value;if(!this._elem.hasAttribute("value"))switch(this._elem.type){case"submit":return"Submit Query";case"reset":return"Reset"}return this._elem.name?this._elem.name:void 0},value:function(){return this._elem.value||this._elem.textContent},disabled:function(){return this._elem.disabled?1:0},type:function(){return this._elem.type||""}},_helpers:{isLearnable:Util.alwaysTrue},_eventHandler:function(recorder,ev){return this._logger.trace("Button.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),ContentUtils.isTouchEnabled()?ButtonBehavior._eventHandlerTouchEnabled.call(this,recorder,ev):"click"===ev.type?(recorder.sendRecordEvent(this,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY}}),!0):void 0},_eventHandlerTouchEnabled:function(recorder,ev){return this._logger.trace("Button._eventHandlerTouchEnabled: Received recordable event: "+ev.type),"click"===ev.type},_gestureHandler:function(recorder,gestureInfo){return this._logger.trace("Button._gestureHandler: Received gesture: "+gestureInfo.event),!!this._elem.disabled&&(this._logger.trace("Button._gestureHandler: element is disabled, ignore"),!0)}},CheckBoxBehavior={_micclass:["WebCheckBox","HtmlToggle"],_attrs:{"logical name":function(){var res=this._getLogicalName();if(res)return res;var text=this.GetAttrSync("acc_name");if(text)return text;if(text=this.GetAttrSync("name"))return text;if(text=this.GetAttrSync("innertext"))return text;var nextSibling=this._elem.nextSibling;return nextSibling&&3===nextSibling.nodeType?nextSibling.textContent:""},part_value:function(){return this._elem.checked?"ON":"OFF"},data:function(){return this.GetAttrSync("part_value")},value:function(){return this._elem.value||"ON"},checked:function(){return this._elem.checked?1:0}},_methods:{SET_DATA:function(msg,resultCallback){this._logger.trace("CheckBoxBehavior: on command SET_DATA"),this.GetAttrSync("part_value")!==msg._data.data&&this._fireEvent(this._elem,"click",{}),resultCallback(msg)},SET_VALUE_EX:function(msg,resultCallback){if(1===this.GetAttrSync("disabled")&&ErrorReporter.ThrowObjectDisabled(),this.GetAttrSync("part_value")!==msg._data.value){var visibleMsg=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.SRVC_MAKE_OBJ_VISIBLE(visibleMsg,function(){this._fireEvent(this._elem,"click",{}),resultCallback(msg)}.bind(this))}else resultCallback(msg)}},_eventHandler:function(recorder,ev){return this._logger.trace("CheckBox.eventHandler: Received recordable event: "+ev.type),ContentUtils.isTouchEnabled()?CheckBoxBehavior._eventHandlerTouchEnabled.call(this,recorder,ev):"click"===ev.type?(this._elem===ev.target&&recorder.sendRecordEvent(this,ev,{event:"onclick",part_value:this._elem.checked?"ON":"OFF"}),!0):void 0},_eventHandlerTouchEnabled:function(recorder,ev){switch(this._logger.trace("CheckBox._eventHandlerTouchEnabled: Received recordable event: "+ev.type),ev.type){case"change":return recorder.sendRecordEvent(this,ev,{event:"onclick",part_value:this._elem.checked?"ON":"OFF",force_record:!0}),!0;case"click":return!0}},_gestureHandler:function(recorder,gestureInfo){return this._logger.trace("CheckBox._gestureHandler: Received gesture: "+gestureInfo.event),"tap"===gestureInfo.event},_helpers:{_getLogicalName:function(){},isLearnable:Util.alwaysTrue}},CommonBehavior={_micclass:["WebElement","Any Web Object"],_attrs:{"logical name":function(){return this.GetAttrSync("acc_name")||this.GetAttrSync("name")||this.GetAttrSync("html id")||this.GetAttrSync("innertext")},"html tag":function(){return this._elem.tagName},"tags tree":function(){var arr=[];return this._getTagsTree(arr,this._elem,0),[[arr]]},rect:function(){var client_rect=this._elem.getBoundingClientRect();return{left:Math.floor(client_rect.left),top:Math.floor(client_rect.top),right:Math.floor(client_rect.right),bottom:Math.floor(client_rect.bottom)}},pos:function(){var rect=this.GetAttrSync("rect");return{x:rect.left,y:rect.top}},x:function(){
return this.GetAttrSync("rect").left},y:function(){return this.GetAttrSync("rect").top},width:function(){return this._elem.offsetWidth},height:function(){return this._elem.offsetHeight},view_x:function(msg,resultCallback){var frameReqMsg=new Msg(MSG_TYPES.QUERY,Util.shallowObjectClone(this._parentID),{view_x:null});content.dispatcher.sendMessage(frameReqMsg,null,null,function(resMsg){var frm_x=resMsg._data.view_x;this.GetAttr("x",msg,function(obj_x){msg._to.object=this.getID().object,resultCallback(obj_x+frm_x)}.bind(this))}.bind(this))},view_y:function(msg,resultCallback){var frameReqMsg=new Msg(MSG_TYPES.QUERY,Util.shallowObjectClone(this._parentID),{view_y:null});content.dispatcher.sendMessage(frameReqMsg,null,null,function(resMsg){var frm_y=resMsg._data.view_y;this.GetAttr("y",msg,function(obj_y){msg._to.object=this.getID().object,resultCallback(obj_y+frm_y)}.bind(this))}.bind(this))},parent:function(){for(var ao,elem=this._elem;;){if(!(elem=elem.parentElement))break;if(ao=content.kitsManager.createAO(elem,this._parentID))return ao.getID()}return Util.shallowObjectClone(this._parentID)},abs_x:function(msg,resultCallback){this.GetAttr("screen_rect",msg,function(result){resultCallback(result.left)})},abs_y:function(msg,resultCallback){this.GetAttr("screen_rect",msg,function(result){resultCallback(result.top)})},screen_rect:function(msg,resultCallback){var frameReqMsg=new Msg(MSG_TYPES.QUERY,Util.shallowObjectClone(this._parentID),{rect:null});content.dispatcher.sendMessage(frameReqMsg,null,null,function(resMsg){var frm_rect=resMsg._data.rect,frm_abs_x=frm_rect.left,frm_abs_y=frm_rect.top;(this._outerAO?this._outerAO:this).GetAttr("rect",msg,function(rect){rect.left+=frm_abs_x,rect.top+=frm_abs_y,rect.right+=frm_abs_x,rect.bottom+=frm_abs_y,msg._to.object=this.getID().object,resultCallback(rect)}.bind(this))}.bind(this))},class:function(){return this._elem.className},class_name:function(){return this.GetAttrSync("class")},innertext:function(){return Util.cleanTextProperty(this._elem.textContent)},inner_text:function(){return this.GetAttrSync("innertext")},outertext:function(){return Util.cleanTextProperty(this._elem.outerText||this.GetAttrSync("innertext"))},outer_text:function(){return this.GetAttrSync("outertext")},innerhtml:function(){return this._elem.innerHTML},inner_html:function(){return this.GetAttrSync("innerhtml")},outerhtml:function(){return this._elem.outerHTML},outer_html:function(){return this.GetAttrSync("outerhtml")},"html id":function(){return this._elem.id},title:function(){return this._elem.title},version:function(){return Util.browserApplicationVersion()},visible:function(){var rect=this._elem.getBoundingClientRect();if(0===rect.width&&0===rect.height)return!1;var style=getComputedStyle(this._elem,null);return"none"!==style.display&&"hidden"!==style.visibility},focus:function(){return this._elem.ownerDocument.activeElement===this._elem},focused:function(){return this.GetAttrSync("focus")},attribute:function(msg){return this._getAttributes(this._elem,msg)},"all attributes":function(){var res=[];return Util.makeArray(this._elem.attributes).forEach(function(attr){res.push(attr.name),res.push(attr.value)}),res.join(";;")},"all styles":function(){var style=window.getComputedStyle(this._elem,null),res=[];return Util.makeArray(style).forEach(function(styleName){res.push(styleName),res.push(style.getPropertyValue(styleName))}),res.join(";;")},style:function(msg){return this._getCSSValues(this._elem,msg)},value:function(){return this._elem.value},xpath:function(){return window._QTP.AutoXpathRecorder(this._elem)},_xpath:function(){return window._QTP.AutoXpathRecorder(this._elem)},css:function(){return window._QTP.CSSGenerator(this._elem)},disabled:function(){return this._elem.disabled?1:0},type:function(){return this._elem.type},name:function(){return this._elem.name},text:function(){return content.settings.useinnertextfortextcollection?this._elem.textContent.replace(/\xA0/g," "):ContentUtils.getVisibleTextContent(this._elem)},acc_name:function(){return ContentUtils.getAccNameFromControl(this._elem)},elementinterface:function(msg,resultCallback){return DotObjUtil.WrapElement(this._elem,this.getID(),resultCallback)},is_container:function(){return!1},ancestor:function(){for(var parent=this.getParent();parent;parent=parent.getParent())if(parent.GetAttrSync("is_container"))return parent.getID()},source_index:function(){var allElems=Util.makeArray(document.getElementsByTagName("*")),ret=allElems.indexOf(this._elem);if(ret>=0)return ret},"all text items":function(){return Util.getTextNodesValue(this._elem).join(";")},role:function(){return this._elem.getAttribute("role")||""}},_methods:{WEB_GETFORMA:function(msg,resultCallback){if(this._logger.trace("CommonBehavior: on commnad WEB_GETFORMA"),msg._data=msg._data||{},msg._data.WEB_PN_ID=msg._to,this._elem.form){var form_ao=content.kitsManager.createAO(this._elem.form,this._parentID);msg._data.WEB_PN_ID.object=form_ao.getID().object}else msg._data.WEB_PN_ID=null;resultCallback(msg)},MAKE_VISIBLE:function(msg,resultCallback){this._logger.trace("CommonBehavior: on command MAKE_VISIBLE");for(var elem=this._elem,data=msg._data,container=elem,elem_rect=this.GetAttrSync("rect"),scroll_to_center=data.WEB_PN_SCROLL_TO_CENTER,pt=data.pos?{x:data.pos.x,y:data.pos.y}:{x:0,y:0};;){if(!(container=container.parentNode))break;if("DIV"===container.tagName){var con_rect=content.kitsManager.createAO(container,this._parentID).GetAttrSync("rect");if(!Util.isRectEmpty(con_rect)){(scroll_to_center||!Util.isVisible(elem_rect,con_rect))&&(scroll_to_center?(container.scrollLeft+=elem_rect.left-Util.getCenterPoint(con_rect).x+pt.x,container.scrollTop+=elem_rect.top-Util.getCenterPoint(con_rect).y+pt.y):(container.scrollLeft+=elem_rect.left-con_rect.left+pt.x,container.scrollTop+=elem_rect.top-con_rect.top+pt.y),elem_rect=this.GetAttrSync("rect"))}}}var frame_rect={left:0,top:0,right:window.innerWidth,bottom:window.innerHeight};!scroll_to_center&&Util.isVisible(elem_rect,frame_rect)||(scroll_to_center?window.scrollTo(elem_rect.left-Util.getCenterPoint(frame_rect).x+pt.x+window.scrollX,elem_rect.top-Util.getCenterPoint(frame_rect).y+pt.y+window.scrollY):window.scrollTo(elem_rect.left+pt.x+window.scrollX,elem_rect.top+pt.y+window.scrollY));var req_data={pos:{x:data.pos?pt.x+elem_rect.left:elem_rect.left,y:data.pos?pt.y+elem_rect.top:elem_rect.top},WEB_PN_SCROLL_TO_CENTER:data.WEB_PN_SCROLL_TO_CENTER},reqMsg=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),req_data);content.dispatcher.sendMessage(reqMsg,null,null,function(){this._logger.trace("CommonBehavior: MAKE_VISIBLE: on callback from parent's SRVC_MAKE_OBJ_VISIBLE. Get 'screen_rect' attribute"),this.GetAttr("screen_rect",msg,function(rect){this._logger.trace("CommonBehavior: MAKE_VISIBLE: on callback from 'screen_rect' attribute. Value: ",rect),msg._data.rect=rect,msg._data.pos={x:rect.left+pt.x,y:rect.top+pt.y},msg._data.hwnd=-1,resultCallback(msg)}.bind(this))}.bind(this))},GET_SCREEN_RECT:function(msg,resultCallback){this._logger.trace("CommonBehavior: on commnad GET_SCREEN_RECT"),this.GetAttr("screen_rect",msg,function(result){msg._data.rect=result,resultCallback(msg)})},CONTAINS_TEXT:function(msg,resultCallback){this._logger.trace("CommonBehavior: on commnad CONTAINS_TEXT");var str=msg._data,regex=new RegExp(str);!!regex.test(this.GetAttrSync("text"))||this.GetAttrSync("text").indexOf(str),resultCallback(msg)},CALL_EVENT:function(msg,resultCallback){this._logger.trace("CommonBehavior: on commnad CALL_EVENT");var event=msg._data.event;event=event.toLowerCase().replace(/^on/,""),this._fireEvent(this._elem,event,msg._data),resultCallback(msg)},WEB_CLICK_EX:function(msg,resultCallback){1===this.GetAttrSync("disabled")&&ErrorReporter.ThrowObjectDisabled(),msg.delay=!0;var clickMsg=Util.deepObjectClone(msg);ContentUtils.protectCallbackAgainstPrematureNavigation(resultCallback,msg,this._logger,"WEB_CLICK_EX")(msg);var msgMakeVisible=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.SRVC_MAKE_OBJ_VISIBLE(msgMakeVisible,function(){this._fireEvent(this._elem,"click",clickMsg._data)}.bind(this))},HIGHLIGHT_OBJECT:function(msg,resultCallback){this._logger.trace("CommonBehavior: on command HIGHLIGHT_OBJECT"),ContentUtils.highlightElement(this._elem,resultCallback,msg)},HIGHLIGHT_MATCHES:function(msg,resultCallback){this._logger.trace("CommonBehavior: on command HIGHLIGHT_OBJECT");var elems=msg._data.WEB_PN_ID.map(function(id){return content.rtidManager.GetElementFromID(id.object)});ContentUtils.highlightElements(elems,resultCallback,msg)},TOUCH_SWIPE:function(msg,callback){function computeDelta(direction,distance){switch(direction){case 0:return{x:-distance,y:0};case 1:return{x:distance,y:0};case 2:return{x:0,y:-distance};case 3:return{x:0,y:distance}}throw Error("Unexpeced direction: "+direction)}this._logger.trace("CommonBehavior: Swipe(",msg._data,")");var delta=computeDelta(msg._data.direction,msg._data.distance),interval=50,steps=Math.max(Math.floor(msg._data.duration/interval),1);this._warnIfNoTouch(msg),this._pan(msg._data.pos,delta,interval,steps,msg,callback)},TOUCH_LONG_TAP:function(msg,callback){this._logger.trace("CommonBehavior: LongTap(",msg._data,")");var point=this._pointRelativeToElem(msg._data.pos),duration=msg._data.duration,element=this._elem;this._warnIfNoTouch(msg);var wrappedCallback=ContentUtils.protectCallbackAgainstPrematureNavigation(callback,msg,this._logger,"LongTap"),sim=new SimulateGesture;sim.addTouch(element,point),Util.setTimeout(function(){sim.removeTouches(),wrappedCallback(msg)},duration)},TOUCH_PINCH:function(msg,callback){function moveTouch(step){var ratio=(1-scale)*step/totalSteps,positions=[{x:first.x+deltaX*ratio,y:first.y+deltaY*ratio},{x:second.x-deltaX*ratio,y:second.y-deltaY*ratio}];pinch.move(positions),step===totalSteps?Util.setTimeout(function(){pinch.removeTouches(),wrappedCallback(msg)},interval):Util.setTimeout(moveTouch,interval,step+1)}this._logger.trace("CommonBehavior: Pinch(",msg._data,")");var scale=msg._data.scale,duration=msg._data.duration,point=this._pointRelativeToElem(msg._data.pos),element=this._elem,interval=50,totalSteps=Math.max(Math.floor(duration/interval)-2,1);this._warnIfNoTouch(msg);var wrappedCallback=ContentUtils.protectCallbackAgainstPrematureNavigation(callback,msg,this._logger,"Pinch"),rect=element.getBoundingClientRect(),defaultDelta=35,deltaX=Math.min(defaultDelta,Math.abs(point.x-rect.left),Math.abs(rect.right-point.x)),deltaY=Math.min(defaultDelta,Math.abs(point.y-rect.top),Math.abs(rect.bottom-point.y)),first={x:point.x-deltaX,y:point.y-deltaY},second={x:point.x+deltaY,y:point.y+deltaY},pinch=new SimulateGesture;pinch.addTouch(element,first),Util.setTimeout(function(){pinch.addTouch(element,second),Util.setTimeout(moveTouch,interval,0)},interval)},WEB_DOUBLE_CLICK:function(msg,callback){this._logger.trace("CommonBehavior: DoubleClick(",msg._data,")");var duration=msg._data.duration,wrappedCallback=ContentUtils.protectCallbackAgainstPrematureNavigation(callback,msg,this._logger,"DblClick");this._fireEvent(this._elem,"click",msg._data),Util.setTimeout(function(self){self._fireEvent(self._elem,"click",msg._data),self._fireEvent(self._elem,"dblclick",msg._data),wrappedCallback(msg)},duration,this)},WEB_HOVER_TAP:function(msg,callback){ContentUtils.isTouchEnabled()?(this._logger.trace("CommonBehavior: Tapping for HoverTap(",msg._data,")"),this._fireEvent(this._elem,"click",msg._data)):(this._logger.trace("CommonBehavior: Hovering for HoverTap(",msg._data,")"),["mouseover","mouseenter","mousemove"].forEach(function(event){this._fireEvent(this._elem,event,msg._data)},this)),callback(msg)},TOUCH_PAN:function(msg,callback){this._logger.trace("CommonBehavior: Pan(",msg._data,")");var interval=50,steps=Math.max(Math.floor(msg._data.duration/interval),1);this._warnIfNoTouch(msg),this._pan(msg._data.pos,msg._data.distance,interval,steps,msg,callback)},IS_MOUSE_REPLAY_REQUIRED:function(msg,resultCallback){this._logger.trace("CommonBehavior: on commnad IS_MOUSE_REPLAY_REQUIRED"),resultCallback(msg)}},_eventHandler:function(recorder,ev){if(this._logger.trace("Common.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),ContentUtils.isTouchEnabled())return!1;var data=null;switch(ev.type){case"click":data={event:"onclick"};break;case"dblclick":data={event:"ondblclick"};break;case"mouseup":data={event:"onmouseup","event button":this._quirkyButton(ev.button)};break;case"mousedown":data={event:"onmousedown","event button":this._quirkyButton(ev.button)};break;case"mouseover":data={event:"onmouseover"};break;case"mouseout":data={event:"onmouseout"};break;case"contextmenu":data={event:"oncontextmenu"};break;case"dragstart":return recorder.queueRecordEvent(this,ev,{event:"ondragstart","event point":{x:ev.clientX,y:ev.clientY}}),!0;case"dragend":return recorder.discardQueuedRecordEvents(),!0;case"drop":return recorder.sendRecordEventWithQueue(this,ev,{event:"ondrop","event point":{x:ev.clientX,y:ev.clientY}}),!0}return data?(recorder.sendRecordEvent(this,ev,Util.extend(data,{"event point":{x:ev.clientX,y:ev.clientY}})),!0):void 0},_gestureHandler:function(recorder,gestureInfo){return this._logger.trace("Common._gestureHandler: Received gesture: "+gestureInfo.event),"tap"===gestureInfo.event?(recorder.sendRecordEvent(this,null,{event:"onclick","event point":{x:gestureInfo.clientX,y:gestureInfo.clientY}}),!0):(recorder.sendRecordEvent(this,null,gestureInfo),!0)}},ContentEditableBehavior={_micclass:["WebEdit"],_attrs:{value:function(){return this._elem.innerHTML?this._elem.innerHTML.replace("\n","\r\n"):""},name:function(){return this._elem.getAttribute("name")||""},kind:function(){return"other"},readonly:function(){return 0},disabled:function(){return 0},type:function(){return""},"max length":function(){return-1},data:function(){return this._elem.innerHTML?this._elem.innerHTML.replace("\n","\r\n"):""}},_methods:{SET_VALUE:function(msg,resultCallback){this._logger.trace("ContentEditableBehavior: on command SET_VALUE"),Util.isNullOrUndefined(msg._data.value)&&ErrorReporter.ThrowInvalidArg(),this._elem.innerHTML=msg._data.value,this._fireEvent(this._elem,"input",{}),resultCallback(msg)},SET_DATA:function(msg,resultCallback){this._logger.trace("ContentEditableBehavior: on command SET_DATA"),msg._data.value=msg._data.data,this.InvokeMethod("SET_VALUE",msg,resultCallback)}},_helpers:{isLearnable:Util.alwaysTrue},_eventHandler:function(recorder,ev){switch(this._logger.trace("ContentEditable.eventHandler: Received recordable event: "+ev.type),ev.type){case"click":return!0;case"focus":return this._elem._beforeChangeTxtValue=this._elem.textContent||"",!0;case"blur":return this._elem.textContent!==this._elem._beforeChangeTxtValue&&recorder.sendRecordEvent(this,ev,{event:"onchange",value:this._elem.textContent,type:this._elem.type,force_record:!0}),!0}}},EditBehavior={_micclass:["WebEdit","StdObject"],_attrs:{name:function(){return this._elem.name||Util.getMicClass(this)},"logical name":function(){var text=this.GetAttrSync("acc_name");return text||((text=this._elem.name)?text:(text=this.GetAttrSync("placeholder"))||"")},value:function(){return this._elem.value?this._elem.value.replace("\n","\r\n"):""},"default value":function(){return this._elem.defaultValue},cols:function(){return this._elem.size||this._elem.cols},"width in characters":function(){return this.GetAttrSync("cols")},rows:function(){return this._elem.rows||0},kind:function(){return"INPUT"===this._elem.tagName?"singleline":"TEXTAREA"===this._elem.tagName?"multiline":void 0},type:function(){var inputTypes=["text","password","submit","radio","checkbox","button","color","date","datetime","datetime-local","email","month","number","range","search","tel","time","url","week"],type=this._elem.getAttribute("type");return null!=type&&-1!=inputTypes.indexOf(type)||(type=this._elem.type),type},disabled:function(){return this._elem.disabled?1:0},readonly:function(){return this._elem.readOnly?1:0},"max length":function(){var maxLength=this._elem.maxLength;return"INPUT"===this._elem.tagName?-1==maxLength||2147483647==maxLength?524288:maxLength:"TEXTAREA"===this._elem.tagName&&(524288==maxLength||2147483647==maxLength)?-1:maxLength},data:function(){return this.GetAttrSync("value")},innertext:function(){return"TEXTAREA"===this._elem.tagName?Util.cleanTextProperty(this.GetAttrSync("value")):""},placeholder:function(){return this._elem.placeholder||""},pattern:function(){return this._elem.pattern||""},required:function(){return this._elem.required||!1}},_methods:{SET_VALUE:function(msg,resultCallback){this._logger.trace("EditBehavior: on command SET_VALUE"),Util.isNullOrUndefined(msg._data.value)&&ErrorReporter.ThrowInvalidArg();var value=msg._data.value,performCommit=msg._data.perform_commit;if(Util.assert("string"==typeof value),"string"==typeof value){var newText=msg._data.value;this._elem.value=newText.substring(0,newText.length-1);var lastKey=msg._data.value.charAt(msg._data.value.length-1);this._fireEvent(this._elem,"keydown",{key:lastKey}),this._fireEvent(this._elem,"keypress",{key:lastKey}),this._fireEvent(this._elem,"input",{key:lastKey}),this._elem.value=msg._data.value,this._fireEvent(this._elem,"keyup",{key:lastKey})}else this._elem.value=value,this._fireEvent(this._elem,"input",{});performCommit&&(this._fireEvent(this._elem,"change"),this._fireEvent(this._elem,"blur")),resultCallback(msg)},SET_VALUE_EX:function(msg,resultCallback){var isDisabled=this.GetAttrSync("disabled"),isReadonly=this.GetAttrSync("readonly");(isDisabled||isReadonly)&&ErrorReporter.ThrowObjectDisabled();var maxLength=this.GetAttrSync("max length");Util.isNullOrUndefined(maxLength)&&(maxLength=-1);var text=msg._data.value||"";-1!=maxLength&&text.length>maxLength&&ErrorReporter.ThrowInvalidArg();var msgMakeVisible=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.InvokeMethod("MAKE_VISIBLE",msgMakeVisible,function(){this._fireEvent(this._elem,"focus"),this.InvokeMethod("SET_VALUE",msg,resultCallback)}.bind(this))},SET_DATA:function(msg,resultCallback){this._logger.trace("EditBehavior: on command SET_DATA"),msg._data.value=msg._data.data,this.InvokeMethod("SET_VALUE",msg,resultCallback)}},_eventHandler:function(recorder,ev){if(this._logger.trace("Edit._eventHandler: Received recordable event: "+ev.type),ContentUtils.isTouchEnabled())return EditBehavior._eventHandlerTouchEnabled.call(this,recorder,ev);switch(ev.type){case"click":return!0;case"change":return recorder.sendRecordEvent(this,ev,{event:"onchange",value:this._elem.value,type:this._elem.type,force_record:!0}),!0}},_eventHandlerTouchEnabled:function(recorder,ev){switch(this._logger.trace("Edit._eventHandlerTouchEnabled: Received recordable event: "+ev.type),ev.type){case"click":return!0;case"focus":return!!this._elem._recordInfo||(this._elem._recordInfo={initialValue:this._elem.value,latestValue:this._elem.value},!0);case"keyup":case"input":case"textInput":return!!this._elem._recordInfo&&(this._elem._recordInfo.latestValue=this._elem.value,!0);case"blur":var recordInfo=this._elem._recordInfo;return delete this._elem._recordInfo,this._sendSetRecordEvent(recorder,ev,recordInfo);case"change":return this._sendSetRecordEvent(recorder,ev,this._elem._recordInfo)}},_gestureHandler:function(recorder,gestureInfo){return this._logger.trace("Edit._gestureHandler: Received gesture: "+gestureInfo.event),"tap"===gestureInfo.event},_eventTargetStarted:function(recorder){return!!ContentUtils.isTouchEnabled()&&(!!this._elem._recordInfo||(this._elem._recordInfo={initialValue:this._elem.value,latestValue:this._elem.value},!0))},_eventTargetEnded:function(recorder){if(!ContentUtils.isTouchEnabled())return!1;var recordInfo=this._elem._recordInfo;return!!recordInfo&&(delete this._elem._recordInfo,recordInfo.latestValue!==recordInfo.initialValue&&(recorder.sendRecordEvent(this,null,{event:"onchange",value:recordInfo.latestValue,type:this._elem.type,force_record:!0}),!0))},_helpers:{isLearnable:Util.alwaysTrue,_sendSetRecordEvent:function(recorder,ev,recordInfo){return!!recordInfo&&(recordInfo.latestValue=this._elem.value,recordInfo.latestValue!==recordInfo.initialValue&&(recorder.sendRecordEvent(this,ev,{event:"onchange",value:recordInfo.latestValue,type:this._elem.type,force_record:!0}),recordInfo.initialValue=recordInfo.latestValue,!0))}}},FileInputBehavior={_micclass:["WebFile","WebEdit","WebButton","StdObject"],_attrs:{name:function(){return this._elem.name||"WebFile"},readonly:function(){return this._elem.readOnly?1:0},"width in characters":function(){return this._elem.size},value:function(){return this._getFilesText()},required:function(){return this._elem.required||!1}},_helpers:{isLearnable:Util.alwaysTrue,_getFilesText:function(){for(var files=[],i=0;i<this._elem.files.length;++i)files.push(this._elem.files[i]);return files.map(function(file){return file.name}).join(", ")}},_eventHandler:function(recorder,ev){switch(this._logger.trace("WebFile.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),ev.type){case"click":return!0;case"focus":return recorder.sendRecordEvent(this,ev,{event:"onfocus"}),this._elem._beforeChangeFilesValue=this._getFilesText(),!0;case"change":return!0;case"blur":var filesText=this._getFilesText();return filesText!==this._elem._beforeChangeFilesValue&&recorder.sendRecordEvent(this,ev,{event:"onchange",value:filesText,type:this._elem.type,force_record:!0}),!0;default:return!1}}},FormBehavior={_eventHandler:function(recorder,ev){switch(this._logger.trace("FormBehavior.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),ev.type){case"keydown":return 13===ev.which&&(this._elem._submitTargetElem=ev.target),!0;case"click":if(this._elem._submitTargetElem){var ao=content.kitsManager.createAO(ev.target,this._parentID);recorder.sendRecordEvent(ao,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY}}),recorder.stopCurrentPropagation()}case"keyup":return this._elem._submitTargetElem=null,!0;case"submit":if(!this._elem._submitTargetElem)return!0;var ao=content.kitsManager.createAO(this._elem._submitTargetElem,this._parentID);return recorder.sendRecordEvent(ao,ev,{force_record:!0,event:"onsubmit"}),recorder.stopCurrentPropagation(),!0}},_gestureHandler:function(recorder,gestureInfo){return this._logger.trace("FormBehavior._gestureHandler: Received gesture: "+gestureInfo.event),"tap"===gestureInfo.event&&(this._elem._submitTargetElem=null,!0)}},ImageBehavior={_micclass:["Image"],_attrs:{"logical name":function(){switch(this._elem.tagName){case"IMG":return this._getNiceName(this._elem.alt)||this._getNiceName(this._elem.src);case"INPUT":return this._getNiceName(this._elem.alt)||this._getNiceName(this._elem.name)||this._getNiceName(this._elem.src);case"AREA":return this._getNiceName(this._elem.alt)||this._getNiceName(this._elem.href)}},name:function(){return this._getNiceName(this._elem.name)||"Image"},alt:function(){return this._elem.alt||""},src:function(){return this._elem.src||""},"file name":function(){var src=this.GetAttrSync("src");return 0===src.indexOf("data:")?"":src.replace(/.*\//,"")},"image type":function(){return this._getImageTypeName()}},_helpers:{_getNiceName:function(name){if(!name)return name;var nice_name=name;return nice_name=nice_name.replace(/.*\\/,""),nice_name=nice_name.replace(/.*\//,""),nice_name=nice_name.replace(/\.[^.]*$/,"")},_getImageTypeName:function(){if("INPUT"===this._elem.tagName)return"Image Button";var isMap=this._elem.isMap,useMap=this._elem.useMap||"";return isMap&&useMap.length>0?"Client & Server Side ImageMap":isMap?"Server Side ImageMap":useMap.length>0?"Client Side ImageMap":"Plain Image"},isLearnable:Util.alwaysTrue},_eventHandler:function(recorder,ev){if(this._logger.trace("Image.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),ContentUtils.isTouchEnabled())return!1;switch(ev.type){case"click":return recorder.sendRecordEvent(this,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY},"image type":this.GetAttrSync("image type")}),!0;default:return!1}}},ImageLinkBehavior={_micclass:["Image","Hyperlink"],_attrs:{href:function(){var parentAnchor;return(parentAnchor=this._getImageParentAnchor())?parentAnchor.href:""},url:function(){return this.GetAttrSync("href")},target:function(){var parentAnchor;return(parentAnchor=this._getImageParentAnchor())?parentAnchor.target:""},"image type":function(){var type=this._getImageTypeName();return"Server Side ImageMap"!==type&&(type="Image Link"),type},attribute:function(msg){var attrVal=this._getAttributes(this._elem,msg);if(attrVal)return attrVal;var parentAnchorElem=this._getImageParentAnchor();return parentAnchorElem?this._getAttributes(parentAnchorElem,msg)||"":""}},override:{getParent:function(){var anchor=this._getImageParentAnchor();return this._getParentAO(anchor)}}},LinkBehavior={_micclass:["Link","Hyperlink","Text"],_attrs:{href:function(){return this._elem.href||""},url:function(){return this.GetAttrSync("href")},target:function(){return this._elem.target||""},color:function(){return getComputedStyle(this._elem,null).color},"background color":function(){return getComputedStyle(this._elem,null).backgroundColor},font:function(){var fontFamily=getComputedStyle(this._elem,null).fontFamily;return fontFamily="''"===fontFamily?"":fontFamily},innertext:function(){return Util.cleanTextProperty(this._elem.textContent)},data:function(){return this.GetAttrSync("text")},name:function(){return Util.cleanTextProperty(this._elem.textContent||"")},text:function(){return this.GetAttrSync("name")}},_eventHandler:function(recorder,ev){if(this._logger.trace("Link.eventHandler: Received recordable event on "+this._elem.tagName+": "+ev.type),"click"===ev.type)return!!ContentUtils.isTouchEnabled()||(recorder.sendRecordEvent(this,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY}}),!0)},_helpers:{isLearnable:Util.alwaysTrue}},ListBehavior={_micclass:["WebList","StdObject"],_attrs:{name:function(){return this._elem.name||"select"},"select type":function(){return this._elem.multiple?"Extended Selection":this._elem.size>1?"Single Selection":"ComboBox Select"},"multiple value":function(){return this.GetAttrSync("selection")},selection:function(){return this._getOptionTextWithPred(this._selectedPred)},value:function(){return this.GetAttrSync("selection")},"default value":function(){return this._getOptionTextWithPred(function(option){return option.defaultSelected})},"all items":function(){return Util.makeArray(this._elem.options).map(function(e){return e.text}).join(";")},"items count":function(){return this._elem.options.length},"selected item index":function(){if(this._elem.multiple){for(var indexes=[],i=0;i<this._elem.options.length;i++)this._elem.options[i].selected&&indexes.push(i);return indexes.join(";")}var val=this._elem.selectedIndex;return null!=val&&-1!==val?val.toString():""},"selected items count":function(){if(this._elem.multiple)return Util.makeArray(this._elem.options).filter(this._selectedPred).length;var selectedIndex=this._elem.selectedIndex;return null!=selectedIndex&&-1!==selectedIndex?1:0},"visible items":function(){var threshold,elem=this._elem;if(elem.size>0){threshold=elem.size;var javaFXPattern=/JavaFX\/([\d.]*)/i,matchResult=javaFXPattern.exec(navigator.userAgent);if(matchResult){parseFloat(matchResult[1])<=8&&elem.size<4&&(threshold=elem.multiple||1!=elem.size?4:1)}}else threshold=elem.multiple?4:1;return Math.min(elem.length,threshold)},multiple:function(){return this._elem.multiple},hwnd:function(){},data:function(){return this.GetAttrSync("value")},innertext:function(){var all_items=this.GetAttrSync("all items");return all_items=all_items.replace(/;/g," "),all_items=" "+all_items,all_items=all_items.replace(/\xA0/g," "),all_items=all_items.replace(/\r|\n/g,"")}},_methods:{ITEM_TO_NUM:function(msg,resultCallback){this._logger.trace("ListBehavior: on command ITEM_TO_NUM");for(var item=msg._data.AN_ITEM_TEXT,i=0;i<this._elem.options.length;++i)if(this._elem.options[i].value===item)return msg._data.item_index=i,void resultCallback(msg);ErrorReporter.ThrowItemNotFound()},NUM_TO_ITEM:function(msg,resultCallback){this._logger.trace("ListBehavior: on command NUM_TO_ITEM");var index=msg._data.item_index;(index<0||index>=this._elem.options.length)&&ErrorReporter.ThrowItemNotFound(),msg._data.AN_ITEM_TEXT=this._elem.options[index].text,resultCallback(msg)},LIST_SELECT:function(msg,resultCallback){this._logger.trace("ListBehavior: on command LIST_SELECT");var rtn=this._getOptionItemToSelect(msg._data.value);this._elem.selectedIndex=rtn.index,resultCallback(msg)},LIST_EXTEND_SELECT:function(msg,resultCallback){this._logger.trace("ListBehavior: on command LIST_EXTEND_SELECT"),this._getOptionItemToSelect(msg._data.value).option.selected=!0,resultCallback(msg)},LIST_DESELECT:function(msg,resultCallback){this._logger.trace("ListBehavior: on command LIST_DESELECT"),this._getOptionItemToSelect(msg._data.value).option.selected=!1,resultCallback(msg)},LIST_SELECT_EX:function(msg,resultCallback){this._logger.trace("ListBehavior: on command LIST_SELECT_EX"),this._listOperationEx(msg,"LIST_SELECT",resultCallback)},LIST_EXTEND_SELECT_EX:function(msg,resultCallback){this._logger.trace("ListBehavior: on command LIST_EXTEND_SELECT_EX"),this._listOperationEx(msg,"LIST_EXTEND_SELECT",resultCallback)},LIST_DESELECT_EX:function(msg,resultCallback){this._logger.trace("ListBehavior: on command LIST_DESELECT_EX"),this._listOperationEx(msg,"LIST_DESELECT",resultCallback)},SET_DATA:function(data,resultCallback){ErrorReporter.ThrowNotImplemented("AO->ListBehavior._methods.SET_DATA"),this._logger.trace("ListBehavior: on command SET_DATA"),data=data.data;var matches=data.match(/^#(\d+)$/);data.value=matches?parseInt(matches[1],10):data,this.InvokeMethod("LIST_SELECT",data,resultCallback)}},_eventHandler:function(recorder,ev){switch(this._logger.trace("List.eventHandler: Received recordable event: "+ev.type),ev.type){case"click":return!0;case"mousedown":return ev.target===this._elem&&this._updatePreviousSelection(),!1;case"change":var selection=this._elem.multiple?[this._getOptionsWithPred(this._selectedPred)]:this.GetAttrSync("selection");return recorder.sendRecordEvent(this,ev,{event:"onchange",value:selection,previous_selection:[this._elem.previousSelection]}),this._updatePreviousSelection(),!0}},_gestureHandler:function(recorder,gestureInfo){return this._logger.trace("ListBehavior._gestureHandler: Received gesture: "+gestureInfo.event),"tap"===gestureInfo.event},_helpers:{_listOperationEx:function(msg,opMethod,resultCallback){var msgMakeVisible=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.SRVC_MAKE_OBJ_VISIBLE(msgMakeVisible,function(){this._fireEvent(this._elem,"focus"),this.InvokeMethod(opMethod,msg,function(resMsg){this._fireEvent(this._elem,"change"),this._fireEvent(this._elem,"blur"),resultCallback(resMsg)}.bind(this))}.bind(this))},_getOptionItemToSelect:function(item){var rtnVal={};if("number"==typeof item)item>=0&&item<this._elem.options.length&&(rtnVal.index=item,rtnVal.option=this._elem.options[item]);else for(var i=0;i<this._elem.options.length;++i)if(this._elem.options[i].text===item){rtnVal.index=i,rtnVal.option=this._elem.options[i];break}return void 0===rtnVal.index&&ErrorReporter.ThrowItemNotFound(),rtnVal},_getUniqueValue:function(opt,i){return opt&&1===Util.makeArray(this._elem.options).filter(function(curr){return opt===curr.text}).length?opt:"#"+i},_getOptionsWithPred:function(pred){var arr=[];return Util.makeArray(this._elem.options).forEach(function(option,i){pred(option)&&arr.push(this._getUniqueValue(option.text,i))},this),arr},_getOptionTextWithPred:function(pred){return this._getOptionsWithPred(pred).join(";")},_selectedPred:function(e){return e.selected},_updatePreviousSelection:function(){
this._elem.previousSelection=this._getOptionsWithPred(this._selectedPred)},isLearnable:Util.alwaysTrue,UseEventConfiguration:function(event){return"mousedown"!==event.type}}},MediaBaseBehavior={_attrs:{src:function(){return this._elem.src},"current source":function(){return this._elem.currentSrc},sources:function(){return Util.makeArray(this._elem.getElementsByTagName("source")).map(function(e){return e.src}).join(";")},duration:function(){var d=this._elem.duration||0;return Math.round(1e3*d)},"current time":function(){var d=this._elem.currentTime||0;return Math.round(1e3*d)},autoplay:function(){return this._elem.autoplay},loop:function(){return this._elem.loop},controls:function(){return this._elem.controls},muted:function(){return this._elem.muted},playing:function(){return!(this._elem.paused||this._elem.ended)},volume:function(){return this._elem.volume.toFixed(2)},"playback rate":function(){return this._elem.playbackRate.toFixed(2)}},_methods:{MEDIA_PLAY:function(msg,resultCallback){if(this._logger.trace("MediaBaseBehavior.MEDIA_PLAY: Started"),this._elem.play(),navigator.userAgent.match(/iPhone|iPad|iPod/i)){(document.fullScreen||document.mozFullScreen||document.webkitIsFullScreen)&&(document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozCancelFullscreen?document.mozCancelFullscreen():document.exitFullscreen?document.exitFullscreen():this._elem.webkitExitFullScreen())}resultCallback(msg)},MEDIA_PAUSE:function(msg,resultCallback){this._logger.trace("MediaBaseBehavior.MEDIA_PAUSE: Started"),this._elem.pause(),resultCallback(msg)},MEDIA_LOAD:function(msg,resultCallback){this._logger.trace("MediaBaseBehavior.MEDIA_LOAD: Started"),this._elem.load(),resultCallback(msg)}},_helpers:{UseEventConfiguration:function(ev){switch(ev.type){case"play":case"pause":return!1}return!0}},_eventHandler:function(recorder,ev){switch(this._logger.trace("MediaBaseBehavior._eventHandler: Received recordable event: "+ev.type),ev.type){case"click":return!0;case"play":case"pause":return recorder.sendRecordEvent(this,ev,{event:"on"+ev.type}),!0}},_gestureHandler:function(recorder,gestureInfo){switch(this._logger.trace("MediaBaseBehavior._eventHandler: Received gesture event: "+gestureInfo.event),gestureInfo.event){case"tap":case"swipe":return!0}return!1}},NumberBehavior={_micclass:["WebNumber"],_helpers:{isLearnable:Util.alwaysTrue}},PluginBehavior={_attrs:{qtp_slv_cookie:function(){var ret=this._elem.getAttribute("qtp_slv_cookie");return this._logger.trace("Asked for qtp_slv_cookie returning: "+ret),ret||""}},_helpers:{isLearnable:Util.alwaysTrue}},RadioGroupBehavior={_micclass:["WebRadioGroup","HtmlToggle"],_attrs:{checked:function(){return this._radios[this._activeRadioIndex].checked?1:0},value:function(){return this._calculateRadioButtonValue(this._elem)},"all items":function(){return this._radios.map(function(elem){return this._radioButtonInitialValue(elem)||"on"},this).join(";")},"selected item index":function(){return this._activeRadioIndex+1},"items count":function(){return this._radios.length},data:function(){return this.GetAttrSync("value")}},_methods:{SET_ACTIVE_RADIO_BY_VALUE:function(msg,resultCallback){this._logger.trace("RadioGroupBehavior: on command SET_ACTIVE_RADIO_BY_VALUE");var val=msg._data.value;if(!val)return void resultCallback(msg);this._setActiveElemByValue(val),resultCallback(msg)},CALL_EVENT:function(msg,resultCallback){this._logger.trace("RadioGroupBehavior: on command CALL_EVENT"),this.InvokeMethod("SET_ACTIVE_RADIO_BY_VALUE",msg,function(resMsg){var event=resMsg._data.event;event=event.replace(/^on/,""),this._fireEvent(this._elem,event,resMsg._data),resultCallback(resMsg)}.bind(this))},MAKE_VISIBLE:function(msg,resultCallback){this._logger.trace("RadioGroupBehavior: on command MAKE_VISIBLE"),this.InvokeMethod("SET_ACTIVE_RADIO_BY_VALUE",msg,function(){CommonBehavior._methods.MAKE_VISIBLE.call(this,msg,resultCallback)}.bind(this))},SET_ACTIVE_RADIO_BY_ELEMENT:function(){this._logger.trace("RadioGroupBehavior: on command SET_ACTIVE_RADIO_BY_ELEMENT"),ErrorReporter.ThrowNotImplemented("SET_ACTIVE_RADIO_BY_ELEMENT")},SET_DATA:function(msg,resultCallback){this._logger.trace("RadioGroupBehavior: on command SET_DATA"),msg._data.value=msg._data.data,this.InvokeMethod("SET_ACTIVE_RADIO_BY_VALUE",msg,resultCallback)},SET_VALUE_EX:function(msg,resultCallback){this._logger.trace("RadioGroupBehavior: on command SET_VALUE"),this._setActiveElemByValue(msg._data.value);var visibleMsg=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.SRVC_MAKE_OBJ_VISIBLE(visibleMsg,function(){this._fireEvent(this._elem,"click",{}),resultCallback(msg)}.bind(this))}},_eventHandler:function(recorder,ev){if(this._logger.trace("RadioGroup.eventHandler: Received recordable event: "+ev.type),ContentUtils.isTouchEnabled())return RadioGroupBehavior._eventHandlerTouchEnabled.call(this,recorder,ev);switch(ev.type){case"click":return this.refreshRadioGroup(),recorder.sendRecordEvent(this,ev,{event:"onclick",value:this.GetAttrSync("value")}),!0}},_eventHandlerTouchEnabled:function(recorder,ev){switch(this._logger.trace("RadioGroup._eventHandlerTouchEnabled: Received recordable event: "+ev.type),ev.type){case"change":case"click":return!0}},_gestureHandler:function(recorder,gestureInfo){if(this._logger.trace("RadioGroupBehavior._gestureHandler: Received gesture: "+gestureInfo.event),"tap"===gestureInfo.event){var elem=this._triggeringElem;if(elem.disabled)return this._logger.trace("RadioGroupBehavior._gestureHandler: element is disabled, ignore"),!0;var value=this._calculateRadioButtonValue(elem);return recorder.sendRecordEvent(this,null,{event:"onclick",value:value,force_record:!0}),!0}},_helpers:{isLearnable:Util.alwaysTrue,refreshRadioGroup:function(triggeringElem){this._logger.trace("RadioGroupBehavior.refreshRadioGroup: started"),triggeringElem&&(this._triggeringElem=triggeringElem);var radioGroupName=this._elem.name,allRadios=Util.makeArray(document.querySelectorAll("input[type=radio]")),allRadiosInGroup=allRadios.filter(function(elem){return elem.name===radioGroupName});this._radios=allRadiosInGroup,this._activeRadioIndex=Util.arrayFindIndex(this._radios,function(radio){return radio.checked}.bind(this)),-1===this._activeRadioIndex&&(this._activeRadioIndex=0),this._elem=this._radios[this._activeRadioIndex]},_radioButtonInitialValue:function(elem){var labelText="";if(content.settings.uselabelforradiobuttonvalue){var labels=ContentUtils.getLabelsFromControl(elem);if(labels&&labels.length){labelText=labels[0].textContent.trim()}}return labelText||elem.value||""},_calculateRadioButtonValue:function(radioElem){this._logger.trace("RadioGroupBehavior._calculateRadioButtonValue: started");var val=this._radioButtonInitialValue(radioElem),radioElemIndex=-1,not_unique=this._radios.filter(function(elem,i){return elem===radioElem&&(radioElemIndex=i),this._radioButtonInitialValue(elem)===val},this).length>1;return-1===radioElemIndex?(this._logger.error("RadioGroupBehavior._calculateRadioButtonValue: could not find radio element in radio array"),val):""===val||"on"===val||not_unique?"#"+radioElemIndex:val},_setActiveElemByValue:function(val){var elem,activeRadioIndex=-1,matches=val.match(/^#(\d+)$/);if(matches){var index=parseInt(matches[1],10);index>=0&&index<this._radios.length&&(elem=this._radios[index],activeRadioIndex=index)}else{var valUpperCase=val.toUpperCase();this._radios.some(function(radio,index){return this._radioButtonInitialValue(radio).toUpperCase()===valUpperCase&&(elem=radio,activeRadioIndex=index,!0)}.bind(this))}-1==activeRadioIndex&&ErrorReporter.ThrowItemNotFound(),this.GetAttrSync("disabled")&&ErrorReporter.ThrowObjectDisabled(),this._elem=elem,this._activeRadioIndex=activeRadioIndex}}},RangeBaseBehavior={_attrs:{min:function(){return this._elem.min},max:function(){return this._elem.max},step:function(){return this._elem.step}}},RangeBehavior={_micclass:["WebRange"],_attrs:{"require web replay":Util.alwaysTrue},_helpers:{isLearnable:Util.alwaysTrue}},TableBehavior={_micclass:["WebTable"],_attrs:{name:function(){if(this._elem.name)return this._elem.name;for(var children=this._elem.getElementsByTagName("*"),i=0;i<children.length;i++)if(-1===["TH","TR","TD"].indexOf(children[i].tagName)){var ao=content.kitsManager.createAO(children[i],this._parentID);if("WebElement"!==Util.getMicClass(ao)){var name=ao.GetAttrSync("name");if(name&&""!==name.trim())return name}}return"WebTable"},border:function(){return this._elem.border},rows:function(){return this._getRows().length},cols:function(msg){var rowId=0,rows=this._getRows();return null!=msg._data.cols&&"number"==typeof msg._data.cols&&((msg._data.cols<1||msg._data.cols>rows.length)&&ErrorReporter.ThrowOutOfRange(),rowId=msg._data.cols-1),0===rows.length?0:this._getCells(rows[rowId]).length},"column names":function(){function text(e){return content.settings.useinnertextfortextcollection?e.textContent:ContentUtils.getVisibleTextContent(e)}for(var rows=this._getRows(),i=0;i<rows.length;i++){if(""!==text(rows[i]).trim()){var cells=this._getCells(rows[i]);return Util.makeArray(cells).map(text).join(";")}}},"logical name":function(){var caption=this.GetAttrSync("table caption");if(caption)return caption;for(var rows=this._getRows(),i=0;i<rows.length;i++)for(var cells=this._getCells(rows[i]),j=0;j<cells.length;j++){for(var children=cells[j].children,k=0;k<children.length;k++){var rtnVal,ao=content.kitsManager.createAO(children[k],this._parentID);if((rtnVal="TABLE"===children[k].tagName?ao.GetAttrSync("logical name"):ao.GetAttrSync("innertext"))&&""!==rtnVal.trim())return rtnVal}var text=cells[j].textContent;if(""!==text.trim())return text}},"cell id":function(msg){var row=msg._data["cell id"][0][0],col=msg._data["cell id"][0][1],id=msg._to;if(0===row&&0===col)return id;--row,--col;var rows=this._getRows();if(!(row<0||row>=rows.length)){if(-1===col)return id.object=content.kitsManager.createAO(rows[row],this._parentID).getID().object,id;var cells=this._getCells(rows[row]);if(!(col<0||col>=cells.length))return id.object=content.kitsManager.createAO(cells[col],this._parentID).getID().object,id}},"table caption":function(){return this._elem.caption?this._elem.caption.textContent:""}},_methods:{GET_TABLE_DATA:function(msg,resultCallback){this._logger.trace("TableBehavior: on command GET_TABLE_DATA");for(var rows=this._getRows(),maxcol=0,i=0;i<rows.length;i++){for(var cells=this._getCells(rows[i]),rowText=[[]],j=0;j<cells.length;j++){var ao=content.kitsManager.createAO(cells[j],this._parentID);rowText[0].push(ao.GetAttrSync("text"))}cells.length>maxcol&&(maxcol=cells.length),msg._data["WEB_PN_ROW_DATA"+(i+1)]=rowText}msg._data.row=rows.length,msg._data.WEB_AN_MAX_COLUMN=maxcol,resultCallback(msg)},GET_TABLE_COLUMN:function(msg,resultCallback){this._logger.trace("TableBehavior: on command GET_TABLE_COLUMN"),"number"!=typeof msg._data.row&&ErrorReporter.ThrowInvalidArg();var rows=this._getRows();(msg._data.row<1||msg._data.row>rows.length)&&ErrorReporter.ThrowOutOfRange();var cells=this._getCells(rows[msg._data.row-1]);msg._data.col=cells.length,resultCallback(msg)},GET_TABLE_CELL_DATA:function(msg,resultCallback){this._logger.trace("TableBehavior: on command GET_TABLE_CELL_DATA"),"number"==typeof msg._data.row&&"number"==typeof msg._data.col||ErrorReporter.ThrowInvalidArg();var rows=this._getRows();(msg._data.row<1||msg._data.row>rows.length)&&ErrorReporter.ThrowOutOfRange();var cells=this._getCells(rows[msg._data.row-1]);(msg._data.col<1||msg._data.col>cells.length)&&ErrorReporter.ThrowOutOfRange();var ao=content.kitsManager.createAO(cells[msg._data.col-1],this._parentID);msg._data.text=ao.GetAttrSync("text"),resultCallback(msg)},GET_ROW_WITH_CELLTEXT:function(msg,resultCallback){this._logger.trace("TableBehavior: on command GET_ROW_WITH_CELLTEXT");var start_row=msg._data.row,column=msg._data.col,text=msg._data.text;"number"==typeof start_row&&"number"==typeof column||ErrorReporter.ThrowInvalidArg();var rows=this._getRows();start_row>rows.length&&ErrorReporter.ThrowOutOfRange();var cells=this._getCells(rows[start_row>0?start_row-1:0]);if(column>cells.length&&ErrorReporter.ThrowOutOfRange(),msg._data={},msg._attr_names=["row"],msg._data.row=-1,-1===this.GetAttrSync("text").indexOf(text))return void resultCallback(msg);for(var i=start_row>0?start_row-1:0;i<rows.length;i++)if(cells=this._getCells(rows[i]),column>0){if(column-1<cells.length){var row_text=content.kitsManager.createAO(cells[column-1],this._parentID).GetAttrSync("text");if(-1!==row_text.indexOf(text))return msg._data.row=i+1,void resultCallback(msg)}}else for(var j=0;j<cells.length;j++){var cell_text=content.kitsManager.createAO(cells[j],this._parentID).GetAttrSync("text");if(-1!==cell_text.indexOf(text))return msg._data.row=i+1,void resultCallback(msg)}resultCallback(msg)}},_helpers:{isLearnable:Util.alwaysTrue,_getRows:function(){return this._elem.rows},_getCells:function(row){return row.cells}}},VideoBehavior={_micclass:["WebVideo"],_attrs:{name:function(){return"WebVideo"}},_helpers:{isLearnable:Util.alwaysTrue}},TabBehavior={_micclass:["WebTabStrip","StdObject"],_attrs:{name:function(){return this._elem.name||Util.getMicClass(this)},"logical name":function(){return this.GetAttrSync("acc_name")||this.GetAttrSync("name")||this.GetAttrSync("id")},disabled:function(){return this._elem.disabled?1:0},readonly:function(){return this._elem.readOnly?1:0},type:function(){return this._elem.type}},_helpers:{isLearnable:Util.alwaysTrue}},TreeBehavior={_micclass:["WebTree"],_helpers:{isLearnable:Util.alwaysTrue}},VirtualTextBehavior={MIN_CHARS_IN_TEXT:10,_attrs:{micclass:function(){return""},"text before":function(){return this._getTextBeforeData().text},"text after":function(){var selectedRange=this._elem,afterTxtRange=new Range;afterTxtRange.setStart(selectedRange.endContainer,selectedRange.endOffset),afterTxtRange.setEndAfter(document.body.lastChild);var allAfterTxt=Util.cleanSpecialChars(Util.stringTrimLeft(afterTxtRange.toString()));if(allAfterTxt=Util.cleanMultipleSpaces(allAfterTxt),allAfterTxt.length<=VirtualTextBehavior.MIN_CHARS_IN_TEXT)return allAfterTxt;var lastSpaceIndex=allAfterTxt.indexOf(" ",VirtualTextBehavior.MIN_CHARS_IN_TEXT);return-1===lastSpaceIndex?allAfterTxt:allAfterTxt.substr(0,lastSpaceIndex)},newindexoftextafter:function(){return 1},indexoftextbefore:function(){return this._getTextBeforeData().index},"frame name":function(){return""},"is input text":function(){switch(this._elem.commonAncestorContainer.nodeName.toLowerCase()){case"input":case"textarea":return!0}return!1}},_helpers:{isLearnable:Util.alwaysFalse,_getTextBeforeData:function(){if(this._txtBeforeData)return this._txtBeforeData;var selectedRange=this._elem,beforeTxtRange=new Range;beforeTxtRange.setStart(document.body,0),beforeTxtRange.setEnd(selectedRange.startContainer,selectedRange.startOffset);var allBeforeText=Util.cleanSpecialChars(beforeTxtRange.toString().trimRight());if(allBeforeText=Util.cleanMultipleSpaces(allBeforeText),allBeforeText.length<=VirtualTextBehavior.MIN_CHARS_IN_TEXT)return allBeforeText;var lastSpaceIndex=allBeforeText.lastIndexOf(" ",allBeforeText.length-VirtualTextBehavior.MIN_CHARS_IN_TEXT);if(-1===lastSpaceIndex)this._txtBeforeData={text:allBeforeText,index:1};else{var beforeTxt=allBeforeText.substr(lastSpaceIndex+1);this._txtBeforeData={},this._txtBeforeData.text=beforeTxt,this._txtBeforeData.index=Util.stringCount(allBeforeText,beforeTxt)}return this._txtBeforeData}}},WebKit={_logger:new LoggerUtil("Content.WebKit"),name:"WebKit",priority:0,createAO:function(element,parentID,noDefault){this._logger.trace(function(){return"createAO: creating AO for element "+element.tagName}),"OPTION"===element.tagName&&(element=element.parentNode);var ao=new AO(element,parentID);switch(this._logger.trace("createAO: merging common behavior"),ao.mergeBehavior(CommonBehavior),element.tagName){case"A":if(ao._isRealLink())ao.mergeBehavior(LinkBehavior);else if(noDefault)return null;break;case"IMG":ao.mergeBehavior(ImageBehavior),ao._getImageParentAnchor()&&ao.mergeBehavior(ImageLinkBehavior);break;case"BUTTON":ao.mergeBehavior(ButtonBehavior);break;case"INPUT":switch(element.type){case"button":case"submit":case"reset":ao.mergeBehavior(ButtonBehavior);break;case"text":ao.mergeBehavior(EditBehavior);break;case"image":ao.mergeBehavior(ImageBehavior);break;case"checkbox":ao.mergeBehavior(CheckBoxBehavior);break;case"radio":ao.mergeBehavior(RadioGroupBehavior),ao.refreshRadioGroup(ao._elem);break;case"file":ao.mergeBehavior(FileInputBehavior);break;case"hidden":if(noDefault)return null;break;case"range":ao.mergeBehavior(EditBehavior),ao.mergeBehavior(RangeBaseBehavior),ao.mergeBehavior(RangeBehavior);break;case"number":ao.mergeBehavior(EditBehavior),ao.mergeBehavior(RangeBaseBehavior),ao.mergeBehavior(NumberBehavior);break;default:ao.mergeBehavior(EditBehavior)}break;case"TEXTAREA":ao.mergeBehavior(EditBehavior);break;case"SELECT":ao.mergeBehavior(ListBehavior);break;case"AREA":ao.mergeBehavior(AreaBehavior);break;case"TABLE":ao.mergeBehavior(TableBehavior);break;case"IFRAME":case"FRAME":ao.mergeBehavior(FrameBehavior);break;case"VIDEO":ao.mergeBehavior(MediaBaseBehavior),ao.mergeBehavior(VideoBehavior);break;case"AUDIO":ao.mergeBehavior(MediaBaseBehavior),ao.mergeBehavior(AudioBehavior);break;case"FORM":if(noDefault)return null;ao.mergeBehavior(FormBehavior);break;case"OBJECT":if(noDefault)return null;ao.mergeBehavior(PluginBehavior);break;case"SPAN":case"DIV":if(!element.isContentEditable)return noDefault?null:ao;this._logger.debug("createAO: This is a content editable element"),ao.mergeBehavior(ContentEditableBehavior);break;default:if(noDefault)return null}return ao},createPageAO:function(parentID){var ao=this.createAO(document.documentElement,parentID);return ao.mergeBehavior(FrameBehavior),ao.mergeBehavior(PageBehavior),ao},createVirtualTextAO:function(range,parentID){var ao=new AO(range,parentID);return ao.mergeBehavior(VirtualTextBehavior),ao},_getFactory:function(useOnlyWebKit){return useOnlyWebKit?this:content.kitsManager},_uninterestingMicClasses:Util.objectFromArray(["WebElement","WebTable"],!0),_getInterestingAOHierarchy:function(ao,element,parentID,useOnlyWebKit){var res=[];if(element.form){var formAO=this._getFactory(useOnlyWebKit).createAO(element.form,parentID);res.push(formAO)}return res.push(ao),res},_getInterestingAO:function(element,parentID,useOnlyWebKit){for(var curr=element;curr;curr=curr.parentElement){curr=ContentUtils.getTargetElem(curr);var ao=this._getFactory(useOnlyWebKit).createAO(curr,parentID,!0);if(ao){var micClass=Util.getMicClass(ao);if(!this._uninterestingMicClasses[micClass])return ao}}return this.createAO(element,parentID,!1)},createRecordAOArray:function(element,parentID,useOnlyWebKit){var ao=this._getInterestingAO(element,parentID,useOnlyWebKit);return this._getInterestingAOHierarchy(ao,element,parentID,useOnlyWebKit)},relevant:Util.alwaysTrue};KitsManager.prototype.LoadKit(WebKit);var KitUtil={CreateKit:function(name,relevantFunc){var factories=[];return{_logger:new LoggerUtil("Content."+name),name:name,priority:1,registerFactory:function(factory){factories.push(factory)},createAO:function(element,parentId,noDefault,micclass){var ret=null,candidates=factories;if(element.hasAttribute("role")||(candidates=factories.filter(function(factory){return!factory.isRoleBased})),candidates.some(function(factory){return ret=factory.createAO(element,parentId)}),micclass&&ret){var actualMicClass=Util.getMicClass(ret);if(micclass.isRegExp)var matched=Util.valMatchReg(actualMicClass,micclass.regExQuery);else var matched=actualMicClass===micclass;ret=matched?ret:null}return ret},relevant:function(){var shouldLoad=relevantFunc();return this._logger.trace(this.name+" relevant: should load "+shouldLoad),shouldLoad}}},createAO:function(elem,parentId,behaviors){var ao=new AO(elem,parentId);return ao.mergeBehavior(CommonBehavior),behaviors.forEach(function(b){ao.mergeBehavior(b)}),ao}},RoleWebKit=KitUtil.CreateKit("RoleWebKit",ContentUtils.isWebRoleBasedKitEnabled),RoleWebUtil={createAO:function(elem,parentId,behaviors){return KitUtil.createAO(elem,parentId,behaviors)},getRole:function(elem){return elem.getAttribute("role")},getName:function(elem){return elem.getAttribute("name")},getLogicalName:function(elem){return ContentUtils.getAccNameFromControl(elem)||elem.getAttribute("name")||elem.getAttribute("id")||Util.cleanTextProperty(elem.textContent)},getText:function(elem){return Util.cleanTextProperty((elem.textContent||"").trimRight())}};KitsManager.prototype.LoadKit(RoleWebKit);var RoleWebMenu={isRoleBased:!1,_MenuPathManager:function(){this._logger=WebKit._logger,this._menuPathSet=[],this._activeRootMenu=null},_menuPathManager:null,_util:{_lastItem:function(arr){return arr.length?arr[arr.length-1]:void 0},_isDisabled:function(elem){return Util.findAncestor(elem,function(elem){return elem.hasAttribute("aria-disabled")||elem.hasAttribute("disabled")})},intersectDirection:{vert:"vert",horiz:"horiz",both:"both"},_getMenuLayout:function(menu){var menuitems=RoleWebMenu._util.getMenuItems(menu),intersectDirection=RoleWebMenu._util.intersectDirection;if(menuitems.length<=1)return intersectDirection.both;var firstItem=menuitems[0],lastItem=menuitems[menuitems.length-1],rectFirst=firstItem.getBoundingClientRect(),rectLast=lastItem.getBoundingClientRect();return Math.abs(rectFirst.left-rectLast.left)>Math.abs(rectFirst.top-rectLast.top)?intersectDirection.horiz:intersectDirection.vert},_reverseDirection:function(direction){var intersectDirection=RoleWebMenu._util.intersectDirection;return direction===intersectDirection.horiz?intersectDirection.vert:direction===intersectDirection.vert?intersectDirection.horiz:intersectDirection.both},_isMenuItemAdjacentToMenu:function(menuitem,menu2,tolerance){var menu1=RoleWebMenu._util._getSurroundingMenus(menuitem)[0],direction=RoleWebMenu._util._getMenuLayout(menu1);direction=RoleWebMenu._util._reverseDirection(direction);var rect1=menuitem.getBoundingClientRect();rect1=Util.shallowObjectClone(rect1);var rect2=menu2.getBoundingClientRect();return rect2=Util.shallowObjectClone(rect2),RoleWebMenu._util._isRectIntersecInDirection(rect1,rect2,tolerance,direction)},_isRectIntersecInDirection:function(rect1,rect2,tolerance,direction){var intersectDirection=RoleWebMenu._util.intersectDirection;direction!==intersectDirection.both&&direction!==intersectDirection.horiz||(rect1.left-=tolerance,rect1.right+=tolerance,rect1.width=rect1.right-rect1.left),direction!==intersectDirection.both&&direction!==intersectDirection.vert||(rect1.top-=tolerance,rect1.bottom+=tolerance,rect1.height=rect1.bottom-rect1.top);var intersection=Util.intersectRect(rect1,rect2);return!Util.isRectEmpty(intersection)},_findAdjacentMenuNearMenuItem:function(menuItem,menus,tolerance){var curMenu=RoleWebMenu._util._getSurroundingMenus(menuItem)[0];return Util.arrayFind(menus,function(menu){return menu!=curMenu&&RoleWebMenu._util._isMenuItemAdjacentToMenu(menuItem,menu,tolerance)})},_simulateMouseOverOnMenuItem:function(ao,targetMenuItem,data,relatedTarget){ao._fireEvent(targetMenuItem,"mouseover",data,relatedTarget),"undefined"!=typeof PointerEvent&&ao._fireEvent(targetMenuItem,"pointerover",data,relatedTarget),ao._fireEvent(targetMenuItem,"mouseenter",data,relatedTarget),ao._fireEvent(targetMenuItem,"mousemove",data)},_isRoleMenu:function(elem){var role=RoleWebUtil.getRole(elem);return"menu"===role||"menubar"===role},_hasAttrRoleMenuItem:function(elem){var role=RoleWebUtil.getRole(elem);return"menuitem"===role||"menuitemradio"===role||"menuitemcheckbox"===role||"menuitemcheckable"===role},_isRoleMenuItem:function(elem){var type=elem.getAttribute("type");if(RoleWebMenu._util._hasAttrRoleMenuItem(elem))return"separator"!==type;if("LI"!==elem.nodeName)return!1;var parentListElem=Util.findAncestor(elem.parentElement,function(e){return"OL"===e.nodeName||"UL"===e.nodeName});if(!parentListElem)return!1;if(RoleWebMenu._util._isRoleMenu(parentListElem)){return!RoleWebMenu._util._traverseChildrenBreadth(parentListElem,function(elem){return"LI"===elem.nodeName&&RoleWebMenu._util._hasAttrRoleMenuItem(elem)},function(elem){return"LI"!==elem.nodeName})}return!1},_getVisibleMenuSet:function(elem){var menus=Util.makeArray(elem.querySelectorAll("[role=menu],[role=menubar]"));return menus=menus.filter(function(menu){return!!RoleWebMenu._util._isVisible(menu)&&1===RoleWebMenu._util._getSurroundingMenus(menu).length}),menus.filter(RoleWebMenu._util._isVisible)},_minusArray:function(source,toRemove){return source.filter(function(item){return toRemove.indexOf(item)<0})},_isVisible:function(elem){if(!elem.offsetWidth||!elem.offsetHeight)return!1;var boundRect=Util.shallowObjectClone(elem.getBoundingClientRect());boundRect.left+=window.pageXOffset,boundRect.right+=window.pageXOffset,boundRect.top+=window.pageYOffset,boundRect.bottom+=window.pageYOffset;var maxDocWidth=Math.max(document.documentElement.offsetWidth,window.innerWidth),maxDocHeight=Math.max(document.documentElement.offsetHeight,window.innerHeight),windowRect={left:0,top:0,right:maxDocWidth,bottom:maxDocHeight},intersectRect=Util.intersectRect(windowRect,boundRect);if(Util.isRectEmpty(intersectRect))return!1;var style=getComputedStyle(elem,null);return"none"!==style.display&&"hidden"!==style.visibility},_isVisibleIgnoreScroll:function(elem,isLeaf){var style=getComputedStyle(elem,null);return!!(!isLeaf&&"hidden"!==style.overflow||elem.offsetWidth&&elem.offsetHeight)&&("none"!==style.display&&"hidden"!==style.visibility)},_getMenuItemText:function(elem){function getItemTextUtil(node,textArr){Util.makeArray(node.childNodes).forEach(function(node){node.nodeType===Node.TEXT_NODE?textArr.push(node.textContent||""):node.nodeType===Node.ELEMENT_NODE&&(RoleWebMenu._util._isRoleMenu(node)||RoleWebMenu._util._isRoleMenuItem(node)||!RoleWebMenu._util._isVisibleIgnoreScroll(node,!1)||getItemTextUtil(node,textArr))})}var textArr=[];getItemTextUtil(elem,textArr);var text=textArr.join("");return Util.cleanTextProperty(text).trim()},_getDirectParentMenu:function(elem){var ret=null,haveMeetMenuItem=!1;return Util.findAncestor(elem,function(elemInner){return RoleWebMenu._util._isRoleMenuItem(elemInner)?!!haveMeetMenuItem||(haveMeetMenuItem=!0,!1):!!RoleWebMenu._util._isRoleMenu(elemInner)&&(ret=elemInner,!0)}),ret},_getSurroundingMenus:function(elem){var ret=[],directMenu=RoleWebMenu._util._getDirectParentMenu(elem);if(!directMenu)return ret;ret.push(directMenu);var directMenuRect=directMenu.getBoundingClientRect();return Util.findAncestor(directMenu.parentElement,function(elem){if(RoleWebMenu._util._isRoleMenuItem(elem))return!0;if(RoleWebMenu._util._isRoleMenu(elem)){var elemRect=elem.getBoundingClientRect(),rectIntersect=Util.intersectRect(elemRect,directMenuRect);if(!Util.isEqualRects(rectIntersect,directMenuRect))return!0;ret.push(elem)}return!1}),ret.reverse(),ret},_getOwnerMenus:function(elem){var menu,menuItem,ret=[],func=function(elemInner){return RoleWebMenu._util._isRoleMenu(elemInner)?(menu||(menu=elemInner),!0):!!RoleWebMenu._util._isRoleMenuItem(elemInner)&&(!!menuItem||(menuItem=elemInner,!1))};return Util.findAncestor(elem,func),menu&&(elem===menu||menuItem)&&(ret=RoleWebMenu._util._getSurroundingMenus(menu)),ret},_getOwnerMenuItem:function(elem){return elem?Util.findAncestor(elem,function(elem){return RoleWebMenu._util._isRoleMenuItem(elem)}):null},_elemRectSame:function(elem,rect){if(!elem||!rect)return!1;var curRect=elem.getBoundingClientRect();return Util.isEqualRects(curRect,rect,1)},_doReplay:function(msg,resultCallback,ao,textArr){function callRecursiveTrigger(timeout,level,resetElapsed){Util.setTimeout(recursiveTriggerSubMenu,timeout,level),resetElapsed?timeElapsed=timeout:timeElapsed+=timeout}function triggerSubMenu(currentLevel){var currentMenu,targetMenuItem,visibleMenuSetCur,matchNumber=textArr[currentLevel].match(/^\s*#(\d+)\s*$/);if(0===currentLevel)currentMenu=ao._elem;else{if(activeChildMenu){if(currentMenu=activeChildMenu,timeElapsed<timeoutForMenuExpanding){if(!RoleWebMenu._util._isVisible(currentMenu))return timeElapsed>timeoutForMouseOver&&!haveClickIntermediateMenuItem&&(ao._fireEvent(previousMenuItem,"click",msg._data),haveClickIntermediateMenuItem=!0),void callRecursiveTrigger(checkInterval,currentLevel,!1);if(!RoleWebMenu._util._elemRectSame(currentMenu,lastBoundingRectOfMenu))return lastBoundingRectOfMenu=currentMenu.getBoundingClientRect(),void callRecursiveTrigger(checkInterval,currentLevel,!1)}}else{visibleMenuSetCur=RoleWebMenu._util._getVisibleMenuSet(document.body);var diffMenuSet=RoleWebMenu._util._minusArray(visibleMenuSetCur,visibleMenuSetPreviousGlobal);if(0===diffMenuSet.length)if(timeElapsed<timeoutForMenuExpanding){if(timeElapsed>timeoutForMouseOver&&!haveClickIntermediateMenuItem){var menusToDetect=RoleWebMenu._util._minusArray(visibleMenuSetCur,ancestorMenus);currentMenu=RoleWebMenu._util._findAdjacentMenuNearMenuItem(previousMenuItem,menusToDetect,10),currentMenu||ao._fireEvent(previousMenuItem,"click",msg._data),haveClickIntermediateMenuItem=!0}if(!currentMenu)return void callRecursiveTrigger(checkInterval,currentLevel,!1)}else{var menusToDetect=RoleWebMenu._util._minusArray(visibleMenuSetCur,ancestorMenus);currentMenu=RoleWebMenu._util._findAdjacentMenuNearMenuItem(previousMenuItem,menusToDetect,10)}else currentMenu=diffMenuSet[0],ancestorMenus=ancestorMenus.concat(diffMenuSet)}if(currentMenu||ErrorReporter.ThrowItemNotFound(),!lastBoundingRectOfMenu)return activeChildMenu=currentMenu,lastBoundingRectOfMenu=currentMenu.getBoundingClientRect(),void callRecursiveTrigger(checkInterval,currentLevel,!1)}if(targetMenuItem=RoleWebMenu._util.getMenuItemToSelect(currentMenu,matchNumber?matchNumber[1]:textArr[currentLevel],!!matchNumber),targetMenuItem||ErrorReporter.ThrowItemNotFound(),targetMenuItem.scrollIntoView&&targetMenuItem.scrollIntoView(),ancestorMenus.indexOf(currentMenu)<0&&ancestorMenus.push(currentMenu),currentLevel!==textArr.length-1)activeChildMenu=RoleWebMenu._util._traverseChildrenBreadth(targetMenuItem,function(elem){return RoleWebMenu._util._isVisible(elem)&&RoleWebMenu._util._isRoleMenu(elem)}),activeChildMenu||(visibleMenuSetPreviousGlobal=visibleMenuSetCur||RoleWebMenu._util._getVisibleMenuSet(document.body)),RoleWebMenu._util._simulateMouseOverOnMenuItem(ao,targetMenuItem,msg._data,previousMenuItem),lastBoundingRectOfMenu=void 0,haveClickIntermediateMenuItem=!1,timeoutForMenuExpanding=targetMenuItem&&targetMenuItem.hasAttribute("aria-haspopup")?2e3:1e3,callRecursiveTrigger(checkInterval,currentLevel+1,!0);else{RoleWebMenu._util._simulateMouseOverOnMenuItem(ao,targetMenuItem,msg._data);var rect=targetMenuItem.getBoundingClientRect(),elemTopMost=document.elementFromPoint((rect.left+rect.right)/2,(rect.top+rect.bottom)/2);ao._fireEvent(elemTopMost,"click",msg._data),resultCallback(msg)}previousMenuItem=targetMenuItem}function recursiveTriggerSubMenu(currentLevel){try{triggerSubMenu(currentLevel)}catch(e){var logger=new LoggerUtil("RoleWebMenu");logger.warn("recursiveTriggerSubMenu: Got Exception:"+e+" Details: "+(e.Details||"")+" - CallStack: "+e.stack),msg.status=e.message||"ERROR",resultCallback(msg)}}var visibleMenuSetPreviousGlobal,previousMenuItem,activeChildMenu,haveClickIntermediateMenuItem,lastBoundingRectOfMenu,timeoutForMenuExpanding=1e3,timeoutForMouseOver=600,checkInterval=200,timeElapsed=0,ancestorMenus=[];recursiveTriggerSubMenu(0)},getMenuItems:function(elem){function getMenuItemUtil(elem,result){if(elem.children){Util.makeArray(elem.children).forEach(function(elem){if(RoleWebMenu._util._isVisibleIgnoreScroll(elem,!1))if(RoleWebMenu._util._isRoleMenuItem(elem))RoleWebMenu._util._isVisibleIgnoreScroll(elem,!0)&&result.push(elem);else{var surroundingMenusInner=RoleWebMenu._util._getSurroundingMenus(elem);surroundingMenusInner.length&&surroundingMenus.length&&surroundingMenusInner[0]==surroundingMenus[0]&&getMenuItemUtil(elem,result)}})}}
var surroundingMenus=RoleWebMenu._util._getSurroundingMenus(elem),arr=[];return getMenuItemUtil(elem,arr),arr},indexOfMenuItems:function(menu,menuitem){return RoleWebMenu._util.getMenuItems(menu).indexOf(menuitem)},getMenuItemToSelect:function(elem,text,isNumber){var items=RoleWebMenu._util.getMenuItems(elem);return isNumber?items[text]:(text=text.trim(),Util.arrayFind(items,function(item){return RoleWebMenu._util._getMenuItemText(item)===text}))},_traverseChildrenBreadth:function(elem,predFound,predTraverseChildren){var unVisited=[];for(unVisited=unVisited.concat(Util.makeArray(elem.children));unVisited.length;){var elemIterate=unVisited.splice(0,1)[0];if(predFound(elemIterate))return elemIterate;predTraverseChildren&&!predTraverseChildren(elemIterate)||(unVisited=unVisited.concat(Util.makeArray(elemIterate.children)))}return null}},createAO:function(elem,parentId){if(1===content.settings.WebActivityState){var ownerMenus=RoleWebMenu._util._getOwnerMenus(elem);if(ownerMenus.length){var newAo=RoleWebUtil.createAO(ownerMenus[0],parentId,[this._behavior]);return newAo}}else if(RoleWebMenu._util._isRoleMenu(elem)){var newAo=RoleWebUtil.createAO(elem,parentId,[this._behavior]);return newAo}return null},_behavior:{_micclass:["WebMenu","StdObject"],name:"RoleWebMenuBehavior",_helpers:{UseEventConfiguration:function(event){return"mouseover"!==event.type&&"mousedown"!==event.type&&"mouseup"!==event.type}},_attrs:{name:function(){return RoleWebUtil.getName(this._elem)},"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},"top level items":function(){return RoleWebMenu._util.getMenuItems(this._elem).map(function(elem){return RoleWebMenu._util._getMenuItemText(elem)}).join(";")},"top level items count":function(){return RoleWebMenu._util.getMenuItems(this._elem).length},"first item":function(){var items=RoleWebMenu._util.getMenuItems(this._elem);return items.length>0?RoleWebMenu._util._getMenuItemText(items[0]):null}},_methods:{LIST_SELECT:function(msg,resultCallback){this._logger.trace("RoleWebMenuBehavior: on command LIST_SELECT");var str=msg._data.value,arr=str.split&&str.split(";");arr||ErrorReporter.ThrowInvalidArg();var wrappedCallback=ContentUtils.protectCallbackAgainstPrematureNavigation(resultCallback,msg,this._logger,"click");RoleWebMenu._util._doReplay(msg,wrappedCallback,this,arr)}},_eventHandler:function(recorder,ev){if(ContentUtils.isTouchEnabled())return!0;switch(this._logger.trace("RoleWebMenu._eventHandler: Received recordable event: ",ev.type),ev.type){case"mousedown":var selectedMenuItem=RoleWebMenu._util._getOwnerMenuItem(ev.target);if(selectedMenuItem&&!RoleWebMenu._util._isDisabled(selectedMenuItem)){this._elem=RoleWebMenu._menuPathManager.getActiveRootMenu();var pathText=RoleWebMenu._menuPathManager.getRecordPathText(selectedMenuItem);recorder.sendRecordEvent(this,ev,{event:"onchange",value:pathText})}return!0;case"click":case"mouseup":return!0;case"mouseover":var selectedMenuItem=RoleWebMenu._util._getOwnerMenuItem(ev.target);return!(selectedMenuItem&&!RoleWebMenu._util._isDisabled(selectedMenuItem))||(RoleWebMenu._menuPathManager.validate(),RoleWebMenu._menuPathManager.enterMenuItem(selectedMenuItem),!0)}return!0},_gestureHandler:function(recorder,gestureInfo,targetElement){if(this._logger.trace("RoleWebMenuBehavior._gestureHandler: Received gesture: ",gestureInfo.event),"tap"===gestureInfo.event||"longTap"===gestureInfo.event){var selectedMenuItem=RoleWebMenu._util._getOwnerMenuItem(targetElement);if(selectedMenuItem&&!RoleWebMenu._util._isDisabled(selectedMenuItem)){RoleWebMenu._menuPathManager.validate(),RoleWebMenu._menuPathManager.enterMenuItem(selectedMenuItem),this._elem=RoleWebMenu._menuPathManager.getActiveRootMenu();var pathText=RoleWebMenu._menuPathManager.getRecordPathText(selectedMenuItem);recorder.sendRecordEvent(this,null,{event:"onchange",value:pathText,force_record:!0})}}return!0}}};RoleWebMenu._MenuPathManager.prototype={_logger:null,_menuPathSet:null,_activeRootMenu:null,validate:function(){if(this._menuPathSet.forEach(function(menuPath){menuPath.forEach(function(pathItem){pathItem.menu.compareDocumentPosition(pathItem.selectedMenuItem)&Node.DOCUMENT_POSITION_CONTAINED_BY||(pathItem.selectedMenuItem=RoleWebMenu._util.getMenuItems(pathItem.menu)[pathItem.selectedMenuItemIndex])});var menuArr=menuPath.map(function(item){return item.menu}),nRemoveIndex=Util.arrayFindIndex(menuArr,function(item){return!RoleWebMenu._util._isVisible(item)});nRemoveIndex>=0&&menuPath.splice(nRemoveIndex);for(var i=0;i<menuPath.length-1;i++){var fatherObj=menuPath[i],childObj=menuPath[i+1];if(!RoleWebMenu._util._isMenuItemAdjacentToMenu(fatherObj.selectedMenuItem,childObj.menu,10)){menuPath.splice(i+1);break}}}),this._menuPathSet=this._menuPathSet.filter(function(item){return item.length}),this._activeRootMenu&&!RoleWebMenu._util._isVisible(this._activeRootMenu)&&(this._activeRootMenu=null),this._activeRootMenu){0===this.indexPairArrByMenu(this._activeRootMenu).length&&(this._activeRootMenu=null)}},indexPairArrByMenu:function(menuToSearch){var ret=[];return this._menuPathSet.forEach(function(menuPath,outerIndex){menuPath.forEach(function(pathItem,innerIndex){pathItem.menu==menuToSearch&&ret.push({outerIndex:outerIndex,innerIndex:innerIndex})})}),ret},pathItemByMenu:function(menuPath,menu){return Util.arrayFind(menuPath,function(pathItem){return pathItem.menu==menu})},eraseFollowingSubPath:function(menuPath,remainedPathItem){var indexRemained=menuPath.indexOf(remainedPathItem);indexRemained>=0&&indexRemained+1<menuPath.length&&menuPath.splice(indexRemained+1)},enterMenuItem:function(menuItemToEnter){var menuToEnter=RoleWebMenu._util._getSurroundingMenus(menuItemToEnter)[0],menuItemIndex=RoleWebMenu._util.indexOfMenuItems(menuToEnter,menuItemToEnter);if(0===this._menuPathSet.length)this.appendNewPath(menuToEnter,menuItemToEnter,menuItemIndex,menuToEnter);else{var activePath=this.getActiveMenuPath();if(activePath){var locatedPathItem=this.pathItemByMenu(activePath,menuToEnter);if(locatedPathItem)locatedPathItem.selectedMenuItem!=menuItemToEnter&&(this.eraseFollowingSubPath(activePath,locatedPathItem),locatedPathItem.selectedMenuItem=menuItemToEnter,locatedPathItem.selectedMenuItemIndex=menuItemIndex);else{var lastPathItem=RoleWebMenu._util._lastItem(activePath);RoleWebMenu._util._isMenuItemAdjacentToMenu(lastPathItem.selectedMenuItem,menuToEnter,10)?this.appendPathItem(activePath,menuToEnter,menuItemToEnter,menuItemIndex):this.appendNewPath(menuToEnter,menuItemToEnter,menuItemIndex,menuToEnter)}}else{var locatedPathIndexPairArr=this.indexPairArrByMenu(menuToEnter);if(0===locatedPathIndexPairArr.length)this.appendNewPath(menuToEnter,menuItemToEnter,menuItemIndex,menuToEnter);else{activePath=this._menuPathSet[locatedPathIndexPairArr[0].outerIndex],this._activeRootMenu=activePath[0].menu;var locatedPathItem=this._menuPathSet[locatedPathIndexPairArr[0].outerIndex][locatedPathIndexPairArr[0].innerIndex];locatedPathItem.selectedMenuItem!=menuItemToEnter&&(activePath.splice(locatedPathIndexPairArr[0].innerIndex+1),locatedPathItem.selectedMenuItem=menuItemToEnter,locatedPathItem.selectedMenuItemIndex=menuItemIndex)}}}},appendNewPath:function(menu,menuItem,menuItemIndex,activeRootMenu){this._menuPathSet.push([{menu:menu,selectedMenuItem:menuItem,selectedMenuItemIndex:menuItemIndex}]),this._activeRootMenu=activeRootMenu},appendPathItem:function(menuPath,menuToAppend,menuItemToAppend,menuItemIndex){menuPath.push({menu:menuToAppend,selectedMenuItem:menuItemToAppend,selectedMenuItemIndex:menuItemIndex})},getActiveRootMenu:function(){return this._activeRootMenu},getRecordPathText:function(menuItem){var activePath=this.getActiveMenuPath();if(!activePath)return"";var arrText=[];return activePath.some(function(pathItem){return arrText.push(RoleWebMenu._util._getMenuItemText(pathItem.selectedMenuItem)),pathItem.selectedMenuItem==menuItem}),arrText.join(";")},clearActiveRootMenu:function(){this._activeRootMenu=null},getActiveMenuPath:function(){var activeRootIndexArr=this.indexPairArrByMenu(this._activeRootMenu);return activeRootIndexArr.length?(activeRootIndexArr=activeRootIndexArr.filter(function(item){return 0===item.innerIndex}),activeRootIndexArr.length>1&&this._logger.warn("RoleWebMenu._MenuPathManager.getActiveMenuPath active menu count larger than 1, it is: ",activeRootIndexArr.length),this._menuPathSet[activeRootIndexArr[0].outerIndex]):null}},RoleWebMenu._menuPathManager=new RoleWebMenu._MenuPathManager,RoleWebKit.registerFactory(RoleWebMenu);var RoleWebButton={isRoleBased:!0,_util:{isButton:function(elem){return"button"===RoleWebUtil.getRole(elem)}},createAO:function(elem,parentId){return RoleWebButton._util.isButton(elem)?RoleWebUtil.createAO(elem,parentId,[ButtonBehavior,this._behavior]):null},_behavior:{name:"RoleWebButton",_attrs:{"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)}},_methods:{CALL_EVENT:function(msg,resultCallback){this._logger.trace("RoleWebButton: on commnad CALL_EVENT");var event=msg._data.event;if(event=event.toLowerCase().replace(/^on/,""),this._elem.children.length>0){var elemRec=this._elem.getBoundingClientRect();this._elem=document.elementFromPoint(elemRec.left+elemRec.width/2,elemRec.top+elemRec.height/2)}this._fireEvent(this._elem,event,msg._data),resultCallback(msg)}}}};RoleWebKit.registerFactory(RoleWebButton);var RoleWebCheckbox={isRoleBased:!0,_util:{isCheckbox:function(elem){return"checkbox"===RoleWebUtil.getRole(elem)}},createAO:function(elem,parentId){return RoleWebCheckbox._util.isCheckbox(elem)?RoleWebUtil.createAO(elem,parentId,[CheckBoxBehavior,this._behavior]):null},_behavior:{name:"RoleWebCheckbox",_attrs:{"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},checked:function(){return"true"===this._elem.getAttribute("aria-checked")?1:0},value:function(){return this._elem.value},part_value:function(){return"true"===this._elem.getAttribute("aria-checked")?"ON":"OFF"}},_eventHandler:function(recorder,ev){return!!ContentUtils.isTouchEnabled()||(this._logger.trace("RoleWebCheckbox.eventHandler: Received recordable event: ",ev.type),"click"===ev.type?(recorder.sendRecordEvent(this,ev,{event:"onclick",part_value:"false"===this._elem.getAttribute("aria-checked")?"ON":"OFF"}),!0):void 0)}}};RoleWebKit.registerFactory(RoleWebCheckbox);var RoleWebRadioGroup={isRoleBased:!0,_util:{isRadioGroup:function(elem){return"radio"===RoleWebUtil.getRole(elem)}},createAO:function(elem,parentId){if(RoleWebRadioGroup._util.isRadioGroup(elem)){var ao=RoleWebUtil.createAO(elem,parentId,[RadioGroupBehavior,this._behavior]);return ao.refreshRadioGroup(ao._elem),ao}return null},_behavior:{name:"RoleWebRadioGroup",_attrs:{"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},checked:function(){return"true"===this._elem.getAttribute("aria-checked")?1:0}},_eventHandler:function(recorder,ev){if(this._logger.trace("RoleWebRadioGroup.eventHandler: Received recordable event: ",ev.type),ContentUtils.isTouchEnabled())return!0;switch(ev.type){case"click":var radioElem=Util.findAncestor(ev.target,function(e){return e.matches&&e.matches("[role=radio]")});return radioElem&&recorder.sendRecordEvent(this,ev,{event:"onclick",value:this._calculateRadioButtonValue(radioElem)}),!0}},_helpers:{_getSiblingRadios:function(elem){for(var radios=[],currentNode=elem.parentNode.firstElementChild;currentNode;currentNode=currentNode.nextElementSibling){var role=RoleWebUtil.getRole(currentNode);1===currentNode.nodeType&&"radio"===role&&radios.push(currentNode)}return radios},refreshRadioGroup:function(triggeringElem){this._logger.trace("RoleWebRadioGroup.refreshRadioGroup: started"),triggeringElem&&(this._triggeringElem=triggeringElem);var radioGroup=Util.findAncestor(this._elem,function(item){return item.matches&&item.matches("[role=radiogroup]")});this._radios=radioGroup?radioGroup.querySelectorAll("[role=radio]"):this._getSiblingRadios(triggeringElem),this._activeRadioIndex=Util.arrayFindIndex(this._radios,function(radio){return"true"===radio.getAttribute("aria-checked")}.bind(this)),-1===this._activeRadioIndex&&(this._activeRadioIndex=0),this._elem=this._radios[this._activeRadioIndex]},_radioButtonInitialValue:function(elem){return RoleWebUtil.getText(elem)||RoleWebUtil.getText(elem.parentElement)}}}};RoleWebKit.registerFactory(RoleWebRadioGroup);var RoleWebList={isRoleBased:!1,_util:{isList:function(elem){if("INPUT"===elem.tagName)return!1;var role=RoleWebUtil.getRole(elem);return"list"===role||"listbox"===role||!(role||!RoleWebList._util.isULhavingLIsWithOptionRole(elem))},isULhavingLIsWithOptionRole:function(elem){return"UL"===elem.tagName&&(0===elem.querySelectorAll("ul").length&&elem.querySelectorAll("li[role=option]").length>0)},getListItems:function(elem){return Util.makeArray(elem.querySelectorAll("[role=option], [role=listitem]"))},getSelectedItem:function(items){return Util.arrayFind(items,function(item){return"true"===item.getAttribute("aria-selected")})},getItemToSelect:function(elem,value){var items=RoleWebList._util.getListItems(elem);return"number"!=typeof value?Util.arrayFind(items,function(item){return RoleWebUtil.getText(item)===value}):value>=0&&value<items.length?items[value]:null}},createAO:function(elem,parentId){return RoleWebList._util.isList(elem)?RoleWebUtil.createAO(elem,parentId,[ListBehavior,this._behavior]):null},_behavior:{name:"RoleWebListBehavior",_attrs:{"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},"default value":function(){return null},selection:function(){var items=RoleWebList._util.getListItems(this._elem),arr=[];return items.forEach(function(item){"true"===item.getAttribute("aria-selected")&&arr.push(RoleWebUtil.getText(item))}),arr.join(";")},"all items":function(){var items=RoleWebList._util.getListItems(this._elem);return Util.makeArray(items).map(RoleWebUtil.getText).join(";")},"items count":function(){return RoleWebList._util.getListItems(this._elem).length},"selected item index":function(){for(var items=RoleWebList._util.getListItems(this._elem),indexes=[],i=0;i<items.length;i++)"true"===items[i].getAttribute("aria-selected")&&indexes.push(i);return indexes.join(";")},"selected items count":function(){return RoleWebList._util.getListItems(this._elem).filter(function(item){return"true"===item.getAttribute("aria-selected")}).length},"visible items":function(){return this._getVisibleItems().length},"first item":function(){var items=RoleWebList._util.getListItems(this._elem);return items.length>0?RoleWebUtil.getText(items[0]):null},is_role_based:function(){return!0}},_methods:{NUM_TO_ITEM:function(msg,resultCallback){this._logger.trace("RoleWebListBehavior: on command NUM_TO_ITEM");var items=RoleWebList._util.getListItems(this._elem),index=msg._data.item_index;(index<0||index>=items.length)&&ErrorReporter.ThrowItemNotFound(),msg._data.AN_ITEM_TEXT=RoleWebUtil.getText(items[index]),resultCallback(msg)},LIST_SELECT:function(msg,resultCallback){function onComplete(){var target=RoleWebList._util.getItemToSelect(self._elem,msg._data.value);target?(ContentUtils.isTouchEnabled()&&(msg._data.pos=ContentUtils.pointRelativeToElem(target,{x:Constants.noCoordinate,y:Constants.noCoordinate}),target=document.elementFromPoint(msg._data.pos.x,msg._data.pos.y)),self._fireEvent(target,"click",msg._data)):ErrorReporter.ThrowItemNotFound(),resultCallback(msg)}this._logger.trace("RoleWebListBehavior: on command LIST_SELECT");var self=this;this._makeItemVisible(msg,onComplete)},MAKE_ITEM_VISIBLE:function(msg,resultCallback){this._logger.trace("RoleWebListBehavior: on command MAKE_ITEM_VISIBLE"),this._scrollByXPath(msg,resultCallback)}},_eventHandler:function(recorder,ev){if(ContentUtils.isTouchEnabled())return!0;switch(this._logger.trace("RoleWebList._eventHandler: Received recordable event: ",ev.type),ev.type){case"click":return!0;case"mousedown":var selectedItem=Util.findAncestor(ev.target,function(e){return e.matches&&e.matches("[role=option], [role=listitem]")});if(selectedItem)recorder.sendRecordEvent(this,ev,{event:"onchange",value:RoleWebUtil.getText(selectedItem)});else{0===RoleWebList._util.getListItems(this._elem).length&&recorder.sendRecordEvent(this,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY}})}return!0}},_gestureHandler:function(recorder,ev,targetElement){if(this._logger.trace("RoleWebList._gestureHandler: Received gesture: ",ev.event),"tap"==ev.event||"longtap"==ev.event){var selectedItem=Util.findAncestor(targetElement,function(e){return e.matches&&e.matches("[role=option], [role=listitem]")});if(!selectedItem){var elements=document.elementsFromPoint(ev.clientX,ev.clientY);selectedItem=Util.arrayFind(elements,function(elem){var role=RoleWebUtil.getRole(elem);return"option"===role||"listitem"===role})}if(selectedItem)recorder.sendRecordEvent(this,null,{event:"onchange",value:RoleWebUtil.getText(selectedItem),force_record:!0});else{0===RoleWebList._util.getListItems(this._elem).length&&recorder.sendRecordEvent(this,null,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY},force_record:!0})}return!0}},_helpers:{_scrollDirection:{ScrollUp:0,ScrollDown:1},_retryCounter:0,_axix:{min:0,max:9999},_makeItemVisible:function(msg,onComplete){var self=this;Util.setTimeout(function(){var value=msg._data.value;self._isItemVisible(value)?onComplete&&onComplete():(self._scrollByDirection(self._scrollDirection.ScrollUp,value,onComplete),self._isItemVisible(value)||self._scrollByDirection(self._scrollDirection.ScrollDown,value,onComplete))},500)},_getClickableElementByDirection:function(direction){switch(direction){case this._scrollDirection.ScrollUp:return this._getTopRightClickableElement();case this._scrollDirection.ScrollDown:return this._getBottomRightClickableElement()}},_getTopRightClickableElement:function(){var elemRec=this._elem.getBoundingClientRect();Util.isRectEmpty(elemRec)&&(elemRec=this._elem.parentElement.getBoundingClientRect());var topRightPosition={x:elemRec.left+elemRec.width-10,y:elemRec.top+10};return document.elementFromPoint(topRightPosition.x,topRightPosition.y)},_getBottomRightClickableElement:function(){var elemRec=this._elem.getBoundingClientRect();Util.isRectEmpty(elemRec)&&(elemRec=this._elem.parentElement.getBoundingClientRect());var bottomRightPosition={x:elemRec.left+elemRec.width-10,y:elemRec.bottom-10};return document.elementFromPoint(bottomRightPosition.x,bottomRightPosition.y)},_getClickPosition:function(direction,clickableElement){var clickableElementRec=clickableElement.getBoundingClientRect(),position={x:clickableElementRec.width-10,y:clickableElementRec.height-10};return"IMG"===clickableElement.tagName&&(clickableElement=clickableElement.parentElement,clickableElementRec=clickableElement.getBoundingClientRect(),position={x:clickableElementRec.width-10,y:clickableElementRec.height-10},direction==this._scrollDirection.ScrollUp&&(position.y=10)),position},_getElementByXPath:function(xpath){var element=null,iterate=null;return xpath&&(iterate=document.evaluate(xpath,this._elem,null,XPathResult.ANY_TYPE,null),element=iterate.iterateNext()),element||ErrorReporter.ThrowItemNotFound(),iterate.iterateNext()&&ErrorReporter.ThrowItemNotUnique(),element},_areTwoVisibleItemListEqual:function(listOne,listTwo){var areEqual=!0;listOne.length!==listTwo.length&&(areEqual=!1);for(var i=0;i<listOne.length;i++)if(listOne[i]!==listTwo[i]){areEqual=!1;break}return this._retryCounter=areEqual?this._retryCounter+1:0,areEqual},_scrollByDirection:function(direction,value,onComplete){var clickableElement=this._getClickableElementByDirection(direction);if(clickableElement){this._retryCounter=0;for(var position=this._getClickPosition(direction,clickableElement),isVisible=this._isItemVisible(value);!isVisible;){var originalVisibleItems=this._getVisibleItems();if(this._fireEvent(clickableElement,"click",{pos:position}),(isVisible=this._isItemVisible(value))&&onComplete){onComplete();break}if(this._areTwoVisibleItemListEqual(originalVisibleItems,this._getVisibleItems())&&this._retryCounter>5){direction==this._scrollDirection.ScrollDown&&onComplete&&onComplete();break}}}},_scrollByXPath:function(msg,resultCallback){function scroll(value,position,expire){self._isItemVisible(value)?resultCallback(msg):(new Date).getTime()>expire?(msg.status="ERROR",resultCallback(msg)):(self._fireEvent(elementByXPath,"click",{pos:position}),Util.setTimeout(scroll,100,value,position,expire))}var timeout=msg._data.timeout,value=msg._data.value,xpath=msg._data.xpath;if(timeout<0)return void ErrorReporter.ThrowInvalidArg();var elementByXPath=this._getElementByXPath(xpath),position=this._getClickPosition(null,elementByXPath),expire=(new Date).getTime()+timeout,self=this;scroll(value,position,expire)},_getVisibleItems:function(){var items=RoleWebList._util.getListItems(this._elem),visibleItems=[];return items.forEach(function(item){this._isItemVisible(RoleWebUtil.getText(item))&&visibleItems.push(item)},this),visibleItems},_isItemVisible:function(value){var item=RoleWebList._util.getItemToSelect(this._elem,value);if(!item)return!1;var topRightArea=this._getTopRightClickableElement(),bottomRightArea=this._getBottomRightClickableElement(),top=topRightArea?topRightArea.getBoundingClientRect().top:this._axix.min,bottom=bottomRightArea?bottomRightArea.getBoundingClientRect().bottom:this._axix.max,itemRec=item.getBoundingClientRect();return itemRec.bottom<=bottom+itemRec.height/2&&itemRec.top+itemRec.height/2>=top}}}},RoleWebComboBox={isRoleBased:!0,_util:{isComboxBox:function(elem){return"INPUT"!==elem.tagName&&"combobox"===RoleWebUtil.getRole(elem)}},createAO:function(elem,parentId){return RoleWebComboBox._util.isComboxBox(elem)?RoleWebUtil.createAO(elem,parentId,[ListBehavior,this._behavior]):null},_behavior:{name:"RoleWebComboBoxBehavior",_attrs:{"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},"default value":function(){return null},selection:function(){var items=Util.makeArray(RoleWebList._util.getListItems(this._elem)),arr=[];return items.forEach(function(item){"true"===item.getAttribute("aria-selected")&&arr.push(RoleWebUtil.getText(item))}),arr.join(";")},"all items":function(){var items=RoleWebList._util.getListItems(this._elem);return Util.makeArray(items).map(RoleWebUtil.getText).join(";")},"items count":function(){return 0},is_role_based:function(){return!0}},_methods:{CALL_EVENT:function(msg,resultCallback){this._logger.trace("RoleWebComboBox: on commnad CALL_EVENT");var self=this;Util.setTimeout(function(){var elemRec=self._elem.getBoundingClientRect(),propPos={x:elemRec.right-5,y:elemRec.top+elemRec.height/2},elementFromPoint=document.elementFromPoint(propPos.x,propPos.y);self._fireEvent(elementFromPoint,"mousedown",msg._data),self._fireEvent(elementFromPoint,"mouseup",msg._data),resultCallback(msg)},500)}},_eventHandler:function(recorder,ev){switch(this._logger.trace("RoleWebComboBox._eventHandler: Received recordable event: ",ev.type),ev.type){case"mousedown":return recorder.sendRecordEvent(this,ev,{event:"onclick","event point":{x:ev.clientX,y:ev.clientY}}),!0}return!1}}};RoleWebKit.registerFactory(RoleWebList),RoleWebKit.registerFactory(RoleWebComboBox);var RoleWebTab={isRoleBased:!0,_util:{isWebTab:function(elem){return"tablist"===RoleWebUtil.getRole(elem)&&0!==RoleWebTab._util.getTabItems(elem).length},getTabItems:function(elem){return elem.querySelectorAll("[role=tab]")},getItemToSelect:function(elem,value){var items=RoleWebTab._util.getTabItems(elem);return"number"!=typeof value?Util.arrayFind(items,function(item){return RoleWebUtil.getText(item)===value}):value>=0&&value<items.length?items[value]:null},getClickableItem:function(elem){return elem.firstChild&&"A"===elem.firstChild.tagName?elem.firstChild:elem}},createAO:function(elem,parentId){return RoleWebTab._util.isWebTab(elem)?RoleWebUtil.createAO(elem,parentId,[TabBehavior,this._behavior]):null},_behavior:{name:"RoleWebTabBehavior",_attrs:{name:function(){return RoleWebUtil.getName(this._elem)},"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},"all items":function(){var items=RoleWebTab._util.getTabItems(this._elem);return Util.makeArray(items).map(RoleWebUtil.getText).join(";")},"items count":function(){return RoleWebTab._util.getTabItems(this._elem).length},"first item":function(){var items=RoleWebTab._util.getTabItems(this._elem);return items.length>0?RoleWebUtil.getText(items[0]):null}},_methods:{LIST_SELECT:function(msg,resultCallback){this._logger.trace("RoleWebTabBehavior: on command LIST_SELECT");var targetTab=RoleWebTab._util.getItemToSelect(this._elem,msg._data.value);targetTab?(this._elem=RoleWebTab._util.getClickableItem(targetTab),this._fireEvent(this._elem,"click",msg._data)):ErrorReporter.ThrowItemNotFound(),resultCallback(msg)}},_eventHandler:function(recorder,ev){if(ContentUtils.isTouchEnabled())return!0;switch(this._logger.trace("RoleWebTab._eventHandler: Received recordable event: ",ev.type),ev.type){case"click":var tabItem=Util.findAncestor(ev.target,function(e){return e.matches&&e.matches("[role=tab]")});return tabItem=tabItem||ev.target.querySelector("[role=tab]"),tabItem&&recorder.sendRecordEvent(this,ev,{event:"onchange",value:RoleWebUtil.getText(tabItem)}),!0}return!1},_gestureHandler:function(recorder,ev,targetElement){if(this._logger.trace("RoleWebTabBehavior._gestureHandler: Received gesture: ",ev.event),"tap"==ev.event||"longtap"==ev.event){var tabItem=Util.findAncestor(targetElement,function(e){return e.matches&&e.matches("[role=tab]")});return tabItem=tabItem||targetElement.querySelector("[role=tab]"),tabItem&&recorder.sendRecordEvent(this,null,{event:"onchange",value:RoleWebUtil.getText(tabItem),force_record:!0}),!0}}}},RoleWebTabLink={isRoleBased:!0,_util:{isWebTabLink:function(elem){if("A"!==elem.tagName)return!1;var role=RoleWebUtil.getRole(elem),parentRole=RoleWebUtil.getRole(elem.parentElement);return"tab"===role||"tab"===parentRole}},createAO:function(elem,parentId){return RoleWebTabLink._util.isWebTabLink(elem)?RoleWebUtil.createAO(elem,parentId,[this._behavior]):null},_behavior:{_eventHandler:function(recorder,ev){this._logger.trace("RoleWebTabLink._eventHandler: Received recordable event: ",ev.type)}}};RoleWebKit.registerFactory(RoleWebTab),RoleWebKit.registerFactory(RoleWebTabLink);var RoleWebLink={isRoleBased:!0,_util:{isWebLink:function(elem){return"link"===RoleWebUtil.getRole(elem)}},createAO:function(elem,parentId){return RoleWebLink._util.isWebLink(elem)?RoleWebUtil.createAO(elem,parentId,[LinkBehavior]):null}};RoleWebKit.registerFactory(RoleWebLink);var RoleWebTree={isRoleBased:!0,_util:{isTree:function(elem){return"tree"===RoleWebUtil.getRole(elem)},_getTreeItems:function(elem){return Util.makeArray(elem.querySelectorAll("[role=treeitem]"))},getSelectedItem:function(elem){return elem.querySelector("[aria-selected=true]")},isItemExpanded:function(elem){if(elem=RoleWebTree._helpers._getTreeItem(elem),"true"===elem.getAttribute("aria-expanded"))return!0;if("false"===elem.getAttribute("aria-expanded"))return!1;var child=elem.querySelector("[role=treeitem]");if(child){var display=child.parentNode.style.getPropertyValue("display");if("block"===display)return!0;if("none"===display)return!1}return!0},isItemCollapsed:function(elem){return!RoleWebTree._util.isItemExpanded(elem)},isTreeItem:function(elem){return!(!elem||!elem.nodeName)&&(elem.nodeType!==Node.TEXT_NODE&&elem.nodeType!==Node.COMMENT_NODE&&"treeitem"==elem.getAttribute("role"))},getTextContent:function(elem){if(RoleWebTree._util.isTreeItem(elem))for(;elem.hasChildNodes();){var child=Util.arrayFind(elem.childNodes,function(e){return Util.cleanTextProperty(e.textContent)&&"#comment"!=e.nodeName});if(!child.hasChildNodes())break;elem=child}return Util.cleanTextProperty(elem.textContent)}},createAO:function(elem,parentId){return RoleWebTree._util.isTree(elem)?RoleWebUtil.createAO(elem,parentId,[TreeBehavior,this._behavior]):null},_behavior:{name:"RoleWebTreeBehavior",_attrs:{name:function(){return RoleWebUtil.getName(this._elem)||RoleWebUtil.getLogicalName(this._elem)},"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},"all items":function(){var allItems=RoleWebTree._util._getTreeItems(this._elem);return Util.makeArray(allItems).map(RoleWebTree._util.getTextContent).join(";")},"items count":function(){return RoleWebTree._util._getTreeItems(this._elem).length},selection:function(){var selection=RoleWebTree._util.getSelectedItem(this._elem);return RoleWebTree._helpers._getPathFromElem(selection)},"first item":function(){var firstRoot=RoleWebTree._util._getTreeItems(this._elem)[0];return firstRoot?RoleWebTree._util.getTextContent(firstRoot):null}},_eventHandler:function(recorder,ev){if(ContentUtils.isTouchEnabled())return!0;switch(ev.type){case"click":var operation,elem=Util.findAncestor(ev.target,function(e){return e.matches&&e.matches("[role=treeitem]")}),path=RoleWebTree._helpers._getPathFromElem(elem),nodes=path.split(";"),text=nodes[nodes.length-1];return operation=RoleWebTree._helpers._isLeaf(elem)||RoleWebTree._helpers._isClickOnItem(elem,text,ev.target)?RoleWebTree._helpers._actionType.select:RoleWebTree._util.isItemExpanded(elem)?RoleWebTree._helpers._actionType.collapse:RoleWebTree._helpers._actionType.expand,recorder.sendRecordEvent(this,ev,{event:"onclick",name:operation,value:path}),!0}},_gestureHandler:function(recorder,ev,targetElement){if("tap"==ev.event||"longtap"==ev.event){var operation,elem=Util.findAncestor(targetElement,function(e){return e.matches&&e.matches("[role=treeitem]")}),path=RoleWebTree._helpers._getPathFromElem(elem),nodes=path.split(";"),text=nodes[nodes.length-1];return operation=RoleWebTree._helpers._isLeaf(elem)||RoleWebTree._helpers._isClickOnItem(elem,text,targetElement)?RoleWebTree._helpers._actionType.select:RoleWebTree._util.isItemExpanded(elem)?RoleWebTree._helpers._actionType.collapse:RoleWebTree._helpers._actionType.expand,recorder.sendRecordEvent(this,null,{event:"onclick",name:operation,value:path,force_record:!0}),!0}},_methods:{LIST_SELECT:function(msg,resultCallback){RoleWebTree._helpers._makeSelection(msg,this,RoleWebTree._helpers._actionType.select,resultCallback)},WEB_TREE_EXPAND:function(msg,resultCallback){RoleWebTree._helpers._makeSelection(msg,this,RoleWebTree._helpers._actionType.expand,resultCallback)},WEB_TREE_COLLAPSE:function(msg,resultCallback){RoleWebTree._helpers._makeSelection(msg,this,RoleWebTree._helpers._actionType.collapse,resultCallback)}}},_helpers:{_actionType:{select:"Select",expand:"Expand",collapse:"Collapse"},_getPathFromElem:function(elem){if(0==arguments.length)return"";for(var path=[],e=elem;e;e=this._getParentNode(e))RoleWebTree._util.isTreeItem(e)&&path.push(RoleWebTree._util.getTextContent(e));return path=path.reverse().join(";")},_getItemFromPath:function(path,tree){if(0==arguments.length)return null;for(var item=tree||this._elem,nodes=path.split(";"),i=0;i<nodes.length;i++){var children=this._getDirectChildrenItems(item),node=nodes[i],tryIndex=this._tryGetItemByIndex(node,children);item=tryIndex||Util.arrayFind(children,function(child){return node==RoleWebTree._util.getTextContent(child)})}return item||ErrorReporter.ThrowItemNotFound(),item},_tryGetItemByIndex:function(indexStr,items){if(0==indexStr.indexOf("#")){var index=Number(indexStr.substr(1));if(index<items.length)return items[index];ErrorReporter.ThrowItemNotFound()}},_makeSelection:function(msg,current,type,resultCallback){if(current){var xpathForSelector=msg._data.xpath,xpathForOpener=msg._data._xpath,nodes="string"==typeof msg._data.value?[msg._data.value]:msg._data.value[0],path=nodes.join(";");switch(type){case this._actionType.select:this._expandParent(current._elem,msg,current,path,xpathForOpener,function(){var item=RoleWebTree._helpers._getItemFromPath(path,current._elem);RoleWebTree._helpers._clickItem(item,msg,current,RoleWebTree._util.getTextContent(item),xpathForSelector),resultCallback(msg)});break;case this._actionType.expand:
this._expandParent(current._elem,msg,current,path,xpathForOpener,function(){var item=RoleWebTree._helpers._getItemFromPath(path,current._elem);RoleWebTree._util.isItemCollapsed(item)?RoleWebTree._helpers._clickOpener(item,msg,current,xpathForOpener,function(){resultCallback(msg)}):resultCallback(msg)});break;case this._actionType.collapse:var item=this._getItemFromPath(path,current._elem);RoleWebTree._util.isItemExpanded(item)?this._clickOpener(item,msg,current,xpathForOpener,function(){resultCallback(msg)}):resultCallback(msg)}}},_redirectByXpathAsPriority:function(item,xpath){if(xpath){item=document.evaluate(xpath,item,null,XPathResult.ANY_TYPE,null).iterateNext()}return item||ErrorReporter.ThrowItemNotFound(),item},_clickItem:function(item,msg,current,text,xpath){var target=xpath?RoleWebTree._helpers._redirectByXpathAsPriority(item,xpath):RoleWebTree._helpers._findItem(item,text);current._fireEvent(target,"click",msg._data)},_clickOpener:function(item,msg,current,xpath,onComplete){var target=xpath?RoleWebTree._helpers._redirectByXpathAsPriority(item,xpath):RoleWebTree._helpers._findOpener(item),status=RoleWebTree._util.isItemExpanded(item);current._fireEvent(target,"mouseover",msg._data),status==RoleWebTree._util.isItemExpanded(item)&&current._fireEvent(target,"click",msg._data),Util.setTimeout(function(){status==RoleWebTree._util.isItemExpanded(item)&&current._fireEvent(target,"dblclick",msg._data),onComplete&&onComplete()},2e3)},_findItem:function(item,text){if(RoleWebTree._util.isTreeItem(item))for(;item.hasChildNodes();){var child=Util.arrayFind(item.childNodes,function(itemChild){return RoleWebTree._util.getTextContent(itemChild)==text});if(!child||!child.hasChildNodes())return item;item=child}return item},_findOpener:function(item){if(RoleWebTree._util.isTreeItem(item))for(;item.childElementCount;)item=Util.arrayFind(item.children,function(itemChild){return!RoleWebTree._helpers._isZeroSize(itemChild)})||item.firstElementChild;return item||ErrorReporter.ThrowItemNotFound(),item},_isZeroSize:function(elem){return 0==elem.offsetWidth||0==elem.offsetHeight},_isLeaf:function(elem){return!elem.hasAttribute("aria-expanded")&&0===elem.querySelectorAll("[role=treeitem]").length},_isClickOnItem:function(elem,text,target){return RoleWebTree._helpers._findItem(elem,text).contains(target)},_expandParent:function(item,msg,current,path,xpath,onComplete){for(var parent=this._getTreeRoot(item),nodes=path.split(";"),onCompleteCalled=!1,i=0;i<nodes.length-1;i++){var children=this._getDirectChildrenItems(parent),node=nodes[i],tryIndex=this._tryGetItemByIndex(node,children);parent=tryIndex||Util.arrayFind(children,function(child){return node==RoleWebTree._util.getTextContent(child)}),RoleWebTree._util.isItemCollapsed(parent)&&(this._clickOpener(parent,msg,current,xpath,onComplete),onCompleteCalled=!0)}!onCompleteCalled&&onComplete&&onComplete()},_getParentNode:function(elem){return this._getLogicalParentFromLevel(elem)||this._getLogicalParentFromAriaOwns(elem)||this._getParentFromDom(elem)},_getDirectChildrenItems:function(elem){var children=this._getLogicalChildrenFromLevel(elem)||this._getLogicalChildrenFromAriaOwns(elem)||this._getChildrenFromDom(elem);return Util.makeArray(children)},_getParentFromDom:function(elem){return Util.findAncestor(elem.parentElement,function(parent){return parent.matches("[role=treeitem]")||parent.matches("[role=tree]")})},_getChildrenFromDom:function(elem){var children=Util.makeArray(RoleWebTree._util._getTreeItems(elem));return children=RoleWebTree._util.isTree(elem)?children.filter(function(child){return-1==RoleWebTree._helpers._getPathFromElem(child).indexOf(";")}):children.filter(function(child){return elem==RoleWebTree._helpers._getParentFromDom(child)})},_getLogicalChildrenFromAriaOwns:function(elem){var aria_owns=elem.getAttribute("aria-owns");if(aria_owns){var ids=aria_owns.split(/\s+/).filter(function(id){return""!=id}),children=ids.map(function(id){var item=document.getElementById(id);if(item)return Util.makeArray(item.querySelectorAll("[role=treeitem]"))}).reduce(function(a,b){return a.concat(b)},[]).filter(function(child){return child}),currentLevel=this._calculateLevelFromPath(elem);return children.filter(function(child){return RoleWebTree._helpers._calculateLevelFromPath(child)==currentLevel+1})}},_calculateLevelFromPath:function(elem){return RoleWebTree._helpers._getPathFromElem(elem).split(";").length},_getLogicalParentFromAriaOwns:function(elem){var tree=this._getTreeRoot(elem);if(0!=tree.querySelectorAll("[role='treeitem'][aria-owns]").length)for(var iterator=elem;iterator!=tree;iterator=iterator.parentNode){var id=iterator.id;if(id){"number"==typeof id&&(id="'"+id+"'");var selector="[aria-owns~="+id+"]",searchResult=tree.querySelector(selector);if(searchResult)return searchResult}}},_getLogicalChildrenFromLevel:function(elem){var level=this._getLevel(elem);if(level){for(var items=RoleWebTree._util._getTreeItems(this._getTreeRoot(elem)),index=Util.arrayFindIndex(items,function(itemChild){return itemChild==elem}),children=[],i=index+1;i<items.length;i++){var item=items[i],itemLevel=this._getLevel(item);if(itemLevel<=level)break;itemLevel==level+1&&(children=children.concat(item))}if(0!=children.length)return children}},_getLogicalParentFromLevel:function(elem){var level=this._getLevel(elem);if(level)for(var items=RoleWebTree._util._getTreeItems(this._getTreeRoot(elem)),index=Util.arrayFindIndex(items,function(item){return item==elem}),i=index-1;i>=0;i--){var item=items[i];if(this._getLevel(item)==level-1)return item}},_getLevel:function(elem){if(RoleWebTree._util.isTreeItem(elem))return Number(elem.getAttribute("aria-level"))},_getTreeItem:function(elem){return RoleWebTree._util.isTreeItem(elem)||(elem=Util.findAncestor(elem,function(item){return item.matches&&item.matches("[role=treeitem]")})),elem},_getTreeRoot:function(elem){return RoleWebTree._util.isTree(elem)||(elem=Util.findAncestor(elem,function(item){return item.matches&&item.matches("[role=tree]")})),elem}}};RoleWebKit.registerFactory(RoleWebTree);var RoleWebTable={isRoleBased:!0,_util:{isWebTable:function(elem){return"TABLE"!==elem.tagName&&"grid"===RoleWebUtil.getRole(elem)}},createAO:function(elem,parentId){return RoleWebTable._util.isWebTable(elem)?RoleWebUtil.createAO(elem,parentId,[TableBehavior,this._behavior]):null},_behavior:{name:"RoleWebTableBehavior",_attrs:{"logical name":function(){return RoleWebUtil.getLogicalName(this._elem)},cols:function(msg){var columnHeaders=this._getColumnHeaders();if(columnHeaders.length>0)return columnHeaders.length;var rows=this._getRows();return 0===rows.length?0:this._getCells(rows[0]).length},"column names":function(){var columnHeaders=this._getColumnHeaders();return Util.makeArray(columnHeaders).map(function(col){return col.textContent}).join(";")}},_helpers:{_filteredByContainer:function(items){return Util.makeArray(items).filter(function(item){return this._elem===Util.findAncestor(item,function(e){return e.matches&&e.matches("[role=grid]")})},this)},_getRows:function(){var rows=this._elem.querySelectorAll("[role=row]");return this._filteredByContainer(rows)},_getCells:function(row){var cells=row.querySelectorAll("[role=gridcell]");return this._filteredByContainer(cells)},_getColumnHeaders:function(){var headers=this._elem.querySelectorAll("[role=columnheader]");return this._filteredByContainer(headers)}}}};RoleWebKit.registerFactory(RoleWebTable);var JQMKit=KitUtil.CreateKit("jQmKit",function(){return ContentUtils.runOnDocSync(function(){return!("undefined"==typeof $||!$.mobile)})}),JQMUtil={matchControl:function(elem,matchingLabelClasses,controlCriteria){if("LABEL"===elem.tagName&&this._hasExpectedClass(elem,matchingLabelClasses)){var control=this._getControlFromLabel(elem,controlCriteria);if(control)return{control:control,label:elem}}else if(controlCriteria(elem)){var label=this.getLabelFromControl(elem,matchingLabelClasses);if(label)return{control:elem,label:label}}return null},_hasExpectedClass:function(elem,classNames){return classNames.some(function(name){return Util.elemHasClass(elem,name)})},_getControlFromLabel:function(label,controlCriteria){var candidate=label.control||label.nextElementSibling;return candidate&&controlCriteria(candidate)?candidate:null},getLabelFromControl:function(elem,classNames){var labels=ContentUtils.getLabelsFromControl(elem);if(labels&&labels.length)return Util.makeArray(labels).filter(function(label){return this._hasExpectedClass(label,classNames)},this)[0];var prev=elem.previousElementSibling;return prev&&"LABEL"===prev.tagName&&!prev.control&&this._hasExpectedClass(prev,classNames)?prev:void 0}},JQMButton={createAO:function(elem,parentId){return Util.elemHasClass(elem,"ui-btn")&&elem.offsetWidth?KitUtil.createAO(elem,parentId,[ButtonBehavior,this._behavior]):null},_behavior:{name:"JQMButtonBehavior",_eventHandler:function(recorder,ev){return this._logger.trace("JQMButton._eventHandler: Received recordable event: "+ev.type),!!ContentUtils.isTouchEnabled()&&(this._logger.trace("JQMButton._eventHandler: ignoring event in touch mode"),!0)}}},JQMCheckBox={createAO:function(elem,parentId){var match=JQMUtil.matchControl(elem,this._matchingClasses,this._isCheckBox);if(match){var ret=KitUtil.createAO(match.control,parentId,[CheckBoxBehavior,this._behavior]);return ret._label=match.label,ret}return null},_matchingClasses:["ui-checkbox-off","ui-checkbox-on"],_isCheckBox:function(elem){return"INPUT"===elem.tagName&&"checkbox"===elem.type},_behavior:{name:"JQMCheckBoxBehavior",_helpers:{_getLogicalName:function(){return this._label&&this._label.textContent},_label:null},_methods:{CALL_EVENT:function(msg,resultCallback){this._logger.trace("JQMCheckBox: on commnad CALL_EVENT");var event=msg._data.event;event=event.toLowerCase().replace(/^on/,""),this._fireEvent(this._label,event,msg._data),resultCallback(msg)},SET_VALUE_EX:function(msg,resultCallback){if(this._logger.trace("JQMCheckBox: on command SET_VALUE_EX"),1===this.GetAttrSync("disabled")&&ErrorReporter.ThrowObjectDisabled(),this.GetAttrSync("part_value")!==msg._data.value){var visibleMsg=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.SRVC_MAKE_OBJ_VISIBLE(visibleMsg,function(){document.body.click(),this._elem.click(),resultCallback(msg)}.bind(this))}else resultCallback(msg)}},_eventHandler:function(recorder,ev){return this._logger.trace("JQMCheckBox._eventHandler: Received recordable event: "+ev.type),ContentUtils.isTouchEnabled()?(this._logger.trace("JQMCheckBox._eventHandler: ignoring event in touch mode"),!0):"click"===ev.type&&(recorder.sendRecordEvent(this,ev,{event:"onclick",part_value:this._elem.checked?"OFF":"ON"}),!0)},_gestureHandler:function(recorder,gestureInfo){"tap"===gestureInfo.event&&recorder.sendRecordEvent(this,null,{event:"onclick",part_value:this._elem.checked?"OFF":"ON",force_record:!0})}}},JQMRadioGroup={createAO:function(elem,parentId){var match=JQMUtil.matchControl(elem,this.matchingClasses,this._isRadio);if(match){var ao=KitUtil.createAO(match.control,parentId,[RadioGroupBehavior,this._behavior]);return ao.refreshRadioGroup(ao._elem),ao}return null},matchingClasses:["ui-radio-off","ui-radio-on"],_isRadio:function(elem){return"INPUT"===elem.tagName&&"radio"===elem.type},_behavior:{name:"JQMRadioGroup",_methods:{CALL_EVENT:function(msg,resultCallback){this._logger.trace("JQMRadioGroup: on command CALL_EVENT"),this.InvokeMethod("SET_ACTIVE_RADIO_BY_VALUE",msg,function(resMsg){var event=resMsg._data.event;event=event.replace(/^on/,"");var label=JQMUtil.getLabelFromControl(this._elem,JQMRadioGroup.matchingClasses);this._fireEvent(label||this._elem,event,resMsg._data),resultCallback(resMsg)}.bind(this))},SET_VALUE_EX:function(msg,resultCallback){this._logger.trace("JQMRadioGroup: on command SET_VALUE_EX"),this._setActiveElemByValue(msg._data.value);var visibleMsg=new Msg(MSG_TYPES.SRVC_MAKE_OBJ_VISIBLE,Util.shallowObjectClone(this._parentID),{});this.SRVC_MAKE_OBJ_VISIBLE(visibleMsg,function(){document.body.click(),this._elem.click(),resultCallback(msg)}.bind(this))}},_eventHandler:function(recorder,ev){if(this._logger.trace("JQMRadioGroup._eventHandler: Received recordable event: "+ev.type),"click"===ev.type)return this.refreshRadioGroup(),recorder.sendRecordEvent(this,ev,{event:"onclick",value:this._calculateRadioButtonValue(this._triggeringElem||this._elem)}),!0},_helpers:{_radioButtonInitialValue:function(elem){var label=JQMUtil.getLabelFromControl(elem,JQMRadioGroup.matchingClasses);return label&&label.textContent?label.textContent.trim():elem.value||""}}}};JQMKit.registerFactory(JQMCheckBox),JQMKit.registerFactory(JQMRadioGroup),JQMKit.registerFactory(JQMButton),KitsManager.prototype.LoadKit(JQMKit);var SenchaKit=KitUtil.CreateKit("SenchaKit",function(){return ContentUtils.runOnDocSync(function(){return!(!window.Ext||!window.Ext.version)})}),SenchaButton={createAO:function(elem,parentId){return Util.elemHasClass(elem,"x-button")?KitUtil.createAO(elem,parentId,[ButtonBehavior]):null}};SenchaKit.registerFactory(SenchaButton),KitsManager.prototype.LoadKit(SenchaKit),function(){if(!document.evaluate){var BinaryExpr,FilterExpr,FunctionCall,Literal,NameTest,NodeSet,NodeType,NodeUtil,Number,PathExpr,Step,UnaryExpr,UnionExpr,VariableReference,undefined=void 0,config={targetFrame:undefined,exportInstaller:!1,useNative:!0,hasNative:!1,useInnerText:!0},uai=new function(){var ua=navigator.userAgent;if(RegExp==undefined)ua.indexOf("Opera")>=0?this.opera=!0:ua.indexOf("Netscape")>=0?this.netscape=!0:0==ua.indexOf("Mozilla/")?this.mozilla=!0:this.unknown=!0,ua.indexOf("Gecko/")>=0&&(this.gecko=!0),ua.indexOf("Win")>=0?this.windows=!0:ua.indexOf("Mac")>=0?this.mac=!0:ua.indexOf("Linux")>=0?this.linux=!0:ua.indexOf("BSD")>=0?this.bsd=!0:ua.indexOf("SunOS")>=0&&(this.sunos=!0);else if(/AppleWebKit\/(\d+(?:\.\d+)*)/.test(ua)?(this.applewebkit=RegExp.$1,4==RegExp.$1.charAt(0)?this.applewebkit2=!0:this.applewebkit3=!0):"object"==typeof Components&&(/Gecko\/(\d{8})/.test(ua)||"Gecko"==navigator.product&&/^(\d{8})$/.test(navigator.productSub))&&(this.gecko=RegExp.$1),"object"==typeof opera&&"function"==typeof opera.version?(this.opera=opera.version(),this["opera"+this.opera[0]+this.opera[2]]=!0):"object"==typeof opera&&/Opera[\/ ](\d+\.\d+)/.test(ua)?this.opera=RegExp.$1:this.ie||(/Safari\/(\d+(?:\.\d+)*)/.test(ua)?this.safari=RegExp.$1:/NetFront\/(\d+(?:\.\d+)*)/.test(ua)?this.netfront=RegExp.$1:/Konqueror\/(\d+(?:\.\d+)*)/.test(ua)?this.konqueror=RegExp.$1:ua.indexOf("(compatible;")<0&&/^Mozilla\/(\d+\.\d+)/.test(ua)?(this.mozilla=RegExp.$1,/\([^(]*rv:(\d+(?:\.\d+)*).*?\)/.test(ua)&&(this.mozillarv=RegExp.$1),/Firefox\/(\d+(?:\.\d+)*)/.test(ua)?this.firefox=RegExp.$1:/Netscape\d?\/(\d+(?:\.\d+)*)/.test(ua)&&(this.netscape=RegExp.$1)):this.unknown=!0),ua.indexOf("Win 9x 4.90")>=0)this.windows="ME";else if(/Win(?:dows)? ?(NT ?(\d+\.\d+)?|\d+|ME|Vista|XP)/.test(ua))if(this.windows=RegExp.$1,RegExp.$2)this.winnt=RegExp.$2;else switch(RegExp.$1){case"2000":this.winnt="5.0";break;case"XP":this.winnt="5.1";break;case"Vista":this.winnt="6.0"}else ua.indexOf("Mac")>=0?this.mac=!0:ua.indexOf("Linux")>=0?this.linux=!0:/(\w*BSD)/.test(ua)?this.bsd=RegExp.$1:ua.indexOf("SunOS")>=0&&(this.sunos=!0)},Lexer=function(source){for(var proto=Lexer.prototype,tokens=source.match(proto.regs.token),i=0,l=tokens.length;i<l;i++)proto.regs.strip.test(tokens[i])&&tokens.splice(i,1);for(var n in proto)tokens[n]=proto[n];return tokens.index=0,tokens};Lexer.prototype.regs={token:/\$?(?:(?![0-9-])[\w-]+:)?(?![0-9-])[\w-]+|\/\/|\.\.|::|\d+(?:\.\d*)?|\.\d+|"[^"]*"|'[^']*'|[!<>]=|(?![0-9-])[\w-]+:\*|\s+|./g,strip:/^\s/},Lexer.prototype.peek=function(i){return this[this.index+(i||0)]},Lexer.prototype.next=function(){return this[this.index++]},Lexer.prototype.back=function(){this.index--},Lexer.prototype.empty=function(){return this.length<=this.index};var Ctx=function(node,position,last){this.node=node,this.position=position||1,this.last=last||1},BaseExpr=function(){};BaseExpr.prototype.number=function(ctx){var exrs=this.evaluate(ctx);return exrs.isNodeSet?exrs.number():+exrs},BaseExpr.prototype.string=function(ctx){var exrs=this.evaluate(ctx);return exrs.isNodeSet?exrs.string():""+exrs},BaseExpr.prototype.bool=function(ctx){var exrs=this.evaluate(ctx);return exrs.isNodeSet?exrs.bool():!!exrs};var BaseExprHasPredicates=function(){};BaseExprHasPredicates.parsePredicates=function(lexer,expr){for(;"["==lexer.peek();){if(lexer.next(),lexer.empty())throw Error("missing predicate expr");var predicate=BinaryExpr.parse(lexer);if(expr.predicate(predicate),lexer.empty())throw Error("unclosed predicate expr");if("]"!=lexer.next())throw lexer.back(),Error("bad token: "+lexer.next())}},BaseExprHasPredicates.prototype=new BaseExpr,BaseExprHasPredicates.prototype.evaluatePredicates=function(nodeset,start){var predicates,predicate,nodes,nodeset,position,reverse;reverse=this.reverse,predicates=this.predicates,nodeset.sort();for(var i=start||0,l0=predicates.length;i<l0;i++){predicate=predicates[i];for(var deleteIndexes=[],nodes=nodeset.list(),j=0,l1=nodes.length;j<l1;j++){switch(position=reverse?l1-j:j+1,exrs=predicate.evaluate(new Ctx(nodes[j],position,l1)),typeof exrs){case"number":exrs=position==exrs;break;case"string":exrs=!!exrs;break;case"object":exrs=exrs.bool()}exrs||deleteIndexes.push(j)}for(var j=deleteIndexes.length-1,l1=0;j>=l1;j--)nodeset.del(deleteIndexes[j])}return nodeset},!window.BinaryExpr&&window.defaultConfig&&(window.BinaryExpr=null),BinaryExpr=function(op,left,right,datatype){this.op=op,this.left=left,this.right=right,this.datatype=BinaryExpr.ops[op][2],this.needContextPosition=left.needContextPosition||right.needContextPosition,this.needContextNode=left.needContextNode||right.needContextNode,"="==this.op&&(right.needContextNode||right.needContextPosition||"nodeset"==right.datatype||"void"==right.datatype||!left.quickAttr?left.needContextNode||left.needContextPosition||"nodeset"==left.datatype||"void"==left.datatype||!right.quickAttr||(this.quickAttr=!0,this.attrName=right.attrName,this.attrValueExpr=left):(this.quickAttr=!0,this.attrName=left.attrName,this.attrValueExpr=right))},BinaryExpr.compare=function(op,comp,left,right,ctx){var type,lnodes,rnodes,nodes,nodeset,primitive;if(left=left.evaluate(ctx),right=right.evaluate(ctx),left.isNodeSet&&right.isNodeSet){lnodes=left.list(),rnodes=right.list();for(var i=0,l0=lnodes.length;i<l0;i++)for(var j=0,l1=rnodes.length;j<l1;j++)if(comp(NodeUtil.to("string",lnodes[i]),NodeUtil.to("string",rnodes[j])))return!0;return!1}if(left.isNodeSet||right.isNodeSet){left.isNodeSet?(nodeset=left,primitive=right):(nodeset=right,primitive=left),nodes=nodeset.list(),type=typeof primitive;for(var i=0,l=nodes.length;i<l;i++)if(comp(NodeUtil.to(type,nodes[i]),primitive))return!0;return!1}return"="==op||"!="==op?"boolean"==typeof left||"boolean"==typeof right?comp(!!left,!!right):"number"==typeof left||"number"==typeof right?comp(+left,+right):comp(left,right):comp(+left,+right)},BinaryExpr.ops={div:[6,function(left,right,ctx){return left.number(ctx)/right.number(ctx)},"number"],mod:[6,function(left,right,ctx){return left.number(ctx)%right.number(ctx)},"number"],"*":[6,function(left,right,ctx){return left.number(ctx)*right.number(ctx)},"number"],"+":[5,function(left,right,ctx){return left.number(ctx)+right.number(ctx)},"number"],"-":[5,function(left,right,ctx){return left.number(ctx)-right.number(ctx)},"number"],"<":[4,function(left,right,ctx){return BinaryExpr.compare("<",function(a,b){return a<b},left,right,ctx)},"boolean"],">":[4,function(left,right,ctx){return BinaryExpr.compare(">",function(a,b){return a>b},left,right,ctx)},"boolean"],"<=":[4,function(left,right,ctx){return BinaryExpr.compare("<=",function(a,b){return a<=b},left,right,ctx)},"boolean"],">=":[4,function(left,right,ctx){return BinaryExpr.compare(">=",function(a,b){return a>=b},left,right,ctx)},"boolean"],"=":[3,function(left,right,ctx){return BinaryExpr.compare("=",function(a,b){return a==b},left,right,ctx)},"boolean"],"!=":[3,function(left,right,ctx){return BinaryExpr.compare("!=",function(a,b){return a!=b},left,right,ctx)},"boolean"],and:[2,function(left,right,ctx){return left.bool(ctx)&&right.bool(ctx)},"boolean"],or:[1,function(left,right,ctx){return left.bool(ctx)||right.bool(ctx)},"boolean"]},BinaryExpr.parse=function(lexer){var op,precedence,info,expr,stack=[];for(lexer.index;;){if(lexer.empty())throw Error("missing right expression");if(expr=UnaryExpr.parse(lexer),!(op=lexer.next()))break;if(info=this.ops[op],!(precedence=info&&info[0])){lexer.back();break}for(;stack.length&&precedence<=this.ops[stack[stack.length-1]][0];)expr=new BinaryExpr(stack.pop(),stack.pop(),expr);stack.push(expr,op)}for(;stack.length;)expr=new BinaryExpr(stack.pop(),stack.pop(),expr);return expr},BinaryExpr.prototype=new BaseExpr,BinaryExpr.prototype.evaluate=function(ctx){return BinaryExpr.ops[this.op][1](this.left,this.right,ctx)},BinaryExpr.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"binary: "+this.op+"\n",indent+="    ",t+=this.left.show(indent),t+=this.right.show(indent)},!window.UnaryExpr&&window.defaultConfig&&(window.UnaryExpr=null),UnaryExpr=function(op,expr){this.op=op,this.expr=expr,this.needContextPosition=expr.needContextPosition,this.needContextNode=expr.needContextNode},UnaryExpr.ops={"-":1},UnaryExpr.parse=function(lexer){return this.ops[lexer.peek()]?new UnaryExpr(lexer.next(),UnaryExpr.parse(lexer)):UnionExpr.parse(lexer)},UnaryExpr.prototype=new BaseExpr,UnaryExpr.prototype.datatype="number",UnaryExpr.prototype.evaluate=function(ctx){return-this.expr.number(ctx)},UnaryExpr.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"unary: "+this.op+"\n",indent+="    ",t+=this.expr.show(indent)},!window.UnionExpr&&window.defaultConfig&&(window.UnionExpr=null),UnionExpr=function(){this.paths=[]},UnionExpr.ops={"|":1},UnionExpr.parse=function(lexer){var union,expr;if(expr=PathExpr.parse(lexer),!this.ops[lexer.peek()])return expr;for(union=new UnionExpr,union.path(expr);;){if(!this.ops[lexer.next()])break;if(lexer.empty())throw Error("missing next union location path");union.path(PathExpr.parse(lexer))}return lexer.back(),union},UnionExpr.prototype=new BaseExpr,UnionExpr.prototype.datatype="nodeset",UnionExpr.prototype.evaluate=function(ctx){for(var paths=this.paths,nodeset=new NodeSet,i=0,l=paths.length;i<l;i++){var exrs=paths[i].evaluate(ctx);if(!exrs.isNodeSet)throw Error("PathExpr must be nodeset");nodeset.merge(exrs)}return nodeset},UnionExpr.prototype.path=function(path){this.paths.push(path),path.needContextPosition&&(this.needContextPosition=!0),path.needContextNode&&(this.needContextNode=!0)},UnionExpr.prototype.show=function(indent){indent=indent||"";var t="";t+=indent+"union:\n",indent+="    ";for(var i=0;i<this.paths.length;i++)t+=this.paths[i].show(indent);return t},!window.PathExpr&&window.defaultConfig&&(window.PathExpr=null),PathExpr=function(filter){this.filter=filter,this.steps=[],this.datatype=filter.datatype,this.needContextPosition=filter.needContextPosition,this.needContextNode=filter.needContextNode},PathExpr.ops={"//":1,"/":1},PathExpr.parse=function(lexer){var op,expr,path,token;if(this.ops[lexer.peek()]){if(op=lexer.next(),token=lexer.peek(),"/"==op&&(lexer.empty()||"."!=token&&".."!=token&&"@"!=token&&"*"!=token&&!/(?![0-9])[\w]/.test(token)))return FilterExpr.root();if(path=new PathExpr(FilterExpr.root()),lexer.empty())throw Error("missing next location step");expr=Step.parse(lexer),path.step(op,expr)}else if(expr=FilterExpr.parse(lexer)){if(!this.ops[lexer.peek()])return expr;path=new PathExpr(expr)}else expr=Step.parse(lexer),path=new PathExpr(FilterExpr.context()),path.step("/",expr);for(;;){if(!this.ops[lexer.peek()])break;if(op=lexer.next(),lexer.empty())throw Error("missing next location step");path.step(op,Step.parse(lexer))}return path},PathExpr.prototype=new BaseExpr,PathExpr.prototype.evaluate=function(ctx){var nodeset=this.filter.evaluate(ctx);if(!nodeset.isNodeSet)throw Exception("Filter nodeset must be nodeset type");for(var steps=this.steps,i=0,l0=steps.length;i<l0&&nodeset.length;i++){var step=steps[i][1],reverse=step.reverse,iter=nodeset.iterator(reverse),prevNodeset=nodeset;nodeset=null;var node,next;if(step.needContextPosition||"following"!=step.axis)if(step.needContextPosition||"preceding"!=step.axis){node=iter();var j=0;for(nodeset=step.evaluate(new Ctx(node),!1,prevNodeset,j);node=iter();)j++,nodeset.merge(step.evaluate(new Ctx(node),!1,prevNodeset,j))}else node=iter(),nodeset=step.evaluate(new Ctx(node));else{for(node=iter();next=iter();node=next)if(uai.applewebkit2){var contains=!1,ancestor=next;do{if(ancestor==node){contains=!0;break}}while(ancestor=ancestor.parentNode);if(!contains)break}else try{if(!node.contains(next))break}catch(e){if(!(8&next.compareDocumentPosition(node)))break}nodeset=step.evaluate(new Ctx(node))}}return nodeset},PathExpr.prototype.step=function(op,step){if(step.op=op,this.steps.push([op,step]),this.quickAttr=!1,1==this.steps.length&&"/"==op&&"attribute"==step.axis){var test=step.test;test.notOnlyElement||"*"==test.name||(this.quickAttr=!0,this.attrName=test.name)}},PathExpr.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"path:\n",indent+="    ",t+=indent+"filter:\n",t+=this.filter.show(indent+"    "),this.steps.length){t+=indent+"steps:\n",indent+="    ";for(var i=0;i<this.steps.length;i++){var step=this.steps[i];t+=indent+"operator: "+step[0]+"\n",t+=step[1].show(indent)}}return t},!window.FilterExpr&&window.defaultConfig&&(window.FilterExpr=null),FilterExpr=function(primary){this.primary=primary,this.predicates=[],this.datatype=primary.datatype,this.needContextPosition=primary.needContextPosition,this.needContextNode=primary.needContextNode},FilterExpr.parse=function(lexer){var expr,filter,token,ch;switch(token=lexer.peek(),ch=token.charAt(0)){case"$":expr=VariableReference.parse(lexer);break;case"(":if(lexer.next(),expr=BinaryExpr.parse(lexer),lexer.empty())throw Error('unclosed "("');if(")"!=lexer.next())throw lexer.back(),Error("bad token: "+lexer.next());break;case'"':case"'":expr=Literal.parse(lexer);break;default:if(isNaN(+token)){if(NodeType.types[token])return null;if(!/(?![0-9])[\w]/.test(ch)||"("!=lexer.peek(1))return null;expr=FunctionCall.parse(lexer)}else expr=Number.parse(lexer)}return"["!=lexer.peek()?expr:(filter=new FilterExpr(expr),BaseExprHasPredicates.parsePredicates(lexer,filter),filter)},FilterExpr.root=function(){return new FunctionCall("root-node")},FilterExpr.context=function(){return new FunctionCall("context-node")},FilterExpr.prototype=new BaseExprHasPredicates,FilterExpr.prototype.evaluate=function(ctx){var nodeset=this.primary.evaluate(ctx);if(!nodeset.isNodeSet){if(this.predicates.length)throw Error("Primary result must be nodeset type if filter have predicate expression");return nodeset}return this.evaluatePredicates(nodeset)},FilterExpr.prototype.predicate=function(predicate){this.predicates.push(predicate)},FilterExpr.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"filter: \n",indent+="    ",t+=this.primary.show(indent),this.predicates.length){t+=indent+"predicates: \n",indent+="    ";for(var i=0;i<this.predicates.length;i++)t+=this.predicates[i].show(indent)}return t},!window.NodeUtil&&window.defaultConfig&&(window.NodeUtil=null),NodeUtil={to:function(valueType,node){var t,type=node.nodeType;if(1==type&&config.useInnerText&&!uai.applewebkit2&&(t=node.textContent,t=t==undefined||null==t?node.innerText:t,t=t==undefined||null==t?"":t),"string"!=typeof t)if(9==type||1==type)for(node=9==type?node.documentElement:node.firstChild,t="",stack=[],i=0;node;){do{1!=node.nodeType&&(t+=node.nodeValue),stack[i++]=node}while(node=node.firstChild);for(;i&&!(node=stack[--i].nextSibling););}else t=node.nodeValue;switch(valueType){case"number":return+t;case"boolean":return!!t;default:return t}},attrPropMap:{name:"name",class:"className",dir:"dir",id:"id",name:"name",title:"title"},attrMatch:function(node,attrName,attrValue){return!!(!attrName||null==attrValue&&node.hasAttribute&&node.hasAttribute(attrName)||null!=attrValue&&node.getAttribute&&node.getAttribute(attrName)==attrValue)},getDescendantNodes:function(test,node,nodeset,attrName,attrValue,prevNodeset,prevIndex){if(prevNodeset&&prevNodeset.delDescendant(node,prevIndex),attrValue&&"id"==attrName&&node.getElementById)(node=node.getElementById(attrValue))&&test.match(node)&&nodeset.push(node);else if(attrValue&&"name"==attrName&&node.getElementsByName)for(var nodes=node.getElementsByName(attrValue),i=0,l=nodes.length;i<l;i++)node=nodes[i],(uai.opera?node.name==attrValue&&test.match(node):test.match(node))&&nodeset.push(node);else if(attrValue&&"class"==attrName&&node.getElementsByClassName)for(var nodes=node.getElementsByClassName(attrValue),i=0,l=nodes.length;i<l;i++)node=nodes[i],node.className==attrValue&&test.match(node)&&nodeset.push(node);else if(test.notOnlyElement)!function(parent){for(var f=arguments.callee,node=parent.firstChild;node;node=node.nextSibling)NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node.nodeType)&&nodeset.push(node),f(node)}(node);else{var name=test.name;if(node.getElementsByTagName){var nodes=node.getElementsByTagName(name);if(nodes)for(var i=0;node=nodes[i++];)NodeUtil.attrMatch(node,attrName,attrValue)&&nodeset.push(node)}}return nodeset},getChildNodes:function(test,node,nodeset,attrName,attrValue){for(var node=node.firstChild;node;node=node.nextSibling)NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node)&&nodeset.push(node);return nodeset}},!window.Step&&window.defaultConfig&&(window.Step=null),Step=function(axis,test){this.axis=axis,this.reverse=Step.axises[axis][0],this.func=Step.axises[axis][1],this.test=test,this.predicates=[],this._quickAttr=Step.axises[axis][2]},Step.axises={ancestor:[!0,function(test,node,nodeset,_,__,prevNodeset,prevIndex){for(;node=node.parentNode;)prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex,!0),test.match(node)&&nodeset.unshift(node);return nodeset}],"ancestor-or-self":[!0,function(test,node,nodeset,_,__,prevNodeset,prevIndex){do{prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex,!0),test.match(node)&&nodeset.unshift(node)}while(node=node.parentNode);return nodeset}],attribute:[!1,function(test,node,nodeset){var attrs=node.attributes;if(attrs)if(test.notOnlyElement&&0==test.type||"*"==test.name)for(var attr,i=0;attr=attrs[i];i++)nodeset.push(attr);else{var attr=attrs.getNamedItem(test.name);attr&&nodeset.push(attr)}return nodeset}],child:[!1,NodeUtil.getChildNodes,!0],descendant:[!1,NodeUtil.getDescendantNodes,!0],"descendant-or-self":[!1,function(test,node,nodeset,attrName,attrValue,prevNodeset,prevIndex){return NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node)&&nodeset.push(node),NodeUtil.getDescendantNodes(test,node,nodeset,attrName,attrValue,prevNodeset,prevIndex)},!0],following:[!1,function(test,node,nodeset,attrName,attrValue){do{for(var child=node;child=child.nextSibling;)NodeUtil.attrMatch(child,attrName,attrValue)&&test.match(child)&&nodeset.push(child),nodeset=NodeUtil.getDescendantNodes(test,child,nodeset,attrName,attrValue)}while(node=node.parentNode);return nodeset},!0],"following-sibling":[!1,function(test,node,nodeset,_,__,prevNodeset,prevIndex){for(;node=node.nextSibling;)prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex),test.match(node)&&nodeset.push(node);return nodeset}],namespace:[!1,function(test,node,nodeset){return nodeset}],parent:[!1,function(test,node,nodeset){if(9==node.nodeType)return nodeset;if(2==node.nodeType)return nodeset.push(node.ownerElement),nodeset;var node=node.parentNode;return test.match(node)&&nodeset.push(node),nodeset}],preceding:[!0,function(test,node,nodeset,attrName,attrValue){var parents=[];do{parents.unshift(node)}while(node=node.parentNode);for(var i=1,l0=parents.length;i<l0;i++){
var siblings=[];for(node=parents[i];node=node.previousSibling;)siblings.unshift(node);for(var j=0,l1=siblings.length;j<l1;j++)node=siblings[j],NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node)&&nodeset.push(node),nodeset=NodeUtil.getDescendantNodes(test,node,nodeset,attrName,attrValue)}return nodeset},!0],"preceding-sibling":[!0,function(test,node,nodeset,_,__,prevNodeset,prevIndex){for(;node=node.previousSibling;)prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex,!0),test.match(node)&&nodeset.unshift(node);return nodeset}],self:[!1,function(test,node,nodeset){return test.match(node)&&nodeset.push(node),nodeset}]},Step.parse=function(lexer){var axis,test,step,token;if("."==lexer.peek())step=this.self(),lexer.next();else if(".."==lexer.peek())step=this.parent(),lexer.next();else{if("@"==lexer.peek()){if(axis="attribute",lexer.next(),lexer.empty())throw Error("missing attribute name")}else if("::"==lexer.peek(1)){if(!/(?![0-9])[\w]/.test(lexer.peek().charAt(0)))throw Error("bad token: "+lexer.next());if(axis=lexer.next(),lexer.next(),!this.axises[axis])throw Error("invalid axis: "+axis);if(lexer.empty())throw Error("missing node name")}else axis="child";if(token=lexer.peek(),/(?![0-9])[\w]/.test(token.charAt(0)))if("("==lexer.peek(1)){if(!NodeType.types[token])throw Error("invalid node type: "+token);test=NodeType.parse(lexer)}else test=NameTest.parse(lexer);else{if("*"!=token)throw Error("bad token: "+lexer.next());test=NameTest.parse(lexer)}step=new Step(axis,test)}return BaseExprHasPredicates.parsePredicates(lexer,step),step},Step.self=function(){return new Step("self",new NodeType("node"))},Step.parent=function(){return new Step("parent",new NodeType("node"))},Step.prototype=new BaseExprHasPredicates,Step.prototype.evaluate=function(ctx,special,prevNodeset,prevIndex){var node=ctx.node;if(special||"//"!=this.op){if(this.needContextPosition&&(prevNodeset=null,prevIndex=null),this.quickAttr){var attrValue=this.attrValueExpr?this.attrValueExpr.string(ctx):null,nodeset=this.func(this.test,node,new NodeSet,this.attrName,attrValue,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset,1)}else{var nodeset=this.func(this.test,node,new NodeSet,null,null,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset)}prevNodeset&&prevNodeset.doDel()}else if(this.needContextPosition||"child"!=this.axis){var step=new Step("descendant-or-self",new NodeType("node")),nodes=step.evaluate(ctx,!1,prevNodeset,prevIndex).list(),nodeset=null;step.op="/";for(var i=0,l=nodes.length;i<l;i++)nodeset?nodeset.merge(this.evaluate(new Ctx(nodes[i]),!0)):nodeset=this.evaluate(new Ctx(nodes[i]),!0);nodeset=nodeset||new NodeSet}else if(this.quickAttr){var attrValue=this.attrValueExpr?this.attrValueExpr.string(ctx):null,nodeset=NodeUtil.getDescendantNodes(this.test,node,new NodeSet,this.attrName,attrValue,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset,1)}else{var nodeset=NodeUtil.getDescendantNodes(this.test,node,new NodeSet,null,null,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset)}return nodeset},Step.prototype.predicate=function(predicate){if(this.predicates.push(predicate),(predicate.needContextPosition||"number"==predicate.datatype||"void"==predicate.datatype)&&(this.needContextPosition=!0),this._quickAttr&&1==this.predicates.length&&predicate.quickAttr){var attrName=predicate.attrName;this.attrName=attrName,this.attrValueExpr=predicate.attrValueExpr,this.quickAttr=!0}},Step.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"step: \n",indent+="    ",this.axis&&(t+=indent+"axis: "+this.axis+"\n"),t+=this.test.show(indent),this.predicates.length){t+=indent+"predicates: \n",indent+="    ";for(var i=0;i<this.predicates.length;i++)t+=this.predicates[i].show(indent)}return t},!window.NodeType&&window.defaultConfig&&(window.NodeType=null),NodeType=function(name,literal){switch(this.name=name,this.literal=literal,name){case"comment":this.type=8;break;case"text":this.type=3;break;case"processing-instruction":this.type=7;break;case"node":this.type=0}},NodeType.types={comment:1,text:1,"processing-instruction":1,node:1},NodeType.parse=function(lexer){var type,literal,ch;if(type=lexer.next(),lexer.next(),lexer.empty())throw Error("bad nodetype");if(ch=lexer.peek().charAt(0),'"'!=ch&&"'"!=ch||(literal=Literal.parse(lexer)),lexer.empty())throw Error("bad nodetype");if(")"!=lexer.next())throw lexer.back(),Error("bad token "+lexer.next());return new NodeType(type,literal)},NodeType.prototype=new BaseExpr,NodeType.prototype.notOnlyElement=!0,NodeType.prototype.match=function(node){return!this.type||this.type==node.nodeType},NodeType.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"nodetype: "+this.type+"\n",this.literal&&(indent+="    ",t+=this.literal.show(indent)),t},!window.NameTest&&window.defaultConfig&&(window.NameTest=null),NameTest=function(name){this.name=name.toLowerCase()},NameTest.parse=function(lexer){return new NameTest("*"!=lexer.peek()&&":"==lexer.peek(1)&&"*"==lexer.peek(2)?lexer.next()+lexer.next()+lexer.next():lexer.next())},NameTest.prototype=new BaseExpr,NameTest.prototype.match=function(node){var type=node.nodeType;return!(1!=type&&2!=type||"*"!=this.name&&this.name!=node.nodeName.toLowerCase())},NameTest.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"nametest: "+this.name+"\n"},!window.VariableReference&&window.defaultConfig&&(window.VariableReference=null),VariableReference=function(name){this.name=name.substring(1)},VariableReference.parse=function(lexer){var token=lexer.next();if(token.length<2)throw Error("unnamed variable reference");return new VariableReference(token)},VariableReference.prototype=new BaseExpr,VariableReference.prototype.datatype="void",VariableReference.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"variable: "+this.name+"\n"},!window.Literal&&window.defaultConfig&&(window.Literal=null),Literal=function(text){this.text=text.substring(1,text.length-1)},Literal.parse=function(lexer){var token=lexer.next();if(token.length<2)throw Error("unclosed literal string");return new Literal(token)},Literal.prototype=new BaseExpr,Literal.prototype.datatype="string",Literal.prototype.evaluate=function(ctx){return this.text},Literal.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"literal: "+this.text+"\n"},!window.Number&&window.defaultConfig&&(window.Number=null),Number=function(digit){this.digit=+digit},Number.parse=function(lexer){return new Number(lexer.next())},Number.prototype=new BaseExpr,Number.prototype.datatype="number",Number.prototype.evaluate=function(ctx){return this.digit},Number.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"number: "+this.digit+"\n"},!window.FunctionCall&&window.defaultConfig&&(window.FunctionCall=null),FunctionCall=function(name){var info=FunctionCall.funcs[name];if(!info)throw Error(name+" is not a function");this.name=name,this.func=info[0],this.args=[],this.datatype=info[1],info[2]&&(this.needContextPosition=!0),this.needContextNodeInfo=info[3],this.needContextNode=this.needContextNodeInfo[0]},FunctionCall.funcs={"context-node":[function(){if(0!=arguments.length)throw Error("Function context-node expects ()");var ns;return ns=new NodeSet,ns.push(this.node),ns},"nodeset",!1,[!0]],"root-node":[function(){if(0!=arguments.length)throw Error("Function root-node expects ()");var ns,ctxn;return ns=new NodeSet,ctxn=this.node,9==ctxn.nodeType?ns.push(ctxn):ns.push(ctxn.ownerDocument),ns},"nodeset",!1,[]],last:[function(){if(0!=arguments.length)throw Error("Function last expects ()");return this.last},"number",!0,[]],position:[function(){if(0!=arguments.length)throw Error("Function position expects ()");return this.position},"number",!0,[]],count:[function(ns){if(1!=arguments.length||!(ns=ns.evaluate(this)).isNodeSet)throw Error("Function count expects (nodeset)");return ns.length},"number",!1,[]],id:[function(s){var ids,ns,i,id,elm,ctxn,doc;if(1!=arguments.length)throw Error("Function id expects (object)");for(ctxn=this.node,doc=9==ctxn.nodeType?ctxn:ctxn.ownerDocument,s=s.string(this),ids=s.split(/\s+/),ns=new NodeSet,i=0,l=ids.length;i<l;i++)if(id=ids[i],elm=doc.getElementById(id),uai.opera&&elm&&elm.id!=id)for(var elms=doc.getElementsByName(id),j=0,l0=elms.length;j<l0;j++)elm=elms[j],elm.id==id&&ns.push(elm);else elm&&ns.push(elm);return ns.isSorted=!1,ns},"nodeset",!1,[]],"local-name":[function(ns){var nd;switch(arguments.length){case 0:nd=this.node;break;case 1:if((ns=ns.evaluate(this)).isNodeSet){nd=ns.first();break}default:throw Error("Function local-name expects (nodeset?)")}return""+nd.nodeName.toLowerCase()},"string",!1,[!0,!1]],name:[function(ns){return FunctionCall.funcs["local-name"][0].apply(this,arguments)},"string",!1,[!0,!1]],"namespace-uri":[function(ns){return""},"string",!1,[!0,!1]],string:[function(s){switch(arguments.length){case 0:s=NodeUtil.to("string",this.node);break;case 1:s=s.string(this);break;default:throw Error("Function string expects (object?)")}return s},"string",!1,[!0,!1]],concat:[function(s1,s2){if(arguments.length<2)throw Error("Function concat expects (string, string[, ...])");for(var t="",i=0,l=arguments.length;i<l;i++)t+=arguments[i].string(this);return t},"string",!1,[]],"starts-with":[function(s1,s2){if(2!=arguments.length)throw Error("Function starts-with expects (string, string)");return s1=s1.string(this),s2=s2.string(this),0==s1.indexOf(s2)},"boolean",!1,[]],contains:[function(s1,s2){if(2!=arguments.length)throw Error("Function contains expects (string, string)");return s1=s1.string(this),s2=s2.string(this),-1!=s1.indexOf(s2)},"boolean",!1,[]],substring:[function(s,n1,n2){var a1,a2;switch(s=s.string(this),n1=n1.number(this),arguments.length){case 2:n2=s.length-n1+1;break;case 3:n2=n2.number(this);break;default:throw Error("Function substring expects (string, string)")}return n1=Math.round(n1),n2=Math.round(n2),a1=n1-1,a2=n1+n2-1,a2==1/0?s.substring(a1<0?0:a1):s.substring(a1<0?0:a1,a2)},"string",!1,[]],"substring-before":[function(s1,s2){var n;if(2!=arguments.length)throw Error("Function substring-before expects (string, string)");return s1=s1.string(this),s2=s2.string(this),n=s1.indexOf(s2),-1==n?"":s1.substring(0,n)},"string",!1,[]],"substring-after":[function(s1,s2){if(2!=arguments.length)throw Error("Function substring-after expects (string, string)");s1=s1.string(this),s2=s2.string(this);var n=s1.indexOf(s2);return-1==n?"":s1.substring(n+s2.length)},"string",!1,[]],"string-length":[function(s){switch(arguments.length){case 0:s=NodeUtil.to("string",this.node);break;case 1:s=s.string(this);break;default:throw Error("Function string-length expects (string?)")}return s.length},"number",!1,[!0,!1]],"normalize-space":[function(s){switch(arguments.length){case 0:s=NodeUtil.to("string",this.node);break;case 1:s=s.string(this);break;default:throw Error("Function normalize-space expects (string?)")}return s.replace(/\s+/g," ").replace(/^ /,"").replace(/ $/,"")},"string",!1,[!0,!1]],translate:[function(s1,s2,s3){if(3!=arguments.length)throw Error("Function translate expects (string, string, string)");s1=s1.string(this),s2=s2.string(this),s3=s3.string(this);for(var map=[],i=0,l=s2.length;i<l;i++){var ch=s2.charAt(i);map[ch]||(map[ch]=s3.charAt(i)||"")}for(var t="",i=0,l=s1.length;i<l;i++){var ch=s1.charAt(i),replace=map[ch];t+=replace!=undefined?replace:ch}return t},"string",!1,[]],boolean:[function(b){if(1!=arguments.length)throw Error("Function boolean expects (object)");return b.bool(this)},"boolean",!1,[]],not:[function(b){if(1!=arguments.length)throw Error("Function not expects (object)");return!b.bool(this)},"boolean",!1,[]],true:[function(){if(0!=arguments.length)throw Error("Function true expects ()");return!0},"boolean",!1,[]],false:[function(){if(0!=arguments.length)throw Error("Function false expects ()");return!1},"boolean",!1,[]],lang:[function(s){return!1},"boolean",!1,[]],number:[function(n){switch(arguments.length){case 0:n=NodeUtil.to("number",this.node);break;case 1:n=n.number(this);break;default:throw Error("Function number expects (object?)")}return n},"number",!1,[!0,!1]],sum:[function(ns){var nodes,n,i,l;if(1!=arguments.length||!(ns=ns.evaluate(this)).isNodeSet)throw Error("Function sum expects (nodeset)");for(nodes=ns.list(),n=0,i=0,l=nodes.length;i<l;i++)n+=NodeUtil.to("number",nodes[i]);return n},"number",!1,[]],floor:[function(n){if(1!=arguments.length)throw Error("Function floor expects (number)");return n=n.number(this),Math.floor(n)},"number",!1,[]],ceiling:[function(n){if(1!=arguments.length)throw Error("Function ceiling expects (number)");return n=n.number(this),Math.ceil(n)},"number",!1,[]],round:[function(n){if(1!=arguments.length)throw Error("Function round expects (number)");return n=n.number(this),Math.round(n)},"number",!1,[]]},FunctionCall.parse=function(lexer){var expr,func=new FunctionCall(lexer.next());for(lexer.next();")"!=lexer.peek();){if(lexer.empty())throw Error("missing function argument list");if(expr=BinaryExpr.parse(lexer),func.arg(expr),","!=lexer.peek())break;lexer.next()}if(lexer.empty())throw Error("unclosed function argument list");if(")"!=lexer.next())throw lexer.back(),Error("bad token: "+lexer.next());return func},FunctionCall.prototype=new BaseExpr,FunctionCall.prototype.evaluate=function(ctx){return this.func.apply(ctx,this.args)},FunctionCall.prototype.arg=function(arg){this.args.push(arg),arg.needContextPosition&&(this.needContextPosition=!0);var args=this.args;arg.needContextNode&&(args.needContexNode=!0),this.needContextNode=args.needContextNode||this.needContextNodeInfo[args.length]},FunctionCall.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"function: "+this.name+"\n",indent+="    ",this.args.length){t+=indent+"arguments: \n",indent+="    ";for(var i=0;i<this.args.length;i++)t+=this.args[i].show(indent)}return t};var NodeID={uuid:1,get:function(node){return node.__jsxpath_id__||(node.__jsxpath_id__=this.uuid++)}};!window.NodeSet&&window.defaultConfig&&(window.NodeSet=null),NodeSet=function(){this.length=0,this.nodes=[],this.seen={},this.idIndexMap=null,this.reserveDels=[]},NodeSet.prototype.isNodeSet=!0,NodeSet.prototype.isSorted=!0,NodeSet.prototype.merge=function(nodeset){if(this.isSorted=!1,nodeset.only)return this.push(nodeset.only);if(this.only){var only=this.only;delete this.only,this.push(only),this.length--}for(var nodes=nodeset.nodes,i=0,l=nodes.length;i<l;i++)this._add(nodes[i])},NodeSet.prototype.sort=function(){if(!this.only&&!this.sortOff&&!this.isSorted){this.isSorted=!0,this.idIndexMap=null;this.nodes.sort(function(a,b){if(a==b)return 0;if(a.compareDocumentPosition){var result=a.compareDocumentPosition(b);return 2&result?1:4&result?-1:0}for(var node1=a,node2=b,ancestor1=a,ancestor2=b,deep1=0,deep2=0;ancestor1=ancestor1.parentNode;)deep1++;for(;ancestor2=ancestor2.parentNode;)deep2++;if(deep1>deep2){for(;deep1--!=deep2;)node1=node1.parentNode;if(node1==node2)return 1}else if(deep2>deep1){for(;deep2--!=deep1;)node2=node2.parentNode;if(node1==node2)return-1}for(;(ancestor1=node1.parentNode)!=(ancestor2=node2.parentNode);)node1=ancestor1,node2=ancestor2;for(;node1=node1.nextSibling;)if(node1==node2)return-1;return 1})}},NodeSet.prototype.reserveDelByNodeID=function(id,offset,reverse){var index,map=this.createIdIndexMap();if((index=map[id])&&(reverse&&this.length-offset-1>index||!reverse&&offset<index)){var obj={value:index,order:String.fromCharCode(index),toString:function(){return this.order},valueOf:function(){return this.value}};this.reserveDels.push(obj)}},NodeSet.prototype.reserveDelByNode=function(node,offset,reverse){this.reserveDelByNodeID(NodeID.get(node),offset,reverse)},NodeSet.prototype.doDel=function(){if(this.reserveDels.length){if(this.length<65536)var dels=this.reserveDels.sort(function(a,b){return b-a});else var dels=this.reserveDels.sort(function(a,b){return b-a});for(var i=0,l=dels.length;i<l;i++)this.del(dels[i]);this.reserveDels=[],this.idIndexMap=null}},NodeSet.prototype.createIdIndexMap=function(){if(this.idIndexMap)return this.idIndexMap;for(var map=this.idIndexMap={},nodes=this.nodes,i=0,l=nodes.length;i<l;i++){var node=nodes[i];map[NodeID.get(node)]=i}return map},NodeSet.prototype.del=function(index){if(this.length--,this.only)delete this.only;else{var node=this.nodes.splice(index,1)[0];this._first==node&&(delete this._first,delete this._firstSourceIndex,delete this._firstSubIndex),delete this.seen[NodeID.get(node)]}},NodeSet.prototype.delDescendant=function(elm,offset){if(!this.only){var nodeType=elm.nodeType;if((1==nodeType||9==nodeType)&&!uai.applewebkit2){if(!elm.contains)if(1==nodeType){var _elm=elm;elm={contains:function(node){return 8&node.compareDocumentPosition(_elm)}}}else elm={contains:function(){return!0}};for(var nodes=this.nodes,i=offset+1;i<nodes.length;i++)elm.contains(nodes[i])&&(this.del(i),i--)}}},NodeSet.prototype._add=function(node,reverse){var seen=this.seen,id=NodeID.get(node);if(seen[id])return!0;seen[id]=!0,this.length++,reverse?this.nodes.unshift(node):this.nodes.push(node)},NodeSet.prototype.unshift=function(node){if(!this.length)return this.length++,void(this.only=node);if(this.only){var only=this.only;delete this.only,this.unshift(only),this.length--}return this._add(node,!0)},NodeSet.prototype.push=function(node){if(!this.length)return this.length++,void(this.only=node);if(this.only){var only=this.only;delete this.only,this.push(only),this.length--}return this._add(node)},NodeSet.prototype.first=function(){return this.only?this.only:(this.nodes.length>1&&this.sort(),this.nodes[0])},NodeSet.prototype.list=function(){return this.only?[this.only]:(this.sort(),this.nodes)},NodeSet.prototype.string=function(){var node=this.only||this.first();return node?NodeUtil.to("string",node):""},NodeSet.prototype.bool=function(){return!(!this.length&&!this.only)},NodeSet.prototype.number=function(){return+this.string()},NodeSet.prototype.iterator=function(reverse){this.sort();var nodeset=this;if(reverse){var count=0;return function(){var index=nodeset.length-count++-1;return nodeset.only&&0==index?nodeset.only:nodeset.nodes[index]}}var count=0;return function(){return nodeset.only&&0==count++?nodeset.only:nodeset.nodes[count++]}};var win,install=function(win){win=win||this;var doc=win.document;win.undefined;win.XPathExpression=function(expr){if(!expr.length)throw win.Error("no expression");var lexer=this.lexer=Lexer(expr);if(lexer.empty())throw win.Error("no expression");if(this.expr=BinaryExpr.parse(lexer),!lexer.empty())throw win.Error("bad token: "+lexer.next())},win.XPathExpression.prototype.evaluate=function(node,type){return new win.XPathResult(this.expr.evaluate(new Ctx(node)),type)},win.XPathResult=function(value,type){if(0==type)switch(typeof value){case"object":type++;case"boolean":type++;case"string":type++;case"number":type++}switch(this.resultType=type,type){case 1:return void(this.numberValue=value.isNodeSet?value.number():+value);case 2:return void(this.stringValue=value.isNodeSet?value.string():""+value);case 3:return void(this.booleanValue=value.isNodeSet?value.bool():!!value);case 4:case 5:case 6:case 7:this.nodes=value.list(),this.snapshotLength=value.length,this.index=0,this.invalidIteratorState=!1;break;case 8:case 9:return void(this.singleNodeValue=value.first())}},win.XPathResult.prototype.iterateNext=function(){return this.nodes[this.index++]||null},win.XPathResult.prototype.snapshotItem=function(i){return this.nodes[i]||null},win.XPathResult.ANY_TYPE=0,win.XPathResult.NUMBER_TYPE=1,win.XPathResult.STRING_TYPE=2,win.XPathResult.BOOLEAN_TYPE=3,win.XPathResult.UNORDERED_NODE_ITERATOR_TYPE=4,win.XPathResult.ORDERED_NODE_ITERATOR_TYPE=5,win.XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE=6,win.XPathResult.ORDERED_NODE_SNAPSHOT_TYPE=7,win.XPathResult.ANY_UNORDERED_NODE_TYPE=8,win.XPathResult.FIRST_ORDERED_NODE_TYPE=9,doc.createExpression=function(expr){return new win.XPathExpression(expr,null)},doc.evaluate=function(expr,context,_,type){return doc.createExpression(expr,null).evaluate(context,type)}};if(config.targetFrame){var frame=document.getElementById(config.targetFrame);frame&&(win=frame.contentWindow)}config.exportInstaller&&(window.install=install),config.hasNative&&config.useNative||install(win||window)}}(),function(){if(!this._QTP||!this._QTP.wnd){var qtpProps={};qtpProps.wnd=this.window,qtpProps.window={},qtpProps.window.document={},qtpProps.window.undefined=void 0,qtpProps.wnd&&qtpProps.wnd.XPathResult&&(qtpProps.window.XPathResult=qtpProps.wnd.XPathResult);var document=null,window=qtpProps.window,navigator=null;"undefined"!=typeof _qtp_inject_xpath&&1!=_qtp_inject_xpath||(qtpProps.XPathInjector=function(){var undefined=void 0,defaultConfig={targetFrame:undefined,exportInstaller:!1,useNative:!0,useInnerText:!0},config={};for(var n in defaultConfig)n in config||(config[n]=defaultConfig[n]);if(config.hasNative=!!(document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("XPath",null)),!config.hasNative||!config.useNative||config.exportInstaller){var BinaryExpr,FilterExpr,FunctionCall,Literal,NameTest,NodeSet,NodeType,NodeUtil,Number,PathExpr,Step,UnaryExpr,UnionExpr,VariableReference,uai=new function(){var ua=navigator.userAgent;if(RegExp==undefined)ua.indexOf("Opera")>=0?this.opera=!0:ua.indexOf("Netscape")>=0?this.netscape=!0:0==ua.indexOf("Mozilla/")?this.mozilla=!0:this.unknown=!0,ua.indexOf("Gecko/")>=0&&(this.gecko=!0),ua.indexOf("Win")>=0?this.windows=!0:ua.indexOf("Mac")>=0?this.mac=!0:ua.indexOf("Linux")>=0?this.linux=!0:ua.indexOf("BSD")>=0?this.bsd=!0:ua.indexOf("SunOS")>=0&&(this.sunos=!0);else if(/AppleWebKit\/(\d+(?:\.\d+)*)/.test(ua)?(this.applewebkit=RegExp.$1,4==RegExp.$1.charAt(0)?this.applewebkit2=!0:this.applewebkit3=!0):"object"==typeof Components&&(/Gecko\/(\d{8})/.test(ua)||"Gecko"==navigator.product&&/^(\d{8})$/.test(navigator.productSub))&&(this.gecko=RegExp.$1),"object"==typeof opera&&"function"==typeof opera.version?(this.opera=opera.version(),this["opera"+this.opera[0]+this.opera[2]]=!0):"object"==typeof opera&&/Opera[\/ ](\d+\.\d+)/.test(ua)?this.opera=RegExp.$1:this.ie||(/Safari\/(\d+(?:\.\d+)*)/.test(ua)?this.safari=RegExp.$1:/NetFront\/(\d+(?:\.\d+)*)/.test(ua)?this.netfront=RegExp.$1:/Konqueror\/(\d+(?:\.\d+)*)/.test(ua)?this.konqueror=RegExp.$1:ua.indexOf("(compatible;")<0&&/^Mozilla\/(\d+\.\d+)/.test(ua)?(this.mozilla=RegExp.$1,/\([^(]*rv:(\d+(?:\.\d+)*).*?\)/.test(ua)&&(this.mozillarv=RegExp.$1),/Firefox\/(\d+(?:\.\d+)*)/.test(ua)?this.firefox=RegExp.$1:/Netscape\d?\/(\d+(?:\.\d+)*)/.test(ua)&&(this.netscape=RegExp.$1)):this.unknown=!0),ua.indexOf("Win 9x 4.90")>=0)this.windows="ME";else if(/Win(?:dows)? ?(NT ?(\d+\.\d+)?|\d+|ME|Vista|XP)/.test(ua))if(this.windows=RegExp.$1,RegExp.$2)this.winnt=RegExp.$2;else switch(RegExp.$1){case"2000":this.winnt="5.0";break;case"XP":this.winnt="5.1";break;case"Vista":this.winnt="6.0"}else ua.indexOf("Mac")>=0?this.mac=!0:ua.indexOf("Linux")>=0?this.linux=!0:/(\w*BSD)/.test(ua)?this.bsd=RegExp.$1:ua.indexOf("SunOS")>=0&&(this.sunos=!0)},Lexer=function(source){for(var proto=Lexer.prototype,tokens=source.match(proto.regs.token),i=0,l=tokens.length;i<l;i++)proto.regs.strip.test(tokens[i])&&tokens.splice(i,1);for(var n in proto)tokens[n]=proto[n];return tokens.index=0,tokens};Lexer.prototype.regs={token:/\$?(?:(?![0-9-])[\w-]+:)?(?![0-9-])[\w-]+|\/\/|\.\.|::|\d+(?:\.\d*)?|\.\d+|"[^"]*"|'[^']*'|[!<>]=|(?![0-9-])[\w-]+:\*|\s+|./g,strip:/^\s/},Lexer.prototype.peek=function(i){return this[this.index+(i||0)]},Lexer.prototype.next=function(){return this[this.index++]},Lexer.prototype.back=function(){this.index--},Lexer.prototype.empty=function(){return this.length<=this.index};var Ctx=function(node,position,last){this.node=node,this.position=position||1,this.last=last||1},BaseExpr=function(){};BaseExpr.prototype.number=function(ctx){var exrs=this.evaluate(ctx);return exrs.isNodeSet?exrs.number():+exrs},BaseExpr.prototype.string=function(ctx){var exrs=this.evaluate(ctx);return exrs.isNodeSet?exrs.string():""+exrs},BaseExpr.prototype.bool=function(ctx){var exrs=this.evaluate(ctx);return exrs.isNodeSet?exrs.bool():!!exrs};var BaseExprHasPredicates=function(){};BaseExprHasPredicates.parsePredicates=function(lexer,expr){for(;"["==lexer.peek();){if(lexer.next(),lexer.empty())throw Error("missing predicate expr");var predicate=BinaryExpr.parse(lexer);if(expr.predicate(predicate),lexer.empty())throw Error("unclosed predicate expr");if("]"!=lexer.next())throw lexer.back(),Error("bad token: "+lexer.next())}},BaseExprHasPredicates.prototype=new BaseExpr,BaseExprHasPredicates.prototype.evaluatePredicates=function(nodeset,start){var predicates,predicate,nodes,nodeset,position,reverse;reverse=this.reverse,predicates=this.predicates,nodeset.sort();for(var i=start||0,l0=predicates.length;i<l0;i++){predicate=predicates[i];for(var deleteIndexes=[],nodes=nodeset.list(),j=0,l1=nodes.length;j<l1;j++){switch(position=reverse?l1-j:j+1,exrs=predicate.evaluate(new Ctx(nodes[j],position,l1)),typeof exrs){case"number":exrs=position==exrs;break;case"string":exrs=!!exrs;break;case"object":exrs=exrs.bool()}exrs||deleteIndexes.push(j)}for(var j=deleteIndexes.length-1,l1=0;j>=l1;j--)nodeset.del(deleteIndexes[j])}return nodeset},!window.BinaryExpr&&window.defaultConfig&&(window.BinaryExpr=null),BinaryExpr=function(op,left,right,datatype){this.op=op,this.left=left,this.right=right,this.datatype=BinaryExpr.ops[op][2],this.needContextPosition=left.needContextPosition||right.needContextPosition,this.needContextNode=left.needContextNode||right.needContextNode,"="==this.op&&(right.needContextNode||right.needContextPosition||"nodeset"==right.datatype||"void"==right.datatype||!left.quickAttr?left.needContextNode||left.needContextPosition||"nodeset"==left.datatype||"void"==left.datatype||!right.quickAttr||(this.quickAttr=!0,this.attrName=right.attrName,this.attrValueExpr=left):(this.quickAttr=!0,this.attrName=left.attrName,this.attrValueExpr=right))},BinaryExpr.compare=function(op,comp,left,right,ctx){var type,lnodes,rnodes,nodes,nodeset,primitive;if(left=left.evaluate(ctx),right=right.evaluate(ctx),left.isNodeSet&&right.isNodeSet){lnodes=left.list(),rnodes=right.list();for(var i=0,l0=lnodes.length;i<l0;i++)for(var j=0,l1=rnodes.length;j<l1;j++)if(comp(NodeUtil.to("string",lnodes[i]),NodeUtil.to("string",rnodes[j])))return!0;return!1}if(left.isNodeSet||right.isNodeSet){left.isNodeSet?(nodeset=left,primitive=right):(nodeset=right,primitive=left),nodes=nodeset.list(),type=typeof primitive;for(var i=0,l=nodes.length;i<l;i++)if(comp(NodeUtil.to(type,nodes[i]),primitive))return!0;return!1}return"="==op||"!="==op?"boolean"==typeof left||"boolean"==typeof right?comp(!!left,!!right):"number"==typeof left||"number"==typeof right?comp(+left,+right):comp(left,right):comp(+left,+right)},BinaryExpr.ops={div:[6,function(left,right,ctx){return left.number(ctx)/right.number(ctx)},"number"],mod:[6,function(left,right,ctx){return left.number(ctx)%right.number(ctx)},"number"],"*":[6,function(left,right,ctx){return left.number(ctx)*right.number(ctx)},"number"],"+":[5,function(left,right,ctx){return left.number(ctx)+right.number(ctx)},"number"],"-":[5,function(left,right,ctx){return left.number(ctx)-right.number(ctx)},"number"],"<":[4,function(left,right,ctx){return BinaryExpr.compare("<",function(a,b){return a<b},left,right,ctx)},"boolean"],">":[4,function(left,right,ctx){return BinaryExpr.compare(">",function(a,b){return a>b},left,right,ctx)},"boolean"],"<=":[4,function(left,right,ctx){return BinaryExpr.compare("<=",function(a,b){return a<=b},left,right,ctx)},"boolean"],">=":[4,function(left,right,ctx){return BinaryExpr.compare(">=",function(a,b){return a>=b},left,right,ctx)},"boolean"],"=":[3,function(left,right,ctx){return BinaryExpr.compare("=",function(a,b){return a==b},left,right,ctx)},"boolean"],"!=":[3,function(left,right,ctx){return BinaryExpr.compare("!=",function(a,b){return a!=b},left,right,ctx)},"boolean"],and:[2,function(left,right,ctx){return left.bool(ctx)&&right.bool(ctx)},"boolean"],or:[1,function(left,right,ctx){return left.bool(ctx)||right.bool(ctx)},"boolean"]},BinaryExpr.parse=function(lexer){var op,precedence,info,expr,stack=[];for(lexer.index;;){if(lexer.empty())throw Error("missing right expression");if(expr=UnaryExpr.parse(lexer),!(op=lexer.next()))break;if(info=this.ops[op],!(precedence=info&&info[0])){lexer.back();break}for(;stack.length&&precedence<=this.ops[stack[stack.length-1]][0];)expr=new BinaryExpr(stack.pop(),stack.pop(),expr);stack.push(expr,op)}for(;stack.length;)expr=new BinaryExpr(stack.pop(),stack.pop(),expr);return expr},BinaryExpr.prototype=new BaseExpr,BinaryExpr.prototype.evaluate=function(ctx){return BinaryExpr.ops[this.op][1](this.left,this.right,ctx)},BinaryExpr.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"binary: "+this.op+"\n",indent+="    ",t+=this.left.show(indent),t+=this.right.show(indent)},!window.UnaryExpr&&window.defaultConfig&&(window.UnaryExpr=null),UnaryExpr=function(op,expr){this.op=op,this.expr=expr,this.needContextPosition=expr.needContextPosition,this.needContextNode=expr.needContextNode},UnaryExpr.ops={"-":1},UnaryExpr.parse=function(lexer){return this.ops[lexer.peek()]?new UnaryExpr(lexer.next(),UnaryExpr.parse(lexer)):UnionExpr.parse(lexer)},UnaryExpr.prototype=new BaseExpr,UnaryExpr.prototype.datatype="number",UnaryExpr.prototype.evaluate=function(ctx){return-this.expr.number(ctx)},UnaryExpr.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"unary: "+this.op+"\n",indent+="    ",t+=this.expr.show(indent)},!window.UnionExpr&&window.defaultConfig&&(window.UnionExpr=null),UnionExpr=function(){this.paths=[]},UnionExpr.ops={"|":1},UnionExpr.parse=function(lexer){var union,expr;if(expr=PathExpr.parse(lexer),!this.ops[lexer.peek()])return expr;for(union=new UnionExpr,union.path(expr);;){if(!this.ops[lexer.next()])break;if(lexer.empty())throw Error("missing next union location path");union.path(PathExpr.parse(lexer))}return lexer.back(),union},UnionExpr.prototype=new BaseExpr,UnionExpr.prototype.datatype="nodeset",UnionExpr.prototype.evaluate=function(ctx){for(var paths=this.paths,nodeset=new NodeSet,i=0,l=paths.length;i<l;i++){var exrs=paths[i].evaluate(ctx);if(!exrs.isNodeSet)throw Error("PathExpr must be nodeset");nodeset.merge(exrs)}return nodeset},UnionExpr.prototype.path=function(path){this.paths.push(path),path.needContextPosition&&(this.needContextPosition=!0),path.needContextNode&&(this.needContextNode=!0)},UnionExpr.prototype.show=function(indent){indent=indent||"";var t="";t+=indent+"union:\n",indent+="    ";for(var i=0;i<this.paths.length;i++)t+=this.paths[i].show(indent);return t},!window.PathExpr&&window.defaultConfig&&(window.PathExpr=null),PathExpr=function(filter){this.filter=filter,this.steps=[],this.datatype=filter.datatype,this.needContextPosition=filter.needContextPosition,this.needContextNode=filter.needContextNode},PathExpr.ops={"//":1,"/":1},PathExpr.parse=function(lexer){var op,expr,path,token;if(this.ops[lexer.peek()]){if(op=lexer.next(),token=lexer.peek(),"/"==op&&(lexer.empty()||"."!=token&&".."!=token&&"@"!=token&&"*"!=token&&!/(?![0-9])[\w]/.test(token)))return FilterExpr.root();if(path=new PathExpr(FilterExpr.root()),lexer.empty())throw Error("missing next location step");expr=Step.parse(lexer),path.step(op,expr)}else if(expr=FilterExpr.parse(lexer)){if(!this.ops[lexer.peek()])return expr;path=new PathExpr(expr)}else expr=Step.parse(lexer),path=new PathExpr(FilterExpr.context()),path.step("/",expr);for(;;){if(!this.ops[lexer.peek()])break;if(op=lexer.next(),lexer.empty())throw Error("missing next location step");path.step(op,Step.parse(lexer))}return path},PathExpr.prototype=new BaseExpr,PathExpr.prototype.evaluate=function(ctx){var nodeset=this.filter.evaluate(ctx);if(!nodeset.isNodeSet)throw Exception("Filter nodeset must be nodeset type")
;for(var steps=this.steps,i=0,l0=steps.length;i<l0&&nodeset.length;i++){var step=steps[i][1],reverse=step.reverse,iter=nodeset.iterator(reverse),prevNodeset=nodeset;nodeset=null;var node,next;if(step.needContextPosition||"following"!=step.axis)if(step.needContextPosition||"preceding"!=step.axis){node=iter();var j=0;for(nodeset=step.evaluate(new Ctx(node),!1,prevNodeset,j);node=iter();)j++,nodeset.merge(step.evaluate(new Ctx(node),!1,prevNodeset,j))}else node=iter(),nodeset=step.evaluate(new Ctx(node));else{for(node=iter();next=iter();node=next)if(uai.applewebkit2){var contains=!1,ancestor=next;do{if(ancestor==node){contains=!0;break}}while(ancestor=ancestor.parentNode);if(!contains)break}else try{if(!node.contains(next))break}catch(e){if(!(8&next.compareDocumentPosition(node)))break}nodeset=step.evaluate(new Ctx(node))}}return nodeset},PathExpr.prototype.step=function(op,step){if(step.op=op,this.steps.push([op,step]),this.quickAttr=!1,1==this.steps.length&&"/"==op&&"attribute"==step.axis){var test=step.test;test.notOnlyElement||"*"==test.name||(this.quickAttr=!0,this.attrName=test.name)}},PathExpr.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"path:\n",indent+="    ",t+=indent+"filter:\n",t+=this.filter.show(indent+"    "),this.steps.length){t+=indent+"steps:\n",indent+="    ";for(var i=0;i<this.steps.length;i++){var step=this.steps[i];t+=indent+"operator: "+step[0]+"\n",t+=step[1].show(indent)}}return t},!window.FilterExpr&&window.defaultConfig&&(window.FilterExpr=null),FilterExpr=function(primary){this.primary=primary,this.predicates=[],this.datatype=primary.datatype,this.needContextPosition=primary.needContextPosition,this.needContextNode=primary.needContextNode},FilterExpr.parse=function(lexer){var expr,filter,token,ch;switch(token=lexer.peek(),ch=token.charAt(0)){case"$":expr=VariableReference.parse(lexer);break;case"(":if(lexer.next(),expr=BinaryExpr.parse(lexer),lexer.empty())throw Error('unclosed "("');if(")"!=lexer.next())throw lexer.back(),Error("bad token: "+lexer.next());break;case'"':case"'":expr=Literal.parse(lexer);break;default:if(isNaN(+token)){if(NodeType.types[token])return null;if(!/(?![0-9])[\w]/.test(ch)||"("!=lexer.peek(1))return null;expr=FunctionCall.parse(lexer)}else expr=Number.parse(lexer)}return"["!=lexer.peek()?expr:(filter=new FilterExpr(expr),BaseExprHasPredicates.parsePredicates(lexer,filter),filter)},FilterExpr.root=function(){return new FunctionCall("root-node")},FilterExpr.context=function(){return new FunctionCall("context-node")},FilterExpr.prototype=new BaseExprHasPredicates,FilterExpr.prototype.evaluate=function(ctx){var nodeset=this.primary.evaluate(ctx);if(!nodeset.isNodeSet){if(this.predicates.length)throw Error("Primary result must be nodeset type if filter have predicate expression");return nodeset}return this.evaluatePredicates(nodeset)},FilterExpr.prototype.predicate=function(predicate){this.predicates.push(predicate)},FilterExpr.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"filter: \n",indent+="    ",t+=this.primary.show(indent),this.predicates.length){t+=indent+"predicates: \n",indent+="    ";for(var i=0;i<this.predicates.length;i++)t+=this.predicates[i].show(indent)}return t},!window.NodeUtil&&window.defaultConfig&&(window.NodeUtil=null),NodeUtil={to:function(valueType,node){var t,type=node.nodeType;if(1==type&&config.useInnerText&&!uai.applewebkit2&&(t=node.textContent,t=t==undefined||null==t?node.innerText:t,t=t==undefined||null==t?"":t),"string"!=typeof t)if(9==type||1==type)for(node=9==type?node.documentElement:node.firstChild,t="",stack=[],i=0;node;){do{1!=node.nodeType&&(t+=node.nodeValue),stack[i++]=node}while(node=node.firstChild);for(;i&&!(node=stack[--i].nextSibling););}else t=node.nodeValue;switch(valueType){case"number":return+t;case"boolean":return!!t;default:return t}},attrPropMap:{name:"name",class:"className",dir:"dir",id:"id",name:"name",title:"title"},attrMatch:function(node,attrName,attrValue){return!!(!attrName||null==attrValue&&node.hasAttribute&&node.hasAttribute(attrName)||null!=attrValue&&node.getAttribute&&node.getAttribute(attrName)==attrValue)},getDescendantNodes:function(test,node,nodeset,attrName,attrValue,prevNodeset,prevIndex){if(prevNodeset&&prevNodeset.delDescendant(node,prevIndex),attrValue&&"id"==attrName&&node.getElementById)(node=node.getElementById(attrValue))&&test.match(node)&&nodeset.push(node);else if(attrValue&&"name"==attrName&&node.getElementsByName)for(var nodes=node.getElementsByName(attrValue),i=0,l=nodes.length;i<l;i++)node=nodes[i],(uai.opera?node.name==attrValue&&test.match(node):test.match(node))&&nodeset.push(node);else if(attrValue&&"class"==attrName&&node.getElementsByClassName)for(var nodes=node.getElementsByClassName(attrValue),i=0,l=nodes.length;i<l;i++)node=nodes[i],node.className==attrValue&&test.match(node)&&nodeset.push(node);else if(test.notOnlyElement)!function(parent){for(var f=arguments.callee,node=parent.firstChild;node;node=node.nextSibling)NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node.nodeType)&&nodeset.push(node),f(node)}(node);else{var name=test.name;if(node.getElementsByTagName){var nodes=node.getElementsByTagName(name);if(nodes)for(var i=0;node=nodes[i++];)NodeUtil.attrMatch(node,attrName,attrValue)&&nodeset.push(node)}}return nodeset},getChildNodes:function(test,node,nodeset,attrName,attrValue){for(var node=node.firstChild;node;node=node.nextSibling)NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node)&&nodeset.push(node);return nodeset}},!window.Step&&window.defaultConfig&&(window.Step=null),Step=function(axis,test){this.axis=axis,this.reverse=Step.axises[axis][0],this.func=Step.axises[axis][1],this.test=test,this.predicates=[],this._quickAttr=Step.axises[axis][2]},Step.axises={ancestor:[!0,function(test,node,nodeset,_,__,prevNodeset,prevIndex){for(;node=node.parentNode;)prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex,!0),test.match(node)&&nodeset.unshift(node);return nodeset}],"ancestor-or-self":[!0,function(test,node,nodeset,_,__,prevNodeset,prevIndex){do{prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex,!0),test.match(node)&&nodeset.unshift(node)}while(node=node.parentNode);return nodeset}],attribute:[!1,function(test,node,nodeset){var attrs=node.attributes;if(attrs)if(test.notOnlyElement&&0==test.type||"*"==test.name)for(var attr,i=0;attr=attrs[i];i++)nodeset.push(attr);else{var attr=attrs.getNamedItem(test.name);attr&&nodeset.push(attr)}return nodeset}],child:[!1,NodeUtil.getChildNodes,!0],descendant:[!1,NodeUtil.getDescendantNodes,!0],"descendant-or-self":[!1,function(test,node,nodeset,attrName,attrValue,prevNodeset,prevIndex){return NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node)&&nodeset.push(node),NodeUtil.getDescendantNodes(test,node,nodeset,attrName,attrValue,prevNodeset,prevIndex)},!0],following:[!1,function(test,node,nodeset,attrName,attrValue){do{for(var child=node;child=child.nextSibling;)NodeUtil.attrMatch(child,attrName,attrValue)&&test.match(child)&&nodeset.push(child),nodeset=NodeUtil.getDescendantNodes(test,child,nodeset,attrName,attrValue)}while(node=node.parentNode);return nodeset},!0],"following-sibling":[!1,function(test,node,nodeset,_,__,prevNodeset,prevIndex){for(;node=node.nextSibling;)prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex),test.match(node)&&nodeset.push(node);return nodeset}],namespace:[!1,function(test,node,nodeset){return nodeset}],parent:[!1,function(test,node,nodeset){if(9==node.nodeType)return nodeset;if(2==node.nodeType)return nodeset.push(node.ownerElement),nodeset;var node=node.parentNode;return test.match(node)&&nodeset.push(node),nodeset}],preceding:[!0,function(test,node,nodeset,attrName,attrValue){var parents=[];do{parents.unshift(node)}while(node=node.parentNode);for(var i=1,l0=parents.length;i<l0;i++){var siblings=[];for(node=parents[i];node=node.previousSibling;)siblings.unshift(node);for(var j=0,l1=siblings.length;j<l1;j++)node=siblings[j],NodeUtil.attrMatch(node,attrName,attrValue)&&test.match(node)&&nodeset.push(node),nodeset=NodeUtil.getDescendantNodes(test,node,nodeset,attrName,attrValue)}return nodeset},!0],"preceding-sibling":[!0,function(test,node,nodeset,_,__,prevNodeset,prevIndex){for(;node=node.previousSibling;)prevNodeset&&1==node.nodeType&&prevNodeset.reserveDelByNode(node,prevIndex,!0),test.match(node)&&nodeset.unshift(node);return nodeset}],self:[!1,function(test,node,nodeset){return test.match(node)&&nodeset.push(node),nodeset}]},Step.parse=function(lexer){var axis,test,step,token;if("."==lexer.peek())step=this.self(),lexer.next();else if(".."==lexer.peek())step=this.parent(),lexer.next();else{if("@"==lexer.peek()){if(axis="attribute",lexer.next(),lexer.empty())throw Error("missing attribute name")}else if("::"==lexer.peek(1)){if(!/(?![0-9])[\w]/.test(lexer.peek().charAt(0)))throw Error("bad token: "+lexer.next());if(axis=lexer.next(),lexer.next(),!this.axises[axis])throw Error("invalid axis: "+axis);if(lexer.empty())throw Error("missing node name")}else axis="child";if(token=lexer.peek(),/(?![0-9])[\w]/.test(token.charAt(0)))if("("==lexer.peek(1)){if(!NodeType.types[token])throw Error("invalid node type: "+token);test=NodeType.parse(lexer)}else test=NameTest.parse(lexer);else{if("*"!=token)throw Error("bad token: "+lexer.next());test=NameTest.parse(lexer)}step=new Step(axis,test)}return BaseExprHasPredicates.parsePredicates(lexer,step),step},Step.self=function(){return new Step("self",new NodeType("node"))},Step.parent=function(){return new Step("parent",new NodeType("node"))},Step.prototype=new BaseExprHasPredicates,Step.prototype.evaluate=function(ctx,special,prevNodeset,prevIndex){var node=ctx.node;if(special||"//"!=this.op){if(this.needContextPosition&&(prevNodeset=null,prevIndex=null),this.quickAttr){var attrValue=this.attrValueExpr?this.attrValueExpr.string(ctx):null,nodeset=this.func(this.test,node,new NodeSet,this.attrName,attrValue,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset,1)}else{var nodeset=this.func(this.test,node,new NodeSet,null,null,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset)}prevNodeset&&prevNodeset.doDel()}else if(this.needContextPosition||"child"!=this.axis){var step=new Step("descendant-or-self",new NodeType("node")),nodes=step.evaluate(ctx,!1,prevNodeset,prevIndex).list(),nodeset=null;step.op="/";for(var i=0,l=nodes.length;i<l;i++)nodeset?nodeset.merge(this.evaluate(new Ctx(nodes[i]),!0)):nodeset=this.evaluate(new Ctx(nodes[i]),!0);nodeset=nodeset||new NodeSet}else if(this.quickAttr){var attrValue=this.attrValueExpr?this.attrValueExpr.string(ctx):null,nodeset=NodeUtil.getDescendantNodes(this.test,node,new NodeSet,this.attrName,attrValue,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset,1)}else{var nodeset=NodeUtil.getDescendantNodes(this.test,node,new NodeSet,null,null,prevNodeset,prevIndex);nodeset=this.evaluatePredicates(nodeset)}return nodeset},Step.prototype.predicate=function(predicate){if(this.predicates.push(predicate),(predicate.needContextPosition||"number"==predicate.datatype||"void"==predicate.datatype)&&(this.needContextPosition=!0),this._quickAttr&&1==this.predicates.length&&predicate.quickAttr){var attrName=predicate.attrName;this.attrName=attrName,this.attrValueExpr=predicate.attrValueExpr,this.quickAttr=!0}},Step.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"step: \n",indent+="    ",this.axis&&(t+=indent+"axis: "+this.axis+"\n"),t+=this.test.show(indent),this.predicates.length){t+=indent+"predicates: \n",indent+="    ";for(var i=0;i<this.predicates.length;i++)t+=this.predicates[i].show(indent)}return t},!window.NodeType&&window.defaultConfig&&(window.NodeType=null),NodeType=function(name,literal){switch(this.name=name,this.literal=literal,name){case"comment":this.type=8;break;case"text":this.type=3;break;case"processing-instruction":this.type=7;break;case"node":this.type=0}},NodeType.types={comment:1,text:1,"processing-instruction":1,node:1},NodeType.parse=function(lexer){var type,literal,ch;if(type=lexer.next(),lexer.next(),lexer.empty())throw Error("bad nodetype");if(ch=lexer.peek().charAt(0),'"'!=ch&&"'"!=ch||(literal=Literal.parse(lexer)),lexer.empty())throw Error("bad nodetype");if(")"!=lexer.next())throw lexer.back(),Error("bad token "+lexer.next());return new NodeType(type,literal)},NodeType.prototype=new BaseExpr,NodeType.prototype.notOnlyElement=!0,NodeType.prototype.match=function(node){return!this.type||this.type==node.nodeType},NodeType.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"nodetype: "+this.type+"\n",this.literal&&(indent+="    ",t+=this.literal.show(indent)),t},!window.NameTest&&window.defaultConfig&&(window.NameTest=null),NameTest=function(name){this.name=name.toLowerCase()},NameTest.parse=function(lexer){return new NameTest("*"!=lexer.peek()&&":"==lexer.peek(1)&&"*"==lexer.peek(2)?lexer.next()+lexer.next()+lexer.next():lexer.next())},NameTest.prototype=new BaseExpr,NameTest.prototype.match=function(node){var type=node.nodeType;return!(1!=type&&2!=type||"*"!=this.name&&this.name!=node.nodeName.toLowerCase())},NameTest.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"nametest: "+this.name+"\n"},!window.VariableReference&&window.defaultConfig&&(window.VariableReference=null),VariableReference=function(name){this.name=name.substring(1)},VariableReference.parse=function(lexer){var token=lexer.next();if(token.length<2)throw Error("unnamed variable reference");return new VariableReference(token)},VariableReference.prototype=new BaseExpr,VariableReference.prototype.datatype="void",VariableReference.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"variable: "+this.name+"\n"},!window.Literal&&window.defaultConfig&&(window.Literal=null),Literal=function(text){this.text=text.substring(1,text.length-1)},Literal.parse=function(lexer){var token=lexer.next();if(token.length<2)throw Error("unclosed literal string");return new Literal(token)},Literal.prototype=new BaseExpr,Literal.prototype.datatype="string",Literal.prototype.evaluate=function(ctx){return this.text},Literal.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"literal: "+this.text+"\n"},!window.Number&&window.defaultConfig&&(window.Number=null),Number=function(digit){this.digit=+digit},Number.parse=function(lexer){return new Number(lexer.next())},Number.prototype=new BaseExpr,Number.prototype.datatype="number",Number.prototype.evaluate=function(ctx){return this.digit},Number.prototype.show=function(indent){indent=indent||"";var t="";return t+=indent+"number: "+this.digit+"\n"},!window.FunctionCall&&window.defaultConfig&&(window.FunctionCall=null),FunctionCall=function(name){var info=FunctionCall.funcs[name];if(!info)throw Error(name+" is not a function");this.name=name,this.func=info[0],this.args=[],this.datatype=info[1],info[2]&&(this.needContextPosition=!0),this.needContextNodeInfo=info[3],this.needContextNode=this.needContextNodeInfo[0]},FunctionCall.funcs={"context-node":[function(){if(0!=arguments.length)throw Error("Function context-node expects ()");var ns;return ns=new NodeSet,ns.push(this.node),ns},"nodeset",!1,[!0]],"root-node":[function(){if(0!=arguments.length)throw Error("Function root-node expects ()");var ns,ctxn;return ns=new NodeSet,ctxn=this.node,9==ctxn.nodeType?ns.push(ctxn):ns.push(ctxn.ownerDocument),ns},"nodeset",!1,[]],last:[function(){if(0!=arguments.length)throw Error("Function last expects ()");return this.last},"number",!0,[]],position:[function(){if(0!=arguments.length)throw Error("Function position expects ()");return this.position},"number",!0,[]],count:[function(ns){if(1!=arguments.length||!(ns=ns.evaluate(this)).isNodeSet)throw Error("Function count expects (nodeset)");return ns.length},"number",!1,[]],id:[function(s){var ids,ns,i,id,elm,ctxn,doc;if(1!=arguments.length)throw Error("Function id expects (object)");for(ctxn=this.node,doc=9==ctxn.nodeType?ctxn:ctxn.ownerDocument,s=s.string(this),ids=s.split(/\s+/),ns=new NodeSet,i=0,l=ids.length;i<l;i++)if(id=ids[i],elm=doc.getElementById(id),uai.opera&&elm&&elm.id!=id)for(var elms=doc.getElementsByName(id),j=0,l0=elms.length;j<l0;j++)elm=elms[j],elm.id==id&&ns.push(elm);else elm&&ns.push(elm);return ns.isSorted=!1,ns},"nodeset",!1,[]],"local-name":[function(ns){var nd;switch(arguments.length){case 0:nd=this.node;break;case 1:if((ns=ns.evaluate(this)).isNodeSet){nd=ns.first();break}default:throw Error("Function local-name expects (nodeset?)")}return""+nd.nodeName.toLowerCase()},"string",!1,[!0,!1]],name:[function(ns){return FunctionCall.funcs["local-name"][0].apply(this,arguments)},"string",!1,[!0,!1]],"namespace-uri":[function(ns){return""},"string",!1,[!0,!1]],string:[function(s){switch(arguments.length){case 0:s=NodeUtil.to("string",this.node);break;case 1:s=s.string(this);break;default:throw Error("Function string expects (object?)")}return s},"string",!1,[!0,!1]],concat:[function(s1,s2){if(arguments.length<2)throw Error("Function concat expects (string, string[, ...])");for(var t="",i=0,l=arguments.length;i<l;i++)t+=arguments[i].string(this);return t},"string",!1,[]],"starts-with":[function(s1,s2){if(2!=arguments.length)throw Error("Function starts-with expects (string, string)");return s1=s1.string(this),s2=s2.string(this),0==s1.indexOf(s2)},"boolean",!1,[]],contains:[function(s1,s2){if(2!=arguments.length)throw Error("Function contains expects (string, string)");return s1=s1.string(this),s2=s2.string(this),-1!=s1.indexOf(s2)},"boolean",!1,[]],substring:[function(s,n1,n2){var a1,a2;switch(s=s.string(this),n1=n1.number(this),arguments.length){case 2:n2=s.length-n1+1;break;case 3:n2=n2.number(this);break;default:throw Error("Function substring expects (string, string)")}return n1=Math.round(n1),n2=Math.round(n2),a1=n1-1,a2=n1+n2-1,a2==1/0?s.substring(a1<0?0:a1):s.substring(a1<0?0:a1,a2)},"string",!1,[]],"substring-before":[function(s1,s2){var n;if(2!=arguments.length)throw Error("Function substring-before expects (string, string)");return s1=s1.string(this),s2=s2.string(this),n=s1.indexOf(s2),-1==n?"":s1.substring(0,n)},"string",!1,[]],"substring-after":[function(s1,s2){if(2!=arguments.length)throw Error("Function substring-after expects (string, string)");s1=s1.string(this),s2=s2.string(this);var n=s1.indexOf(s2);return-1==n?"":s1.substring(n+s2.length)},"string",!1,[]],"string-length":[function(s){switch(arguments.length){case 0:s=NodeUtil.to("string",this.node);break;case 1:s=s.string(this);break;default:throw Error("Function string-length expects (string?)")}return s.length},"number",!1,[!0,!1]],"normalize-space":[function(s){switch(arguments.length){case 0:s=NodeUtil.to("string",this.node);break;case 1:s=s.string(this);break;default:throw Error("Function normalize-space expects (string?)")}return s.replace(/\s+/g," ").replace(/^ /,"").replace(/ $/,"")},"string",!1,[!0,!1]],translate:[function(s1,s2,s3){if(3!=arguments.length)throw Error("Function translate expects (string, string, string)");s1=s1.string(this),s2=s2.string(this),s3=s3.string(this);for(var map=[],i=0,l=s2.length;i<l;i++){var ch=s2.charAt(i);map[ch]||(map[ch]=s3.charAt(i)||"")}for(var t="",i=0,l=s1.length;i<l;i++){var ch=s1.charAt(i),replace=map[ch];t+=replace!=undefined?replace:ch}return t},"string",!1,[]],boolean:[function(b){if(1!=arguments.length)throw Error("Function boolean expects (object)");return b.bool(this)},"boolean",!1,[]],not:[function(b){if(1!=arguments.length)throw Error("Function not expects (object)");return!b.bool(this)},"boolean",!1,[]],true:[function(){if(0!=arguments.length)throw Error("Function true expects ()");return!0},"boolean",!1,[]],false:[function(){if(0!=arguments.length)throw Error("Function false expects ()");return!1},"boolean",!1,[]],lang:[function(s){return!1},"boolean",!1,[]],number:[function(n){switch(arguments.length){case 0:n=NodeUtil.to("number",this.node);break;case 1:n=n.number(this);break;default:throw Error("Function number expects (object?)")}return n},"number",!1,[!0,!1]],sum:[function(ns){var nodes,n,i,l;if(1!=arguments.length||!(ns=ns.evaluate(this)).isNodeSet)throw Error("Function sum expects (nodeset)");for(nodes=ns.list(),n=0,i=0,l=nodes.length;i<l;i++)n+=NodeUtil.to("number",nodes[i]);return n},"number",!1,[]],floor:[function(n){if(1!=arguments.length)throw Error("Function floor expects (number)");return n=n.number(this),Math.floor(n)},"number",!1,[]],ceiling:[function(n){if(1!=arguments.length)throw Error("Function ceiling expects (number)");return n=n.number(this),Math.ceil(n)},"number",!1,[]],round:[function(n){if(1!=arguments.length)throw Error("Function round expects (number)");return n=n.number(this),Math.round(n)},"number",!1,[]]},FunctionCall.parse=function(lexer){var expr,func=new FunctionCall(lexer.next());for(lexer.next();")"!=lexer.peek();){if(lexer.empty())throw Error("missing function argument list");if(expr=BinaryExpr.parse(lexer),func.arg(expr),","!=lexer.peek())break;lexer.next()}if(lexer.empty())throw Error("unclosed function argument list");if(")"!=lexer.next())throw lexer.back(),Error("bad token: "+lexer.next());return func},FunctionCall.prototype=new BaseExpr,FunctionCall.prototype.evaluate=function(ctx){return this.func.apply(ctx,this.args)},FunctionCall.prototype.arg=function(arg){this.args.push(arg),arg.needContextPosition&&(this.needContextPosition=!0);var args=this.args;arg.needContextNode&&(args.needContexNode=!0),this.needContextNode=args.needContextNode||this.needContextNodeInfo[args.length]},FunctionCall.prototype.show=function(indent){indent=indent||"";var t="";if(t+=indent+"function: "+this.name+"\n",indent+="    ",this.args.length){t+=indent+"arguments: \n",indent+="    ";for(var i=0;i<this.args.length;i++)t+=this.args[i].show(indent)}return t};var NodeID={uuid:1,get:function(node){return node.__jsxpath_id__||(node.__jsxpath_id__=this.uuid++)}};!window.NodeSet&&window.defaultConfig&&(window.NodeSet=null),NodeSet=function(){this.length=0,this.nodes=[],this.seen={},this.idIndexMap=null,this.reserveDels=[]},NodeSet.prototype.isNodeSet=!0,NodeSet.prototype.isSorted=!0,NodeSet.prototype.merge=function(nodeset){if(this.isSorted=!1,nodeset.only)return this.push(nodeset.only);if(this.only){var only=this.only;delete this.only,this.push(only),this.length--}for(var nodes=nodeset.nodes,i=0,l=nodes.length;i<l;i++)this._add(nodes[i])},NodeSet.prototype.sort=function(){if(!this.only&&!this.sortOff&&!this.isSorted){this.isSorted=!0,this.idIndexMap=null;this.nodes.sort(function(a,b){if(a==b)return 0;if(a.compareDocumentPosition){var result=a.compareDocumentPosition(b);return 2&result?1:4&result?-1:0}for(var node1=a,node2=b,ancestor1=a,ancestor2=b,deep1=0,deep2=0;ancestor1=ancestor1.parentNode;)deep1++;for(;ancestor2=ancestor2.parentNode;)deep2++;if(deep1>deep2){for(;deep1--!=deep2;)node1=node1.parentNode;if(node1==node2)return 1}else if(deep2>deep1){for(;deep2--!=deep1;)node2=node2.parentNode;if(node1==node2)return-1}for(;(ancestor1=node1.parentNode)!=(ancestor2=node2.parentNode);)node1=ancestor1,node2=ancestor2;for(;node1=node1.nextSibling;)if(node1==node2)return-1;return 1})}},NodeSet.prototype.reserveDelByNodeID=function(id,offset,reverse){var index,map=this.createIdIndexMap();if((index=map[id])&&(reverse&&this.length-offset-1>index||!reverse&&offset<index)){var obj={value:index,order:String.fromCharCode(index),toString:function(){return this.order},valueOf:function(){return this.value}};this.reserveDels.push(obj)}},NodeSet.prototype.reserveDelByNode=function(node,offset,reverse){this.reserveDelByNodeID(NodeID.get(node),offset,reverse)},NodeSet.prototype.doDel=function(){if(this.reserveDels.length){if(this.length<65536)var dels=this.reserveDels.sort(function(a,b){return b-a});else var dels=this.reserveDels.sort(function(a,b){return b-a});for(var i=0,l=dels.length;i<l;i++)this.del(dels[i]);this.reserveDels=[],this.idIndexMap=null}},NodeSet.prototype.createIdIndexMap=function(){if(this.idIndexMap)return this.idIndexMap;for(var map=this.idIndexMap={},nodes=this.nodes,i=0,l=nodes.length;i<l;i++){var node=nodes[i];map[NodeID.get(node)]=i}return map},NodeSet.prototype.del=function(index){if(this.length--,this.only)delete this.only;else{var node=this.nodes.splice(index,1)[0];this._first==node&&(delete this._first,delete this._firstSourceIndex,delete this._firstSubIndex),delete this.seen[NodeID.get(node)]}},NodeSet.prototype.delDescendant=function(elm,offset){if(!this.only){var nodeType=elm.nodeType;if((1==nodeType||9==nodeType)&&!uai.applewebkit2){if(!elm.contains)if(1==nodeType){var _elm=elm;elm={contains:function(node){return 8&node.compareDocumentPosition(_elm)}}}else elm={contains:function(){return!0}};for(var nodes=this.nodes,i=offset+1;i<nodes.length;i++)elm.contains(nodes[i])&&(this.del(i),i--)}}},NodeSet.prototype._add=function(node,reverse){var seen=this.seen,id=NodeID.get(node);if(seen[id])return!0;seen[id]=!0,this.length++,reverse?this.nodes.unshift(node):this.nodes.push(node)},NodeSet.prototype.unshift=function(node){if(!this.length)return this.length++,void(this.only=node);if(this.only){var only=this.only;delete this.only,this.unshift(only),this.length--}return this._add(node,!0)},NodeSet.prototype.push=function(node){if(!this.length)return this.length++,void(this.only=node);if(this.only){var only=this.only;delete this.only,this.push(only),this.length--}return this._add(node)},NodeSet.prototype.first=function(){return this.only?this.only:(this.nodes.length>1&&this.sort(),this.nodes[0])},NodeSet.prototype.list=function(){return this.only?[this.only]:(this.sort(),this.nodes)},NodeSet.prototype.string=function(){var node=this.only||this.first();return node?NodeUtil.to("string",node):""},NodeSet.prototype.bool=function(){return!(!this.length&&!this.only)},NodeSet.prototype.number=function(){return+this.string()},NodeSet.prototype.iterator=function(reverse){this.sort();var nodeset=this;if(reverse){var count=0;return function(){var index=nodeset.length-count++-1;return nodeset.only&&0==index?nodeset.only:nodeset.nodes[index]}}var count=0;return function(){return nodeset.only&&0==count++?nodeset.only:nodeset.nodes[count++]}};var win,install=function(win){win=win||this;var doc=win.document;win.undefined;win.XPathExpression=function(expr){if(!expr.length)throw win.Error("no expression");var lexer=this.lexer=Lexer(expr);if(lexer.empty())throw win.Error("no expression");if(this.expr=BinaryExpr.parse(lexer),!lexer.empty())throw win.Error("bad token: "+lexer.next())},win.XPathExpression.prototype.evaluate=function(node,type){return new win.XPathResult(this.expr.evaluate(new Ctx(node)),type)},win.XPathResult=function(value,type){if(0==type)switch(typeof value){case"object":type++;case"boolean":type++;case"string":type++;case"number":type++}switch(this.resultType=type,type){case 1:return void(this.numberValue=value.isNodeSet?value.number():+value);case 2:return void(this.stringValue=value.isNodeSet?value.string():""+value);case 3:return void(this.booleanValue=value.isNodeSet?value.bool():!!value);case 4:case 5:case 6:case 7:this.nodes=value.list(),this.snapshotLength=value.length,this.index=0,this.invalidIteratorState=!1;break;case 8:case 9:return void(this.singleNodeValue=value.first())}},win.XPathResult.prototype.iterateNext=function(){return this.nodes[this.index++]},win.XPathResult.prototype.snapshotItem=function(i){return this.nodes[i]},win.XPathResult.ANY_TYPE=0,win.XPathResult.NUMBER_TYPE=1,win.XPathResult.STRING_TYPE=2,win.XPathResult.BOOLEAN_TYPE=3,win.XPathResult.UNORDERED_NODE_ITERATOR_TYPE=4,win.XPathResult.ORDERED_NODE_ITERATOR_TYPE=5,win.XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE=6,win.XPathResult.ORDERED_NODE_SNAPSHOT_TYPE=7,win.XPathResult.ANY_UNORDERED_NODE_TYPE=8,win.XPathResult.FIRST_ORDERED_NODE_TYPE=9,doc.createExpression=function(expr){return new win.XPathExpression(expr,null)},doc.evaluate=function(expr,context,_,type){return doc.createExpression(expr,null).evaluate(context,type)}};if(config.targetFrame){var frame=document.getElementById(config.targetFrame);frame&&(win=frame.contentWindow)}config.exportInstaller&&(window.install=install),config.hasNative&&config.useNative||install(win||window)}}),"undefined"!=typeof _qtp_inject_css&&1!=_qtp_inject_css||(qtpProps.SizzleInjector=function(){!function(){function dirNodeCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var sibDir="previousSibling"==dir&&!isXML,i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){sibDir&&1===elem.nodeType&&(elem.sizcache=doneName,elem.sizset=i),elem=elem[dir];for(var match=!1;elem;){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(1!==elem.nodeType||isXML||(elem.sizcache=doneName,elem.sizset=i),elem.nodeName===cur){match=elem;break}elem=elem[dir]}checkSet[i]=match}}}function dirCheck(dir,cur,doneName,checkSet,nodeCheck,isXML){for(var sibDir="previousSibling"==dir&&!isXML,i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){sibDir&&1===elem.nodeType&&(elem.sizcache=doneName,elem.sizset=i),elem=elem[dir];for(var match=!1;elem;){if(elem.sizcache===doneName){match=checkSet[elem.sizset];break}if(1===elem.nodeType)if(isXML||(elem.sizcache=doneName,elem.sizset=i),"string"!=typeof cur){if(elem===cur){match=!0;break}}else if(Sizzle.filter(cur,[elem]).length>0){match=elem;break}elem=elem[dir]}checkSet[i]=match}}}var chunker=/((?:\((?:\([^()]+\)|[^()]+)+\)|\[(?:\[[^[\]]*\]|['"][^'"]*['"]|[^[\]'"]+)+\]|\\.|[^ >+~,(\[\\]+)+|[>+~])(\s*,\s*)?/g,done=0,toString=Object.prototype.toString,hasDuplicate=!1,Sizzle=function(selector,context,results,seed){results=results||[];var origContext=context=context||document;if(1!==context.nodeType&&9!==context.nodeType)return[];if(!selector||"string"!=typeof selector)return results;var m,set,checkSet,extra,parts=[],prune=!0,contextXML=isXML(context);for(chunker.lastIndex=0;null!==(m=chunker.exec(selector));)if(parts.push(m[1]),m[2]){extra=RegExp.rightContext;break}if(parts.length>1&&origPOS.exec(selector))if(2===parts.length&&Expr.relative[parts[0]])set=posProcess(parts[0]+parts[1],context);else for(set=Expr.relative[parts[0]]?[context]:Sizzle(parts.shift(),context);parts.length;)selector=parts.shift(),Expr.relative[selector]&&(selector+=parts.shift()),set=posProcess(selector,set);else{if(!seed&&parts.length>1&&9===context.nodeType&&!contextXML&&Expr.match.ID.test(parts[0])&&!Expr.match.ID.test(parts[parts.length-1])){var ret=Sizzle.find(parts.shift(),context,contextXML);context=ret.expr?Sizzle.filter(ret.expr,ret.set)[0]:ret.set[0]}if(context){var ret=seed?{expr:parts.pop(),set:makeArray(seed)}:Sizzle.find(parts.pop(),1!==parts.length||"~"!==parts[0]&&"+"!==parts[0]||!context.parentNode?context:context.parentNode,contextXML);for(set=ret.expr?Sizzle.filter(ret.expr,ret.set):ret.set,parts.length>0?checkSet=makeArray(set):prune=!1;parts.length;){var cur=parts.pop(),pop=cur;Expr.relative[cur]?pop=parts.pop():cur="",null==pop&&(pop=context),Expr.relative[cur](checkSet,pop,contextXML)}}else checkSet=parts=[]}if(checkSet||(checkSet=set),!checkSet)throw"Syntax error, unrecognized expression: "+(cur||selector);if("[object Array]"===toString.call(checkSet))if(prune)if(context&&1===context.nodeType)for(var i=0;null!=checkSet[i];i++)checkSet[i]&&(!0===checkSet[i]||1===checkSet[i].nodeType&&contains(context,checkSet[i]))&&results.push(set[i]);else for(var i=0;null!=checkSet[i];i++)checkSet[i]&&1===checkSet[i].nodeType&&results.push(set[i]);else results.push.apply(results,checkSet);else makeArray(checkSet,results);return extra&&(Sizzle(extra,origContext,results,seed),Sizzle.uniqueSort(results)),results};Sizzle.uniqueSort=function(results){if(sortOrder&&(hasDuplicate=!1,results.sort(sortOrder),hasDuplicate))for(var i=1;i<results.length;i++)results[i]===results[i-1]&&results.splice(i--,1)},Sizzle.matches=function(expr,set){return Sizzle(expr,null,null,set)},Sizzle.find=function(expr,context,isXML){var set,match;if(!expr)return[];for(var i=0,l=Expr.order.length;i<l;i++){
var match,type=Expr.order[i];if(match=Expr.match[type].exec(expr)){var left=RegExp.leftContext;if("\\"!==left.substr(left.length-1)&&(match[1]=(match[1]||"").replace(/\\/g,""),null!=(set=Expr.find[type](match,context,isXML)))){expr=expr.replace(Expr.match[type],"");break}}}return set||(set=context.getElementsByTagName("*")),{set:set,expr:expr}},Sizzle.filter=function(expr,set,inplace,not){for(var match,anyFound,old=expr,result=[],curLoop=set,isXMLFilter=set&&set[0]&&isXML(set[0]);expr&&set.length;){for(var type in Expr.filter)if(null!=(match=Expr.match[type].exec(expr))){var found,item,filter=Expr.filter[type];if(anyFound=!1,curLoop==result&&(result=[]),Expr.preFilter[type])if(match=Expr.preFilter[type](match,curLoop,inplace,result,not,isXMLFilter)){if(!0===match)continue}else anyFound=found=!0;if(match)for(var i=0;null!=(item=curLoop[i]);i++)if(item){found=filter(item,match,i,curLoop);var pass=not^!!found;inplace&&null!=found?pass?anyFound=!0:curLoop[i]=!1:pass&&(result.push(item),anyFound=!0)}if(void 0!==found){if(inplace||(curLoop=result),expr=expr.replace(Expr.match[type],""),!anyFound)return[];break}}if(expr==old){if(null==anyFound)throw"Syntax error, unrecognized expression: "+expr;break}old=expr}return curLoop};var Expr=Sizzle.selectors={order:["ID","NAME","TAG"],match:{ID:/#((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,CLASS:/\.((?:[\w\u00c0-\uFFFF_-]|\\.)+)/,NAME:/\[name=['"]*((?:[\w\u00c0-\uFFFF_-]|\\.)+)['"]*\]/,ATTR:/\[\s*((?:[\w\u00c0-\uFFFF_-]|\\.)+)\s*(?:(\S?=)\s*(['"]*)(.*?)\3|)\s*\]/,TAG:/^((?:[\w\u00c0-\uFFFF\*_-]|\\.)+)/,CHILD:/:(only|nth|last|first)-child(?:\((even|odd|[\dn+-]*)\))?/,POS:/:(nth|eq|gt|lt|first|last|even|odd)(?:\((\d*)\))?(?=[^-]|$)/,PSEUDO:/:((?:[\w\u00c0-\uFFFF_-]|\\.)+)(?:\((['"]*)((?:\([^\)]+\)|[^\2\(\)]*)+)\2\))?/},attrMap:{class:"className",for:"htmlFor"},attrHandle:{href:function(elem){return elem.getAttribute("href")}},relative:{"+":function(checkSet,part,isXML){var isPartStr="string"==typeof part,isTag=isPartStr&&!/\W/.test(part),isPartStrNotTag=isPartStr&&!isTag;isTag&&!isXML&&(part=part.toUpperCase());for(var elem,i=0,l=checkSet.length;i<l;i++)if(elem=checkSet[i]){for(;(elem=elem.previousSibling)&&1!==elem.nodeType;);checkSet[i]=isPartStrNotTag||elem&&elem.nodeName===part?elem||!1:elem===part}isPartStrNotTag&&Sizzle.filter(part,checkSet,!0)},">":function(checkSet,part,isXML){var isPartStr="string"==typeof part;if(isPartStr&&!/\W/.test(part)){part=isXML?part:part.toUpperCase();for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];if(elem){var parent=elem.parentNode;checkSet[i]=parent.nodeName===part&&parent}}}else{for(var i=0,l=checkSet.length;i<l;i++){var elem=checkSet[i];elem&&(checkSet[i]=isPartStr?elem.parentNode:elem.parentNode===part)}isPartStr&&Sizzle.filter(part,checkSet,!0)}},"":function(checkSet,part,isXML){var doneName=done++,checkFn=dirCheck;if(!part.match(/\W/)){var nodeCheck=part=isXML?part:part.toUpperCase();checkFn=dirNodeCheck}checkFn("parentNode",part,doneName,checkSet,nodeCheck,isXML)},"~":function(checkSet,part,isXML){var doneName=done++,checkFn=dirCheck;if("string"==typeof part&&!part.match(/\W/)){var nodeCheck=part=isXML?part:part.toUpperCase();checkFn=dirNodeCheck}checkFn("previousSibling",part,doneName,checkSet,nodeCheck,isXML)}},find:{ID:function(match,context,isXML){if(void 0!==context.getElementById&&!isXML){var m=context.getElementById(match[1]);return m?[m]:[]}},NAME:function(match,context,isXML){if(void 0!==context.getElementsByName){for(var ret=[],results=context.getElementsByName(match[1]),i=0,l=results.length;i<l;i++)results[i].getAttribute("name")===match[1]&&ret.push(results[i]);return 0===ret.length?null:ret}},TAG:function(match,context){return context.getElementsByTagName(match[1])}},preFilter:{CLASS:function(match,curLoop,inplace,result,not,isXML){if(match=" "+match[1].replace(/\\/g,"")+" ",isXML)return match;for(var elem,i=0;null!=(elem=curLoop[i]);i++)elem&&(not^(elem.className&&(" "+elem.className+" ").indexOf(match)>=0)?inplace||result.push(elem):inplace&&(curLoop[i]=!1));return!1},ID:function(match){return match[1].replace(/\\/g,"")},TAG:function(match,curLoop){for(var i=0;!1===curLoop[i];i++);return curLoop[i]&&isXML(curLoop[i])?match[1]:match[1].toUpperCase()},CHILD:function(match){if("nth"==match[1]){var test=/(-?)(\d*)n((?:\+|-)?\d*)/.exec("even"==match[2]&&"2n"||"odd"==match[2]&&"2n+1"||!/\D/.test(match[2])&&"0n+"+match[2]||match[2]);match[2]=test[1]+(test[2]||1)-0,match[3]=test[3]-0}return match[0]=done++,match},ATTR:function(match,curLoop,inplace,result,not,isXML){var name=match[1].replace(/\\/g,"");return!isXML&&Expr.attrMap[name]&&(match[1]=Expr.attrMap[name]),"~="===match[2]&&(match[4]=" "+match[4]+" "),match},PSEUDO:function(match,curLoop,inplace,result,not){if("not"===match[1]){if(!(match[3].match(chunker).length>1||/^\w/.test(match[3]))){var ret=Sizzle.filter(match[3],curLoop,inplace,!0^not);return inplace||result.push.apply(result,ret),!1}match[3]=Sizzle(match[3],null,null,curLoop)}else if(Expr.match.POS.test(match[0])||Expr.match.CHILD.test(match[0]))return!0;return match},POS:function(match){return match.unshift(!0),match}},filters:{enabled:function(elem){return!1===elem.disabled&&"hidden"!==elem.type},disabled:function(elem){return!0===elem.disabled},checked:function(elem){return!0===elem.checked},selected:function(elem){return elem.parentNode.selectedIndex,!0===elem.selected},parent:function(elem){return!!elem.firstChild},empty:function(elem){return!elem.firstChild},has:function(elem,i,match){return!!Sizzle(match[3],elem).length},header:function(elem){return/h\d/i.test(elem.nodeName)},text:function(elem){return"text"===elem.type},radio:function(elem){return"radio"===elem.type},checkbox:function(elem){return"checkbox"===elem.type},file:function(elem){return"file"===elem.type},password:function(elem){return"password"===elem.type},submit:function(elem){return"submit"===elem.type},image:function(elem){return"image"===elem.type},reset:function(elem){return"reset"===elem.type},button:function(elem){return"button"===elem.type||"BUTTON"===elem.nodeName.toUpperCase()},input:function(elem){return/input|select|textarea|button/i.test(elem.nodeName)}},setFilters:{first:function(elem,i){return 0===i},last:function(elem,i,match,array){return i===array.length-1},even:function(elem,i){return i%2==0},odd:function(elem,i){return i%2==1},lt:function(elem,i,match){return i<match[3]-0},gt:function(elem,i,match){return i>match[3]-0},nth:function(elem,i,match){return match[3]-0==i},eq:function(elem,i,match){return match[3]-0==i}},filter:{PSEUDO:function(elem,match,i,array){var name=match[1],filter=Expr.filters[name];if(filter)return filter(elem,i,match,array);if("contains"===name)return(elem.textContent||elem.innerText||"").indexOf(match[3])>=0;if("not"===name){var not=match[3];for(i=0,l=not.length;i<l;i++)if(not[i]===elem)return!1;return!0}},CHILD:function(elem,match){var type=match[1],node=elem;switch(type){case"only":case"first":for(;node=node.previousSibling;)if(1===node.nodeType)return!1;if("first"==type)return!0;node=elem;case"last":for(;node=node.nextSibling;)if(1===node.nodeType)return!1;return!0;case"nth":var first=match[2],last=match[3];if(1==first&&0==last)return!0;var doneName=match[0],parent=elem.parentNode;if(parent&&(parent.sizcache!==doneName||!elem.nodeIndex)){var count=0;for(node=parent.firstChild;node;node=node.nextSibling)1===node.nodeType&&(node.nodeIndex=++count);parent.sizcache=doneName}var diff=elem.nodeIndex-last;return 0==first?0==diff:diff%first==0&&diff/first>=0}},ID:function(elem,match){return 1===elem.nodeType&&elem.getAttribute("id")===match},TAG:function(elem,match){return"*"===match&&1===elem.nodeType||elem.nodeName===match},CLASS:function(elem,match){return(" "+(elem.className||elem.getAttribute("class"))+" ").indexOf(match)>-1},ATTR:function(elem,match){var name=match[1],result=Expr.attrHandle[name]?Expr.attrHandle[name](elem):null!=elem[name]?elem[name]:elem.getAttribute(name),value=result+"",type=match[2],check=match[4];return null==result?"!="===type:"="===type?value===check:"*="===type?value.indexOf(check)>=0:"~="===type?(" "+value+" ").indexOf(check)>=0:check?"!="===type?value!=check:"^="===type?0===value.indexOf(check):"$="===type?value.substr(value.length-check.length)===check:"|="===type&&(value===check||value.substr(0,check.length+1)===check+"-"):value&&!1!==result},POS:function(elem,match,i,array){var name=match[2],filter=Expr.setFilters[name];if(filter)return filter(elem,i,match,array)}}},origPOS=Expr.match.POS;for(var type in Expr.match)Expr.match[type]=new RegExp(Expr.match[type].source+/(?![^\[]*\])(?![^\(]*\))/.source);var makeArray=function(array,results){return array=Array.prototype.slice.call(array),results?(results.push.apply(results,array),results):array};try{Array.prototype.slice.call(document.documentElement.childNodes)}catch(e){makeArray=function(array,results){var ret=results||[];if("[object Array]"===toString.call(array))Array.prototype.push.apply(ret,array);else if("number"==typeof array.length)for(var i=0,l=array.length;i<l;i++)ret.push(array[i]);else for(var i=0;array[i];i++)ret.push(array[i]);return ret}}var sortOrder;document.documentElement.compareDocumentPosition?sortOrder=function(a,b){var ret=4&a.compareDocumentPosition(b)?-1:a===b?0:1;return 0===ret&&(hasDuplicate=!0),ret}:"sourceIndex"in document.documentElement?sortOrder=function(a,b){var ret=a.sourceIndex-b.sourceIndex;return 0===ret&&(hasDuplicate=!0),ret}:document.createRange&&(sortOrder=function(a,b){var aRange=a.ownerDocument.createRange(),bRange=b.ownerDocument.createRange();aRange.selectNode(a),aRange.collapse(!0),bRange.selectNode(b),bRange.collapse(!0);var ret=aRange.compareBoundaryPoints(Range.START_TO_END,bRange);return 0===ret&&(hasDuplicate=!0),ret}),function(){var form=document.createElement("div"),id="script"+(new Date).getTime();form.innerHTML="<a name='"+id+"'/>";var root=document.documentElement;root.insertBefore(form,root.firstChild),document.getElementById(id)&&(Expr.find.ID=function(match,context,isXML){if(void 0!==context.getElementById&&!isXML){var m=context.getElementById(match[1]);return m?m.id===match[1]||void 0!==m.getAttributeNode&&m.getAttributeNode("id").nodeValue===match[1]?[m]:void 0:[]}},Expr.filter.ID=function(elem,match){var node=void 0!==elem.getAttributeNode&&elem.getAttributeNode("id");return 1===elem.nodeType&&node&&node.nodeValue===match}),root.removeChild(form),root=form=null}(),function(){var div=document.createElement("div");div.appendChild(document.createComment("")),div.getElementsByTagName("*").length>0&&(Expr.find.TAG=function(match,context){var results=context.getElementsByTagName(match[1]);if("*"===match[1]){for(var tmp=[],i=0;results[i];i++)1===results[i].nodeType&&tmp.push(results[i]);results=tmp}return results}),div.innerHTML="<a href='#'></a>",div.firstChild&&void 0!==div.firstChild.getAttribute&&"#"!==div.firstChild.getAttribute("href")&&(Expr.attrHandle.href=function(elem){return elem.getAttribute("href",2)}),div=null}(),document.querySelectorAll&&function(){var oldSizzle=Sizzle,div=document.createElement("div");if(div.innerHTML="<p class='TEST'></p>",!div.querySelectorAll||0!==div.querySelectorAll(".TEST").length){Sizzle=function(query,context,extra,seed){if(context=context||document,!seed&&9===context.nodeType&&!isXML(context))try{return makeArray(context.querySelectorAll(query),extra)}catch(e){}return oldSizzle(query,context,extra,seed)};for(var prop in oldSizzle)Sizzle[prop]=oldSizzle[prop];div=null}}(),document.getElementsByClassName&&document.documentElement.getElementsByClassName&&function(){var div=document.createElement("div");div.innerHTML="<div class='test e'></div><div class='test'></div>",0!==div.getElementsByClassName("e").length&&(div.lastChild.className="e",1!==div.getElementsByClassName("e").length&&(Expr.order.splice(1,0,"CLASS"),Expr.find.CLASS=function(match,context,isXML){if(void 0!==context.getElementsByClassName&&!isXML)return context.getElementsByClassName(match[1])},div=null))}();var contains=document.compareDocumentPosition?function(a,b){return 16&a.compareDocumentPosition(b)}:function(a,b){return a!==b&&(!a.contains||a.contains(b))},isXML=function(elem){return 9===elem.nodeType&&"HTML"!==elem.documentElement.nodeName||!!elem.ownerDocument&&"HTML"!==elem.ownerDocument.documentElement.nodeName},posProcess=function(selector,context){for(var match,tmpSet=[],later="",root=context.nodeType?[context]:context;match=Expr.match.PSEUDO.exec(selector);)later+=match[0],selector=selector.replace(Expr.match.PSEUDO,"");selector=Expr.relative[selector]?selector+"*":selector;for(var i=0,l=root.length;i<l;i++)Sizzle(selector,root[i],tmpSet);return Sizzle.filter(later,tmpSet)};window.Sizzle=Sizzle}(),qtpProps.Sizzle=window.Sizzle});var finder={css:function(specifier,context){var retVal=[];try{document="undefined"!=typeof GlobalNSResolver?GlobalNSResolver.document:qtpProps.wnd.document,qtpProps.Sizzle||qtpProps.SizzleInjector();for(var elems=qtpProps.Sizzle(specifier,context),i=0;i<elems.length;i++)retVal.push(elems[i])}catch(ex){}return document=null,retVal},xpath_evaluate:function(specifier,context,resultType){var result=null;try{document="undefined"!=typeof GlobalNSResolver?GlobalNSResolver.document:qtpProps.wnd.document,document.evaluate?result=document.evaluate(specifier,context,null,window.XPathResult[resultType],null):(qtpProps.window.document.evaluate||(GlobalNSResolver&&GlobalNSResolver.navigator?navigator=GlobalNSResolver.navigator:document&&document.parentWindow&&document.parentWindow.navigator&&(navigator=document.parentWindow.navigator),qtpProps.XPathInjector(),navigator=null),result=qtpProps.window.document.evaluate(specifier,context,null,qtpProps.window.XPathResult[resultType],null))}catch(ex){}return navigator=null,document=null,result},xpath:function(specifier,context){var curVal,retVal=[];try{for(var result=finder.xpath_evaluate(specifier,context,"ANY_TYPE");curVal=result.iterateNext();)retVal.push(curVal)}catch(ex){}return retVal},uniqify:function(arr1,arr2){var retVal=[];for(var objIndex1 in arr1){var obj1=arr1[objIndex1];obj1.wrappedJSObject&&(obj1=obj1.wrappedJSObject);for(var objIndex2 in arr2){var obj2=arr2[objIndex2];if(obj2.wrappedJSObject&&(obj2=obj2.wrappedJSObject),obj1==obj2){retVal.push(arr1[objIndex1]);break}}}return retVal}};if(qtpProps.evaluate=function(){document="undefined"!=typeof GlobalNSResolver?GlobalNSResolver.document:qtpProps.wnd.document;for(var retVal=[],firstTime=!0,context=null,i=0;i<arguments.length;i++){var specifier=arguments[i];if(void 0!=specifier)if("object"!=typeof specifier){var pos=specifier.indexOf(":");if(-1!=pos){var finderFunc=finder[specifier.substr(0,pos)];specifier=specifier.substr(pos+1),firstTime?(retVal=finderFunc(specifier,context),firstTime=!1):retVal=finder.uniqify(retVal,finderFunc(specifier,context))}}else context=specifier}return document=null,retVal},qtpProps.finder=finder,this._QTP=this._QTP||{},Object.keys)Object.keys(qtpProps).forEach(function(key){this._QTP[key]=qtpProps[key]});else for(key in qtpProps)this._QTP[key]=qtpProps[key]}}.call(this),("undefined"!=typeof _QTP||window._QTP)&&function(){var _QTP=this;_QTP.AutoXpathRecorder=function(srcElem){function findImportentAncestor(elem){function calcSimilarity(node1,node2){var calcedSimilarty=0,weight=0;for(var calcF in calcFunctions){var cf=calcFunctions[calcF];cf.weight>0&&(calcedSimilarty+=cf.func(node1,node2),weight+=cf.weight)}return calcedSimilarty/weight}function calcDomSimilarity(node1,node2){if(!areEqual(node1,node2))return 0;var list1=node1.childNodes,list2=node2.childNodes;return 0==list1.length&&0==list2.length?.5:0==list1.length||0==list2.length?0:Math.abs(list1.length-list2.length)>10?0:list1.length>5||list2.length>5?0:1-calcEditDistance(list1,0,list2,0)/(list1.length+list2.length)}function calcEditDistance(list1,index1,list2,index2){return index1+1>=list1.length?list2.length-index2-1:index2+1>=list2.length?list1.length-index1-1:areEqual(list1[index1],list2[index2])?calcEditDistance(list1,index1+1,list2,index2+1):Math.min(calcEditDistance(list1,index1+1,list2,index2),calcEditDistance(list1,index1,list2,index2+1))+1}function areEqual(elem1,elem2){try{var role1=elem1.getAttribute?elem1.getAttribute("role"):"",role2=elem2.getAttribute?elem2.getAttribute("role"):"";return elem1.tagName==elem2.tagName&&role1==role2}catch(e){return!1}}for(var bestElem,calcFunctions={domSimilarity:{func:calcDomSimilarity,weight:1}},bestGrade=0;(elem=elem.parentNode).parentNode;){for(var grade=1,siblings=1,curSibling=elem.parentNode.firstChild;curSibling;curSibling=curSibling.nextSibling)if(1==curSibling.nodeType&&curSibling!=elem){var g=calcSimilarity(elem,curSibling);if(grade+=g,++siblings>20)break}if(1!=siblings&&(grade=grade/siblings-1/(siblings*siblings),Log("grade: "+grade),grade>bestGrade&&(bestGrade=grade,bestElem=elem,bestGrade>.8)))break}if(Log("bestGrade: "+bestGrade),bestElem&&bestGrade>.5)return bestElem}function qouteString(srcText){var qoutes='"';if(/"/g.test(srcText)){if(/'/g.test(srcText))return"";qoutes="'"}return qoutes+srcText+qoutes}function isStrongId(idString){return!!idString&&!/\d/.test(idString)}function xpathBuilder(srcElem,destElem,options,doc){if(!destElem)return"";for(var xpathString="",done=!1,nextE=srcElem,textAdded=!1;nextE&&nextE!=destElem&&!done;){var currentE=nextE;if(!(nextE=currentE.parentNode))return"";var nodeStr=currentE.tagName,predicate="",nodeId=currentE.id;if(isStrongId(nodeId))predicate='@id="'+nodeId+'"',done=!0;else{if(options&xpathBuilder.addRole)try{var role=currentE.getAttribute?currentE.getAttribute("role"):"";role&&(predicate+='@role="'+role+'"')}catch(e){}if(options&xpathBuilder.addText&&nextE!=srcElem&&destElem!=doc.body){var result=_QTP.finder.xpath_evaluate("text()",currentE,"STRING_TYPE"),txt=result?result.stringValue:"";if(""!=txt){var qoutedString=qouteString(txt);""!=qoutedString&&(""!=predicate&&(predicate+=" and "),predicate+="text()="+qoutedString)}}if(!textAdded&&options&xpathBuilder.addNormalizedSpace){var result=_QTP.finder.xpath_evaluate("normalize-space()",currentE,"STRING_TYPE"),txt=result?result.stringValue:"";if(txt&&txt.length>0&&txt.length<=20){var qoutedString=qouteString(txt);if(""!=qoutedString){var newPredicate=predicate;if(""!=newPredicate&&(newPredicate+=" and "),newPredicate+="normalize-space()="+qoutedString,nextE==destElem)predicate=newPredicate,textAdded=!0;else{var tempXpath="//"+nodeStr+"["+newPredicate+"]"+xpathString,res=_QTP.finder.xpath_evaluate(tempXpath,currentE,"ANY_TYPE");if(res&&res.iterateNext){for(var num=0;res.iterateNext()&&!(++num>1););1==num&&(predicate=newPredicate,textAdded=!0)}}}}}}if(""!=predicate&&(nodeStr+="["+predicate+"]"),!done&&!textAdded&&options&xpathBuilder.addSpecifier)for(var node,results=_QTP.finder.xpath_evaluate(nodeStr,nextE,"ORDERED_NODE_ITERATOR_TYPE"),i=1;results&&(node=results.iterateNext());){if(node.wrappedJSObject==currentE||node==currentE){nodeStr+="["+i+"]";break}i++}xpathString="/"+nodeStr+xpathString}return""!=xpathString&&(xpathString="/"+xpathString),xpathString}function isXpathUnique(xpath,doc){var snapshotLength=0;try{snapshotLength=doc.evaluate(xpath,doc,null,XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE,null).snapshotLength}catch(e){return!1}return 1===snapshotLength}function Log(str){}var doc="undefined"!=typeof GlobalNSResolver?GlobalNSResolver.document:window.document;if(doc.body.contains(srcElem)){if(xpathBuilder.addText=1,xpathBuilder.addSpecifier=2,xpathBuilder.addRole=4,xpathBuilder.addNormalizedSpace=8,srcElem===doc.body)return"//BODY";var endElem=findImportentAncestor(srcElem);if(endElem){var xpathResult=xpathBuilder(srcElem,endElem.parentNode,xpathBuilder.addSpecifier|xpathBuilder.addRole|xpathBuilder.addNormalizedSpace,doc);if(isXpathUnique(xpathResult,doc))return xpathResult}return xpathBuilder(srcElem,doc.body,xpathBuilder.addSpecifier|xpathBuilder.addRole,doc)}}}.call("undefined"!=typeof _QTP?_QTP:window._QTP),("undefined"!=typeof _QTP||window._QTP)&&function(){function nodeNameInCorrectCase(node){var shadowRootType=node.shadowRootType;return shadowRootType?"#shadow-root ("+shadowRootType+")":node.xmlVersion?node.nodeName:node.nodeName.toLowerCase()}var _QTP=this,WebInspector={DOMPresentationUtils:{}};if(void 0===Node||!Node)var Node={ELEMENT_NODE:1,DOCUMENT_NODE:9};WebInspector.DOMPresentationUtils.cssPath=function(node,optimized){if(node.nodeType!==Node.ELEMENT_NODE)return"";for(var steps=[],contextNode=node;contextNode;){var step=WebInspector.DOMPresentationUtils._cssPathStep(contextNode,!!optimized,contextNode===node);if(!step)break;if(steps.push(step),step.optimized)break;contextNode=contextNode.parentNode}return steps.reverse(),steps.join(" > ")},WebInspector.DOMPresentationUtils._cssPathStep=function(node,optimized,isTargetNode){function prefixedElementClassNames(node){var classAttribute=node.getAttribute("class");return classAttribute?safeArrayMap(safeArrayFilter(classAttribute.split(/\s+/g),Boolean),function(name){return"$"+name}):[]}function safeArrayFilter(arr,fn){if(arr.filter)return arr.filter(fn);for(var ret=[],i=0;i<arr.length;i++)fn(arr[i])&&ret.push(arr[i]);return ret}function safeArrayMap(arr,fn){if(arr.map)return arr.map(fn);for(var ret=[],i=0;i<arr.length;i++){var item=fn(arr[i]);ret.push(item)}return ret}function idSelector(id){return"#"+escapeIdentifierIfNeeded(id)}function escapeIdentifierIfNeeded(ident){if(isCSSIdentifier(ident))return ident;var shouldEscapeFirst=/^(?:[0-9]|-[0-9-]?)/.test(ident),lastIndex=ident.length-1;return ident.replace(/./g,function(c,i){return shouldEscapeFirst&&0===i||!isCSSIdentChar(c)?escapeAsciiChar(c,i===lastIndex):c})}function escapeAsciiChar(c,isLast){return"\\"+toHexByte(c)+(isLast?"":" ")}function toHexByte(c){var hexByte=c.charCodeAt(0).toString(16);return 1===hexByte.length&&(hexByte="0"+hexByte),hexByte}function isCSSIdentChar(c){return!!/[a-zA-Z0-9_-]/.test(c)||c.charCodeAt(0)>=160}function isCSSIdentifier(value){return/^-?[a-zA-Z_][a-zA-Z0-9_-]*$/.test(value)}if(node.nodeType!==Node.ELEMENT_NODE)return null;var id=node.getAttribute("id");if(optimized){if(id)return new WebInspector.DOMNodePathStep(idSelector(id),!0);var nodeNameLower=node.nodeName.toLowerCase();if("body"===nodeNameLower||"head"===nodeNameLower||"html"===nodeNameLower)return new WebInspector.DOMNodePathStep(nodeNameInCorrectCase(node),!0)}var nodeName=nodeNameInCorrectCase(node);if(id)return new WebInspector.DOMNodePathStep(nodeName+idSelector(id),!0);var parent=node.parentNode;if(!parent||parent.nodeType===Node.DOCUMENT_NODE)return new WebInspector.DOMNodePathStep(nodeName,!0);for(var prefixedOwnClassNamesArray=prefixedElementClassNames(node),needsClassNames=!1,needsNthChild=!1,ownIndex=-1,elementIndex=-1,siblings=parent.children,i=0;(-1===ownIndex||!needsNthChild)&&i<siblings.length;++i){var sibling=siblings[i];if(sibling.nodeType===Node.ELEMENT_NODE)if(elementIndex+=1,sibling!==node){if(!needsNthChild&&nodeNameInCorrectCase(sibling)===nodeName){needsClassNames=!0;var ownClassNames=prefixedOwnClassNamesArray.keySet,ownClassNameCount=0;for(var name in ownClassNames)++ownClassNameCount;if(0!==ownClassNameCount)for(var siblingClassNamesArray=prefixedElementClassNames(sibling),j=0;j<siblingClassNamesArray.length;++j){var siblingClass=siblingClassNamesArray[j];if(ownClassNames.hasOwnProperty(siblingClass)&&(delete ownClassNames[siblingClass],!--ownClassNameCount)){needsNthChild=!0;break}}else needsNthChild=!0}}else ownIndex=elementIndex}var result=nodeName;if(isTargetNode&&"input"===nodeName.toLowerCase()&&node.getAttribute("type")&&!node.getAttribute("id")&&!node.getAttribute("class")&&(result+='[type="'+node.getAttribute("type")+'"]'),needsNthChild)result+=":nth-child("+(ownIndex+1)+")";else if(needsClassNames)for(var prefixedName in prefixedOwnClassNamesArray.keySet)result+="."+escapeIdentifierIfNeeded(prefixedName.substr(1));return new WebInspector.DOMNodePathStep(result,!1)},WebInspector.DOMNodePathStep=function(value,optimized){this.value=value,this.optimized=optimized||!1},WebInspector.DOMNodePathStep.prototype={toString:function(){return this.value}},_QTP.CSSGenerator=function(elem){return WebInspector.DOMPresentationUtils.cssPath(elem)},_QTP.autoCssLog=function(str){if(_QTP.wnd&&_QTP.wnd.console)_QTP.wnd.console.log(str);else{var d=void 0;d="undefined"!=typeof GlobalNSResolver?GlobalNSResolver.document:window.document,d&&d.parentWindow&&d.parentWindow.console.log(str)}}}.call("undefined"!=typeof _QTP?_QTP:window._QTP),WebExtKit.prototype={name:"WebExtKit",priority:100,loadToolkits:function(toolkits){this._logger.trace("loadToolkits called"),this._toolkitManager.loadToolkits(toolkits),this._tagElements=this._toolkitManager.getTagList()},createAO:function(element,parentID,noDefault,micclass){this._logger.trace("createAO called");var ao=null;if(!Util.isNullOrUndefined(element)&&!Util.isNullOrUndefined(element.tagName)){var tagName=element.tagName.toLowerCase();if(-1!==this._tagElements.indexOf(tagName)||-1!==this._tagElements.indexOf("default")){var rootElem={_elem:null},control=this._toolkitManager.createControl(element,this._skipTypes,rootElem,micclass);null!==control&&(this._logger.trace("createAO: element found control. Contro is ",control.controlType),this._skipTypes.push(control.controlType),this._logger.trace("createAO: skipTypes push control types. skipTypes contains ",this._skipTypes),ao=new WebExtAO(Util.isNullOrUndefined(rootElem._elem)?element:rootElem._elem,control,parentID),this._skipTypes.pop(),this._logger.trace("createAO: skipTypes pop(); skipTypes contians ",this._skipTypes))}}return ao},createRecordAOArray:function(element,parentID){for(var aos=[],curr=element;curr;curr=curr.parentElement){var ao=this.createAO(curr,parentID,!0);ao&&aos.push(ao)}aos.reverse();var foundChildAO=null;return aos.some(function(childAO){return foundChildAO=childAO,childAO.RegisterExtEventHandler(),!childAO.UseDefaultEventHandlingForChildren()},this),foundChildAO?[foundChildAO]:null},relevant:Util.alwaysTrue},ToolkitManager.prototype={loadToolkits:function(toolkits){this._logger.trace("loadToolkits: started"),toolkits.forEach(function(item,index){var toolkitIndex=index+1;this._loadToolkit(item,toolkitIndex)},this)},_loadToolkit:function(toolkitInfo,index){if(this._logger.trace("_loadToolkit: name = "+toolkitInfo.name+"; index = "+index),-1===this._getToolkitIndexByName(toolkitInfo.name)){this._logger.trace("_loadToolkit: "+toolkitInfo.name+" does not exists. Add it to the list");var kit=new Toolkit(toolkitInfo,index);this._addToolkit(kit)}},getTagList:function(){this._logger.trace("getTagList:started");var tagList=[];return this._toolkits.forEach(function(toolkit){toolkit.getTagList().forEach(function(tag){-1===tagList.indexOf(tag)&&tagList.push(tag)})}),tagList},createControl:function(element,skipTypes,rootElem,micclass){this._logger.trace("createControl: started");var controlObj=null;return Util.arrayFindIndex(this._toolkits,function(toolkit){return null!==(controlObj=toolkit.createControl(element,skipTypes,rootElem||{},micclass))}),controlObj},_addToolkit:function(toolkit){for(var i=0;i<this._toolkits.length&&!(this._toolkits[i].priority>toolkit.priority);i++);this._logger.trace("_addToolkit: insert at "+i),this._toolkits.splice(i,0,toolkit)},_getToolkitIndexByName:function(toolkitName){return Util.arrayFindIndex(this._toolkits,function(toolkit){return toolkit.toolkitName.toUpperCase()===toolkitName.toUpperCase()})}},Toolkit.prototype={CONST_PRIORITY_ATTR_DEF_VALUE:100,CONST_UNINITIALIZE:"UNINITIALIZE",_setScriptingEnviroment:function(){this._logger.trace("_setScriptingEnviroment: started");var scriptEnv={},browserInfo=Util.browserApplicationVersion().split(" ");return scriptEnv.name=browserInfo[0],scriptEnv.version=browserInfo[1],scriptEnv},_initControlList:function(controlObjects){this._logger.trace("_initControlList: started");var controls=[],ctrl=null,controlList=[];return controlList=controlList.concat(controlObjects),controlList.forEach(function(item,index){ctrl=new Control(item,index+1,this),controls.push(ctrl),this._controlByMicClass[ctrl.controlType]=ctrl},this),controls},getTagList:function(){this._logger.trace("getTagList:started"),Util.isNullOrUndefined(this._controlListByTags)&&(this._controlListByTags=[],this._controls.forEach(function(control){var controltags=control.initIdentificationTags();this.registerControlByTagList(control,controltags)},this));var tagList=[];return Util.isNullOrUndefined(this._controlListByTags)||this._controlListByTags.forEach(function(item){tagList.push(item.tagName)}),tagList},registerControlByTagList:function(control,tagList){tagList.forEach(function(tag){this.registerControlByTagName(control,tag._name)},this)},registerControlByTagName:function(control,tagName){var tn=tagName.toString().toLowerCase(),index=this._getControlListIndexByTagName(tn);if(-1===index){var tagWithControl={tagName:tn,controls:[control]};this._controlListByTags.push(tagWithControl)}else this._controlListByTags[index].controls.push(control)},_getControlListIndexByTagName:function(tagName){return Util.isNullOrUndefined(this._controlListByTags)?-1:Util.arrayFindIndex(this._controlListByTags,function(control){return tagName===control.tagName})},getControlByMicClass:function(micclass){return micclass?this._controlByMicClass[micclass]:null},createControl:function(element,skipTypes,rootElem,micclass){var control=null;if(micclass)return control=this.getControlByMicClass(micclass),null!=control&&-1===skipTypes.indexOf(control.controlType)?control.getControlByIdentification(element,rootElem||{}):null;var controlList=this._getCandidateControlList(element);return Util.arrayFindIndex(controlList,function(item){return-1===skipTypes.indexOf(item.controlType)&&(control=item.getControlByIdentification(element,rootElem||{})),!Util.isNullOrUndefined(control)}),control},_getCandidateControlList:function(element){var controlList=[],index=this._getControlListIndexByTagName(element.tagName.toLowerCase());return-1!==index&&(controlList=this._controlListByTags[index].controls),index=this._getControlListIndexByTagName("default"),-1!==index&&(controlList=controlList.concat(this._controlListByTags[index].controls)),controlList},getControlByCommonIdentification:function(element){var control=null;if(!Util.isNullOrUndefined(this._commonIdentificationInfo)){var controlClassName=this._callCommonIdentificationHandler(this._commonIdentificationInfo,element);!Util.isNullOrUndefined(controlClassName)&&"string"==typeof controlClassName&&controlClassName.length&&(control=this._getControlByControlName(controlClassName))}return control},_callCommonIdentificationHandler:function(commonIdentificationInfo,element){var controlClassName=null;if(this._commonIdentificationFunctionHandler===this.CONST_UNINITIALIZE&&(this._commonIdentificationFunctionHandler=this._getHandler(commonIdentificationInfo)),!Util.isNullOrUndefined(this._commonIdentificationFunctionHandler)){var ret=this._commonIdentificationFunctionHandler.execute(element,[]);Util.isNullOrUndefined(ret.type)||"OBJECT"!==ret.type||"string"!=typeof ret.result||(controlClassName=ret.result)}return controlClassName},_getControlByControlName:function(controlName){return Util.arrayFind(this._controls,function(control){return control.controlType===controlName})||null},getSettingVar:function(name){var setting=Util.arrayFind(this._settings,function(setting){return setting._name===name});return Util.isNullOrUndefined(setting)?null:setting._value},getJscript:function(jsFileName){return this.jsFunctionsManager.getJSScript(jsFileName)},_getHandler:function(handlerInfo){var handler=SectionHandlersFactory.prototype.getSectionHandler(handlerInfo._type);return Util.isNullOrUndefined(handler)||handler.initialize(handlerInfo,null,this)||(handler=null),handler}},JSFunctionsManager.prototype={getJSScript:function(jsFileName){var jsfunctionscript="",index=this._getIndex(jsFileName);return-1!==index&&(jsfunctionscript=this._jsFunctionScripts[index]),jsfunctionscript},_getIndex:function(jsFileName){
return Util.arrayFindIndex(this._jsFunctionFileNames,function(item){return item===jsFileName})}},Control.prototype={CONST_DEFAULT_TAG_VALUE:"default",CONST_UNINITIALIZE:"UNINITIALIZE",_identificationType:{IdentifyIfPropMatch:0,CallIDFuncIfPropMatch:1,SkipIfPropMatch:2},_identificationMode:{Identified:0,CallIndentificationFunction:1,Skip:2},_initMethodList:function(controlInfo){var methodList=[];try{Util.isNullOrUndefined(controlInfo.Run.Methods.Method)||(methodList=methodList.concat(controlInfo.Run.Methods.Method))}catch(error){}return methodList},initIdentificationTags:function(){var tagList=[],browserEntry=this._getBrowserSpecificEntry(this._toolkit.scriptEnv);return Util.isNullOrUndefined(browserEntry)||(Util.isNullOrUndefined(browserEntry.HTMLTags)?tagList.push({_name:this.CONST_DEFAULT_TAG_VALUE}):tagList=tagList.concat(browserEntry.HTMLTags.Tag)),tagList},_getBrowserSpecificEntry:function(scriptEnv){var browsers,browserEntry=null,min_version=parseFloat(scriptEnv.version),max_version=NaN,checkBrowserMinVersionInRange=function(currentVersion,minVersion,maxVersion){return!(isNaN(minVersion)||isNaN(currentVersion)||currentVersion<minVersion)&&(!!isNaN(maxVersion)||currentVersion<maxVersion)};try{browsers=this._controlInfo.Identification.Browser}catch(exception){this._logger.info("_getBrowserSpecificEntry: fail to get Identification.Browser"),browsers=null}if(Util.isNullOrUndefined(browsers))return this._logger.info("_getBrowserSpecficEntry: Identification.Browser not exist. get the identification node."),this._controlInfo.Identification;var browserList=[];return browserList=browserList.concat(browsers),browserList.forEach(function(browser){"*"===browser._name&&Util.isNullOrUndefined(browserEntry)?browserEntry=browser:browser._name.toLowerCase()===scriptEnv.name.toLowerCase()&&(Util.isNullOrUndefined(browser._min_version)?(Util.isNullOrUndefined(browserEntry)||"*"===browserEntry._name)&&(browserEntry=browser):checkBrowserMinVersionInRange(parseFloat(browser._min_version),min_version,max_version)&&(browserEntry=browser,max_version=parseFloat(browser._min_version)))}),browserEntry},getControlByIdentification:function(element,rootElem){var idMode=this.getIdentificationModeForElement(element);return idMode===this._identificationMode.Identified?this:idMode===this._identificationMode.Skip?null:this._getControlByIdentificationHandler(element,rootElem)},getIdentificationModeForElement:function(element){return this._initializeIdentificationConditionsSection(),Util.isNullOrUndefined(this._identificationConditions)?this._identificationMode.Skip:!Util.isNullOrUndefined(this._identificationConditions[this._identificationType.IdentifyIfPropMatch])&&this._identificationConditions[this._identificationType.IdentifyIfPropMatch].evaluate(element)?this._identificationMode.Identified:Util.isNullOrUndefined(this._identificationConditions[this._identificationType.CallIDFuncIfPropMatch])||this._identificationConditions[this._identificationType.CallIDFuncIfPropMatch].evaluate(element)?!Util.isNullOrUndefined(this._identificationConditions[this._identificationType.SkipIfPropMatch])&&this._identificationConditions[this._identificationType.SkipIfPropMatch].evaluate(element)?this._identificationMode.Skip:this._identificationMode.CallIndentificationFunction:this._identificationMode.Skip},_initializeIdentificationConditionsSection:function(){if(Util.isNullOrUndefined(this._identificationConditions)){this._identificationConditions=new Array(3);var conditions=this._getBrowserSpecificConditions(this._toolkit.scriptEnv);if(Util.isNullOrUndefined(conditions))this._logger.info("no condition found in the control");else{var conditionsList=[];conditionsList=conditionsList.concat(conditions),conditionsList.forEach(function(item){this._conditionsExpressParse(item)},this)}}},_conditionsExpressParse:function(conditions){if(!Util.isNullOrUndefined(conditions._type)){var index=this._identificationConditionTypeStrToIndex(conditions._type);if(index<0)return void this._logger.error("identification type is not correct");if(Util.isNullOrUndefined(this._identificationConditions[index])){var conditionExp=new ConditionsExpress(conditions);conditionExp.isValid()&&(this._identificationConditions[index]=conditionExp)}else this._logger.error("condition express for the condition type exist already")}},_identificationConditionTypeStrToIndex:function(conditionType){var conditionIndex=this._identificationType[conditionType];return Util.isNullOrUndefined(conditionIndex)?-1:conditionIndex},_getBrowserSpecificConditions:function(scriptEnv){var conditionsEntry=null,browserEntry=this._getBrowserSpecificEntry(scriptEnv);return browserEntry&&!Util.isNullOrUndefined(browserEntry.Conditions)&&(conditionsEntry=browserEntry.Conditions),conditionsEntry},_getControlByIdentificationHandler:function(element,rootElem){var control=null;return Util.isNullOrUndefined(this._toolkit._commonIdentificationInfo)?this._callControlIdentificationHandler(element,rootElem)&&(control=this):control=this._toolkit.getControlByCommonIdentification(element),control},_callControlIdentificationHandler:function(element,rootElement){var result=!1;if("string"==typeof this._identificationHanlder&&this._identificationHanlder===this.CONST_UNINITIALIZE&&(this._identificationHanlder=this._getHandler(this._controlInfo.Identification)),Util.isNullOrUndefined(this._identificationHanlder))return!1;var ret=this._identificationHanlder.execute(element,[]);return Util.isNullOrUndefined(ret.type)||"UNDEFINED"===ret.type||Util.isNullOrUndefined(ret.result)||("boolean"==typeof ret.result?result=ret.result:"number"==typeof ret.result?result=0!==parseInt(ret.result,10):"object"==typeof ret.result&&(rootElement._elem=ret.result,result=!0)),result},getInternalElement:function(element){var innerElement=null;if(!this.isRootElement(element))return this._logger.error("getInternalElement: the element is not the control supported"),null;if("string"==typeof this._innerElementHandler&&this._innerElementHandler===this.CONST_UNINITIALIZE&&this._initializeInnerElementHandler(),Util.isNullOrUndefined(this._innerElementHandler))return innerElement;var ret=this._innerElementHandler.execute(element,[]);return Util.isNullOrUndefined(ret.type)||"OBJECT"!==ret.type||(innerElement=ret.result),innerElement},_initializeInnerElementHandler:function(){var handlerInfo={};handlerInfo._function=this.getSettingVar("func_to_get_base_elem"),handlerInfo._file_name=this.getSettingVar("file_for_func_to_get_base_elem"),this._innerElementHandler=this._getHandler(handlerInfo)},isRootElement:function(element){var idMode=this.getIdentificationModeForElement(element);return idMode===this._identificationMode.Identified||idMode!==this._identificationMode.Skip&&this._callControlIdentificationHandler(element,{})},getSettingVar:function(name){var setting=Util.arrayFind(this._settings,function(item){return item._name===name});return Util.isNullOrUndefined(setting)?null:setting._value},_getHandler:function(handlerInfo){var handler=SectionHandlersFactory.prototype.getSectionHandler(handlerInfo._type);return Util.isNullOrUndefined(handler)||handler.initialize(handlerInfo,this,this._toolkit)||(handler=null),handler},getExtProperty:function(element,property){var propertyValue=null;if("string"==typeof this._propertyHandler&&this._propertyHandler===this.CONST_UNINITIALIZE&&this._initializePropertyHandler(),Util.isNullOrUndefined(this._propertyHandler))return propertyValue;var ret=this._propertyHandler.execute(element,[property]);return Util.isNullOrUndefined(ret.type)||"UNDEFINED"===ret.type||(propertyValue=ret.result),propertyValue},_initializePropertyHandler:function(){var handlerInfo={};Util.isNullOrUndefined(this._controlInfo.Run)||Util.isNullOrUndefined(this._controlInfo.Run.Properties)?(handlerInfo._function="get_property_value",handlerInfo._file_name=this.getSettingVar("file_for_func_to_get_base_elem")):handlerInfo=this._controlInfo.Run.Properties,this._propertyHandler=this._getHandler(handlerInfo)},invokeExtMethod:function(element,methodName,args){var methodIndex=Util.arrayFindIndex(this._methodList,function(method){return method._name===methodName});-1===methodIndex&&(methodIndex=Util.arrayFindIndex(this._methodList,function(method){return method._name.toLowerCase()===methodName.toLowerCase()}));var handlerInfo={};-1===methodIndex?(handlerInfo._function=methodName,handlerInfo._file_name=this.getSettingVar("file_for_func_to_get_base_elem")):handlerInfo=this._methodList[methodIndex];var ret,methodHandler=this._getHandler(handlerInfo);Util.isNullOrUndefined(methodHandler)||(ret=methodHandler.execute(element,args));var result={};return ret&&!Util.isNullOrUndefined(ret.type)&&"UNDEFINED"!==ret.type?result.status="pass":result.status="fail",Util.isNullOrUndefined(ret.result)||(result.data=ret.result),result},isObjSpyable:function(){try{var controlSpyable=this._controlInfo.Filter.Spy._is_control_spyable;if(!Util.isNullOrUndefined(controlSpyable)&&"no"===controlSpyable.toLowerCase())return!1}catch(error){this._logger.warn("isObjSpyable: return true by default, error: "+error)}return!0},UseDefaultEventHandling:function(){try{var value=this._controlInfo.Record.EventListening._use_default_event_handling;if(value&&("FALSE"===value.toUpperCase()||"0"===value))return!1}catch(error){this._logger.warn("UseDefaultEventHandling: return true by default, error: "+error)}return!0},UseDefaultEventHandlingForChildren:function(){try{var value=this._controlInfo.Record.EventListening._use_default_event_handling_for_children;if(value&&("FALSE"===value.toUpperCase()||"0"===value))return!1}catch(error){this._logger.warn("UseDefaultEventHandlingForChildren: return true by default, error: "+error)}return!0},_getControlLearnType:function(){var learnControl=ControlLearnType.Yes;try{if(!Util.isNullOrUndefined(this._controlInfo.Filter.Learn._learn_control))switch(this._controlInfo.Filter.Learn._learn_control){case"Yes":learnControl=ControlLearnType.Yes;break;case"No":learnControl=ControlLearnType.No;break;case"IfChildren":learnControl=ControlLearnType.IfChildren}}catch(exception){this._logger.info("_getControlLearnType: fail to get Filter.Learn.learn_control")}return learnControl},_getChildrenLearnType:function(){var learnChildren=ChildrenLearnType.Yes;try{if(!Util.isNullOrUndefined(this._controlInfo.Filter.Learn._learn_children))switch(this._controlInfo.Filter.Learn._learn_children){case"Yes":learnChildren=ChildrenLearnType.Yes;break;case"No":learnChildren=ChildrenLearnType.No;break;case"CallFilterFunc":learnChildren=ChildrenLearnType.LetMeSupply}}catch(exception){this._logger.info("_getChildrenLearnType: fail to get Filter.Learn.learn_children")}return learnChildren},getChildrenForLearn:function(element){var result=null;if("string"==typeof this._learnFilterHandler&&this._learnFilterHandler===this.CONST_UNINITIALIZE&&(this._learnFilterHandler=this._getHandler(this._controlInfo.Filter.Learn)),!Util.isNullOrUndefined(this._learnFilterHandler)){var ret=this._learnFilterHandler.execute(element,[]);Util.isNullOrUndefined(ret.type)||"OBJECT"!==ret.type||(result=ret.result)}return result},RegisterExtEventHandler:function(element){this._callListenToEventsHandler(element)},_callListenToEventsHandler:function(element){if(this._listenToEventsHandler===this.CONST_UNINITIALIZE){var handlerInfo;handlerInfo=this._controlInfo.Record&&this._controlInfo.Record.EventListening?this._controlInfo.Record.EventListening:{_function:"ListenToEvents"},this._listenToEventsHandler=this._getHandler(handlerInfo)}this._listenToEventsHandler&&this._listenToEventsHandler.execute(element,[])},isContainer:function(){return this._controlInfo&&"true"===this._controlInfo._IsContainer}},ConditionsExpress.prototype={CONST_LOGIC_AND:0,CONST_LOGIC_OR:1,_logicType:this.CONST_LOGIC_AND,_init:function(conditionInfo){if(Util.isNullOrUndefined(conditionInfo._logic)||"or"!==conditionInfo._logic.toLowerCase()||(this._logicType=this.CONST_LOGIC_OR),!Util.isNullOrUndefined(conditionInfo.Condition)){var conditionList=[];conditionList=conditionList.concat(conditionInfo.Condition),conditionList.forEach(function(item){this._parseSubCondition(item)},this)}if(!Util.isNullOrUndefined(conditionInfo.Conditions)){var conditionsList=[];conditionsList=conditionsList.concat(conditionInfo.Conditions),conditionsList.forEach(function(item){this._parseSubConditions(item)},this)}},_parseSubCondition:function(conditionInfo){var condition=new Condition(conditionInfo);condition.isValid()&&this._conditions.push(condition)},_parseSubConditions:function(conditionsInfo){var conditionExpress=new ConditionsExpress(conditionsInfo);conditionExpress.isValid()&&this._conditions.push(conditionExpress)},isValid:function(){return this._conditions.length>0},evaluate:function(element){if(!this.isValid()||Util.isNullOrUndefined(this._conditions)||0===this._conditions.length)return!1;return this._logicType===this.CONST_LOGIC_OR?this._conditions.some(function(item){return!0===item.evaluate(element)}):this._conditions.every(function(item){return!0===item.evaluate(element)})}},Condition.cache=Object.create(null),Condition.MAXSIZE=20480,Condition.cacheSize=0,Condition.prototype={_init:function(conditionInfo){Util.isNullOrUndefined(conditionInfo._prop_name)||(this._propName=conditionInfo._prop_name),Util.isNullOrUndefined(conditionInfo._trim)||"false"!==conditionInfo._trim.toLowerCase()&&"0"!==conditionInfo._trim||(this._trimExpectedValue=!1),Util.isNullOrUndefined(conditionInfo._expected_value)||(this._trimExpectedValue?this._expectedValue=conditionInfo._expected_value.trim().toLowerCase():this._expectedValue=conditionInfo._expected_value.toLowerCase()),Util.isNullOrUndefined(conditionInfo._is_reg_exp)||"true"!==conditionInfo._is_reg_exp.toLowerCase()&&"1"!==conditionInfo._is_reg_exp||(this._isRegExp=!0),Util.isNullOrUndefined(conditionInfo._equal)||"false"!==conditionInfo._equal.toLowerCase()&&"0"!==conditionInfo._equal||(this._isNegative=!0)},isValid:function(){return this._propName.length>0&&this._expectedValue.length>0},evaluate:function(element){if(!this.isValid())return!1;var result=this._matchHtmlElemProp(element,this._propName,this._expectedValue,this._isRegExp,this._trimExpectedValue);return this._isNegative?!result:result},_expectValueMeanTrue:function(value){return"true"===value||"1"===value||"yes"===value||"valid"===value},_expectValueMeanFalse:function(value){return"false"===value||"0"===value||"no"===value||"null"===value},_testPropertyValueAgainstExpected:function(expectedValue,propVal){var key=expectedValue+"$"+propVal;if(!(key in Condition.cache)){var regExpress=new RegExp(expectedValue),isMatched=regExpress.test(propVal);return Condition.cacheSize>=Condition.MAXSIZE&&(Condition.cache=Object.create(null),Condition.cacheSize=0),Condition.cache[key]=isMatched,Condition.cacheSize++,isMatched}return Condition.cache[key]},_matchHtmlElemProp:function(element,propName,expectedValue,isRegExp,trimBeforeCompare){var propVal=element[propName]||element.getAttribute(propName);if(Util.isNullOrUndefined(propVal))return this._expectValueMeanFalse(expectedValue);if("string"==typeof propVal){trimBeforeCompare&&(propVal=propVal.trim().toLowerCase());var _expectedValue=expectedValue.toLowerCase();return isRegExp?this._testPropertyValueAgainstExpected(_expectedValue,propVal):propVal===expectedValue}if("boolean"==typeof propVal)return propVal?this._expectValueMeanTrue(expectedValue):this._expectValueMeanFalse(expectedValue);if("number"==typeof propVal){return Number(expectedValue)===propVal}return this._expectValueMeanTrue(expectedValue)}},WebExtAO.prototype=new AO,WebExtAO.prototype.constructor=WebExtAO,WebExtAO.prototype._initMicClass=function(){this._micclass=[this._control.controlType];var otherTypes=this._control.getSettingVar("other supported types");otherTypes&&(this._micclass=this._micclass.concat(otherTypes.split("; ")))},WebExtAO.prototype._initInternalElement=function(element){var innerAO=null;this._logger.trace("WebExtAO._initInternalElement: started");var innerElem=this._control.getInternalElement(element);return Util.isNullOrUndefined(innerElem)||(innerAO=content.kitsManager.createAO(innerElem,this._parentID,!0)),innerAO},WebExtAO.prototype._initBaseAO=function(element){var baseAO=WebKit.createAO(element,this._parentID,!1,!0);return baseAO.setOuterAO(this),this._mergeBaseAOBehavior(baseAO),baseAO},WebExtAO.prototype.GetAttr=function(property,msg,resultCallback){this._logger.trace("WebExtAO.GetAttr: query property "+property);var propertyValue=this.GetExtAttr(property,msg);return Util.isNullOrUndefined(propertyValue)?this._processProperty(property,msg,function(){this.GetAttr(property,msg,resultCallback)}):resultCallback(Util.cleanSpecialChars(propertyValue))},WebExtAO.prototype.GetAttrSync=function(property,msg){this._logger.trace("WEbExtAO.GetAttrSync: query property "+property);var propertyValue=this.GetExtAttr(property,msg);return Util.isNullOrUndefined(propertyValue)?this._processProperty(property,msg,function(){return this.GetAttrSync(property,msg)}):Util.cleanTextProperty(propertyValue)},WebExtAO.prototype.GetExtAttr=function(property,msg){this._logger.trace("WebExtAO.GetExtAttr: started to query"+property);var propertyValue=null;return this._lazyInit("_attrs",property),propertyValue=this._attrs[property]?this._attrs[property].call(this,msg):this._getControlExtAttr(property),this._logger.trace("WebExtAO.GetExtAttr: "+property+" = "+propertyValue),propertyValue},WebExtAO.prototype._getControlExtAttr=function(property){var propertyValue=null;return-1===this._excludeAttrs.indexOf(property)&&(propertyValue=this._control.getExtProperty(this._elem,property),Util.isNullOrUndefined(propertyValue)&&(this._logger.trace("WebExtAO.GetExtAttr:fail to get "+property+" attribute from control"),propertyValue=null,this._excludeAttrs.push(property))),Array.isArray(propertyValue)&&"micclass"!==property&&(propertyValue=propertyValue.join(";")),propertyValue},WebExtAO.prototype._processProperty=function(property,msg,func){return Util.isNullOrUndefined(this._innerAO)||this._isCoreProperty(property)?func.call(this._baseAO):func.call(this._innerAO)},WebExtAO.prototype.InvokeMethod=function(method,msg,resultCallback){if("WEBEXT_GENERIC_METHOD_NAME"===method)return this._logger.trace("InvokeMethod: invoke ext method"),this.InvokeExtMethod(method,msg,resultCallback);if("GET_TABLE_DATA"===method){var funcToGetTableData=this._control.getSettingVar("func_to_get_table_data");if(!Util.isNullOrUndefined(funcToGetTableData)&&funcToGetTableData.length>0)return this._logger.trace("InvokeMethod: invoke ext method for GET_TABLE_DATA"),this._getTableData(funcToGetTableData,msg,resultCallback)}return Util.isNullOrUndefined(this._innerAO)?this._baseAO.InvokeMethod(method,msg,resultCallback):this._innerAO.InvokeMethod(method,msg,resultCallback)},WebExtAO.prototype._getTableData=function(getTableDataFunc,msg,resultCallback){var fillTableData=function(msg,data){if(!Array.isArray(data))return void this._logger.error("The return value is not array for function "+getTableDataFunc);for(var rows=data,maxcol=0,i=0;i<rows.length;++i){var cells=rows[i];if(!Array.isArray(cells))return void this._logger.error("The content is not array at row #"+i);cells.length>maxcol&&(maxcol=cells.length);var rowText=[cells];msg._data["WEB_PN_ROW_DATA"+(i+1)]=rowText}msg._data.row=rows.length,msg._data.WEB_AN_MAX_COLUMN=maxcol}.bind(this),callbackWrapper=function(msg){msg._data.WEBEXT_PN_METHOD_RETURN_VALUE&&fillTableData(msg,msg._data.WEBEXT_PN_METHOD_RETURN_VALUE),resultCallback(msg)}.bind(this);this.invokeMethodOnControl(getTableDataFunc,[],msg,callbackWrapper)},WebExtAO.prototype.InvokeExtMethod=function(method,msg,callback){if("WEBEXT_GENERIC_METHOD_NAME"!==method)return this._logger.warn("WebExtAO.InvokeExtMethod: the method name is not supported by Web Ext"),void ErrorReporter.ThrowGeneralError();var extMethod=msg._data.WEBEXT_PN_METHOD_NAME;this._logger.trace("WebExtAO.InvokeExtMethod: the ext method name is "+extMethod),0===extMethod.length&&(this._logger.warn("WebExtAO.InvokeExtMethod: the method name is empty"),ErrorReporter.ThrowInvalidArg());var argsList=[],argsCount=msg._data.WEBEXT_PN_METHOD_PARAMS_COUNT;if(this._logger.trace("InvokeExtMethod: the params count is "+argsCount),argsCount>50||argsCount<0)this._logger.warn("WebExtAO.InvokeMethod: the argCount is not correct.WEBEXT_PN_METHOD_PARAMS_COUNT = "+argsCount.toString()),ErrorReporter.ThrowInvalidArg();else for(var index=0;index<argsCount;index++)argsList.push(msg._data["WEBEXT_PN_METHOD_PARAM_"+index.toString()]);this.invokeMethodOnControl(extMethod,argsList,msg,callback)},WebExtAO.prototype.invokeMethodOnControl=function(methodName,argsList,msg,resultCallback){function waitingForReportCallbackHelper(self,theMsg){self._sendingReport?Util.setTimeout(waitingForReportCallbackHelper,50,self,theMsg):(self._replayReport&&(Util.extend(theMsg._data,self._replayReport),self._replayReport=null),resultCallback(theMsg))}function processReturnValueHelper(self,theMsg,retVal){try{switch(PageProxy.setActiveAO(null),retVal.status){case"pass":!Util.isNullOrUndefined(retVal.data)&&Util.isNullOrUndefined(theMsg._data.WEBEXT_PN_METHOD_RETURN_VALUE)&&(theMsg._data.WEBEXT_PN_METHOD_RETURN_VALUE=retVal.data),waitingForReportCallbackHelper(self,theMsg);break;case"fail":self._processExtMethodCallError(retVal.data,methodName,theMsg,waitingForReportCallbackHelper.bind(null,self));break;default:ErrorReporter.ThrowGeneralError()}}catch(e){theMsg.status=e.message||"ERROR",waitingForReportCallbackHelper(self,theMsg)}self._replayReport=null}var ret=this._invokeHandlerOnControl(methodName,argsList);ret.data&&ret.data.isPromise&&ret.data.cookie?PageProxy.addAsyncCall(ret.data.cookie,processReturnValueHelper.bind(null,this,msg)):processReturnValueHelper(this,msg,ret)},WebExtAO.prototype._invokeHandlerOnControl=function(handlerName,argsList){return PageProxy.setActiveAO(this),this._replayReport=null,this._control.invokeExtMethod(this._elem,handlerName,argsList)},WebExtAO.prototype.isObjSpyable=function(){return this._control.isObjSpyable()},WebExtAO.prototype.report=function(status,method,parameters,details,type){this._logger.trace("report: report started");var data={WEBEXT_PN_REPORT_STATUS:status,WEBEXT_PN_METHOD_NAME:method,WEBEXT_PN_PARAMETERS:parameters,WEBEXT_PN_REPORT_DETAILS:details,WEBEXT_PN_REPORT_EVENT_TYPE:type};if(BrowserServices.shouldSendWebExtReportWithResponse)return void(this._replayReport=data);this._sendingReport=!0;var msg=new Msg("WEBEXT_REPORT_LINE",this.getID(),data);content.dispatcher.sendMessage(msg,RtIdUtils.GetExtensionRtId(),null,function(){this._sendingReport=!1}.bind(this))},WebExtAO.prototype._processExtMethodCallError=function(errorResult,method,msg,callback){if(Util.isNullOrUndefined(errorResult))ErrorReporter.ThrowGeneralError();else switch(errorResult.ErrorType){case"Error":msg._data.WEBEXT_PN_EXE_ERROR_FILE=this._control.controlType+".js",msg._data.WEBEXT_PN_EXE_ERROR_DESCRIPTION=errorResult.ErrorDescription,ErrorReporter.ThrowGeneralError();break;case"MethodNotFound":this._lazyInit("_methods",method),this._methods[method]?this._methods[method].call(this,msg,callback):(this._logger.warn("InvokeMethod: unknown method "+method),ErrorReporter.ThrowMethodNotFound());break;default:ErrorReporter.ThrowGeneralError()}},WebExtAO.prototype.getControlLearnType=function(){return this._control._learnControl},WebExtAO.prototype.getChildrenLearnType=function(){return this._control._learnChildren},WebExtAO.prototype.getChildrenForLearn=function(element){return this._control.getChildrenForLearn(element)},WebExtAO.prototype.RegisterExtEventHandler=function(){PageProxy.setActiveAO(this),this._control.RegisterExtEventHandler(this._elem),PageProxy.setActiveAO(null)},WebExtAO.prototype.ReceiveEvent=function(recorder,ev){if(!Util.isExtEventRegistered(ev.target,ev.type))if(this._elem===ev.target)this.UseDefaultEventHandling()&&this._baseAO&&this._baseAO.ReceiveEvent(recorder,ev);else if(this.UseDefaultEventHandlingForChildren()){var aoArr=WebKit.createRecordAOArray(ev.target,recorder.frame.id,!0);aoArr.forEach(function(ao){ao.ReceiveEvent(recorder,ev)},recorder)}},WebExtAO.prototype._gestureToCustomEventMapper=function(gesture){return gesture?"UFT_GESTURE_"+gesture.toUpperCase():""},WebExtAO.prototype.ReceiveGesture=function(recorder,info,elem){this._fireCustomGestureEvent(elem,info)},WebExtAO.prototype._fireCustomGestureEvent=function(elem,info){var eventName=this._gestureToCustomEventMapper(info.event);if(eventName&&elem){var customEventDetails={bubbles:!0,cancelable:!1,detail:info},ev=ContentUtils.createCrossOriginCustomEvent(eventName,customEventDetails);elem.dispatchEvent(ev)}},WebExtAO.prototype.UseDefaultEventHandlingForChildren=function(){return this._control.UseDefaultEventHandlingForChildren()},WebExtAO.prototype.UseDefaultEventHandling=function(){return this._control.UseDefaultEventHandling()},WebExtAO.prototype.UseEventConfiguration=function(event){return this.UseDefaultEventHandling()},WebExtAO.prototype._mergeBaseAOBehavior=function(baseAO){this._logger.trace("mergeBaseAOBehavior: merging base AO behavior"),baseAO._behaviors.forEach(function(behavior){var funcs=behavior._helpers;for(var f in funcs)this[f]=funcs[f]},this)};var WebExtAOBehavior={_attrs:{is_container:function(){return!Util.isNullOrUndefined(this._control)&&this._control.isContainer()},"logical name":function(){return this._getControlExtAttr("logical name")||this._getControlExtAttr("logical_name")},"cell id":function(msg){var funcGetCellElemName=this._control.getSettingVar("func_to_get_cell_elem");if(Util.isNullOrUndefined(funcGetCellElemName))return null;var row=msg._data["cell id"][0][0],col=msg._data["cell id"][0][1],ret=this._invokeHandlerOnControl(funcGetCellElemName,[row,col]);return"pass"===ret.status&&ret.data instanceof HTMLElement?content.kitsManager.createAO(ret.data,this._parentID).getID():null},innerhtml:function(){return this._elem.innerHTML.replace(/ _uft_custom_id="[0-9]+"/g,"")},outerhtml:function(){return this._elem.outerHTML.replace(/ _uft_custom_id="[0-9]+"/g,"")}},_helpers:{isLearnable:Util.alwaysTrue,_isCoreProperty:function(property){var bIsCoreProp=!1;switch(property){case"html tag":case"height":case"width":case"abs_x":case"abs_y":case"x":case"y":case"coords":case"rect":case"pos":case"screen_rect":case"real rect":case"real pos":bIsCoreProp=!0}return bIsCoreProp}}};SectionHandlersFactory.prototype={getSectionHandler:function(type){var sectionType=type||"javascript",handler=null;switch(sectionType){case"boolean":handler=new BoolSectionHandler;break;case"javascript":case"jscript":handler=new JScriptSectionHandler}return handler}},SectionHandlerBase.prototype={CONST_RESULT_TYPE_UNDEFINED:"UNDEFINED",CONST_RESULT_TYPE_BOOL:"BOOL",CONST_RESULT_TYPE_OBJECT:"OBJECT",initialize:function(sectionInfo,control,toolkit){return this._sectionInfo=sectionInfo,this._control=control,this._toolkit=toolkit,this._valid=this._initSectionHanlder(sectionInfo,control,toolkit),this._valid},_initSectionHanlder:function(){return!0},terminate:function(){},execute:function(element,args){var result={type:this.CONST_RESULT_TYPE_UNDEFINED,result:null};return this._valid&&this._executeSection(element,args,result),result},_executeSection:function(){},getControlSettings:function(name){var settingValue=null;return Util.isNullOrUndefined(this._control)||(settingValue=this._control.getSettingVar(name)),settingValue},getToolkitSettings:function(name){var settingValue=null;return Util.isNullOrUndefined(this._toolkit)||(settingValue=this._toolkit.getSettingVar(name)),settingValue}},JScriptSectionHandler.prototype=new SectionHandlerBase,JScriptSectionHandler.prototype.constructor=JScriptSectionHandler,JScriptSectionHandler.prototype._functionWrapperList=[],JScriptSectionHandler.prototype._initSectionHanlder=function(sectionInfo,control,toolkit){var getFileName=function(filename){if("string"==typeof filename){var splashIndex=filename.lastIndexOf("\\");return splashIndex=-1!==splashIndex?splashIndex+1:0,filename.slice(splashIndex)}return filename},result=!1;if(Util.isNullOrUndefined(toolkit))return result;for(;;){if(this._jsFileName=sectionInfo._file_name,!Util.isNullOrUndefined(this._jsFileName))break;if(this._jsFileName=this.getControlSettings("default_imp_file"),!Util.isNullOrUndefined(this._jsFileName))break;if(this._jsFileName=this.getToolkitSettings("default_imp_file"),!Util.isNullOrUndefined(this._jsFileName))break;return result}return this._jsFileName=getFileName(this._jsFileName),Util.isNullOrUndefined(sectionInfo._function)?result:(this._function=sectionInfo._function,this._toolkitCommonFileName=getFileName(this.getToolkitSettings("common_file")),result=!0)},JScriptSectionHandler.prototype._executeSection=function(element,args,result){if(!this._functionWrapperClassName.length){this._functionWrapperClassName=this._jsFileName.replace(".js",""),this._functionWrapperClassName+="FunctionWrapper";var index=this._getFunctionWrapperIndex(this._functionWrapperClassName);if(-1!==index)this._functionWrapper=this._functionWrapperList[index];else{var script=this._getFunctionScript();if(Util.isNullOrUndefined(script))return;this._functionWrapper=new FunctionWrapper(this._functionWrapperClassName,script),this._functionWrapperList.push(this._functionWrapper)}}var ret=PageProxy.invokeOnPage(this._functionWrapperClassName,element,this._functionWrapper._functionBody,this._function,args);Util.isNullOrUndefined(ret)||(ret.status===PageAgent.INVOKE_STATUS_PASS?(result.type=this.CONST_RESULT_TYPE_OBJECT,result.result=ret.data):(result.type=this.CONST_RESULT_TYPE_UNDEFINED,ret.data.type===PageAgent.INVOKE_ERROR_METHOD_NOT_FOUND?result.result={ErrorType:"MethodNotFound"}:result.result={ErrorType:"Error",ErrorDescription:ret.data.error}))},JScriptSectionHandler.prototype.terminate=function(){},JScriptSectionHandler.prototype._getFunctionWrapperIndex=function(functionName){return Util.arrayFindIndex(this._functionWrapperList,function(functionWrapper){return functionWrapper._functionName===functionName})},JScriptSectionHandler.prototype._getFunctionScript=function(){var script=this._toolkit.getJscript(this._qtpCommonFileName)||"";return Util.isNullOrUndefined(this._toolkitCommonFileName)||(script+=this._toolkit.getJscript(this._toolkitCommonFileName)||""),script+=this._toolkit.getJscript(this._jsFileName)||""},BoolSectionHandler.prototype=new SectionHandlerBase,BoolSectionHandler.prototype.constructor=BoolSectionHandler,BoolSectionHandler.prototype._initSectionHanlder=function(sectionInfo){if(!Util.isNullOrUndefined(sectionInfo._value)){switch(sectionInfo._value.toString().toLowerCase()){case"true":this._value=!0,this._valid=!0;break;case"false":this._value=!1,this._valid=!0}}return this._valid},BoolSectionHandler.prototype._executeSection=function(){var ret={};return ret.type=this.CONST_RESULT_TYPE_BOOL,ret.result=this._value,ret},BoolSectionHandler.prototype.terminate=function(){},QTPUtil.prototype={Alert:function(s){alert(s)},_dispatchEvent:function(op,data){var detail={};detail.op=op,detail.data=data;var event=document.createEvent("CustomEvent");event.initCustomEvent("_UFT_TOOLKIT_RESULT",!0,!0,detail);var result=window.dispatchEvent(event);_logger.debug("QTPUtil._dispatchEvent: dispatch event to page, result: "+result)},isHandlerRegistered:function(element,aoId,eventName){if(Util.isNullOrUndefined(element._QTPExtHandlerRegArray))return!1;var index=Util.arrayFindIndex(element._QTPExtHandlerRegArray,function(item){return RtIdUtils.IsRTIDEqual(item.WEB_PN_ID,aoId)}),exist=!1;return-1!==index&&-1!==element._QTPExtHandlerRegArray[index].eventTypes.indexOf(eventName)&&(exist=!0),exist},AddHandlerRegisteredInfo:function(element,aoId,eventName){element._QTPExtHandlerRegArray=element._QTPExtHandlerRegArray||[];var index=Util.arrayFindIndex(element._QTPExtHandlerRegArray,function(item){return RtIdUtils.IsRTIDEqual(item.WEB_PN_ID,aoId)});-1===index&&(element._QTPExtHandlerRegArray.push({WEB_PN_ID:aoId,eventTypes:[]}),index=0),
element._QTPExtHandlerRegArray[index].eventTypes.push(eventName);var eventTypes=element._QTPExtHandlerRegArray[index].eventTypes;element.setAttribute("_uft_ext_events_hooked",JSON.stringify({events:eventTypes}))},RegisterForGesture:function(element,gestureName,handler,handlerParam){if(_logger.trace("QTPUtil.RegisterForGesture: started"),gestureName=gestureName.toLowerCase(),_logger.debug("QTPUtil.RegisterForGesture: gesture name: "+gestureName),PageAgent._activeScriptWrapper._aoId){var script=PageAgent._activeScriptWrapper,elem=PageAgent._activeScriptWrapper._elem,aoId=PageAgent._activeScriptWrapper._aoId,eventHandler=function(e){var params=[handlerParam,e];script.invoke(elem,handler,params,aoId)},eventType=this._gestureToCustomEventMapper(gestureName);if(!eventType)return void _logger.warn("cant add event listener for the following gesture :"+gestureName);this._updateGestureRegisterInfo(element,eventType,eventHandler),_logger.trace("QTPUtil.RegisterForGesture: add EventListener to element for the custom event - "+eventType),element.addEventListener(eventType,eventHandler)}},_updateGestureRegisterInfo:function(element,eventType,eventHandler){element._QTPExtGestureHandlerRegArray=element._QTPExtGestureHandlerRegArray||[],element._QTPExtGestureHandlerRegArray[eventType]&&element.removeEventListener(eventType,element._QTPExtGestureHandlerRegArray[eventType]),element._QTPExtGestureHandlerRegArray[eventType]=eventHandler},_gestureToCustomEventMapper:function(gesture){return gesture?"UFT_GESTURE_"+gesture.toUpperCase():""},RegisterForEvent:function(element,eventName,handler,handlerParam){if(_logger.trace("QTPUtil.RegisterForEvent: started"),eventName=eventName.toLowerCase(),PageAgent._activeScriptWrapper._aoId){var eventType=eventName.length>2&&"on"===eventName.substr(0,2)?eventName.slice(2):eventName;if(!this.isHandlerRegistered(element,PageAgent._activeScriptWrapper._aoId,eventName)){_logger.debug("QTPUtil.RegisterForEvent: event name: "+eventName);var script=PageAgent._activeScriptWrapper,elem=PageAgent._activeScriptWrapper._elem,aoId=PageAgent._activeScriptWrapper._aoId,eventHandler=function(e){var params=[handlerParam,e];script.invoke(elem,handler,params,aoId)}.bind(this);element.addEventListener(eventType,eventHandler,!0),this.AddHandlerRegisteredInfo(element,aoId,eventName)}}},Record:function(methodName,parameters,delay){if(Util.isNullOrUndefined(PageAgent._activeScriptWrapper._aoId))return void _logger.warn("Record data is not sent because there is no valid active ao ID.");var recordData={};recordData.methodName=methodName,recordData.parameters=parameters,recordData.delay=delay,recordData.WEB_PN_ID=PageAgent._activeScriptWrapper._aoId,this._dispatchEvent("Record",recordData)},_report:function(status,method,parameters,details,eventType){var reportData={};reportData.status=status,reportData.method=method,reportData.parameters=parameters,reportData.details=details,reportData.eventType=eventType,this._dispatchEvent("Report",reportData)},Report:function(status,method,parameters,details){this._report(status,method,parameters,details,"Replay")},ReportEvent:function(status,method,parameters,details){this._report(status,method,parameters,details,"User")},LogLine:function(text,severity,id,category){switch(severity){case 4:case 3:_logger.error(text);break;case 2:_logger.warn(text);break;case 1:_logger.info(text);break;case 0:_logger.debug(text);break;default:_logger.error(text)}},Wait:function(milliseconds){for(var start=(new Date).getTime(),expire=start+milliseconds;(new Date).getTime()<expire;);},GetBrowserType:function(){var browserTypeVersion=Util.browserApplicationVersion();return browserTypeVersion.slice(0,browserTypeVersion.lastIndexOf(" "))},GetBrowserVersion:function(){var broswerTypeVersion=Util.browserApplicationVersion();return broswerTypeVersion.slice(broswerTypeVersion.lastIndexOf(" ")+1)},IsFirefoxLegacyAgent:function(){return!1},ResolveAsyncCall:function(cookie,value){var param={cookie:cookie,data:value};this._dispatchEvent("AnswerAsyncCall",param)},RejectAsyncCall:function(cookie,error,line,file){var param={cookie:cookie,data:{errorMessage:error,errorLine:line,errorFile:file}};this._dispatchEvent("AnswerAsyncCall",param)}};var PageProxy={_activeAO:null,setActiveAO:function(ao){this._activeAO=ao},install:function(){this._logger=new LoggerUtil("Content.PageProxy"),window.addEventListener("_UFT_TOOLKIT_RESULT",this.onMessageFromPage.bind(this),!1),content.domSubscriber.startNamespace(),content.domSubscriber.addUtilityObject("_QTPUtil",new QTPUtil),content.domSubscriber.addUtilityObject("PageAgent",PageAgent,{_UFT_INVOKE_REQUEST:"onInvokeRequest"}),content.domSubscriber.addScript("PageAgent._logger = _logger;"),content.domSubscriber.addFunction(ScriptWrapper),content.domSubscriber.addScript("window._uftext = {PageAgent: PageAgent, _QTPUtil: _QTPUtil};"),content.domSubscriber.endNamespace()},onMessageFromPage:function(eventObj){var detail=Util.deepObjectClone(eventObj.detail),data=detail.data;switch(detail.op){case"Report":Util.isNullOrUndefined(this._activeAO)||this._activeAO.report(data.status,data.method,this._wrapParameters(data.parameters),data.details,data.eventType);break;case"Record":if(data=detail.data,data.parameters=this._wrapParameters(data.parameters),!Util.isNullOrUndefined(data.WEB_PN_ID)){var frameId=Util.shallowObjectClone(data.WEB_PN_ID);frameId.object=null;var msg=new Msg("WEBEXT_RECORD_EVENT",frameId,data);content.dispatcher.sendMessage(msg)}break;case"AnswerAsyncCall":var ret,cookie=data.cookie,result=data.data;ret=result&&result.errorMessage?{status:"fail",data:{ErrorType:"Error",ErrorDescription:result.errorMessage}}:{status:"pass",data:result},this.answerAsyncCall(cookie,ret);break;default:this._logger.warn("Unsupported Operation: "+detail.op)}},_wrapParameters:function(parameters){return[parameters]},invokeOnPage:function(key,elem,script,methodName,args){var detail={};detail.elemDOMId=elem.id,detail.key=key,detail.elemId=PageAgent.flagElement(elem),detail.script=script,detail.methodName=methodName,detail.args=args,detail.WEB_PN_ID=Util.isNullOrUndefined(this._activeAO)?null:this._activeAO.getID();var event=ContentUtils.createCrossOriginCustomEvent("_UFT_INVOKE_REQUEST",{detail:detail});window.dispatchEvent(event);var result=PageAgent.getResult(this._logger);return PageAgent.unFlagElement(elem),result},_asyncCallbacks:{},addAsyncCall:function(cookie,func){this._logger.info("addAsyncCall: adding callback with cookie :"+cookie),this._asyncCallbacks[cookie]=func},answerAsyncCall:function(cookie,result){this._asyncCallbacks[cookie]?(this._asyncCallbacks[cookie](result),delete this._asyncCallbacks[cookie]):this._logger.warn("answerAsyncCall: Not find call back associate with cookie ",cookie," result: ",result)}},PageAgent={_logger:null,_scriptwrappers:{},_activeScriptWrapper:null,registerScriptWrapper:function(key,scriptWrapper){this._scriptwrappers[key]=scriptWrapper},onInvokeRequest:function(eventObj){var detail=eventObj.detail,key=detail.key,scriptWrapper=this._scriptwrappers[key];if(scriptWrapper||(this._logger.info("create a new script wrapper."),this.evalCustomizedScriptWrapperInDom(key,detail.script),scriptWrapper=this._scriptwrappers[key]),!scriptWrapper)return void this._logger.error("onInvokeRequest: failed to evaluate script with key: "+key);var elemId=detail.elemId,elem=this.getElement(elemId);null==elem&&(elem=document.getElementById(detail.elemDOMId));var aoId=detail.WEB_PN_ID,res=scriptWrapper.invoke(elem,detail.methodName,detail.args,aoId);this.setResult(res),this._logger.info("invoke result: "+res)},wrap:function(obj){var result={special:!0};return obj instanceof HTMLElement?(result.type="element",result.id=this.flagElement(obj)):obj instanceof Window?result.type="window":obj instanceof Document?result.type="document":"function"==typeof window.Event&&obj instanceof window.Event?(result.type="event",result.data=this.wrapEvent(obj)):result=obj,result},unwrap:function(obj){var result=obj;if(null!==obj&&void 0!==obj&&obj.special)switch(obj.type){case"document":result=window.document;break;case"window":result=window;break;case"element":result=this.getElement(obj.id);break;case"event":result=this.unwrapEvent(obj.data)}else result=obj;return result},_getNextId:function(){var attr=document.documentElement.getAttribute("___nextUFTID");return attr=null===attr||void 0===attr?1:1+parseInt(attr,10),document.documentElement.setAttribute("___nextUFTID",attr),attr},keyCustomAttribute:"_UFT_CUSTOM_ID",flagElement:function(elem){var attribute=elem.getAttribute(this.keyCustomAttribute);return null!==attribute&&void 0!==attribute||(attribute=this._getNextId(),elem.setAttribute(this.keyCustomAttribute,attribute)),attribute},unFlagElement:function(elem){elem.removeAttribute(this.keyCustomAttribute)},getElement:function(id){var elements=document.querySelectorAll("["+this.keyCustomAttribute+'="'+id+'"]');return 0===elements.length?(this._logger.error("Failed to find element with custom id "+id),null):(elements.length>1&&this._logger.warn("more than one element matches the custom attribute id of "+id),elements[0])},_customResultAttributeKey:"__UFT__SYNC__RES",setResult:function(obj){document.documentElement.setAttribute(this._customResultAttributeKey,Util.jsonStringify(obj,_logger))},getResult:function(logger){var jsonStr=document.documentElement.getAttribute(this._customResultAttributeKey);if(!jsonStr)return void(logger&&logger.error("getResult, failed to get result JSON string from document element's attribute."));var jsonObj=JSON.parse(jsonStr);return jsonObj.status===PageAgent.INVOKE_STATUS_PASS&&(jsonObj.data=this.unwrap(jsonObj.data)),jsonObj},wrapEvent:function(eventObj){var obj={};for(var key in eventObj)obj[key]=this.wrap(eventObj[key]);return obj.eventPrototype=eventObj.constructor.name,Util.jsonStringify(obj,_logger)},unwrapEvent:function(eventStr){var o=JSON.parse(eventStr);for(var key in o)o[key]=this.unwrap(o[key]);return o},INVOKE_STATUS_PASS:"passed",INVOKE_STATUS_FAIL:"failed",INVOKE_ERROR_METHOD_NOT_FOUND:"MethodNotFound",INOVKE_ERROR_GENERAL:"GeneralERROR",evalCustomizedScriptWrapperInDom:function(key,script){var registerMethodHelper=function(){"function"==typeof METHODNAME&&(this._methods.METHODNAME=METHODNAME)},methodNameProcessor="",methodNames=this._extractMethodNames(script);this._logger.info("Methods extracted: "+methodNames.join(";")),methodNames.forEach(function(methodName){var specialized=Util.safeReplace(registerMethodHelper.toString(),/METHODNAME/g,methodName);methodNameProcessor+="("+specialized+").apply(this);\n"});var str=ScriptWrapper.toString();str=str.replace("#KEYPLACEHOLDER",key),str=Util.safeReplace(str,"//#METHODSPLACEHOLDER",methodNameProcessor),str=Util.safeReplace(str,"//#USERSCRIPTSPLACEHOLDER",script),str="( new "+str+"());",ContentUtils.evalInDocument(str)},_extractMethodNames:function(script){var f=document.createElement("iframe");document.body.appendChild(f);var oldMethods={};Object.getOwnPropertyNames(f.contentWindow).forEach(function(name){"function"==typeof f.contentWindow[name]&&(oldMethods[name]=f.contentWindow[name])}),ContentUtils.evalInDocument(script,f.contentDocument);var newProperties=Object.getOwnPropertyNames(f.contentWindow),candidates=newProperties.filter(function(name){return"function"==typeof f.contentWindow[name]&&f.contentWindow[name]!=oldMethods[name]});return document.body.removeChild(f),candidates}};LoggerUtilSettings.init();var content=null;!function(){function isDomReady(){return document&&document.body&&"none"!==document.body.style.display}function initFrame(){logger.info("initContent: prerequisites for initialization seem OK. Continue with initialization."),content.domSubscriber=new DomRequestSubscriber,content.kitsManager=new KitsManager,content.dispatcher=new ContentDispatcher,content.dispatcher.init(),content.rtidManager=new ObjectRTIDManager,content.frame.init()}function doOnDomReady(func){function eventListener(){!isFinished&&isDomReady()&&(Util.clearInterval(intervalId),isFinished=!0,func())}var isFinished=!1,intervalId=Util.setInterval(eventListener,1e3);document.addEventListener("DOMContentLoaded",eventListener)}var url=window.location?window.location.href:"",logger=new LoggerUtil("ContentLoader");if(content)return void logger.warn("initContent: Already initialized, url="+url);if(BrowserServices.executeOnLoad&&(isDomReady()?BrowserServices.executeOnLoad():doOnDomReady(BrowserServices.executeOnLoad)),!ContentUtils.isInjectable(window,logger)){var iFrameId="Unknown Id";try{iFrameId=window.frameElement?window.frameElement.id:""}catch(e){}return void logger.info("initContent: skip loading content for not injactable for url "+url+" - Frame Id: "+iFrameId)}logger.info("initContent: loading content. For "+(window.parent===window?"Page":"Frame")+" , on "+url),content={},logger.trace("initContent: creating Frame"),content.frame=new Frame,isDomReady()?initFrame():(logger.info("initContent: document is not ready. Waiting for DOMContentLoaded event."),doOnDomReady(initFrame))}(),window._QTP.ext=ext,window._QTP.content=content}}();